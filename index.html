<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hedra</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0A2A66">
  <link rel="icon" href="icon.png">

  <style>
    :root{
      --royal:#0A2A66;
      --royal2:#061b45;
      --bg:#061226;
      --paper:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:rgba(2,6,23,.10);
      --shadow:0 18px 42px rgba(0,0,0,.25);

      --danger:#dc2626;
      --danger2:#7f1d1d;
      --ok:#0f766e;
      --ok2:#065f46;
      --info:#2563eb;
      --info2:#1e3a8a;

      --r:22px;
      --btnR:18px;
    }

    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial}
    body{
      margin:0; color:#fff;
      background:
        radial-gradient(900px 520px at 80% -10%, rgba(10,42,102,.38), transparent 60%),
        radial-gradient(900px 520px at -10% 10%, rgba(10,42,102,.22), transparent 60%),
        linear-gradient(180deg, var(--bg), #031022);
    }

    .page{max-width:1060px; margin:0 auto; padding:14px 14px 110px}

    /* ====== 3D Buttons + Icons ====== */
    .btn{
      border:none;
      border-radius:var(--btnR);
      padding:12px 16px;
      min-height:48px;
      font-weight:1050;
      cursor:pointer;
      color:#fff;
      background: linear-gradient(180deg, rgba(10,42,102,.95), rgba(6,27,69,.95));
      box-shadow:
        0 14px 26px rgba(0,0,0,.28),
        inset 0 1px 0 rgba(255,255,255,.20),
        inset 0 -6px 14px rgba(0,0,0,.18);
      transition: transform .08s ease, filter .12s ease;
      user-select:none;
      display:inline-flex; align-items:center; gap:10px; justify-content:center;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.05)}
    .btn:active{transform:translateY(0px) scale(.985); filter:brightness(1.02)}
    .btn.small{min-height:44px; padding:10px 12px; border-radius:16px; font-size:13px}

    .btn.ghost{
      background: rgba(255,255,255,.10);
      box-shadow:
        0 12px 22px rgba(0,0,0,.18),
        inset 0 1px 0 rgba(255,255,255,.22);
    }

    .btn.light{
      background: linear-gradient(180deg, rgba(31,41,55,.95), rgba(17,24,39,.95));
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(220,38,38,.96), rgba(127,29,29,.96));
      box-shadow:
        0 14px 26px rgba(220,38,38,.18),
        inset 0 1px 0 rgba(255,255,255,.18),
        inset 0 -6px 14px rgba(0,0,0,.18);
    }
    .btn.ok{
      background: linear-gradient(180deg, rgba(15,118,110,.96), rgba(6,95,70,.96));
    }
    .btn.info{
      background: linear-gradient(180deg, rgba(37,99,235,.96), rgba(30,58,138,.96));
    }

    .ic3d{
      width:34px; height:34px;
      border-radius:14px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.14);
      box-shadow:
        0 10px 16px rgba(0,0,0,.22),
        inset 0 1px 0 rgba(255,255,255,.25),
        inset 0 -8px 14px rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.18);
      font-size:16px;
      flex:0 0 auto;
    }

    /* ====== Cards / text contrast ====== */
    .card{
      background: rgba(255,255,255,.98);
      color:var(--ink);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .hr{height:1px; background:rgba(2,6,23,.10); margin:12px 0}
    .hint{color:var(--muted); font-size:12px; line-height:1.7}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}

    /* ====== Home Header (fixed/sticky) ====== */
    .homeHeader{
      position:sticky; top:0; z-index:25;
      background: linear-gradient(180deg, rgba(10,42,102,.92), rgba(6,27,69,.92));
      border:1px solid rgba(255,255,255,.14);
      border-radius: 24px;
      box-shadow: 0 18px 42px rgba(0,0,0,.28);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .titleBig{font-weight:1150; font-size:22px; letter-spacing:.3px}
    .dateBig{margin-top:6px; font-size:17px; font-weight:1050; opacity:.96}
    .whiteInfo{
      margin-top:10px;
      font-weight:1050;
      font-size:15px;
      color:#fff;
      line-height:1.5;
      opacity:.98;
    }

    /* ====== Inputs ====== */
    label{display:block; font-weight:1050; font-size:13px; margin:10px 0 6px}
    input,select,textarea{
      width:100%;
      min-height:48px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(2,6,23,.14);
      outline:none;
      font-size:15px;
      background:#fff;
      color:var(--ink);
    }
    textarea{min-height:88px; resize:vertical}
    input:focus,select:focus,textarea:focus{border-color: rgba(10,42,102,.55)}
    .rowWrap{display:flex; gap:10px; flex-wrap:wrap}
    .rowWrap > *{flex:1; min-width:220px}

    /* ====== List rows ====== */
    .list{display:flex; flex-direction:column; gap:10px}
    .row{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:12px;
      border-radius:20px;
      border:1px solid rgba(2,6,23,.10);
      background:#fff;
      color:var(--ink);
    }
    .left{display:flex; align-items:center; gap:12px; min-width:0}
    .num{
      width:38px; height:38px; border-radius:14px;
      background: rgba(10,42,102,.08);
      border:1px solid rgba(10,42,102,.22);
      display:grid; place-items:center;
      font-weight:1150; color:var(--royal);
      flex:0 0 auto;
    }
    .name{font-weight:1150; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .metaSmall{font-size:12px; color:var(--muted); margin-right:6px; white-space:nowrap}

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(2,6,23,.10);
      background:rgba(10,42,102,.08);
      color:var(--royal);
      font-weight:1050;
      font-size:12px;
      white-space:nowrap;
    }
    .badge.red{background: rgba(220,38,38,.10); border-color: rgba(220,38,38,.20); color:#b91c1c;}
    .badge.green{background: rgba(15,118,110,.10); border-color: rgba(15,118,110,.20); color:#0f766e;}
    .badge.blue{background: rgba(37,99,235,.10); border-color: rgba(37,99,235,.20); color:#1d4ed8;}

    /* ====== Pay button states ====== */
    .payBtn{
      min-width:128px;
      min-height:48px;
      border-radius:18px;
      font-weight:1100;
      cursor:pointer;
      border:none;
      color:#fff;
      user-select:none;
      box-shadow:
        0 14px 26px rgba(0,0,0,.20),
        inset 0 1px 0 rgba(255,255,255,.20),
        inset 0 -8px 14px rgba(0,0,0,.18);
      transition: transform .08s ease, filter .12s ease;
      display:inline-flex; align-items:center; gap:10px; justify-content:center;
      padding:10px 14px;
    }
    .payBtn:hover{transform:translateY(-1px); filter:brightness(1.04)}
    .payBtn:active{transform:translateY(0) scale(.985)}
    .pay-unpaid{background: linear-gradient(180deg, rgba(220,38,38,.96), rgba(127,29,29,.96));}
    .pay-partial{background: linear-gradient(180deg, rgba(37,99,235,.96), rgba(30,58,138,.96));}
    .pay-paid{background: linear-gradient(180deg, rgba(15,118,110,.96), rgba(6,95,70,.96));}

    .moreBtn{
      width:56px; min-height:48px;
      border-radius:18px;
      border:1px solid rgba(2,6,23,.12);
      background:#fff;
      color:var(--ink);
      font-weight:1150;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
    }

    /* ====== Bottom Tabs ====== */
    .bottom{
      position:fixed; left:0; right:0; bottom:0; z-index:30;
      background: rgba(6,18,38,.82);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(255,255,255,.12);
      padding:10px 12px;
    }
    .bottom .wrap{
      max-width:1060px; margin:0 auto;
      display:flex; gap:10px;
    }
    .tab{
      flex:1;
      min-height:56px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color:#fff;
      font-weight:1100;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:10px;
      user-select:none;
      transition: transform .08s ease, filter .12s ease, border-color .12s ease;
      box-shadow: 0 12px 22px rgba(0,0,0,.18);
    }
    .tab:hover{transform:translateY(-1px); filter:brightness(1.05); border-color:rgba(255,255,255,.28)}
    .tab.active{
      background: rgba(10,42,102,.34);
      border-color: rgba(255,255,255,.30);
    }

    /* ====== Modals ====== */
    .overlay{
      position:fixed; inset:0; z-index:90;
      background: rgba(2,6,23,.60);
      display:none;
      padding:14px;
    }
    .modal{
      max-width:760px;
      margin:6vh auto;
      background:#fff;
      color:var(--ink);
      border:1px solid rgba(2,6,23,.12);
      border-radius:24px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modal h3{margin:0 0 6px; font-size:16px}
    .modal .topline{display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap}
    .modal .actions{display:flex; gap:10px; flex-wrap:wrap}
    table{width:100%; border-collapse:separate; border-spacing:0 10px}
    th{font-size:12px; color:var(--muted); text-align:right; padding:0 8px}
    td{background:#fff; border:1px solid rgba(2,6,23,.10); padding:10px 10px; border-radius:14px; color:var(--ink)}

    .toast{
      position:fixed; left:12px; bottom:88px; z-index:100;
      background: rgba(255,255,255,.98);
      color:var(--ink);
      border:1px solid rgba(2,6,23,.12);
      box-shadow: var(--shadow);
      padding:10px 12px;
      border-radius:16px;
      font-weight:1100;
      display:none;
      max-width:92vw;
    }

    /* Splash / Unlock */
    .splash{
      min-height: calc(100vh - 98px);
      display:grid;
      place-items:center;
      padding:18px;
    }
    .splashCard{
      max-width:600px; width:100%;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      border-radius: 26px;
      padding:18px;
      box-shadow: 0 18px 42px rgba(0,0,0,.26);
      backdrop-filter: blur(10px);
    }
  </style>
</head>

<body>
<div class="page">

  <!-- SPLASH -->
  <section id="pageSplash" class="splash">
    <div class="splashCard">
      <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap">
        <div style="display:flex; gap:12px; align-items:center">
          <div class="ic3d">H</div>
          <div>
            <div class="titleBig">Hedra</div>
            <div class="hint" style="color:rgba(255,255,255,.80)">v4.2 Pro â€¢ Ø¥Ø¯Ø§Ø±Ø© ÙƒØ§Ù…Ù„Ø© + Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª</div>
          </div>
        </div>
        <button class="btn small ghost" id="btnInstall" style="display:none">â¬‡ï¸ ØªØ«Ø¨ÙŠØª</button>
      </div>

      <div class="hr" style="background:rgba(255,255,255,.18)"></div>

      <div class="hint" style="color:rgba(255,255,255,.86)">
        Ø³ÙŠØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬.  
        Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù† ÙŠÙØ·Ù„Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ø«Ù†Ø§Ø¡ ÙØªØ­ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ (Ø¥Ù„Ø§ Ø¹Ù†Ø¯ Ø­Ø°Ù Ø­ØµØ© Ø£Ùˆ Ø¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯).
      </div>

      <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn ok" id="btnUnlock"><span class="ic3d">ğŸ”“</span> Ø¯Ø®ÙˆÙ„</button>
        <button class="btn small ghost" id="btnExport"><span class="ic3d">ğŸ“¤</span> ØªØµØ¯ÙŠØ±</button>
        <button class="btn small ghost" id="btnImport"><span class="ic3d">ğŸ“¥</span> Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
      </div>
    </div>
  </section>

  <!-- HOME -->
  <section id="pageHome" style="display:none">
    <div class="homeHeader">
      <div class="titleBig">Hedra</div>
      <div class="dateBig mono" id="bigDate">â€”</div>

      <div class="whiteInfo" id="homeWhiteInfo">
        Ø§Ù„Ø­ØµØ©: â€” / â€”<br>
        Ø§Ù„Ø¯ÙˆØ±Ø©: â€” â†’ â€”
      </div>

      <div class="hr" style="background:rgba(255,255,255,.14)"></div>

      <div class="rowWrap">
        <div>
          <label style="color:#fff; opacity:.92; margin-top:0">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
          <select id="homeGroupSelect"></select>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px">
        <div style="font-weight:1150; font-size:16px" id="homeGroupName">â€”</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn small ok" id="btnAddSession"><span class="ic3d">â•</span> Ø¥Ø¶Ø§ÙØ© Ø­ØµØ©</button>
          <button class="btn small danger" id="btnRemoveSession"><span class="ic3d">ğŸ—‘ï¸</span> Ø­Ø°Ù Ø­ØµØ©</button>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap">
        <div style="font-weight:1150">Ø§Ù„Ø·Ù„Ø§Ø¨</div>
        <div class="hint">Ø²Ø± â€œØ¯ÙØ¹â€ ÙŠÙØªØ­ Ù†Ø§ÙØ°Ø©: Ø¥Ø¬Ù…Ø§Ù„ÙŠ/Ù…Ø¯ÙÙˆØ¹/Ù…ØªØ¨Ù‚ÙŠ + Ø¥Ø¶Ø§ÙØ©/Ø®ØµÙ…/ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±</div>
      </div>

      <div class="hr"></div>
      <div class="list" id="homeStudentsList"></div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="pageAdmin" style="display:none">
    <div class="card">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap">
        <div>
          <div style="font-weight:1150">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
          <div class="hint" id="adminSub">â€”</div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
          <button class="btn small ghost" id="btnChangePin"><span class="ic3d">ğŸ”‘</span> ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ</button>
          <button class="btn small ghost" id="btnGroupLog"><span class="ic3d">ğŸ“œ</span> Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="rowWrap">
        <div>
          <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
          <select id="adminGroupSelect"></select>
        </div>
        <div>
          <label>Ø¨Ø­Ø« (ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª)</label>
          <input id="adminSearchAll" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." />
          <div class="hint">Ø³ÙŠØ¸Ù‡Ø± Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø£Ø³ÙÙ„</div>
        </div>
      </div>

      <div class="hr"></div>
      <div id="adminTotals" class="rowWrap"></div>

      <div class="hr"></div>
      <div class="list" id="adminStudentsList"></div>

      <div class="hr"></div>
      <div id="adminSearchResultsWrap" style="display:none">
        <div style="font-weight:1150">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</div>
        <div class="hint">Ù…Ù† Ø£ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø©</div>
        <div class="hr"></div>
        <div class="list" id="adminSearchResults"></div>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="pageSettings" style="display:none">
    <div class="card">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap">
        <div>
          <div style="font-weight:1150">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
          <div class="hint">Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù…ÙˆØ¹Ø© â€¢ Ø·Ù„Ø§Ø¨ â€¢ Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆØ±Ø© â€¢ Ø·ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ±Ø© â€¢ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
          <button class="btn small ok" id="btnAddGroup"><span class="ic3d">â•</span> Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
          <button class="btn small danger" id="btnReset"><span class="ic3d">ğŸ§¨</span> Ø¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯</button>
        </div>
      </div>

      <div class="hr"></div>

      <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</label>
      <div class="list" id="groupsList"></div>

      <div class="hr"></div>

      <div id="settingsGroupEditor" style="display:none">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap">
          <div style="font-weight:1150" id="editGroupTitle">â€”</div>
          <button class="btn small ghost" id="btnCloseGroupEditor"><span class="ic3d">âœ–ï¸</span> Ø¥ØºÙ„Ø§Ù‚</button>
        </div>

        <div class="hr"></div>

        <div class="rowWrap">
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
            <input id="editGroupName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø­Ø¯ ÙˆØ§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡"/>
          </div>
          <div>
            <label>Ø§Ø³Ù… Ø¹Ø±Ø¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="editGroupDisplayName" placeholder="ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"/>
          </div>
        </div>

        <div class="rowWrap">
          <div>
            <label>Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆØ±Ø©</label>
            <input id="editPriceCycle" type="number" min="0" step="1" placeholder="Ù…Ø«Ø§Ù„: 200"/>
          </div>
          <div>
            <label>Ø·ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ±Ø©</label>
            <select id="editCycleLen">
              <option value="4">4 Ø­ØµØµ</option>
              <option value="8" selected>8 Ø­ØµØµ</option>
              <option value="12">12 Ø­ØµØ©</option>
            </select>
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
          <button class="btn small ok" id="btnSaveGroup"><span class="ic3d">ğŸ’¾</span> Ø­ÙØ¸</button>
          <button class="btn small info" id="btnNewCycle"><span class="ic3d">ğŸ”</span> ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
          <button class="btn small danger" id="btnDeleteGroup"><span class="ic3d">ğŸ—‘ï¸</span> Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
        </div>

        <div class="hr"></div>

        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-end; flex-wrap:wrap">
          <div>
            <div style="font-weight:1150">Ø§Ù„Ø·Ù„Ø§Ø¨</div>
            <div class="hint">Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø®Ø§ØµØ© ØªØ¸Ù‡Ø± Ø¨Ø¬ÙˆØ§Ø± Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <input id="newStudentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." style="min-width:220px"/>
            <button class="btn small ok" id="btnAddStudent"><span class="ic3d">ğŸ‘¤</span> Ø¥Ø¶Ø§ÙØ©</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="list" id="studentsList"></div>
      </div>
    </div>
  </section>
</div>

<!-- Tabs -->
<div class="bottom">
  <div class="wrap">
    <button class="tab active" data-tab="home">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button class="tab" data-tab="admin">ğŸ§¾ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
    <button class="tab" data-tab="settings">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- ====== MODALS ====== -->

<!-- Quick Pay Modal (Home) -->
<div class="overlay" id="qpOverlay">
  <div class="modal">
    <div class="topline">
      <div>
        <h3 id="qpTitle">â€”</h3>
        <div class="hint mono" id="qpSub">â€”</div>
        <div id="qpStateBadges" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap"></div>
      </div>
      <div class="actions">
        <button class="btn small ghost" id="btnQpClose"><span class="ic3d">âœ–ï¸</span> Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>

    <div class="hr"></div>

    <div id="qpNumbers" class="rowWrap"></div>

    <div class="hr"></div>

    <div class="rowWrap">
      <div>
        <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
        <input id="qpAmount" type="number" step="1" placeholder="Ù…Ø«Ø§Ù„: 50"/>
      </div>
      <div>
        <label>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ø¨Ø§Ø´Ø±Ø© (Set Paid)</label>
        <input id="qpSetPaid" type="number" step="1" placeholder="Ù…Ø«Ø§Ù„: 100 (Ù„Ùˆ ÙƒÙ†ØªÙ ÙƒØªØ¨ØªÙŠ 1000 Ø¨Ø§Ù„ØºÙ„Ø·)"/>
        <div class="hint">Ù‡Ø°Ø§ ÙŠØ¹Ø¯Ù„ Ø±Ù‚Ù… â€œØ§Ù„Ù…Ø¯ÙÙˆØ¹â€ Ù…Ø¨Ø§Ø´Ø±Ø© (Ø£Ù†Ø³Ø¨ Ø­Ù„ Ù„Ù„Ø®Ø·Ø£).</div>
      </div>
    </div>

    <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <input id="qpNote" placeholder="Ù…Ø«Ø§Ù„: Ø¯ÙØ¹ Ø¬Ø²Ø¡ / Ù…Ù‚Ø¯Ù… / ØªØµØ­ÙŠØ­"/>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
      <button class="btn small ok" id="btnQpAdd"><span class="ic3d">â•</span> Ø¥Ø¶Ø§ÙØ©</button>
      <button class="btn small light" id="btnQpMinus"><span class="ic3d">â–</span> Ø®ØµÙ…</button>
      <button class="btn small info" id="btnQpPayFull"><span class="ic3d">âœ…</span> Ø¯ÙØ¹ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</button>
      <button class="btn small" id="btnQpApplySet"><span class="ic3d">ğŸ§©</span> ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
    </div>

    <div class="hr"></div>
    <div class="hint">Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø²Ø§Ø¦Ø¯ ÙŠØªØ­ÙˆÙ„ Ù„Ø±ØµÙŠØ¯ ÙˆÙŠÙØ±Ø­Ù„ Ù„Ù„Ø¯ÙˆØ±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¹Ù†Ø¯ ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©.</div>
  </div>
</div>

<!-- Admin Details + Log Modal -->
<div class="overlay" id="adOverlay">
  <div class="modal">
    <div class="topline">
      <div>
        <h3 id="adTitle">â€”</h3>
        <div class="hint mono" id="adSub">â€”</div>
        <div id="adBadges" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap"></div>
      </div>
      <div class="actions">
        <button class="btn small ghost" id="btnAdClose"><span class="ic3d">âœ–ï¸</span> Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>

    <div class="hr"></div>

    <div id="adNumbers" class="rowWrap"></div>

    <div class="hr"></div>
    <div id="adTableWrap"></div>

    <div class="hr"></div>

    <div style="display:flex; gap:10px; flex-wrap:wrap">
      <button class="btn small ok" id="btnAdPayFull"><span class="ic3d">âœ…</span> Ø¯ÙØ¹ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</button>
      <button class="btn small ghost" id="btnAdAdd"><span class="ic3d">â•</span> Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº</button>
      <button class="btn small ghost" id="btnAdMinus"><span class="ic3d">â–</span> Ø®ØµÙ… Ù…Ø¨Ù„Øº</button>
      <button class="btn small" id="btnAdSet"><span class="ic3d">ğŸ§©</span> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</button>
    </div>

    <div id="adAmountWrap" style="display:none; margin-top:10px">
      <label id="adAmountLabel">Ø§Ù„Ù…Ø¨Ù„Øº</label>
      <input id="adAmount" type="number" step="1" placeholder="Ù…Ø«Ø§Ù„: 50"/>
      <button class="btn small ok" id="btnAdApply" style="margin-top:10px"><span class="ic3d">âœ”ï¸</span> ØªØ·Ø¨ÙŠÙ‚</button>
    </div>

    <div class="hr"></div>

    <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap">
      <div style="font-weight:1150">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
      <button class="btn small ghost" id="btnExportLog"><span class="ic3d">ğŸ“¤</span> ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„</button>
    </div>

    <div class="hr"></div>
    <div class="list" id="adLogList"></div>
  </div>
</div>

<!-- Group Log Modal -->
<div class="overlay" id="glOverlay">
  <div class="modal">
    <div class="topline">
      <div>
        <h3>Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</h3>
        <div class="hint mono" id="glSub">â€”</div>
      </div>
      <div class="actions">
        <button class="btn small ghost" id="btnGlClose"><span class="ic3d">âœ–ï¸</span> Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
    <div class="hr"></div>
    <div class="list" id="glList"></div>
  </div>
</div>

<script>
/* =========================================================
   Hedra v4.2 Pro (Single File)
   - PIN once per session (unlock)
   - Delete session + Reset require PIN
   - Home: single section, white session/cycle info
   - Admin: totals + per student details + global search
   - Payments: add/minus/pay full + set paid direct
   - Logs: per student + per group
   - No remembering last group on open
========================================================= */

const DB_KEY = "hedra_v4_2_pro_db";
const SESSION_UNLOCK_KEY = "hedra_v4_2_unlocked";
const SESSION_GROUP_KEY  = "hedra_v4_2_group"; // session only; cleared on unlock/init

let db = { groups: [] };

/* ---------- Utilities ---------- */
function uid(p="id"){ return p+"_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16); }
function round2(n){ return Math.round((Number(n||0))*100)/100; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.style.display="none",2200);
}
function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function loadDB(){
  const raw = localStorage.getItem(DB_KEY);
  if(!raw) return;
  try{
    const p=JSON.parse(raw);
    if(p && typeof p==="object") db=p;
  }catch{}
}
function todayText(){
  return new Date().toLocaleDateString("ar-EG",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
}
function fmtDateAR(iso){
  if(!iso) return "â€”";
  const d=new Date(iso);
  return d.toLocaleDateString("ar-EG");
}
function fmtTimeAR(iso){
  if(!iso) return "â€”";
  const d=new Date(iso);
  return d.toLocaleTimeString("ar-EG",{hour:"2-digit",minute:"2-digit"});
}

/* ---------- PIN / Session Unlock ---------- */
function getPIN(){ return localStorage.getItem("hedra_pin") || ""; }
function setPIN(pin){ localStorage.setItem("hedra_pin", pin); }
function pinCheckOrSetup(){
  const existing = getPIN();
  if(!existing){
    const set = prompt("Ø¹ÙŠÙ‘Ù†ÙŠ Ø±Ù‚Ù… Ø³Ø±ÙŠ (4 Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ Ø£ÙƒØ«Ø±)");
    if(!set || set.trim().length < 4) return false;
    setPIN(set.trim());
    return true;
  }
  const entered = prompt("Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ");
  if(entered === existing) return true;
  alert("Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­");
  return false;
}
function isUnlocked(){ return sessionStorage.getItem(SESSION_UNLOCK_KEY)==="1"; }
function setUnlocked(v){ sessionStorage.setItem(SESSION_UNLOCK_KEY, v ? "1" : "0"); }
function getSessionGroup(){ return sessionStorage.getItem(SESSION_GROUP_KEY) || ""; }
function setSessionGroup(id){ sessionStorage.setItem(SESSION_GROUP_KEY, id || ""); }

/* ---------- Data Model ---------- */
/*
group = {
  id, name, displayName, price, cycleLen,
  students:[{id,name,paused,discountType,discountValue}],
  blocks:[{
    id, createdAtISO,
    sessions:[{id, tsISO}],
    payments:{[sid]:number},
    notes:{[sid]:string},
    carry:{[sid]:number}, // signed
    logs:[{id,tsISO,scope:"group"|"student", sid?, action, amount?, note?, meta?}],
    closed:boolean
  }]
}
*/

function newBlock(){
  return {
    id: uid("b"),
    createdAtISO: new Date().toISOString(),
    sessions: [],
    payments: {},
    notes: {},
    carry: {},
    logs: [],
    closed: false
  };
}

function ensureDefaults(){
  if(!Array.isArray(db.groups)) db.groups=[];

  if(db.groups.length===0){
    db.groups.push({
      id: uid("g"),
      name: "Ù…Ø¬Ù…ÙˆØ¹Ø© 1",
      displayName:"",
      price: 200,
      cycleLen: 8,
      students: [],
      blocks: [ newBlock() ]
    });
  }

  db.groups.forEach(g=>{
    if(!g.id) g.id=uid("g");
    if(typeof g.name!=="string") g.name="Ù…Ø¬Ù…ÙˆØ¹Ø©";
    if(typeof g.displayName!=="string") g.displayName="";
    g.price = Number(g.price||0);
    g.cycleLen = Number(g.cycleLen||8);
    if(!Array.isArray(g.students)) g.students=[];
    if(!Array.isArray(g.blocks) || g.blocks.length===0) g.blocks=[ newBlock() ];

    g.students.forEach(s=>{
      if(!s.id) s.id=uid("s");
      if(typeof s.name!=="string") s.name="Ø·Ø§Ù„Ø¨";
      s.paused = !!s.paused;
      s.discountType = s.discountType || "none";
      s.discountValue = Number(s.discountValue||0);
    });

    g.blocks.forEach(b=>{
      if(!b.id) b.id=uid("b");
      if(!b.createdAtISO) b.createdAtISO=new Date().toISOString();
      if(!Array.isArray(b.sessions)) b.sessions=[];
      if(!b.payments || typeof b.payments!=="object") b.payments={};
      if(!b.notes || typeof b.notes!=="object") b.notes={};
      if(!b.carry || typeof b.carry!=="object") b.carry={};
      if(!Array.isArray(b.logs)) b.logs=[];
      b.closed = !!b.closed;
    });
  });

  saveDB();
}

function getGroupById(id){ return db.groups.find(g=>g.id===id) || null; }
function curBlock(g){ return g?.blocks?.[g.blocks.length-1] || null; }

/* ---------- Pricing / totals ---------- */
function cycleLen(g){ return Math.max(1, Number(g.cycleLen||8)); }
function cyclePrice(g){ return Math.max(0, Number(g.price||0)); }

function effectiveCyclePrice(g,s){
  if(s.paused) return 0;
  const base = cyclePrice(g);
  const t=(s.discountType||"none");
  const v=Number(s.discountValue||0);

  if(t==="exempt") return 0;
  if(t==="fixed") return Math.max(0, base - Math.max(0,v));
  if(t==="percent"){
    const p=Math.max(0, Math.min(100, v));
    return Math.max(0, base*(1-p/100));
  }
  return base;
}
function perSession(g,s){ return round2(effectiveCyclePrice(g,s) / cycleLen(g)); }
function sessionsCount(b){ return (b.sessions||[]).length; }

function carry(b,sid){ return round2(Number(b.carry?.[sid] || 0)); } // signed
function paid(b,sid){ return round2(Number(b.payments?.[sid] || 0)); }

function subscriptionDueSoFar(g,b,s){
  return round2(sessionsCount(b) * perSession(g,s));
}
function totals(g,b,s){
  const sub = subscriptionDueSoFar(g,b,s);
  const prev = carry(b,s.id);
  const total = round2(sub + prev);
  const p = paid(b,s.id);
  const remaining = round2(total - p);
  return { sub, prev, total, paid:p, remaining };
}
function status(g,b,s){
  const t=totals(g,b,s);
  if(t.remaining <= 0) return "paid";
  if(t.paid > 0) return "partial";
  return "unpaid";
}

/* ---------- Cycle labels (auto) ---------- */
function cycleStartLabel(b){
  if(!b || !b.sessions?.length) return "â€”";
  return fmtDateAR(b.sessions[0].tsISO);
}
function cycleEndLabel(g,b){
  if(!b) return "â€”";
  if(sessionsCount(b) < cycleLen(g)) return "â€”";
  const last=b.sessions[b.sessions.length-1];
  return last ? fmtDateAR(last.tsISO) : "â€”";
}
function nextSessionNumber(g,b){
  const sc=sessionsCount(b);
  return Math.min(sc+1, cycleLen(g));
}

/* ---------- Logs ---------- */
function addLog(g,b, entry){
  const x = {
    id: uid("log"),
    tsISO: new Date().toISOString(),
    scope: entry.scope || "group",
    sid: entry.sid || undefined,
    action: entry.action || "Ø¹Ù…Ù„",
    amount: (entry.amount===undefined? undefined : round2(entry.amount)),
    note: entry.note ? String(entry.note).trim() : "",
    meta: entry.meta || ""
  };
  b.logs.unshift(x); // newest first
}
function logText(entry){
  const time = `${fmtDateAR(entry.tsISO)} â€¢ ${fmtTimeAR(entry.tsISO)}`;
  const amt = (entry.amount===undefined) ? "" : ` â€¢ ${entry.amount}`;
  const note = entry.note ? ` â€¢ ${entry.note}` : "";
  const meta = entry.meta ? ` â€¢ ${entry.meta}` : "";
  return `${time} â€¢ ${entry.action}${amt}${note}${meta}`;
}

/* ---------- Export / Import ---------- */
document.getElementById("btnExport").onclick=()=>{
  const data = JSON.stringify(db, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "Hedra_Backup_v4_2.json";
  a.click();
  URL.revokeObjectURL(a.href);
  toast("ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±");
};
document.getElementById("btnImport").onclick=()=>{
  const inp=document.createElement("input");
  inp.type="file"; inp.accept="application/json";
  inp.onchange=()=>{
    const f=inp.files?.[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const parsed=JSON.parse(r.result);
        if(!parsed || typeof parsed!=="object") throw new Error();
        db=parsed;
        ensureDefaults();
        toast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯");
        renderAll();
      }catch{
        alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
      }
    };
    r.readAsText(f);
  };
  inp.click();
};

/* ---------- Tabs ---------- */
const pages = {
  splash: document.getElementById("pageSplash"),
  home: document.getElementById("pageHome"),
  admin: document.getElementById("pageAdmin"),
  settings: document.getElementById("pageSettings")
};
function showTab(k){
  if(k!=="splash" && !isUnlocked()){
    pages.splash.style.display="";
    pages.home.style.display="none";
    pages.admin.style.display="none";
    pages.settings.style.display="none";
    document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab==="home"));
    return;
  }
  pages.splash.style.display = (k==="splash") ? "" : "none";
  pages.home.style.display   = (k==="home") ? "" : "none";
  pages.admin.style.display  = (k==="admin") ? "" : "none";
  pages.settings.style.display = (k==="settings") ? "" : "none";
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===k));
  renderAll();
}
document.querySelectorAll(".tab").forEach(t=>t.addEventListener("click", ()=>showTab(t.dataset.tab)));

/* ---------- Unlock ---------- */
document.getElementById("btnUnlock").onclick=()=>{
  if(pinCheckOrSetup()){
    setUnlocked(true);
    setSessionGroup(""); // Ù„Ø§ Ù†ØªØ°ÙƒØ± Ø¢Ø®Ø± Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
    toast("ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„");
    showTab("home");
  }
};

/* ---------- Home ---------- */
const homeGroupSelect=document.getElementById("homeGroupSelect");
function refreshHomeGroupSelect(){
  homeGroupSelect.innerHTML="";
  const o0=document.createElement("option");
  o0.value=""; o0.textContent="â€” Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø© â€”";
  homeGroupSelect.appendChild(o0);

  db.groups.forEach(g=>{
    const o=document.createElement("option");
    o.value=g.id; o.textContent=g.name;
    homeGroupSelect.appendChild(o);
  });

  homeGroupSelect.value = getSessionGroup();
}
homeGroupSelect.addEventListener("change",(e)=>{
  setSessionGroup(e.target.value || "");
  renderAll();
});

function studentSpecialLabel(s){
  let parts=[];
  if(s.paused) parts.push("Ù…ÙˆÙ‚ÙˆÙ");
  if(s.discountType==="exempt") parts.push("Ù…Ø¹ÙÙ‰");
  if(s.discountType==="fixed") parts.push("Ø®ØµÙ… Ù…Ø¨Ù„Øº");
  if(s.discountType==="percent") parts.push("Ø®ØµÙ… Ù†Ø³Ø¨Ø©");
  if(!parts.length) return "";
  return `(${parts.join(" / ")})`;
}
function studentBadges(s){
  const arr=[];
  if(s.paused) arr.push(`<span class="badge red">Ù…ÙˆÙ‚ÙˆÙ</span>`);
  if(s.discountType==="exempt") arr.push(`<span class="badge">Ù…Ø¹ÙÙ‰</span>`);
  if(s.discountType==="fixed") arr.push(`<span class="badge">Ø®ØµÙ… Ù…Ø¨Ù„Øº: ${escapeHtml(String(s.discountValue||0))}</span>`);
  if(s.discountType==="percent") arr.push(`<span class="badge">Ø®ØµÙ… Ù†Ø³Ø¨Ø©: ${escapeHtml(String(s.discountValue||0))}%</span>`);
  return arr.join("");
}

function renderHomeHeader(){
  document.getElementById("bigDate").textContent = todayText();

  const gid=getSessionGroup();
  const g=getGroupById(gid);
  const b=g?curBlock(g):null;

  document.getElementById("homeGroupName").textContent = g ? (g.displayName || g.name) : "â€”";

  if(!g || !b){
    document.getElementById("homeWhiteInfo").innerHTML = `Ø§Ù„Ø­ØµØ©: â€” / â€”<br>Ø§Ù„Ø¯ÙˆØ±Ø©: â€” â†’ â€”`;
    return;
  }
  // âœ… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø§Ù„Ø­ØµØ©/Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø¨ÙŠØ¶ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  document.getElementById("homeWhiteInfo").innerHTML =
    `Ø§Ù„Ø­ØµØ©: ${nextSessionNumber(g,b)} / ${cycleLen(g)}<br>`+
    `Ø§Ù„Ø¯ÙˆØ±Ø©: ${cycleStartLabel(b)} â†’ ${cycleEndLabel(g,b)}`;
}

function renderHomeStudents(){
  const wrap=document.getElementById("homeStudentsList");
  wrap.innerHTML="";

  const gid=getSessionGroup();
  const g=getGroupById(gid);
  const b=g?curBlock(g):null;

  if(!g){
    wrap.innerHTML = `<div class="hint">Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨.</div>`;
    return;
  }
  if(!g.students.length){
    wrap.innerHTML = `<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©. Ø£Ø¶ÙŠÙÙŠÙ‡Ù… Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.</div>`;
    return;
  }

  const list=[...g.students].sort((a,b)=>a.name.localeCompare(b.name,"ar"));
  list.forEach((s,idx)=>{
    const st=status(g,b,s);

    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <div class="left">
        <div class="num">${idx+1}</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(s.name)} <span class="metaSmall">${escapeHtml(studentSpecialLabel(s))}</span></div>
        </div>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="payBtn ${st==="paid"?"pay-paid":st==="partial"?"pay-partial":"pay-unpaid"}">
          <span class="ic3d">${st==="paid"?"âœ…":st==="partial"?"ğŸŸ¦":"ğŸ’³"}</span>
          ${st==="paid"?"Ù…ÙƒØªÙ…Ù„/Ø±ØµÙŠØ¯":st==="partial"?"Ø¬Ø²Ø¦ÙŠ":"Ø¯ÙØ¹"}
        </button>
        <button class="moreBtn" title="ØªÙØ§ØµÙŠÙ„/Ø³Ø¬Ù„">â‹¯</button>
      </div>
    `;

    row.querySelector(".payBtn").onclick=()=>{
      if(s.paused){ toast("Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆÙ‚ÙˆÙ"); return; }
      openQuickPay(g,b,s);
    };
    row.querySelector(".moreBtn").onclick=()=>openAdminStudent(g,b,s);

    wrap.appendChild(row);
  });
}

/* ---------- Sessions controls ---------- */
document.getElementById("btnAddSession").onclick=()=>{
  const gid=getSessionGroup();
  const g=getGroupById(gid);
  if(!g){ toast("Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£ÙˆÙ„Ø§Ù‹"); return; }
  const b=curBlock(g);

  if(sessionsCount(b) >= cycleLen(g)){
    toast("Ø§ÙƒØªÙ…Ù„Øª Ø­ØµØµ Ø§Ù„Ø¯ÙˆØ±Ø©. Ø§ÙØªØ­ÙŠ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.");
    return;
  }

  b.sessions.push({ id:uid("ss"), tsISO:new Date().toISOString() });
  addLog(g,b,{scope:"group", action:"Ø¥Ø¶Ø§ÙØ© Ø­ØµØ©", meta:`Ø­ØµØµ: ${sessionsCount(b)}/${cycleLen(g)}`});
  saveDB();
  toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­ØµØ©");
  renderAll();
};

document.getElementById("btnRemoveSession").onclick=()=>{
  const gid=getSessionGroup();
  const g=getGroupById(gid);
  if(!g){ toast("Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£ÙˆÙ„Ø§Ù‹"); return; }
  const b=curBlock(g);

  if(!b.sessions.length){
    toast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ù„Ù„Ø­Ø°Ù");
    return;
  }

  // âœ… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø­Ø°Ù Ø§Ù„Ø­ØµØ© ÙŠØ­ØªØ§Ø¬ Ø¨Ø§Ø³ÙˆØ±Ø¯
  if(!pinCheckOrSetup()) return;

  const ok=confirm("Ø­Ø°Ù Ø¢Ø®Ø± Ø­ØµØ©ØŸ");
  if(!ok) return;

  const removed = b.sessions.pop();
  addLog(g,b,{scope:"group", action:"Ø­Ø°Ù Ø­ØµØ©", meta:`ØªØ§Ø±ÙŠØ®: ${fmtDateAR(removed?.tsISO)}`});
  saveDB();
  toast("ØªÙ… Ø­Ø°Ù Ø¢Ø®Ø± Ø­ØµØ©");
  renderAll();
};

/* ---------- Quick Pay (Home) ---------- */
const qpOverlay=document.getElementById("qpOverlay");
let qpCtx=null;

document.getElementById("btnQpClose").onclick=()=>{ qpOverlay.style.display="none"; qpCtx=null; };
qpOverlay.addEventListener("click",(e)=>{ if(e.target===qpOverlay){ qpOverlay.style.display="none"; qpCtx=null; } });

function renderQpNumbers(g,b,s){
  const t=totals(g,b,s);
  document.getElementById("qpNumbers").innerHTML = `
    <div class="row" style="flex:1; min-width:240px">
      <div class="left"><div class="num">âˆ‘</div><div><div class="name">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div><div class="hint mono">${t.total}</div></div></div>
    </div>
    <div class="row" style="flex:1; min-width:240px">
      <div class="left"><div class="num">ğŸ’°</div><div><div class="name">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div><div class="hint mono">${t.paid}</div></div></div>
    </div>
    <div class="row" style="flex:1; min-width:240px">
      <div class="left"><div class="num">ğŸ§¾</div><div><div class="name">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div><div class="hint mono">${t.remaining}</div></div></div>
    </div>
  `;
}

function openQuickPay(g,b,s){
  qpCtx={g,b,s};
  document.getElementById("qpTitle").textContent = s.name;
  document.getElementById("qpSub").textContent =
    `Ø­ØµØµ: ${sessionsCount(b)}/${cycleLen(g)} â€¢ Ø§Ù„Ø¯ÙˆØ±Ø©: ${cycleStartLabel(b)} â†’ ${cycleEndLabel(g,b)}`;

  document.getElementById("qpStateBadges").innerHTML = studentBadges(s) || `<span class="badge">â€”</span>`;
  document.getElementById("qpAmount").value="";
  document.getElementById("qpSetPaid").value="";
  document.getElementById("qpNote").value = String(b.notes?.[s.id] || "");

  renderQpNumbers(g,b,s);

  qpOverlay.style.display="block";
  setTimeout(()=>document.getElementById("qpAmount").focus(), 40);
}

function saveNote(b,sid,note){
  b.notes[sid] = String(note||"").trim();
}

function addPayment(g,b,s,amount,note){
  const cur = paid(b,s.id);
  b.payments[s.id] = round2(cur + amount);
  saveNote(b,s.id,note);
  addLog(g,b,{scope:"student", sid:s.id, action:"Ø¯ÙØ¹", amount, note});
}
function minusPayment(g,b,s,amount,note){
  const cur = paid(b,s.id);
  b.payments[s.id] = round2(Math.max(0, cur - amount));
  saveNote(b,s.id,note);
  addLog(g,b,{scope:"student", sid:s.id, action:"Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹", amount, note});
}
function setPaidValue(g,b,s,newPaid,note){
  b.payments[s.id] = round2(Math.max(0, newPaid));
  saveNote(b,s.id,note);
  addLog(g,b,{scope:"student", sid:s.id, action:"ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹", amount:newPaid, note});
}

document.getElementById("btnQpAdd").onclick=()=>{
  if(!qpCtx) return;
  const {g,b,s}=qpCtx;
  const v=Number(document.getElementById("qpAmount").value||0);
  if(!(v>0)) return alert("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
  addPayment(g,b,s,v,document.getElementById("qpNote").value);
  saveDB(); toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©"); renderAll(); renderQpNumbers(g,b,s);
};
document.getElementById("btnQpMinus").onclick=()=>{
  if(!qpCtx) return;
  const {g,b,s}=qpCtx;
  const v=Number(document.getElementById("qpAmount").value||0);
  if(!(v>0)) return alert("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
  minusPayment(g,b,s,v,document.getElementById("qpNote").value);
  saveDB(); toast("ØªÙ… Ø§Ù„Ø®ØµÙ…"); renderAll(); renderQpNumbers(g,b,s);
};
document.getElementById("btnQpPayFull").onclick=()=>{
  if(!qpCtx) return;
  const {g,b,s}=qpCtx;
  const t=totals(g,b,s);
  if(t.remaining<=0){ toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¨Ù‚ÙŠ"); return; }
  setPaidValue(g,b,s,t.total,document.getElementById("qpNote").value);
  addLog(g,b,{scope:"student", sid:s.id, action:"Ø¯ÙØ¹ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ", amount:t.remaining});
  saveDB(); toast("ØªÙ… Ø§Ù„Ø¯ÙØ¹"); renderAll(); renderQpNumbers(g,b,s);
};
document.getElementById("btnQpApplySet").onclick=()=>{
  if(!qpCtx) return;
  const {g,b,s}=qpCtx;
  const v=Number(document.getElementById("qpSetPaid").value||0);
  if(v<0) return alert("Ø§ÙƒØªØ¨ Ø±Ù‚Ù… ØµØ­ÙŠØ­");
  // âœ… Ø­Ù„ Ø§Ù„Ø®Ø·Ø£ 1000 Ø¨Ø¯Ù„ 100: Ø§ÙƒØªØ¨ 100 Ù‡Ù†Ø§ ÙˆØ§Ø¶ØºØ·ÙŠ ØªØ·Ø¨ÙŠÙ‚
  setPaidValue(g,b,s,v,document.getElementById("qpNote").value);
  saveDB(); toast("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹"); renderAll(); renderQpNumbers(g,b,s);
};

/* ---------- Admin ---------- */
const adminGroupSelect=document.getElementById("adminGroupSelect");
const adminSearchAll=document.getElementById("adminSearchAll");

function refreshAdminGroupSelect(){
  adminGroupSelect.innerHTML="";
  db.groups.forEach(g=>{
    const o=document.createElement("option");
    o.value=g.id; o.textContent=g.name;
    adminGroupSelect.appendChild(o);
  });
  if(db.groups[0]) adminGroupSelect.value=db.groups[0].id;
}
adminGroupSelect.addEventListener("change", ()=>renderAdmin());
adminSearchAll.addEventListener("input", ()=>renderAdminSearchAll());

function renderAdminTotals(g,b){
  let total=0, paidSum=0, remainingSum=0;
  g.students.forEach(s=>{
    const t=totals(g,b,s);
    total += t.total;
    paidSum += t.paid;
    remainingSum += t.remaining;
  });
  total=round2(total); paidSum=round2(paidSum); remainingSum=round2(remainingSum);

  document.getElementById("adminTotals").innerHTML = `
    <div class="row" style="flex:1; min-width:240px">
      <div class="left"><div class="num">âˆ‘</div><div><div class="name">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</div><div class="hint mono">${total}</div></div></div>
    </div>
    <div class="row" style="flex:1; min-width:240px">
      <div class="left"><div class="num">ğŸ’°</div><div><div class="name">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div><div class="hint mono">${paidSum}</div></div></div>
    </div>
    <div class="row" style="flex:1; min-width:240px">
      <div class="left"><div class="num">ğŸ§¾</div><div><div class="name">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div><div class="hint mono">${remainingSum}</div></div></div>
    </div>
  `;
}

function renderAdmin(){
  const gid=adminGroupSelect.value||"";
  const g=getGroupById(gid);
  const b=g?curBlock(g):null;

  document.getElementById("adminSub").textContent = (g && b)
    ? `${g.displayName || g.name} â€¢ Ø­ØµØµ: ${sessionsCount(b)}/${cycleLen(g)} â€¢ Ø§Ù„Ø¯ÙˆØ±Ø©: ${cycleStartLabel(b)} â†’ ${cycleEndLabel(g,b)}`
    : "â€”";

  const listWrap=document.getElementById("adminStudentsList");
  listWrap.innerHTML="";

  if(!g || !b){
    listWrap.innerHTML = `<div class="hint">â€”</div>`;
    return;
  }

  renderAdminTotals(g,b);

  if(!g.students.length){
    listWrap.innerHTML = `<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨.</div>`;
    return;
  }

  const list=[...g.students].sort((a,b)=>a.name.localeCompare(b.name,"ar"));
  list.forEach(s=>{
    const t=totals(g,b,s);
    const st=status(g,b,s);

    const special = studentSpecialLabel(s);

    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <div class="left" style="min-width:0">
        <div class="num">ğŸ‘¤</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(s.name)} <span class="metaSmall">${escapeHtml(special)}</span></div>
          <div class="hint mono">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${t.total} â€¢ Ù…Ø¯ÙÙˆØ¹: ${t.paid} â€¢ Ù…ØªØ¨Ù‚ÙŠ: ${t.remaining}</div>
        </div>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <div class="badge ${st==="paid"?"green":st==="partial"?"blue":""}">${st==="paid"?"Ù…ÙƒØªÙ…Ù„/Ø±ØµÙŠØ¯":st==="partial"?"Ø¬Ø²Ø¦ÙŠ":"ØºÙŠØ± Ù…ÙƒØªÙ…Ù„"}</div>
        <button class="moreBtn">Ø¹Ø±Ø¶</button>
      </div>
    `;
    row.querySelector("button").onclick=()=>openAdminStudent(g,b,s);
    listWrap.appendChild(row);
  });

  renderAdminSearchAll();
}

function renderAdminSearchAll(){
  const q=(adminSearchAll.value||"").trim().toLowerCase();
  const wrap=document.getElementById("adminSearchResultsWrap");
  const out=document.getElementById("adminSearchResults");
  out.innerHTML="";

  if(!q){ wrap.style.display="none"; return; }

  const hits=[];
  db.groups.forEach(g=>{
    const b=curBlock(g);
    g.students.forEach(s=>{
      if(s.name.toLowerCase().includes(q)) hits.push({g,b,s});
    });
  });

  wrap.style.display="";
  if(!hits.length){
    out.innerHTML = `<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</div>`;
    return;
  }

  hits.sort((a,b)=>a.s.name.localeCompare(b.s.name,"ar")).forEach(({g,b,s})=>{
    const t=totals(g,b,s);
    const special = studentSpecialLabel(s);
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <div class="left" style="min-width:0">
        <div class="num">ğŸ”</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(s.name)} <span class="metaSmall">${escapeHtml(special)}</span></div>
          <div class="hint">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: <b>${escapeHtml(g.name)}</b></div>
          <div class="hint mono">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${t.total} â€¢ Ù…Ø¯ÙÙˆØ¹: ${t.paid} â€¢ Ù…ØªØ¨Ù‚ÙŠ: ${t.remaining}</div>
        </div>
      </div>
      <div><button class="moreBtn">Ø¹Ø±Ø¶</button></div>
    `;
    row.querySelector("button").onclick=()=>openAdminStudent(g,b,s);
    out.appendChild(row);
  });
}

/* ---------- Admin Student Modal + Log ---------- */
const adOverlay=document.getElementById("adOverlay");
let adCtx=null;
let adMode=null; // add/minus/set

document.getElementById("btnAdClose").onclick=()=>{ adOverlay.style.display="none"; adCtx=null; adMode=null; document.getElementById("adAmountWrap").style.display="none"; };
adOverlay.addEventListener("click",(e)=>{ if(e.target===adOverlay){ adOverlay.style.display="none"; adCtx=null; adMode=null; document.getElementById("adAmountWrap").style.display="none"; } });

function renderAdNumbers(g,b,s){
  const t=totals(g,b,s);
  document.getElementById("adNumbers").innerHTML=`
    <div class="row" style="flex:1; min-width:240px">
      <div class="left"><div class="num">âˆ‘</div><div><div class="name">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div><div class="hint mono">${t.total}</div></div></div>
    </div>
    <div class="row" style="flex:1; min-width:240px">
      <div class="left"><div class="num">ğŸ’°</div><div><div class="name">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div><div class="hint mono">${t.paid}</div></div></div>
    </div>
    <div class="row" style="flex:1; min-width:240px">
      <div class="left"><div class="num">ğŸ§¾</div><div><div class="name">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div><div class="hint mono">${t.remaining}</div></div></div>
    </div>
  `;
}
function renderAdTable(g,b,s){
  const t=totals(g,b,s);
  const ss = (b.sessions||[]).map(x=>fmtDateAR(x.tsISO)).join(" â€¢ ");
  document.getElementById("adTableWrap").innerHTML = `
    <div class="hint">ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­ØµØµ: <span class="mono">${escapeHtml(ss||"â€”")}</span></div>
    <div class="hr"></div>
    <table>
      <thead><tr><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>
      <tbody>
        <tr><td>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td><td class="mono">${t.sub}</td></tr>
        <tr><td>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚</td><td class="mono">${t.prev}</td></tr>
        <tr><td><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</b></td><td class="mono"><b>${t.total}</b></td></tr>
        <tr><td>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</td><td class="mono">${t.paid}</td></tr>
        <tr><td><b>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</b></td><td class="mono"><b>${t.remaining}</b></td></tr>
      </tbody>
    </table>
  `;
}
function renderAdLog(g,b,s){
  const wrap=document.getElementById("adLogList");
  wrap.innerHTML="";
  const logs=(b.logs||[]).filter(x=>x.scope==="student" && x.sid===s.id);
  if(!logs.length){
    wrap.innerHTML = `<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø¹Ø¯.</div>`;
    return;
  }
  logs.slice(0,80).forEach(x=>{
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <div class="left" style="min-width:0">
        <div class="num">ğŸ“Œ</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(x.action)} ${x.amount!==undefined?`<span class="badge">${escapeHtml(String(x.amount))}</span>`:""}</div>
          <div class="hint mono">${escapeHtml(logText(x))}</div>
        </div>
      </div>
    `;
    wrap.appendChild(row);
  });
}

function openAdminStudent(g,b,s){
  adCtx={g,b,s};
  adMode=null;
  document.getElementById("adAmountWrap").style.display="none";
  document.getElementById("adTitle").textContent = s.name;
  document.getElementById("adSub").textContent =
    `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${g.displayName || g.name} â€¢ Ø­ØµØµ: ${sessionsCount(b)}/${cycleLen(g)} â€¢ Ø§Ù„Ø¯ÙˆØ±Ø©: ${cycleStartLabel(b)} â†’ ${cycleEndLabel(g,b)}`;
  document.getElementById("adBadges").innerHTML = studentBadges(s) || `<span class="badge">â€”</span>`;

  renderAdNumbers(g,b,s);
  renderAdTable(g,b,s);
  renderAdLog(g,b,s);

  adOverlay.style.display="block";
}

document.getElementById("btnAdPayFull").onclick=()=>{
  if(!adCtx) return;
  const {g,b,s}=adCtx;
  const t=totals(g,b,s);
  if(t.remaining<=0){ toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¨Ù‚ÙŠ"); return; }
  setPaidValue(g,b,s,t.total, b.notes?.[s.id] || "");
  addLog(g,b,{scope:"student", sid:s.id, action:"Ø¯ÙØ¹ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ", amount:t.remaining});
  saveDB(); toast("ØªÙ… Ø§Ù„Ø¯ÙØ¹"); renderAll(); openAdminStudent(g,b,s);
};

document.getElementById("btnAdAdd").onclick=()=>{
  adMode="add";
  document.getElementById("adAmountWrap").style.display="";
  document.getElementById("adAmountLabel").textContent="Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº Ù„Ù„Ù…Ø¯ÙÙˆØ¹";
  document.getElementById("adAmount").value="";
  document.getElementById("adAmount").focus();
};
document.getElementById("btnAdMinus").onclick=()=>{
  adMode="minus";
  document.getElementById("adAmountWrap").style.display="";
  document.getElementById("adAmountLabel").textContent="Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (ØªØµØ­ÙŠØ­)";
  document.getElementById("adAmount").value="";
  document.getElementById("adAmount").focus();
};
document.getElementById("btnAdSet").onclick=()=>{
  adMode="set";
  document.getElementById("adAmountWrap").style.display="";
  document.getElementById("adAmountLabel").textContent="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ø¨Ø§Ø´Ø±Ø© (Set Paid)";
  document.getElementById("adAmount").value="";
  document.getElementById("adAmount").focus();
};

document.getElementById("btnAdApply").onclick=()=>{
  if(!adCtx || !adMode) return;
  const {g,b,s}=adCtx;
  const v=Number(document.getElementById("adAmount").value||0);
  if(!(v>=0)) return alert("Ø§ÙƒØªØ¨ Ø±Ù‚Ù… ØµØ­ÙŠØ­");

  if(adMode==="add"){
    addPayment(g,b,s,v,"");
    toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
  }else if(adMode==="minus"){
    minusPayment(g,b,s,v,"");
    toast("ØªÙ… Ø§Ù„Ø®ØµÙ…");
  }else{
    setPaidValue(g,b,s,v,"");
    toast("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹");
  }

  saveDB();
  adMode=null;
  document.getElementById("adAmountWrap").style.display="none";
  renderAll();
  openAdminStudent(g,b,s);
};

document.getElementById("btnExportLog").onclick=()=>{
  if(!adCtx) return;
  const {g,b,s}=adCtx;
  const logs=(b.logs||[]).filter(x=>x.scope==="student" && x.sid===s.id);
  const data = JSON.stringify({student:s.name, group:g.name, logs}, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `Hedra_Log_${s.name}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
  toast("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„");
};

/* ---------- Group Log Modal ---------- */
const glOverlay=document.getElementById("glOverlay");
document.getElementById("btnGlClose").onclick=()=>glOverlay.style.display="none";
glOverlay.addEventListener("click",(e)=>{ if(e.target===glOverlay) glOverlay.style.display="none"; });

document.getElementById("btnGroupLog").onclick=()=>{
  const gid=adminGroupSelect.value||"";
  const g=getGroupById(gid);
  const b=g?curBlock(g):null;
  if(!g || !b){ toast("Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø©"); return; }

  document.getElementById("glSub").textContent =
    `${g.displayName || g.name} â€¢ Ø­ØµØµ: ${sessionsCount(b)}/${cycleLen(g)} â€¢ Ø§Ù„Ø¯ÙˆØ±Ø©: ${cycleStartLabel(b)} â†’ ${cycleEndLabel(g,b)}`;

  const wrap=document.getElementById("glList");
  wrap.innerHTML="";
  const logs=(b.logs||[]).filter(x=>x.scope==="group");
  if(!logs.length){
    wrap.innerHTML = `<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ø¹Ø¯.</div>`;
  }else{
    logs.slice(0,120).forEach(x=>{
      const row=document.createElement("div");
      row.className="row";
      row.innerHTML=`
        <div class="left" style="min-width:0">
          <div class="num">ğŸ“Œ</div>
          <div style="min-width:0">
            <div class="name">${escapeHtml(x.action)} ${x.amount!==undefined?`<span class="badge">${escapeHtml(String(x.amount))}</span>`:""}</div>
            <div class="hint mono">${escapeHtml(logText(x))}</div>
          </div>
        </div>
      `;
      wrap.appendChild(row);
    });
  }

  glOverlay.style.display="block";
};

/* ---------- Settings: Groups & Students ---------- */
const groupsList=document.getElementById("groupsList");
const editor=document.getElementById("settingsGroupEditor");
let editGroupId=null;

document.getElementById("btnAddGroup").onclick=()=>{
  const name=(prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©")||"").trim();
  if(!name) return;
  if(db.groups.some(x=>x.name.trim().toLowerCase()===name.toLowerCase())) return alert("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©");

  db.groups.push({
    id: uid("g"),
    name,
    displayName:"",
    price: 200,
    cycleLen: 8,
    students: [],
    blocks: [ newBlock() ]
  });
  saveDB();
  toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©");
  renderAll();
};

document.getElementById("btnReset").onclick=()=>{
  // âœ… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯ ÙŠØ·Ù„Ø¨ Ø¨Ø§Ø³ÙˆØ±Ø¯
  if(!pinCheckOrSetup()) return;
  const ok=confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯. Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ");
  if(!ok) return;
  localStorage.removeItem(DB_KEY);
  toast("ØªÙ… Ø§Ù„Ù…Ø³Ø­");
  location.reload();
};

document.getElementById("btnCloseGroupEditor").onclick=()=>{
  editor.style.display="none";
  editGroupId=null;
};

document.getElementById("btnSaveGroup").onclick=()=>{
  const g=getGroupById(editGroupId);
  if(!g) return;

  const n=(document.getElementById("editGroupName").value||"").trim();
  if(!n) return alert("Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©");
  if(db.groups.some(x=>x.id!==g.id && x.name.trim().toLowerCase()===n.toLowerCase())) return alert("Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙˆØ¬ÙˆØ¯");

  g.name=n;
  g.displayName=(document.getElementById("editGroupDisplayName").value||"").trim();
  g.price=Number(document.getElementById("editPriceCycle").value||0);
  g.cycleLen=Number(document.getElementById("editCycleLen").value||8);

  saveDB();
  toast("ØªÙ… Ø§Ù„Ø­ÙØ¸");
  renderAll();
};

document.getElementById("btnNewCycle").onclick=()=>{
  const g=getGroupById(editGroupId);
  if(!g) return;
  const b=curBlock(g);

  const ok=confirm("ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ Ø³ÙŠØªÙ… ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ/Ø§Ù„Ø±ØµÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.");
  if(!ok) return;

  const carryMap={};
  g.students.forEach(s=>{
    const t=totals(g,b,s);
    if(Math.abs(t.remaining)>0.0001) carryMap[s.id]=t.remaining;
  });

  b.closed=true;

  const nb=newBlock();
  nb.carry=carryMap;
  addLog(g,nb,{scope:"group", action:"ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©", meta:"ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯/Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª"});
  g.blocks.push(nb);

  saveDB();
  toast("ØªÙ… ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©");
  renderAll();
};

document.getElementById("btnDeleteGroup").onclick=()=>{
  const g=getGroupById(editGroupId);
  if(!g) return;
  const ok=confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§ØŸ");
  if(!ok) return;
  db.groups=db.groups.filter(x=>x.id!==g.id);
  saveDB();
  toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©");
  editor.style.display="none";
  editGroupId=null;
  renderAll();
};

document.getElementById("btnAddStudent").onclick=()=>{
  const g=getGroupById(editGroupId);
  if(!g) return;
  const name=(document.getElementById("newStudentName").value||"").trim();
  if(!name) return;
  if(g.students.some(s=>s.name.trim().toLowerCase()===name.toLowerCase())) return alert("Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯");

  g.students.push({ id:uid("s"), name, paused:false, discountType:"none", discountValue:0 });
  document.getElementById("newStudentName").value="";
  saveDB();
  toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨");
  renderAll();
};

/* Student editor modal reuse: quick edit via prompt (Ø®ÙÙŠÙØ©) */
function editStudent(g,s){
  const newName = (prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨", s.name) || "").trim();
  if(!newName) return;
  if(g.students.some(x=>x.id!==s.id && x.name.trim().toLowerCase()===newName.toLowerCase())) return alert("Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯");

  const type = prompt("Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø©: none / fixed / percent / exempt / paused\nØ§ÙƒØªØ¨: none Ø£Ùˆ fixed Ø£Ùˆ percent Ø£Ùˆ exempt Ø£Ùˆ paused", s.paused ? "paused" : (s.discountType||"none"));
  if(type === null) return;

  if(type==="paused"){
    s.paused=true;
    s.discountType="none";
    s.discountValue=0;
  }else{
    s.paused=false;
    s.discountType = ["none","fixed","percent","exempt"].includes(type) ? type : "none";
    if(s.discountType==="fixed" || s.discountType==="percent"){
      const v = Number(prompt("Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…", String(s.discountValue||0))||0);
      s.discountValue = Number.isFinite(v) ? v : 0;
    }else{
      s.discountValue=0;
    }
  }

  saveDB();
  toast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ø§Ù„Ø¨");
  renderAll();
}

function openGroupEditor(gid){
  const g=getGroupById(gid);
  if(!g) return;
  editGroupId=gid;

  document.getElementById("editGroupTitle").textContent = `ØªØ¹Ø¯ÙŠÙ„: ${g.name}`;
  document.getElementById("editGroupName").value = g.name || "";
  document.getElementById("editGroupDisplayName").value = g.displayName || "";
  document.getElementById("editPriceCycle").value = g.price || 0;
  document.getElementById("editCycleLen").value = String(g.cycleLen||8);

  editor.style.display="";
  renderStudentsListSettings();
}

function renderGroupsList(){
  groupsList.innerHTML="";
  db.groups.forEach(g=>{
    const b=curBlock(g);
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <div class="left" style="min-width:0">
        <div class="num">ğŸ‘¥</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(g.name)}</div>
          <div class="hint mono">Ø·Ù„Ø§Ø¨: ${g.students.length} â€¢ Ø­ØµØµ: ${sessionsCount(b)}/${cycleLen(g)} â€¢ Ø³Ø¹Ø±: ${g.price||0}</div>
        </div>
      </div>
      <div><button class="moreBtn">ØªØ¹Ø¯ÙŠÙ„</button></div>
    `;
    row.querySelector("button").onclick=()=>openGroupEditor(g.id);
    groupsList.appendChild(row);
  });
}

function renderStudentsListSettings(){
  const wrap=document.getElementById("studentsList");
  wrap.innerHTML="";
  const g=getGroupById(editGroupId);
  if(!g){ wrap.innerHTML=`<div class="hint">â€”</div>`; return; }
  if(!g.students.length){ wrap.innerHTML=`<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨.</div>`; return; }

  const list=[...g.students].sort((a,b)=>a.name.localeCompare(b.name,"ar"));
  list.forEach(s=>{
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <div class="left" style="min-width:0">
        <div class="num">ğŸ‘¤</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(s.name)} <span class="metaSmall">${escapeHtml(studentSpecialLabel(s))}</span></div>
          <div class="hint">${studentBadges(s) || "â€”"}</div>
        </div>
      </div>
      <div style="display:flex; gap:8px">
        <button class="moreBtn">â‹¯</button>
      </div>
    `;
    row.querySelector("button").onclick=()=>editStudent(g,s);
    wrap.appendChild(row);
  });
}

/* ---------- Change PIN ---------- */
document.getElementById("btnChangePin").onclick=()=>{
  const existing=getPIN();
  if(existing){
    const entered = prompt("Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ");
    if(entered !== existing){ alert("ØºÙŠØ± ØµØ­ÙŠØ­"); return; }
  }
  const n = prompt("Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (4 Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ Ø£ÙƒØ«Ø±)");
  if(!n || n.trim().length < 4) return alert("Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­");
  setPIN(n.trim());
  toast("ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ");
};

/* ---------- Render All ---------- */
function renderAll(){
  ensureDefaults();

  if(!isUnlocked()){
    pages.splash.style.display="";
    pages.home.style.display="none";
    pages.admin.style.display="none";
    pages.settings.style.display="none";
    return;
  }

  refreshHomeGroupSelect();
  renderHomeHeader();
  renderHomeStudents();

  refreshAdminGroupSelect();
  renderAdmin();

  renderGroupsList();
  if(editor.style.display!=="none"){
    renderStudentsListSettings();
  }
}

/* ---------- Init ---------- */
(function init(){
  loadDB();
  ensureDefaults();

  // Ù„Ø§ Ù†ØªØ°ÙƒØ± Ø¢Ø®Ø± Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
  if(!isUnlocked()){
    setSessionGroup("");
  }

  showTab(isUnlocked() ? "home" : "splash");
  renderAll();
})();

/* ---------- PWA Install ---------- */
let deferredPrompt=null;
window.addEventListener("beforeinstallprompt",(e)=>{
  e.preventDefault();
  deferredPrompt=e;
  document.getElementById("btnInstall").style.display="inline-flex";
});
document.getElementById("btnInstall").onclick=async ()=>{
  if(!deferredPrompt){
    alert("Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­: Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â‹® Ø«Ù… (Install) Ø£Ùˆ (Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)");
    return;
  }
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt=null;
  document.getElementById("btnInstall").style.display="none";
};

/* ---------- Service Worker ---------- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
