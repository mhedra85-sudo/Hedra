<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hedra v5.0</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0A2A66">
  <link rel="icon" href="icon.png">

  <style>
    :root{
      --royal:#0A2A66;
      --royal2:#091F4A;
      --bg:#061226;
      --soft:#EAF2FF;
      --paper:#ffffff;
      --ink:#0b1220;
      --muted:#334155;
      --line:rgba(2,6,23,.12);
      --shadow:0 20px 50px rgba(2,6,23,.28);
      --shadow2:0 12px 28px rgba(2,6,23,.18);
      --r:22px;

      --btnGrad: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.06));
      --btnGrad2: linear-gradient(180deg, rgba(255,255,255,.26), rgba(255,255,255,.10));
      --btn3d: 0 10px 0 rgba(0,0,0,.22), 0 18px 40px rgba(0,0,0,.24);
    }

    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial}
    body{
      margin:0; color:#fff;
      background:
        radial-gradient(1000px 620px at 85% -10%, rgba(10,42,102,.45), transparent 65%),
        radial-gradient(1000px 620px at -10% 10%, rgba(10,42,102,.28), transparent 65%),
        linear-gradient(180deg, var(--bg), var(--bg));
      min-height:100vh;
    }

    /* ---------- Top Sticky ---------- */
    .top{
      position:sticky; top:0; z-index:50;
      background: rgba(6,18,38,.84);
      backdrop-filter: blur(12px);
      border-bottom:1px solid rgba(255,255,255,.12);
      padding:14px 14px 12px;
    }
    .top .wrap{
      max-width:1060px; margin:0 auto;
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:50px; height:50px; border-radius:18px;
      background: linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.22);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      display:grid; place-items:center;
      font-weight:1000; letter-spacing:.8px;
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.25), transparent 55%);
      transform: rotate(20deg);
    }
    .ttl{font-weight:1000; font-size:18px; line-height:1.1}
    .dateBig{font-weight:1000; font-size:15px; opacity:.95; margin-top:4px}
    .subline{opacity:.92; font-size:13px; margin-top:6px; display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}

    /* ---------- Buttons (3D) ---------- */
    .btn{
      border:1px solid rgba(255,255,255,.20);
      background: var(--btnGrad);
      color:#fff;
      border-radius:18px;
      padding:12px 14px;
      min-height:46px;
      font-weight:1000;
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      transition: transform .08s ease, filter .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      box-shadow: 0 10px 0 rgba(0,0,0,.18);
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.06); border-color:rgba(255,255,255,.30)}
    .btn:active{transform:translateY(2px); box-shadow: 0 6px 0 rgba(0,0,0,.16)}
    .btn.small{min-height:42px; border-radius:16px; font-size:13px; padding:10px 12px}
    .btn.royal{background: linear-gradient(180deg, rgba(10,42,102,.70), rgba(10,42,102,.32)); border-color:rgba(255,255,255,.26)}
    .btn.ghost{background: transparent; box-shadow:none}
    .btn.light{background: var(--btnGrad2); border-color: rgba(255,255,255,.26)}
    .btn.danger{background: linear-gradient(180deg, rgba(215,38,56,.65), rgba(215,38,56,.28)); border-color:rgba(255,255,255,.22)}

    .ico{
      width:22px; height:22px;
      display:inline-grid; place-items:center;
      border-radius:10px;
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.20);
      box-shadow: 0 6px 0 rgba(0,0,0,.14);
      font-size:14px;
    }

    /* ---------- Page ---------- */
    .page{max-width:1060px; margin:0 auto; padding:14px 14px 112px}
    .card{
      background: rgba(255,255,255,.96);
      color:var(--ink);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .hr{height:1px; background:rgba(2,6,23,.10); margin:12px 0}
    .hint{color:var(--muted); font-size:12px; line-height:1.8}
    .titleRow{display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap}

    /* ---------- Tabs ---------- */
    .bottom{
      position:fixed; left:0; right:0; bottom:0; z-index:60;
      background: rgba(6,18,38,.84);
      backdrop-filter: blur(12px);
      border-top:1px solid rgba(255,255,255,.12);
      padding:10px 12px;
    }
    .bottom .wrap{max-width:1060px; margin:0 auto; display:flex; gap:10px}
    .tab{
      flex:1; min-height:56px; border-radius:18px;
      border:1px solid rgba(255,255,255,.20);
      background: var(--btnGrad);
      color:#fff; font-weight:1000; cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:10px;
      user-select:none;
      box-shadow: 0 10px 0 rgba(0,0,0,.18);
      transition: transform .08s ease, filter .12s ease, border-color .12s ease;
    }
    .tab:hover{transform:translateY(-1px); filter:brightness(1.05); border-color:rgba(255,255,255,.28)}
    .tab:active{transform:translateY(2px); box-shadow: 0 6px 0 rgba(0,0,0,.16)}
    .tab.active{
      background: linear-gradient(180deg, rgba(10,42,102,.70), rgba(10,42,102,.30));
      border-color: rgba(255,255,255,.30);
    }

    /* ---------- Inputs (always dark text on light bg) ---------- */
    label{display:block; font-weight:1000; font-size:13px; margin:10px 0 6px}
    input,select,textarea{
      width:100%;
      min-height:48px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(2,6,23,.14);
      outline:none;
      font-size:15px;
      background:#fff;
      color:var(--ink);
      box-shadow: var(--shadow2);
    }
    textarea{min-height:92px; resize:vertical}
    input:focus,select:focus,textarea:focus{border-color: rgba(10,42,102,.55)}
    .rowWrap{display:flex; gap:10px; flex-wrap:wrap}
    .rowWrap > *{flex:1; min-width:220px}

    /* ---------- List ---------- */
    .list{display:flex; flex-direction:column; gap:10px}
    .row{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:12px;
      border-radius:20px;
      border:1px solid rgba(2,6,23,.12);
      background:#fff;
      box-shadow: var(--shadow2);
    }
    .left{display:flex; align-items:center; gap:12px; min-width:0}
    .num{
      width:40px; height:40px; border-radius:16px;
      background: rgba(10,42,102,.10);
      border:1px solid rgba(10,42,102,.22);
      display:grid; place-items:center;
      font-weight:1000; color:var(--royal);
      flex:0 0 auto;
      box-shadow: 0 8px 0 rgba(0,0,0,.10);
    }
    .name{font-weight:1000; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .mini{font-size:12px; color:var(--muted); margin-top:4px}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(2,6,23,.12);
      background:rgba(10,42,102,.06);
      color:var(--royal);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }
    .badge.warn{
      background: rgba(215,38,56,.08);
      color: #b91c1c;
      border-color: rgba(215,38,56,.22);
    }

    /* ---------- Action Buttons ---------- */
    .moreBtn{
      width:52px; min-height:48px;
      border-radius:18px;
      border:1px solid rgba(2,6,23,.12);
      background:#fff;
      color:var(--ink);
      font-weight:1100;
      cursor:pointer;
      box-shadow: 0 10px 0 rgba(0,0,0,.12);
      transition: transform .08s ease, filter .12s ease;
    }
    .moreBtn:hover{transform:translateY(-1px); filter:brightness(1.03)}
    .moreBtn:active{transform:translateY(2px); box-shadow: 0 6px 0 rgba(0,0,0,.10)}

    /* ---------- Modal ---------- */
    .overlay{
      position:fixed; inset:0; z-index:90;
      background: rgba(2,6,23,.62);
      display:none;
      padding:14px;
    }
    .modal{
      max-width:720px;
      margin:5vh auto;
      background:#fff;
      color:var(--ink);
      border:1px solid rgba(2,6,23,.12);
      border-radius:24px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modal h3{margin:0 0 6px; font-size:16px}
    .modal .topline{display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap}
    .modal .actions{display:flex; gap:10px; flex-wrap:wrap}

    /* ---------- Attendance ---------- */
    .attGrid{display:grid; gap:8px}
    .attItem{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      border:1px solid rgba(2,6,23,.12);
      border-radius:16px;
      padding:10px 12px;
      box-shadow: var(--shadow2);
      background:#fff;
    }
    .attBtn{
      min-width:120px;
      border-radius:14px;
      border:1px solid rgba(2,6,23,.14);
      background:#fff;
      font-weight:1000;
      cursor:pointer;
      padding:10px 12px;
      box-shadow: 0 10px 0 rgba(0,0,0,.10);
      transition: transform .08s ease, filter .12s ease;
    }
    .attBtn:hover{transform:translateY(-1px); filter:brightness(1.02)}
    .attBtn:active{transform:translateY(2px); box-shadow: 0 6px 0 rgba(0,0,0,.08)}
    .attP{background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.25); color:#166534}
    .attA{background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.25); color:#991b1b}

    /* ---------- Tables ---------- */
    table{width:100%; border-collapse:separate; border-spacing:0 10px}
    th{font-size:12px; color:var(--muted); text-align:right; padding:0 8px}
    td{
      background:#fff;
      border:1px solid rgba(2,6,23,.12);
      padding:10px 10px;
      border-radius:14px;
      color:var(--ink);
    }

    /* ---------- Toast ---------- */
    .toast{
      position:fixed; left:12px; bottom:88px; z-index:110;
      background: rgba(255,255,255,.96);
      color:var(--ink);
      border:1px solid rgba(2,6,23,.12);
      box-shadow: var(--shadow);
      padding:10px 12px;
      border-radius:16px;
      font-weight:1000;
      display:none;
      max-width:92vw;
    }


    /* ---------- Splash / Lock ---------- */
    .splashIcon{
      width:120px; height:120px; border-radius:36px;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.28), rgba(255,255,255,.06) 60%),
                  linear-gradient(180deg, rgba(10,42,102,.85), rgba(10,42,102,.28));
      border:1px solid rgba(255,255,255,.22);
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      display:grid; place-items:center;
      position:relative;
      transform-style:preserve-3d;
      animation: spinH 1.6s ease-in-out infinite;
      overflow:hidden;
    }
    .splashIcon::after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.35), transparent 55%);
      transform: rotate(18deg);
      pointer-events:none;
    }
    .splashH{
      font-weight:1100; font-size:62px; color:#fff;
      text-shadow: 0 12px 30px rgba(0,0,0,.35);
      transform: translateZ(18px);
    }
    @keyframes spinH{
      0%{transform: rotateY(0deg) rotateX(0deg)}
      45%{transform: rotateY(180deg) rotateX(8deg)}
      100%{transform: rotateY(360deg) rotateX(0deg)}
    }
    .pinDots{display:flex; justify-content:center; gap:10px; margin:8px 0 14px}
    .dot{
      width:12px;height:12px;border-radius:999px;
      background: rgba(2,6,23,.14);
      border:1px solid rgba(2,6,23,.20);
      box-shadow: 0 6px 0 rgba(0,0,0,.10);
    }
    .dot.filled{background: rgba(10,42,102,.85); border-color: rgba(10,42,102,.30)}
    .pinPad{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .pinKey{
      min-height:54px;
      border-radius:18px;
      border:1px solid rgba(2,6,23,.12);
      background:#fff;
      box-shadow: 0 10px 0 rgba(0,0,0,.10);
      font-weight:1100;
      cursor:pointer;
      transition: transform .08s ease, filter .12s ease;
    }
    .pinKey:hover{transform:translateY(-1px); filter:brightness(1.02)}
    .pinKey:active{transform:translateY(2px); box-shadow: 0 6px 0 rgba(0,0,0,.08)}


    /* ---------- Print ---------- */
    @media print{
      body{background:#fff;color:#000}
      .top,.bottom,.noPrint{display:none !important}
      .page{padding:0}
      .card{box-shadow:none;border:1px solid #ddd}
    }
  </style>
</head>

<body>
  <!-- TOP -->
  <div class="top">
    <div class="wrap">
      <div class="brand">
        <div class="logo">H</div>
        <div>
          <div class="ttl">Hedra</div>
          <div class="dateBig" id="topDateBig">â€”</div>
          <div class="subline">
            <span class="badge mono" id="topSessionInfo">Ø§Ù„Ø­ØµØ©: â€” / â€”</span>
            <span class="badge mono" id="topCycleInfo">Ø§Ù„Ø¯ÙˆØ±Ø©: â€” â†’ â€”</span>
          </div>
        </div>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end">
        <button class="btn small light noPrint" id="btnInstall" style="display:none"><span class="ico">â¬‡</span> ØªØ­Ù…ÙŠÙ„</button>
        <button class="btn small ghost noPrint" id="btnExport"><span class="ico">â¬†</span> ØªØµØ¯ÙŠØ±</button>
        <button class="btn small ghost noPrint" id="btnImport"><span class="ico">â¬‡</span> Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
      </div>
    </div>
  </div>

  <div class="page">

    <!-- RUN (Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) -->
    <section id="pageRun">
      <div class="card">

        <div class="titleRow">
          <div style="min-width:260px;flex:1">
            <div style="font-weight:1000;font-size:16px">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
            <div class="hint"></div>
          </div>

          <div class="rowWrap" style="justify-content:flex-end; flex:1">
            <button class="btn small royal noPrint" id="btnAddSession"><span class="ico">ï¼‹</span> Ø¥Ø¶Ø§ÙØ© Ø­ØµØ©</button>
            <button class="btn small danger noPrint" id="btnRemoveSession"><span class="ico">âˆ’</span> Ø­Ø°Ù Ø­ØµØ©</button>
          </div>
        </div>

        <div class="hr"></div>

        <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
        <select id="selGroupRun"></select>

        <div class="hr"></div>

        <div class="list" id="runList"></div>
      </div>
    </section>

    <!-- MANAGE (Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©) -->
    <section id="pageManage" style="display:none">
      <div class="card">
        <div class="titleRow">
          <div>
            <div style="font-weight:1000;font-size:16px">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
            <div class="hint" id="manageSub">â€”</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
            <button class="btn small royal noPrint" id="btnBulkSessions"><span class="ico">ğŸ“¥</span> Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</button>
            <button class="btn small ghost noPrint" id="btnSessionsLog"><span class="ico">ğŸ—“</span> Ø³Ø¬Ù„ Ø§Ù„Ø­ØµØµ</button>
            <button class="btn small ghost noPrint" id="btnMonthly"><span class="ico">ğŸ“Š</span> ØªÙ‚Ø§Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠØ©</button>
          </div>
        </div>

        <div class="hr"></div>

        <label>Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… (ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª)</label>
        <input id="qManage" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." />

        <div class="hr"></div>

        <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©)</label>
        <select id="selGroupManage"></select>

        <div class="hr"></div>

        <div id="groupSummary" class="rowWrap"></div>

        <div class="hr"></div>
        <div class="list" id="manageList"></div>
      </div>
    </section>


    <!-- DASHBOARD (Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…) -->
    <section id="pageDashboard" style="display:none">
      <div class="card">
        <div class="titleRow">
          <div>
            <div style="font-weight:1000;font-size:16px">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
            <div class="hint">Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹ Ù„Ù„Ø£Ø¯Ø§Ø¡ + Ø§Ù„ØªØ­ØµÙŠÙ„ + Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ.</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
            <button class="btn small ghost noPrint" id="btnDashPrint"><span class="ico">ğŸ–¨</span> Ø·Ø¨Ø§Ø¹Ø©</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="rowWrap" id="dashCards"></div>

        <div class="hr"></div>

        <div style="font-weight:1000">Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ù…Ù† Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¯ÙØ¹)</div>
        <div class="hint">ÙŠÙ…ÙƒÙ†Ùƒ ÙØªØ­ â€œØªÙ‚Ø§Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠØ©â€ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø£ÙŠØ¶Ù‹Ø§.</div>
        <div class="hr"></div>
        <div id="dashMonthWrap"></div>

        <div class="hr"></div>
        <div style="font-weight:1000">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</div>
        <div class="hint">Ø·Ù„Ø§Ø¨ Ù…ØªØ£Ø®Ø±ÙŠÙ† ÙÙŠ Ø§Ù„Ø³Ø¯Ø§Ø¯ (Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ).</div>
        <div class="hr"></div>
        <div class="list" id="dashAlerts"></div>
      </div>
    </section>


    <!-- SETTINGS (Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª) -->
    <section id="pageSettings" style="display:none">
      <div class="card">
        <div class="titleRow">
          <div>
            <div style="font-weight:1000;font-size:16px">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
            <div class="hint">Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù…ÙˆØ¹Ø§Øª + Ø·Ù„Ø§Ø¨ + Ø£Ø³Ø¹Ø§Ø± Ù„Ù„Ø·Ù„Ø§Ø¨ + Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
            <button class="btn small royal noPrint" id="btnAddGroup"><span class="ico">ï¼‹</span> Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
            <button class="btn small ghost noPrint" id="btnChangePIN"><span class="ico">ğŸ”’</span> ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ</button>
            <button class="btn small danger noPrint" id="btnReset"><span class="ico">ğŸ—‘</span> Ø¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯</button>
          </div>
        </div>

        <div class="hr"></div>

        <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
        <select id="selGroupSettings"></select>

        <div class="hr"></div>

        <div class="rowWrap">
          <div>
            <label>Ù…Ø¯Ø© Ø§Ù„Ø¯ÙˆØ±Ø© (Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ)</label>
            <select id="cycleLen">
              <option value="4">4 Ø­ØµØµ</option>
              <option value="8" selected>8 Ø­ØµØµ</option>
              <option value="12">12 Ø­ØµØ©</option>
            </select>
          </div>
          <div>
            <label>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label>
            <select id="chargeMode">
              <option value="perSessions" selected>Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ</option>
              <option value="byAttendance">Ø­Ø³Ø¨ Ø§Ù„Ø­Ø¶ÙˆØ±/Ø§Ù„ØºÙŠØ§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</option>
            </select>
          </div>
        </div>

        <div class="rowWrap">
          <div>
            <label>Ù‚ÙÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 10 Ø¯Ù‚Ø§Ø¦Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <select id="autoLock">
              <option value="off" selected>Ø¥ÙŠÙ‚Ø§Ù</option>
              <option value="on">ØªØ´ØºÙŠÙ„</option>
            </select>
          </div>
          <div>
            <label>ØªØ¬Ø¯ÙŠØ¯ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</label>
            <button class="btn small royal noPrint" id="btnNewCycle"><span class="ico">ğŸ”</span> ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            <div class="hint">ÙŠÙØ±Ø­Ù‘Ù„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ/Ø§Ù„Ø²ÙŠØ§Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.</div>
          </div>
        </div>

        <div class="hr"></div>

        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-end; flex-wrap:wrap">
          <div>
            <div style="font-weight:1000">Ø§Ù„Ø·Ù„Ø§Ø¨</div>
            <div class="hint">Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆØ±Ø© Ù„Ù„Ø·Ø§Ù„Ø¨ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 0 (Ø­Ø¯Ø¯ÙŠÙ‡ Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨)</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <input id="newStudentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." style="min-width:220px"/>
            <button class="btn small royal noPrint" id="btnAddStudent"><span class="ico">ï¼‹</span> Ø¥Ø¶Ø§ÙØ©</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="list" id="studentsList"></div>
      </div>
    </section>

  </div>

  <!-- Tabs -->
  <div class="bottom noPrint">
    <div class="wrap">
      <button class="tab active" data-tab="run">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="tab" data-tab="manage">ğŸ§¾ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
      <button class="tab" data-tab="dashboard">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
      <button class="tab" data-tab="settings">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>
  </div>


  <!-- SPLASH / LOCK -->
  <div class="overlay" id="lockOverlay" style="display:block">
    <div class="modal" style="max-width:520px">
      <div style="display:flex; flex-direction:column; align-items:center; gap:12px; padding:8px 6px 2px">
        <div class="splashIcon" aria-hidden="true">
          <div class="splashH">H</div>
        </div>
        <div style="text-align:center">
          <div style="font-weight:1000; font-size:20px; letter-spacing:.4px">Hedra</div>
          <div class="hint" id="lockHint">Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù„ÙØªØ­ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="pinDots" id="pinDots"></div>

      <div class="pinPad" id="pinPad"></div>

      <div class="hr"></div>

      <div class="rowWrap noPrint">
        <button class="btn small ghost" id="btnLockRoleAdmin">Ù…Ø¯ÙŠØ±</button>
        <button class="btn small ghost" id="btnLockRoleAssistant">Ù…Ø³Ø§Ø¹Ø¯Ø©</button>
        <button class="btn small ghost" id="btnLockRoleView">Ø¹Ø±Ø¶ ÙÙ‚Ø·</button>
      </div>

      <div class="rowWrap noPrint" style="margin-top:10px">
        <button class="btn small royal" id="btnUnlock"><span class="ico">ğŸ”“</span> ÙØªØ­</button>
        <button class="btn small ghost" id="btnLockClear">Ù…Ø³Ø­</button>
      </div>

      <div class="hr"></div>
      <div class="hint">
        â€¢ ÙÙŠ ÙˆØ¶Ø¹ <b>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</b>: Ù„Ø§ ØªØ¸Ù‡Ø± Ù…Ø¨Ø§Ù„Øº/Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©.<br>
        â€¢ ÙÙŠ ÙˆØ¶Ø¹ <b>Ø¹Ø±Ø¶ ÙÙ‚Ø·</b>: Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„ (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·).<br>
        â€¢ Ù„Ùˆ Ù†Ø³ÙŠØªÙ Ø§Ù„Ø±Ù‚Ù…: Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (ØªØµØ¯ÙŠØ±) â€” Ù„Ø°Ù„Ùƒ Ø§Ø­Ø±ØµÙŠ Ø¹Ù„Ù‰ Ø­ÙØ¸ Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®.
      </div>
    </div>
  </div>


  <div class="toast" id="toast"></div>

  <!-- MODALS -->

  <!-- Pay Modal -->
  <div class="overlay" id="payOverlay">
    <div class="modal">
      <div class="topline">
        <div>
          <h3 id="payTitle">â€”</h3>
          <div class="hint mono" id="paySub">â€”</div>
        </div>
        <div class="actions">
          <button class="btn small ghost noPrint" id="btnPayPrint"><span class="ico">ğŸ–¨</span> Ø·Ø¨Ø§Ø¹Ø© PDF</button>
          <button class="btn small ghost noPrint" id="btnPayClose">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

      <div class="hr"></div>

      <div id="payTableWrap"></div>

      <div class="hr"></div>

      <div class="rowWrap noPrint">
        <button class="btn small royal" id="btnPaySet"><span class="ico">âœ</span> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ù‚ÙŠÙ…Ø© Ø¯Ù‚ÙŠÙ‚Ø©)</button>
        <button class="btn small ghost" id="btnPayAdd"><span class="ico">ï¼‹</span> Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº</button>
        <button class="btn small ghost" id="btnPayMinus"><span class="ico">âˆ’</span> Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹</button>
      </div>

      <div id="payAmountWrap" class="noPrint" style="display:none; margin-top:10px">
        <label id="payAmountLabel">Ø§Ù„Ù…Ø¨Ù„Øº</label>
        <input id="payAmount" type="number" step="1" placeholder="Ù…Ø«Ø§Ù„: 50"/>
        <button class="btn small royal" id="btnPayApply" style="margin-top:10px"><span class="ico">âœ…</span> ØªØ·Ø¨ÙŠÙ‚</button>
      </div>

      <div class="hr"></div>

      <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input id="payNote" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø¯Ø§Ø¯ Ù…ØªØ£Ø®Ø± / ..."/>

      <div class="rowWrap noPrint" style="margin-top:12px">
        <button class="btn small royal" id="btnPaySaveNote"><span class="ico">ğŸ’¾</span> Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
      </div>

      <div class="hr"></div>

      <div style="font-weight:1000">Ø§Ù„Ø­Ø¶ÙˆØ± / Ø§Ù„ØºÙŠØ§Ø¨</div>
      <div class="hint">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±/ØºÙŠØ§Ø¨ Ù„ÙƒÙ„ Ø­ØµØ© (ÙˆØªÙ‚Ø¯Ø± ØªØ¶ÙŠÙ Ø­ØµØµ Ø¨ØªØ§Ø±ÙŠØ® Ù‚Ø¯ÙŠÙ… Ù…Ù† â€œØ¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø§Ø¨Ù‚Ø©â€).</div>
      <div class="hr"></div>
      <div id="attWrap" class="attGrid"></div>
    </div>
  </div>

  <!-- Student Settings Modal -->
  <div class="overlay" id="stOverlay">
    <div class="modal">
      <div class="topline">
        <div>
          <h3 id="stTitle">Ø·Ø§Ù„Ø¨</h3>
          <div class="hint">Ø§Ù„Ø­Ø§Ù„Ø© ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø· â€” Ù„Ø§ ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.</div>
        </div>
        <div class="actions">
          <button class="btn small ghost noPrint" id="btnStClose">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

      <div class="hr"></div>

      <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
      <input id="stName"/>

      <div class="rowWrap">
        <div>
          <label>Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆØ±Ø© Ù„Ù„Ø·Ø§Ù„Ø¨</label>
          <input id="stPrice" type="number" step="1" placeholder="Ù…Ø«Ø§Ù„: 0 / 200"/>
        </div>
        <div>
          <label>Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø·Ø§Ù„Ø¨</label>
          <select id="stPaused">
            <option value="no" selected>Ù„Ø§</option>
            <option value="yes">Ù†Ø¹Ù… (Ù„Ø§ ÙŠØªØ­Ø§Ø³Ø¨)</option>
          </select>
        </div>
      </div>

      <div class="rowWrap">
        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø®ØµÙ…</label>
          <select id="stDiscType">
            <option value="none">Ø¨Ø¯ÙˆÙ†</option>
            <option value="fixed">Ø®ØµÙ… Ù…Ø¨Ù„Øº</option>
            <option value="percent">Ø®ØµÙ… Ù†Ø³Ø¨Ø©</option>
            <option value="exempt">Ù…Ø¹ÙÙ‰</option>
          </select>
        </div>
        <div>
          <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…</label>
          <input id="stDiscVal" type="number" step="1" placeholder="Ù…Ø«Ø§Ù„: 50 Ø£Ùˆ 10%"/>
        </div>
      </div>

      <div class="hr"></div>
      <div class="rowWrap noPrint">
        <button class="btn small royal" id="btnStSave"><span class="ico">ğŸ’¾</span> Ø­ÙØ¸</button>
        <button class="btn small danger" id="btnStDelete"><span class="ico">ğŸ—‘</span> Ø­Ø°Ù</button>
      </div>
    </div>
  </div>

  <!-- Sessions Log Modal -->
  <div class="overlay" id="ssOverlay">
    <div class="modal">
      <div class="topline">
        <div>
          <h3>Ø³Ø¬Ù„ Ø§Ù„Ø­ØµØµ</h3>
          <div class="hint">ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­ØµØµ Ù„Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù…Ø±ØªØ¨Ø©).</div>
        </div>
        <div class="actions">
          <button class="btn small ghost noPrint" id="btnSsClose">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
      <div class="hr"></div>
      <div id="ssList" class="hint mono">â€”</div>
    </div>
  </div>

  <!-- Bulk Sessions Modal -->
  <div class="overlay" id="bulkOverlay">
    <div class="modal">
      <div class="topline">
        <div>
          <h3>ğŸ“¥ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</h3>
          <div class="hint">ÙŠÙˆÙ„Ù‘Ø¯ Ø­ØµØµ Ø¨ØªÙˆØ§Ø±ÙŠØ® Ù‚Ø¯ÙŠÙ…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ + ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±.</div>
        </div>
        <div class="actions">
          <button class="btn small ghost noPrint" id="btnBulkClose">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="rowWrap">
        <div>
          <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
          <input id="bulkFrom" type="date"/>
        </div>
        <div>
          <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
          <input id="bulkTo" type="date"/>
        </div>
      </div>

      <label>Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</label>
      <div class="rowWrap" style="gap:8px">
        <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" class="dow" value="0"> Ø§Ù„Ø£Ø­Ø¯</label>
        <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" class="dow" value="1"> Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</label>
        <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" class="dow" value="2"> Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</label>
        <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" class="dow" value="3"> Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</label>
        <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" class="dow" value="4"> Ø§Ù„Ø®Ù…ÙŠØ³</label>
        <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" class="dow" value="5"> Ø§Ù„Ø¬Ù…Ø¹Ø©</label>
        <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" class="dow" value="6"> Ø§Ù„Ø³Ø¨Øª</label>
      </div>

      <div class="hr"></div>

      <div class="rowWrap noPrint">
        <button class="btn small royal" id="btnBulkApply"><span class="ico">âœ…</span> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­ØµØµ</button>
      </div>
    </div>
  </div>

  <!-- Monthly Report Modal -->
  <div class="overlay" id="monthOverlay">
    <div class="modal">
      <div class="topline">
        <div>
          <h3>ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠØ© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</h3>
          <div class="hint">Ø¯Ø®Ù„/Ù…ØªØ¨Ù‚ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø± (Ù…Ù† Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¯ÙØ¹).</div>
        </div>
        <div class="actions">
          <button class="btn small ghost noPrint" id="btnMonthClose">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
      <div class="hr"></div>
      <div id="monthWrap"></div>
    </div>
  </div>

  <script>
/* =========================================================
   Hedra v4.2 Pro (Fresh Start)
   - Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙ‚Ø· + Ù†Ø§ÙØ°Ø© Ø¯ÙØ¹ ØªØ¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
   - Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© + Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª
   - Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø· ÙˆÙŠØ¨Ø­Ø« ÙÙŠ ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
   - Ù…Ø¯Ø© Ø§Ù„Ø¯ÙˆØ±Ø© = 4/8/12 (Ø¹Ø¯Ø¯ Ø­ØµØµ)
   - ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙˆØ±Ø© ÙŠØ¨Ø¯Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø£ÙˆÙ„ Ø­ØµØ©ØŒ ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù…Ø¯Ø©
   - Ø¥Ø¶Ø§ÙØ© Ø­ØµØ© Ø¨ØªØ§Ø±ÙŠØ® ÙŠØ¯ÙˆÙŠ + Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
   - Ø­Ø¶ÙˆØ±/ØºÙŠØ§Ø¨ Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨ Ù„ÙƒÙ„ Ø­ØµØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ø§Ù„Ø­Ø³Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø¶ÙˆØ±)
   - ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: Set/Add/Minus (ØªØµØ­ÙŠØ­ 1000 Ø¨Ø¯Ù„ 100 Ø¨Ø³Ù‡ÙˆÙ„Ø©)
   - ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ/Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
   - Ù‚ÙÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ 10 Ø¯Ù‚Ø§Ø¦Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) + Ø·Ù„Ø¨ PIN Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ÙƒÙ„ Ø¬Ù„Ø³Ø©
   - Ø¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯ ÙŠØ·Ù„Ø¨ PIN
   - Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± (Ù…ØªØµÙØ­ â†’ Save as PDF)
========================================================= */

const DB_KEY = "hedra_v50_pro_secure";

/* ---------- Security / Roles (Product-grade) ---------- */
const ROLE = { ADMIN:"admin", ASSISTANT:"assistant", VIEW:"view" };
let currentRole = ROLE.ADMIN;

// PIN is still stored locally (device-level). For a sellable product, next step is optional
// encrypted backup + multi-device cloud sync. (We keep export/import as device backup.)
function canEditSensitive(){
  return currentRole === ROLE.ADMIN;
}
function canEditAnything(){
  return currentRole !== ROLE.VIEW;
}

/* Lock screen keypad (no typing) */
let pinBuf = "";
function renderPinDots(){
  const dots = document.getElementById("pinDots");
  if(!dots) return;
  const needed = Math.max(4, (getPIN()||"").length || 4);
  dots.innerHTML = "";
  for(let i=0;i<needed;i++){
    const d=document.createElement("div");
    d.className = "dot" + (i < pinBuf.length ? " filled":"");
    dots.appendChild(d);
  }
}
function openLockScreen(msg){
  const o = document.getElementById("lockOverlay");
  if(!o) return;
  document.getElementById("lockHint").textContent = msg || "Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù„ÙØªØ­ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬";
  pinBuf="";
  renderPinDots();
  o.style.display="block";
}
function closeLockScreen(){
  const o = document.getElementById("lockOverlay");
  if(o) o.style.display="none";
}
function buildPinPad(){
  const pad = document.getElementById("pinPad");
  if(!pad) return;
  const keys = ["1","2","3","4","5","6","7","8","9","âŒ«","0","â†µ"];
  pad.innerHTML="";
  keys.forEach(k=>{
    const b=document.createElement("button");
    b.className="pinKey noPrint";
    b.type="button";
    b.textContent=k;
    b.onclick=()=>{
      if(k==="âŒ«"){ pinBuf = pinBuf.slice(0,-1); renderPinDots(); return; }
      if(k==="â†µ"){ tryUnlock(); return; }
      if(pinBuf.length>=12) return;
      pinBuf += k;
      renderPinDots();
    };
    pad.appendChild(b);
  });
}
function tryUnlock(){
  const existing = getPIN();
  if(!existing){
    // first run: set PIN with keypad (confirm once)
    if(pinBuf.length < 4){ toast("Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù„Ø§Ø²Ù… 4 Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ Ø£ÙƒØ«Ø±"); return; }
    setPIN(pinBuf);
    setUnlocked(true);
    closeLockScreen();
    toast("ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ");
    renderAll();
    return;
  }
  if(pinBuf === existing){
    setUnlocked(true);
    closeLockScreen();
    toast("ØªÙ… Ø§Ù„ÙØªØ­");
    renderAll();
    return;
  }
  pinBuf="";
  renderPinDots();
  toast("Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­");
}

// role buttons
function setRole(r){
  currentRole = r;
  const h = document.getElementById("lockHint");
  if(h){
    h.textContent = r===ROLE.ADMIN ? "Ù…Ø¯ÙŠØ±: ÙƒÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª" :
                    r===ROLE.ASSISTANT ? "Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø­Ø¶ÙˆØ± ÙÙ‚Ø· + Ø¨Ø¯ÙˆÙ† Ù…Ø¨Ø§Ù„Øº" :
                    "Ø¹Ø±Ø¶ ÙÙ‚Ø·: Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„";
  }
}


/* ---------- State ---------- */
let db = {
  settings: {
    currentGroupId: "",
    chargeMode: "perSessions", // perSessions | byAttendance
    autoLock: "off"
  },
  groups: []
};

function uid(p="id"){ return p+"_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16); }
function round2(n){ return Math.round((Number(n||0))*100)/100; }
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.style.display="none",2200);
}

function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function loadDB(){
  const raw = localStorage.getItem(DB_KEY);
  if(!raw) return;
  try{
    const p=JSON.parse(raw);
    if(p && typeof p==="object") db=p;
  }catch{}
}

/* ---------- Date helpers ---------- */
function todayText(){
  return new Date().toLocaleDateString("ar-EG",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
}
function isoYMD(d=new Date()){
  const x=new Date(d); x.setHours(0,0,0,0);
  return x.toISOString().slice(0,10);
}
function fmtDMY(isoOrYmd){
  const d=new Date(isoOrYmd);
  const dd=String(d.getDate()).padStart(2,"0");
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const yy=d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}
function fmtDateAR(tsISO){
  try{
    return new Date(tsISO).toLocaleDateString("ar-EG",{year:"numeric",month:"2-digit",day:"2-digit"});
  }catch{ return "â€”"; }
}
function ymdFromTs(tsISO){
  const d=new Date(tsISO);
  d.setHours(0,0,0,0);
  return d.toISOString().slice(0,10);
}

/* ---------- PIN (once per session) ---------- */
function getPIN(){ return localStorage.getItem("hedra_pin") || ""; }
function setPIN(v){ localStorage.setItem("hedra_pin", String(v||"").trim()); }
function isUnlocked(){
  const flag = sessionStorage.getItem("hedra_unlocked")==="1";
  return flag;
}
function setUnlocked(on){
  sessionStorage.setItem("hedra_unlocked", on?"1":"0");
  sessionStorage.setItem("hedra_last_active", String(Date.now()));
}
function requirePINOnce(){
  // Legacy prompt replaced by lock screen keypad.
  if(isUnlocked()) return true;
  openLockScreen("Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ");
  return false;
}
function touchActivity(){
  sessionStorage.setItem("hedra_last_active", String(Date.now()));
}

/* ---------- Auto Lock (10 minutes) ---------- */
function autoLockTick(){
  if(db.settings.autoLock !== "on") return;
  if(!isUnlocked()) return;
  const last = Number(sessionStorage.getItem("hedra_last_active")||0);
  const now = Date.now();
  if(last && now - last > 10*60*1000){
    setUnlocked(false);
    toast("ØªÙ… Ø§Ù„Ù‚ÙÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§");
    openLockScreen("ØªÙ… Ø§Ù„Ù‚ÙÙ„ â€” Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ");
  }
}
setInterval(autoLockTick, 4000);
["click","keydown","touchstart","mousemove"].forEach(ev=>{
  window.addEventListener(ev, ()=>touchActivity(), {passive:true});
});

/* ---------- Data model ---------- */
/*
group = {
  id, name,
  cycleLen:number,
  cycles:[ cycle ],
  students:[ student ]
}
cycle = {
  id,
  createdAtISO,
  sessions:[ {id, tsISO} ],
  attendance: { [sessionId]: { [sid]: "P"|"A"|"" } },
  txs:[ {id, sid, amount, tsISO, note} ],
  notes:{ [sid]: string },
  carry:{ [sid]: number }, // signed carry from previous cycle (+due/-credit)
  closed:boolean
}
student = { id, name, price:number, paused:boolean, discountType, discountValue }
*/

/* ---------- Logs (simple) ---------- */
function addLog(g, msg){
  if(!g.logs) g.logs=[];
  g.logs.push({ id:uid("log"), tsISO:new Date().toISOString(), msg });
  if(g.logs.length>500) g.logs.shift();
}

/* ---------- Ensure defaults ---------- */
function newCycle(){
  return {
    id: uid("c"),
    createdAtISO: new Date().toISOString(),
    sessions: [],
    attendance: {},
    txs: [],
    notes: {},
    carry: {},
    closed: false
  };
}

function ensureDefaults(){
  if(!db.settings) db.settings={ currentGroupId:"", chargeMode:"perSessions", autoLock:"off" };
  if(!Array.isArray(db.groups)) db.groups=[];
  db.groups.forEach(g=>{
    if(!g.id) g.id=uid("g");
    if(typeof g.name!=="string") g.name="Ù…Ø¬Ù…ÙˆØ¹Ø©";
    if(!g.cycleLen) g.cycleLen=8;
    if(!Array.isArray(g.students)) g.students=[];
    if(!Array.isArray(g.cycles) || g.cycles.length===0) g.cycles=[ newCycle() ];

    g.students.forEach(s=>{
      if(!s.id) s.id=uid("s");
      if(typeof s.name!=="string") s.name="Ø·Ø§Ù„Ø¨";
      if(typeof s.price!=="number") s.price=Number(s.price||0);
      if(typeof s.paused!=="boolean") s.paused=false;
      if(!s.discountType) s.discountType="none";
      if(typeof s.discountValue!=="number") s.discountValue=Number(s.discountValue||0);
    });

    g.cycles.forEach(c=>{
      if(!c.id) c.id=uid("c");
      if(!c.createdAtISO) c.createdAtISO=new Date().toISOString();
      if(!Array.isArray(c.sessions)) c.sessions=[];
      if(!c.attendance || typeof c.attendance!=="object") c.attendance={};
      if(!Array.isArray(c.txs)) c.txs=[];
      if(!c.notes || typeof c.notes!=="object") c.notes={};
      if(!c.carry || typeof c.carry!=="object") c.carry={};
      if(typeof c.closed!=="boolean") c.closed=false;
    });
  });

  if(!db.settings.currentGroupId && db.groups[0]) db.settings.currentGroupId=db.groups[0].id;

  if(db.groups.length===0){
    const g = {
      id: uid("g"),
      name: "Ù…Ø¬Ù…ÙˆØ¹Ø© 1",
      cycleLen: 8,
      students: [],
      cycles: [ newCycle() ],
      logs: []
    };
    db.groups=[g];
    db.settings.currentGroupId=g.id;
  }

  saveDB();
}

/* ---------- Current pointers ---------- */
function curGroup(){
  return db.groups.find(g=>g.id===db.settings.currentGroupId) || db.groups[0] || null;
}
function curCycle(g){
  if(!g) return null;
  return g.cycles[g.cycles.length-1] || null;
}
function cycleLen(g){ return Math.max(1, Number(g?.cycleLen||8)); }
function sessionsCount(c){ return (c?.sessions||[]).length; }

/* ---------- Cycle date range ---------- */
function cycleStartYMD(c){
  if(!c || !c.sessions.length) return "â€”";
  const min = c.sessions.map(s=>ymdFromTs(s.tsISO)).sort()[0];
  return fmtDMY(min);
}
function cycleEndYMD(g,c){
  if(!c || !c.sessions.length) return "â€”";
  if(sessionsCount(c) < cycleLen(g)) return "â€”";
  const max = c.sessions.map(s=>ymdFromTs(s.tsISO)).sort().slice(-1)[0];
  return fmtDMY(max);
}

/* ---------- Pricing / Due ---------- */
function effectiveCyclePrice(s){
  if(s.paused) return 0;
  const base = Math.max(0, Number(s.price||0));
  const t = s.discountType || "none";
  const v = Math.max(0, Number(s.discountValue||0));
  if(t==="exempt") return 0;
  if(t==="fixed") return Math.max(0, base - v);
  if(t==="percent"){
    const p=Math.max(0, Math.min(100, v));
    return Math.max(0, base*(1-p/100));
  }
  return base;
}
function perSessionForStudent(g,s){
  return round2(effectiveCyclePrice(s) / cycleLen(g));
}
function attendanceCountForStudent(c,sid){
  let cnt=0;
  for(const ss of (c.sessions||[])){
    const map = c.attendance?.[ss.id] || {};
    if(map[sid]==="P") cnt++;
  }
  return cnt;
}
function subscriptionDueSoFar(g,c,s){
  const mode = db.settings.chargeMode || "perSessions";
  if(mode==="byAttendance"){
    const pres = attendanceCountForStudent(c, s.id);
    return round2(pres * perSessionForStudent(g,s));
  }
  return round2(sessionsCount(c) * perSessionForStudent(g,s));
}
function carry(c,sid){ return round2(Number(c.carry?.[sid]||0)); }
function paidTotal(c,sid){
  return round2((c.txs||[]).filter(t=>t.sid===sid).reduce((a,t)=>a+Number(t.amount||0),0));
}
function totals(g,c,s){
  const sub = subscriptionDueSoFar(g,c,s);
  const prev = carry(c, s.id);
  const total = round2(sub + prev);
  const paid = paidTotal(c, s.id);
  const remaining = round2(total - paid);
  return { sub, prev, total, paid, remaining };
}

/* ---------- Import / Export ---------- */
document.getElementById("btnExport").onclick=()=>{
  const data = JSON.stringify(db, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "Hedra_v4.2_Backup.json";
  a.click();
  URL.revokeObjectURL(a.href);
  toast("ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±");
};

document.getElementById("btnImport").onclick=()=>{
  const inp=document.createElement("input");
  inp.type="file"; inp.accept="application/json";
  inp.onchange=()=>{
    const f=inp.files?.[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const parsed=JSON.parse(r.result);
        if(!parsed || typeof parsed!=="object") throw new Error();
        db=parsed;
        ensureDefaults();
        toast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯");
        renderAll();
      }catch{
        alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
      }
    };
    r.readAsText(f);
  };
  inp.click();
};

/* ---------- Tabs ---------- */
const pages = {
  run: document.getElementById("pageRun"),
  manage: document.getElementById("pageManage"),
  dashboard: document.getElementById("pageDashboard"),
  settings: document.getElementById("pageSettings")
};

function showTab(k, opt={}){
  const needsPIN = (k==="manage" || k==="settings");
  if(needsPIN && !opt.skipPIN){
    if(!requirePINOnce()) return;
  }
  Object.keys(pages).forEach(x=>pages[x].style.display=(x===k)?"":"none");
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===k));
  renderAll();
}
document.querySelectorAll(".tab").forEach(t=>t.addEventListener("click", ()=>showTab(t.dataset.tab)));

/* ---------- Group selects sync ---------- */
const selGroupRun = document.getElementById("selGroupRun");
const selGroupManage = document.getElementById("selGroupManage");
const selGroupSettings = document.getElementById("selGroupSettings");

function fillGroupSelect(sel){
  sel.innerHTML="";
  db.groups.forEach(g=>{
    const o=document.createElement("option");
    o.value=g.id; o.textContent=g.name;
    sel.appendChild(o);
  });
  sel.value = db.settings.currentGroupId || (db.groups[0]?.id||"");
}
function refreshGroupSelects(){
  fillGroupSelect(selGroupRun);
  fillGroupSelect(selGroupManage);
  fillGroupSelect(selGroupSettings);
}
function onGroupChange(e){
  db.settings.currentGroupId = e.target.value;
  saveDB();
  renderAll();
}
selGroupRun.addEventListener("change", onGroupChange);
selGroupManage.addEventListener("change", onGroupChange);
selGroupSettings.addEventListener("change", onGroupChange);

/* ---------- Top header info ---------- */
function renderTopBar(){
  // Top actions by role
  const bx=document.getElementById("btnExport");
  const bi=document.getElementById("btnImport");
  if(bx) bx.style.display = (currentRole===ROLE.ADMIN) ? "inline-flex" : "none";
  if(bi) bi.style.display = (currentRole===ROLE.ADMIN) ? "inline-flex" : "none";

  const g=curGroup();
  const c=g?curCycle(g):null;
  document.getElementById("topDateBig").textContent = todayText();

  const cur = sessionsCount(c);
  const len = cycleLen(g);
  document.getElementById("topSessionInfo").textContent = `Ø§Ù„Ø­ØµØ©: ${Math.min(cur+1, len)} / ${len}`;

  // cycle label: start from first session, end when completed
  const from = (c && c.sessions.length) ? cycleStartYMD(c) : fmtDMY(isoYMD(new Date()));
  const to = (c && c.sessions.length && sessionsCount(c)>=len) ? cycleEndYMD(g,c) : "â€”";
  document.getElementById("topCycleInfo").textContent = `Ø§Ù„Ø¯ÙˆØ±Ø©: ${from} â†’ ${to}`;
}

/* ---------- Sessions (manual date) ---------- */
function addSessionWithDate(g,c, ymd){
  if(sessionsCount(c) >= cycleLen(g)){
    toast("Ø§ÙƒØªÙ…Ù„Øª Ø­ØµØµ Ø§Ù„Ø¯ÙˆØ±Ø©");
    return false;
  }
  const iso = new Date(ymd+"T12:00:00").toISOString();
  // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…
  const exists = c.sessions.some(s=>ymdFromTs(s.tsISO)===ymd);
  if(exists){
    toast("Ù‡Ø°Ù‡ Ø§Ù„Ø­ØµØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨Ù†ÙØ³ Ø§Ù„ØªØ§Ø±ÙŠØ®");
    return false;
  }
  const ss = { id:uid("ss"), tsISO: iso };
  c.sessions.push(ss);
  // ØªØ±ØªÙŠØ¨
  c.sessions.sort((a,b)=> new Date(a.tsISO)-new Date(b.tsISO));
  addLog(g, `Ø¥Ø¶Ø§ÙØ© Ø­ØµØ©: ${fmtDMY(ymd)}`);
  return true;
}

document.getElementById("btnAddSession").onclick=()=>{
  if(!canEditSensitive()){ toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹"); return; }
  const g=curGroup(); if(!g) return;
  const c=curCycle(g); if(!c) return;

  const ymd = prompt("Ø§ÙƒØªØ¨ÙŠ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­ØµØ© (YYYY-MM-DD)\nÙ…Ø«Ø§Ù„: 2026-02-12", isoYMD(new Date()));
  if(!ymd) return;
  if(!/^\d{4}-\d{2}-\d{2}$/.test(ymd)) return alert("ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­Ø©");

  const ok = addSessionWithDate(g,c, ymd);
  if(!ok) return;

  saveDB();
  toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­ØµØ©");
  renderAll();
};

document.getElementById("btnRemoveSession").onclick=()=>{
  if(!canEditSensitive()){ toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹"); return; }
  const g=curGroup(); if(!g) return;
  const c=curCycle(g); if(!c) return;
  if(!c.sessions.length){ toast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ù„Ù„Ø­Ø°Ù"); return; }

  // Ø­Ø°Ù Ø­ØµØ© = Ù„Ø§Ø²Ù… PIN
  if(!requirePINOnce()) return;

  const last = c.sessions[c.sessions.length-1];
  const ok=confirm(`Ø­Ø°Ù Ø¢Ø®Ø± Ø­ØµØ©ØŸ (${fmtDMY(ymdFromTs(last.tsISO))})`);
  if(!ok) return;

  c.sessions.pop();
  addLog(g, "Ø­Ø°Ù Ø¢Ø®Ø± Ø­ØµØ©");
  saveDB();
  toast("ØªÙ… Ø­Ø°Ù Ø¢Ø®Ø± Ø­ØµØ©");
  renderAll();
};

/* ---------- Bulk sessions ---------- */
const bulkOverlay = document.getElementById("bulkOverlay");
document.getElementById("btnBulkSessions").onclick=()=>{
  if(!canEditSensitive()){ toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹"); return; }
  if(!requirePINOnce()) return;
  document.getElementById("bulkFrom").value = isoYMD(new Date(Date.now()-30*86400000));
  document.getElementById("bulkTo").value = isoYMD(new Date());
  document.querySelectorAll(".dow").forEach(x=>x.checked=false);
  bulkOverlay.style.display="block";
};
document.getElementById("btnBulkClose").onclick=()=>bulkOverlay.style.display="none";
bulkOverlay.addEventListener("click",(e)=>{ if(e.target===bulkOverlay) bulkOverlay.style.display="none"; });

document.getElementById("btnBulkApply").onclick=()=>{
  const g=curGroup(); if(!g) return;
  const c=curCycle(g); if(!c) return;

  const from = document.getElementById("bulkFrom").value;
  const to = document.getElementById("bulkTo").value;
  const dows = [...document.querySelectorAll(".dow")].filter(x=>x.checked).map(x=>Number(x.value));

  if(!from || !to) return alert("Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ù†/Ø¥Ù„Ù‰");
  if(new Date(from) > new Date(to)) return alert("ØªØ§Ø±ÙŠØ® Ù…Ù† Ø£ÙƒØ¨Ø± Ù…Ù† Ø¥Ù„Ù‰");
  if(dows.length===0) return alert("Ø§Ø®ØªØ§Ø±ÙŠ ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");

  let added=0;
  let d = new Date(from+"T12:00:00");
  const end = new Date(to+"T12:00:00");
  while(d <= end){
    const dow = (d.getDay()+6)%7; // ØªØ­ÙˆÙŠÙ„: JS Ø§Ù„Ø£Ø­Ø¯=0 -> Ù†Ø¹ØªØ¨Ø± Ø§Ù„Ø£Ø­Ø¯=0 ÙƒÙ…Ø§ ÙˆØ¶Ø¹Ù†Ø§
    // Ù†Ø­Ù† ÙˆØ¶Ø¹Ù†Ø§ Ø§Ù„Ø£Ø­Ø¯=0 Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ØŒ Ø¥Ø°Ù† Ù†Ø³ØªØ®Ø¯Ù… getDay ÙƒÙ…Ø§ Ù‡Ùˆ
    const jsDow = d.getDay(); // 0..6
    if(dows.includes(jsDow)){
      const ymd = d.toISOString().slice(0,10);
      if(addSessionWithDate(g,c, ymd)) added++;
      if(sessionsCount(c) >= cycleLen(g)) break;
    }
    d.setDate(d.getDate()+1);
  }

  saveDB();
  bulkOverlay.style.display="none";
  toast(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${added} Ø­ØµØµ`);
  renderAll();
};

/* ---------- Settings (group) ---------- */
document.getElementById("btnAddGroup").onclick=()=>{
  if(!canEditSensitive()){ toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹"); return; }
  if(!requirePINOnce()) return;
  const name=(prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©")||"").trim();
  if(!name) return;
  if(db.groups.some(x=>x.name.trim().toLowerCase()===name.toLowerCase())) return alert("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©");
  const g = {
    id: uid("g"),
    name,
    cycleLen: 8,
    students: [],
    cycles: [ newCycle() ],
    logs: []
  };
  db.groups.push(g);
  db.settings.currentGroupId=g.id;
  addLog(g, "Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø©");
  saveDB();
  toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©");
  renderAll();
};

function loadSettingsUI(){
  const g=curGroup(); if(!g) return;
  document.getElementById("cycleLen").value = String(g.cycleLen||8);
  document.getElementById("chargeMode").value = db.settings.chargeMode || "perSessions";
  document.getElementById("autoLock").value = db.settings.autoLock || "off";
}
document.getElementById("cycleLen").onchange=(e)=>{
  const g=curGroup(); if(!g) return;
  g.cycleLen = Number(e.target.value||8);
  addLog(g, `ØªØºÙŠÙŠØ± Ù…Ø¯Ø© Ø§Ù„Ø¯ÙˆØ±Ø© Ø¥Ù„Ù‰ ${g.cycleLen}`);
  saveDB();
  renderAll();
};
document.getElementById("chargeMode").onchange=(e)=>{
  db.settings.chargeMode = e.target.value || "perSessions";
  saveDB();
  toast("ØªÙ… Ø­ÙØ¸ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø³Ø§Ø¨");
  renderAll();
};
document.getElementById("autoLock").onchange=(e)=>{
  db.settings.autoLock = e.target.value || "off";
  saveDB();
  toast("ØªÙ… Ø­ÙØ¸ Ø®ÙŠØ§Ø± Ø§Ù„Ù‚ÙÙ„");
};

/* ---------- New cycle (carry remaining) ---------- */
document.getElementById("btnNewCycle").onclick=()=>{
  if(!canEditSensitive()){ toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹"); return; }
  if(!requirePINOnce()) return;
  const g=curGroup(); if(!g) return;
  const c=curCycle(g); if(!c) return;

  const ok = confirm("ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ Ø³ÙŠØªÙ… ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ/Ø§Ù„Ø²ÙŠØ§Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.");
  if(!ok) return;

  const carryMap = {};
  g.students.forEach(s=>{
    const t = totals(g,c,s);
    if(Math.abs(t.remaining) > 0.0001) carryMap[s.id]=t.remaining;
  });

  c.closed=true;
  const nc = newCycle();
  nc.carry = carryMap;
  g.cycles.push(nc);
  addLog(g, "ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©");
  saveDB();
  toast("ØªÙ… ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©");
  renderAll();
};

/* ---------- Change PIN ---------- */
document.getElementById("btnChangePIN").onclick=()=>{
  if(!canEditSensitive()){ toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹"); return; }
  if(!requirePINOnce()) return;
  const cur = getPIN();
  const old = prompt("Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ");
  if(old !== cur) return alert("Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­");
  const nw = prompt("Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (4 Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ Ø£ÙƒØ«Ø±)");
  if(!nw || nw.trim().length<4) return alert("Ù‚ØµÙŠØ± Ø¬Ø¯Ù‹Ø§");
  setPIN(nw.trim());
  toast("ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ");
};

/* ---------- Reset (requires PIN) ---------- */
document.getElementById("btnReset").onclick=()=>{
  if(!canEditSensitive()){ toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹"); return; }
  if(!requirePINOnce()) return;
  const ok=confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯. Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ");
  if(!ok) return;
  localStorage.removeItem(DB_KEY);
  toast("ØªÙ… Ø§Ù„Ù…Ø³Ø­");
  location.reload();
};

/* ---------- Students add/edit ---------- */
document.getElementById("btnAddStudent").onclick=()=>{
  if(!canEditSensitive()){ toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹"); return; }
  if(!requirePINOnce()) return;
  const g=curGroup(); if(!g) return;
  const name=(document.getElementById("newStudentName").value||"").trim();
  if(!name) return;
  if(g.students.some(s=>s.name.trim().toLowerCase()===name.toLowerCase())) return alert("Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯");
  g.students.push({ id:uid("s"), name, price:0, paused:false, discountType:"none", discountValue:0 });
  document.getElementById("newStudentName").value="";
  addLog(g, `Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨: ${name}`);
  saveDB();
  toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨");
  renderAll();
};

const stOverlay=document.getElementById("stOverlay");
let stCtx=null;

document.getElementById("btnStClose").onclick=()=>{ stOverlay.style.display="none"; stCtx=null; };
stOverlay.addEventListener("click",(e)=>{ if(e.target===stOverlay){ stOverlay.style.display="none"; stCtx=null; } });

function openStudentSettings(g,s){
  stCtx={g,s};
  document.getElementById("stTitle").textContent = s.name;
  document.getElementById("stName").value = s.name || "";
  document.getElementById("stPrice").value = Number(s.price||0);
  document.getElementById("stPaused").value = s.paused ? "yes" : "no";
  document.getElementById("stDiscType").value = s.discountType || "none";
  document.getElementById("stDiscVal").value =
    (s.discountType==="fixed"||s.discountType==="percent") ? String(s.discountValue||0) : "";
  stOverlay.style.display="block";
}

document.getElementById("btnStSave").onclick=()=>{
  if(!canEditSensitive()){ toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹"); return; }
  if(!stCtx) return;
  const { g, s } = stCtx;

  const newName = (document.getElementById("stName").value||"").trim();
  if(!newName) return alert("Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… ØµØ­ÙŠØ­");
  if(g.students.some(x=>x.id!==s.id && x.name.trim().toLowerCase()===newName.toLowerCase())) return alert("Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„");

  s.name = newName;
  s.price = Number(document.getElementById("stPrice").value||0);
  s.paused = (document.getElementById("stPaused").value==="yes");
  s.discountType = document.getElementById("stDiscType").value || "none";
  s.discountValue = Number(document.getElementById("stDiscVal").value||0);

  addLog(g, `ØªØ¹Ø¯ÙŠÙ„ Ø·Ø§Ù„Ø¨: ${s.name}`);
  saveDB();
  toast("ØªÙ… Ø§Ù„Ø­ÙØ¸");
  stOverlay.style.display="none";
  stCtx=null;
  renderAll();
};

document.getElementById("btnStDelete").onclick=()=>{
  if(!canEditSensitive()){ toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹"); return; }
  if(!stCtx) return;
  const { g, s } = stCtx;
  const ok = confirm("Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù ØªØ¹Ø§Ù…Ù„Ø§ØªÙ‡ ÙÙŠ ÙƒÙ„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª.");
  if(!ok) return;

  // delete txs/notes/carry/attendance entries across cycles
  g.cycles.forEach(c=>{
    c.txs = (c.txs||[]).filter(t=>t.sid!==s.id);
    delete c.notes?.[s.id];
    delete c.carry?.[s.id];
    for(const ss of (c.sessions||[])){
      if(c.attendance?.[ss.id]) delete c.attendance[ss.id][s.id];
    }
  });

  g.students = g.students.filter(x=>x.id!==s.id);
  addLog(g, `Ø­Ø°Ù Ø·Ø§Ù„Ø¨: ${s.name}`);
  saveDB();
  toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨");
  stOverlay.style.display="none";
  stCtx=null;
  renderAll();
};

function studentSpecialLabel(s){
  if(s.discountType==="exempt") return "Ù…Ø¹ÙÙ‰";
  if(s.discountType==="fixed" && (s.discountValue||0)>0) return "Ø®ØµÙ…";
  if(s.discountType==="percent" && (s.discountValue||0)>0) return "Ø®ØµÙ…";
  return "";
}

function renderStudentsSettings(){
  const g=curGroup();
  const wrap=document.getElementById("studentsList");
  wrap.innerHTML="";
  if(!g){ wrap.innerHTML=`<div class="hint">â€”</div>`; return; }
  if(!g.students.length){ wrap.innerHTML=`<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨.</div>`; return; }

  const list=[...g.students].sort((a,b)=>a.name.localeCompare(b.name,"ar"));
  list.forEach(s=>{
    const tag = studentSpecialLabel(s);
    const it=document.createElement("div");
    it.className="row";
    it.innerHTML=`
      <div class="left" style="min-width:0">
        <div class="num">ğŸ‘¤</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(s.name)}
            ${s.paused?` <span class="badge warn">Ù…ÙˆÙ‚ÙˆÙ</span>`:""}
            ${tag?` <span class="badge">${escapeHtml(tag)}</span>`:""}
          </div>
          <div class="mini">Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆØ±Ø© Ù„Ù„Ø·Ø§Ù„Ø¨: <span class="mono">${escapeHtml(String(s.price||0))}</span></div>
        </div>
      </div>
      <div>
        <button class="moreBtn noPrint" title="ØªØ¹Ø¯ÙŠÙ„">â‹¯</button>
      </div>
    `;
    it.querySelector("button").onclick=()=>{ if(!requirePINOnce()) return; openStudentSettings(g,s); };
    wrap.appendChild(it);
  });
}

/* ---------- Pay Modal (numbers visible) ---------- */
const payOverlay=document.getElementById("payOverlay");
const payAmountWrap=document.getElementById("payAmountWrap");
const payAmount=document.getElementById("payAmount");
const payAmountLabel=document.getElementById("payAmountLabel");
let payCtx=null;
let payMode=null; // add | minus | set

document.getElementById("btnPayClose").onclick=()=>closePay();
payOverlay.addEventListener("click",(e)=>{ if(e.target===payOverlay) closePay(); });

function closePay(){
  payOverlay.style.display="none";
  payCtx=null;
  payMode=null;
  payAmountWrap.style.display="none";
  payAmount.value="";
}

document.getElementById("btnPayPrint").onclick=()=>{
  // Ø§Ø·Ø¨Ø¹ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Save as PDF)
  window.print();
};

document.getElementById("btnPayAdd").onclick=()=>{
  if(!canEditSensitive()){ toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹"); return; }
  payMode="add";
  payAmountWrap.style.display="";
  payAmountLabel.textContent="Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº";
  payAmount.value="";
  payAmount.focus();
};

document.getElementById("btnPayMinus").onclick=()=>{
  if(!canEditSensitive()){ toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹"); return; }
  payMode="minus";
  payAmountWrap.style.display="";
  payAmountLabel.textContent="Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (ØªØµØ­ÙŠØ­)";
  payAmount.value="";
  payAmount.focus();
};

document.getElementById("btnPaySet").onclick=()=>{
  if(!canEditSensitive()){ toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹"); return; }
  payMode="set";
  payAmountWrap.style.display="";
  payAmountLabel.textContent="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ù‚ÙŠÙ…Ø© Ø¯Ù‚ÙŠÙ‚Ø©) â€” Ù…Ø«Ø§Ù„: 100 Ø¨Ø¯Ù„ 1000";
  // Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙ‚ÙŠÙ…Ø©
  if(payCtx){
    const {c,s}=payCtx;
    payAmount.value = String(paidTotal(c,s.id));
  }else{
    payAmount.value="";
  }
  payAmount.focus();
};

document.getElementById("btnPayApply").onclick=()=>{
  if(!canEditSensitive()){ toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹"); return; }
  if(!payCtx || !payMode) return;
  const {g,c,s}=payCtx;
  const v=Number(payAmount.value||0);
  if(!(v>=0)) return alert("Ø§ÙƒØªØ¨ Ø±Ù‚Ù… ØµØ­ÙŠØ­");

  if(payMode==="set"){
    // Ù†Ù…Ø³Ø­ txs Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆÙ†Ø¶Ø¹ tx ÙˆØ§Ø­Ø¯Ø© Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    c.txs = (c.txs||[]).filter(t=>t.sid!==s.id);
    if(v>0){
      c.txs.push({ id:uid("tx"), sid:s.id, amount:round2(v), tsISO:new Date().toISOString(), note:"(ØªØ¹Ø¯ÙŠÙ„)" });
    }
    addLog(g, `ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¯ÙÙˆØ¹ ${s.name} = ${v}`);
    toast("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
  }else if(payMode==="add"){
    if(!(v>0)) return alert("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±");
    c.txs.push({ id:uid("tx"), sid:s.id, amount:round2(v), tsISO:new Date().toISOString(), note:"(Ø¥Ø¶Ø§ÙØ©)" });
    addLog(g, `Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹ ${s.name} +${v}`);
    toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
  }else{
    if(!(v>0)) return alert("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±");
    // Ø§Ù„Ø®ØµÙ… ÙƒØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ù„Ø¨ (ØªØµØ­ÙŠØ­) â€” ÙŠØ³Ù‡Ù‘Ù„ ØªØ¹Ø¯ÙŠÙ„ 1000 Ø¨Ø¯Ù„ 100
    c.txs.push({ id:uid("tx"), sid:s.id, amount:round2(-v), tsISO:new Date().toISOString(), note:"(Ø®ØµÙ…/ØªØµØ­ÙŠØ­)" });
    addLog(g, `Ø®ØµÙ…/ØªØµØ­ÙŠØ­ ${s.name} -${v}`);
    toast("ØªÙ… Ø§Ù„Ø®ØµÙ…");
  }

  payMode=null;
  payAmountWrap.style.display="none";
  payAmount.value="";
  saveDB();
  renderAll();
  openPayModal(g,c,s);
};

document.getElementById("btnPaySaveNote").onclick=()=>{
  if(!canEditSensitive()){ toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹"); return; }
  if(!payCtx) return;
  const {g,c,s}=payCtx;
  c.notes[s.id] = String(document.getElementById("payNote").value||"").trim();
  addLog(g, `Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø·Ø§Ù„Ø¨ ${s.name}`);
  saveDB();
  toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©");
};

function openPayModal(g,c,s){
  payCtx={g,c,s};
  payMode=null;
  payAmountWrap.style.display="none";
  payAmount.value="";

  const len = cycleLen(g);
  const from = (c.sessions.length) ? cycleStartYMD(c) : fmtDMY(isoYMD(new Date()));
  const to = (c.sessions.length && sessionsCount(c)>=len) ? cycleEndYMD(g,c) : "â€”";

  document.getElementById("payTitle").textContent = s.name;
  document.getElementById("paySub").textContent = `${g.name} â€¢ Ø§Ù„Ø­ØµØµ: ${sessionsCount(c)}/${len} â€¢ Ø§Ù„Ø¯ÙˆØ±Ø©: ${from} â†’ ${to}`;

  document.getElementById("payNote").value = String(c.notes?.[s.id] || "");

  const t=totals(g,c,s);
  const t=totals(g,c,s);

  const table = (currentRole===ROLE.ASSISTANT)
    ? `
    <table>
      <thead><tr><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th></tr></thead>
      <tbody>
        <tr><td>Ø§Ù„Ø­ØµØµ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td><td class="mono">${sessionsCount(c)} / ${cycleLen(g)}</td></tr>
        <tr><td>Ø§Ù„Ø­Ø¶ÙˆØ±</td><td class="mono">${attendanceCountForStudent(c, s.id)}</td></tr>
        <tr><td>Ù…Ù„Ø§Ø­Ø¸Ø©</td><td class="mono">${escapeHtml(String(c.notes?.[s.id]||"â€”"))}</td></tr>
      </tbody>
    </table>
    `
    : (currentRole===ROLE.VIEW)
    ? `
    <table>
      <thead><tr><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th></tr></thead>
      <tbody>
        <tr><td>Ø§Ù„Ø­ØµØµ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td><td class="mono">${sessionsCount(c)} / ${cycleLen(g)}</td></tr>
        <tr><td>Ø§Ù„Ø­Ø¶ÙˆØ±</td><td class="mono">${attendanceCountForStudent(c, s.id)}</td></tr>
      </tbody>
    </table>
    `
    : `
    <table>
      <thead><tr><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>
      <tbody>
        <tr><td>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td><td class="mono">${t.sub}</td></tr>
        <tr><td>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ (Ù…Ø±Ø­Ù‘Ù„)</td><td class="mono">${t.prev}</td></tr>
        <tr><td><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</b></td><td class="mono"><b>${t.total}</b></td></tr>
        <tr><td>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</td><td class="mono">${t.paid}</td></tr>
        <tr><td><b>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</b></td><td class="mono"><b>${t.remaining}</b></td></tr>
      </tbody>
    </table>
  `;

  // Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¯ÙØ¹ (Ø¢Ø®Ø± 8) â€” Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·
  const txs = (c.txs||[]).filter(x=>x.sid===s.id).slice(-8).reverse();
  const txHtml = (currentRole===ROLE.ADMIN && txs.length) ? `
    <div class="hr"></div>
    <div style="font-weight:1000">Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
    <div class="hint">${txs.map(x=>`${fmtDateAR(x.tsISO)}: ${x.amount} ${x.note?("â€¢ "+escapeHtml(x.note)):""}`).join("<br>")}</div>
  ` : "";

  document.getElementById("payTableWrap").innerHTML = table + txHtml;

  // Actions visibility by role
  document.querySelectorAll("#payOverlay .rowWrap.noPrint").forEach(w=>{
    // the first rowWrap is pay action buttons
  });
  const actionRow = document.querySelector("#payOverlay .rowWrap.noPrint");
  if(actionRow) actionRow.style.display = (currentRole===ROLE.ADMIN) ? "" : "none";

  renderAttendanceUI(g,c,s);
  payOverlay.style.display="block";
}

/* ---------- Attendance UI (toggle: â€” -> Ø­Ø¶ÙˆØ± -> ØºÙŠØ§Ø¨ -> â€”) ---------- */
function getAtt(c, sessionId, sid){
  return (c.attendance?.[sessionId]?.[sid]) || "";
}
function setAtt(c, sessionId, sid, v){
  if(!c.attendance[sessionId]) c.attendance[sessionId]={};
  if(!v) delete c.attendance[sessionId][sid];
  else c.attendance[sessionId][sid]=v;
}

function toggleAttendance(g,c,s,sessionId){
  if(!canEditAnything()){ toast("ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·"); return; }
  const cur = getAtt(c,sessionId,s.id);
  const next = cur==="P" ? "A" : cur==="A" ? "" : "P";
  setAtt(c,sessionId,s.id,next);
  addLog(g, `Ø­Ø¶ÙˆØ± ${s.name}: ${fmtDMY(ymdFromTs(c.sessions.find(x=>x.id===sessionId)?.tsISO||new Date().toISOString()))} = ${next||"â€”"}`);
  saveDB();
  openPayModal(g,c,s);
  renderAll();
}

function renderAttendanceUI(g,c,s){
  const wrap = document.getElementById("attWrap");
  wrap.innerHTML="";

  if(!c.sessions.length){
    wrap.innerHTML = `<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ø¨Ø¹Ø¯. Ø£Ø¶ÙŠÙÙŠ Ø­ØµØµ Ø¨ØªØ§Ø±ÙŠØ® Ù‚Ø¯ÙŠÙ… Ù…Ù† â€œØ¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø§Ø¨Ù‚Ø©â€.</div>`;
    return;
  }

  c.sessions.forEach(ss=>{
    const ymd = ymdFromTs(ss.tsISO);
    const val = getAtt(c, ss.id, s.id);
    const label = val==="P" ? "Ø­Ø¶ÙˆØ± âœ…" : val==="A" ? "ØºÙŠØ§Ø¨ âŒ" : "â€”";

    const btnClass = val==="P" ? "attBtn attP" : val==="A" ? "attBtn attA" : "attBtn";
    const item=document.createElement("div");
    item.className="attItem";
    item.innerHTML = `
      <div style="min-width:0">
        <div style="font-weight:1000">${fmtDMY(ymd)}</div>
        <div class="hint mono">${ymd}</div>
      </div>
      <button class="${btnClass} noPrint">${label}</button>
    `;
    item.querySelector("button").onclick=()=>toggleAttendance(g,c,s,ss.id);
    wrap.appendChild(item);
  });
}

/* ---------- MAIN list (no status text) ---------- */
function renderRun(){
  renderTopBar();

  const g=curGroup();
  const c=g?curCycle(g):null;

  const wrap=document.getElementById("runList");
  wrap.innerHTML="";

  if(!g){ wrap.innerHTML=`<div class="hint">Ø£Ø¶ÙŠÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø©.</div>`; return; }
  if(!g.students.length){ wrap.innerHTML=`<div class="hint">Ø£Ø¶ÙŠÙÙŠ Ø·Ù„Ø§Ø¨ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.</div>`; return; }

  const list=[...g.students].sort((a,b)=>a.name.localeCompare(b.name,"ar"));
  list.forEach((s,idx)=>{
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <div class="left">
        <div class="num">${idx+1}</div>
        <div class="name">${escapeHtml(s.name)}</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="btn small royal noPrint" style="min-width:170px"><span class="ico">ğŸ’³</span> Ø¯ÙØ¹</button>
        <button class="moreBtn noPrint" title="ØªÙØ§ØµÙŠÙ„">â‹¯</button>
      </div>
    `;

    // Ø¯ÙØ¹: ÙŠÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹ (ØªØ¸Ù‡Ø± Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¯Ø§Ø®Ù„Ù‡Ø§)
    row.querySelector(".btn").onclick=()=>{
      if(!requirePINOnce()) return;
      openPayModal(g,c,s);
    };
    row.querySelector(".moreBtn").onclick=()=>{
      if(!requirePINOnce()) return;
      openPayModal(g,c,s);
    };

    wrap.appendChild(row);
  });
}

/* ---------- MANAGE: search all groups + group detail ---------- */
document.getElementById("qManage").addEventListener("input", ()=>renderManage());

document.getElementById("btnSessionsLog").onclick=()=>{
  if(!requirePINOnce()) return;
  const g=curGroup(); if(!g) return;
  const c=curCycle(g); if(!c) return;

  const ss = c.sessions.map((x,i)=>`${i+1}) ${fmtDMY(ymdFromTs(x.tsISO))}  (${ymdFromTs(x.tsISO)})`).join("\n");
  document.getElementById("ssList").textContent = ss || "â€”";
  document.getElementById("ssOverlay").style.display="block";
};
document.getElementById("btnSsClose").onclick=()=>document.getElementById("ssOverlay").style.display="none";
document.getElementById("ssOverlay").addEventListener("click",(e)=>{ if(e.target.id==="ssOverlay") document.getElementById("ssOverlay").style.display="none"; });

function groupTotals(g,c){
  let total=0, paid=0, remaining=0;
  g.students.forEach(s=>{
    const t=totals(g,c,s);
    total += t.total;
    paid += t.paid;
    remaining += t.remaining;
  });
  return { total: round2(total), paid: round2(paid), remaining: round2(remaining) };
}

function renderGroupSummary(){
  const g=curGroup();
  const c=g?curCycle(g):null;
  const box=document.getElementById("groupSummary");
  box.innerHTML="";
  if(!g || !c) return;

  const gt = groupTotals(g,c);
  box.innerHTML = `
    <div class="row" style="flex:1">
      <div class="left"><div class="num">ğŸ“Œ</div>
        <div>
          <div class="name">Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)</div>
          <div class="mini">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span class="mono">${gt.total}</span> â€¢ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: <span class="mono">${gt.paid}</span> â€¢ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span class="mono">${gt.remaining}</span></div>
        </div>
      </div>
      <button class="moreBtn noPrint" id="btnPrintGroup">ğŸ–¨</button>
    </div>
  `;
  box.querySelector("#btnPrintGroup").onclick=()=>window.print();
}

function renderManage(){
  renderTopBar();
  renderGroupSummary();

  const q=(document.getElementById("qManage").value||"").trim().toLowerCase();
  const g=curGroup();
  const c=g?curCycle(g):null;

  document.getElementById("manageSub").textContent = g && c
    ? `${g.name} â€¢ Ø­ØµØµ: ${sessionsCount(c)}/${cycleLen(g)} â€¢ Ø§Ù„Ø¯ÙˆØ±Ø©: ${cycleStartYMD(c)} â†’ ${cycleEndYMD(g,c)}`
    : "â€”";

  const wrap=document.getElementById("manageList");
  wrap.innerHTML="";

  // Ø¨Ø­Ø« Ø´Ø§Ù…Ù„: ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
  if(q){
    const hits=[];
    db.groups.forEach(gr=>{
      const cy = curCycle(gr);
      gr.students.forEach(s=>{
        if(s.name.toLowerCase().includes(q)){
          const t=totals(gr,cy,s);
          hits.push({gr,cy,s,t});
        }
      });
    });
    if(!hits.length){
      wrap.innerHTML=`<div class="hint">Ù„Ø§ Ù†ØªØ§Ø¦Ø¬.</div>`;
      return;
    }
    hits.sort((a,b)=>a.s.name.localeCompare(b.s.name,"ar"));
    hits.forEach(h=>{
      const tag = studentSpecialLabel(h.s);
      const it=document.createElement("div");
      it.className="row";
      it.innerHTML=`
        <div class="left" style="min-width:0">
          <div class="num">ğŸ”</div>
          <div style="min-width:0">
            <div class="name">${escapeHtml(h.s.name)}
              ${tag?` <span class="badge">${escapeHtml(tag)}</span>`:""}
            </div>
            <div class="mini">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: <b>${escapeHtml(h.gr.name)}</b> â€¢ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span class="mono">${h.t.remaining}</span></div>
          </div>
        </div>
        <button class="moreBtn noPrint">Ø¹Ø±Ø¶</button>
      `;
      it.querySelector("button").onclick=()=>{
        if(!requirePINOnce()) return;
        // Ù†Ø¨Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù†ÙØ³ Ø§Ù„Ø·Ø§Ù„Ø¨
        db.settings.currentGroupId = h.gr.id;
        saveDB();
        refreshGroupSelects();
        openPayModal(h.gr,h.cy,h.s);
      };
      wrap.appendChild(it);
    });
    return;
  }

  // Ø¹Ø±Ø¶ Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
  if(!g || !c){
    wrap.innerHTML=`<div class="hint">â€”</div>`;
    return;
  }
  if(!g.students.length){
    wrap.innerHTML=`<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨.</div>`;
    return;
  }

  const list=[...g.students].sort((a,b)=>a.name.localeCompare(b.name,"ar"));
  list.forEach(s=>{
    const t=totals(g,c,s);
    const tag = studentSpecialLabel(s);
    const it=document.createElement("div");
    it.className="row";
    it.innerHTML=`
      <div class="left" style="min-width:0">
        <div class="num">ğŸ§¾</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(s.name)}
            ${s.paused?` <span class="badge warn">Ù…ÙˆÙ‚ÙˆÙ</span>`:""}
            ${tag?` <span class="badge">${escapeHtml(tag)}</span>`:""}
          </div>
          <div class="mini">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span class="mono">${t.total}</span> â€¢ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: <span class="mono">${t.paid}</span> â€¢ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span class="mono">${t.remaining}</span></div>
        </div>
      </div>
      <button class="moreBtn noPrint">Ø¹Ø±Ø¶</button>
    `;
    it.querySelector("button").onclick=()=>{
      if(!requirePINOnce()) return;
      openPayModal(g,c,s);
    };
    wrap.appendChild(it);
  });
}

/* ---------- Monthly Reports ---------- */
const monthOverlay = document.getElementById("monthOverlay");
document.getElementById("btnMonthly").onclick=()=>{
  if(!requirePINOnce()) return;
  renderMonthly();
  monthOverlay.style.display="block";
};
document.getElementById("btnMonthClose").onclick=()=>monthOverlay.style.display="none";
monthOverlay.addEventListener("click",(e)=>{ if(e.target===monthOverlay) monthOverlay.style.display="none"; });

function monthKey(tsISO){
  const d=new Date(tsISO);
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function renderMonthly(){
  const g=curGroup(); if(!g) return;
  // Ù†Ø¬Ù…Ø¹ txs Ù…Ù† ÙƒÙ„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª
  const map = {}; // month -> income
  g.cycles.forEach(c=>{
    (c.txs||[]).forEach(t=>{
      const k=monthKey(t.tsISO);
      map[k]=(map[k]||0)+Number(t.amount||0);
    });
  });

  const months = Object.keys(map).sort().reverse();
  const wrap=document.getElementById("monthWrap");

  // Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)
  const c=curCycle(g);
  const gt = groupTotals(g,c);

  if(!months.length){
    wrap.innerHTML = `<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¯ÙØ¹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>
      <div class="hr"></div>
      <div class="row"><div class="left"><div class="num">ğŸ“Œ</div>
        <div><div class="name">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</div><div class="mini mono">${gt.remaining}</div></div></div></div>`;
    return;
  }

  const rows = months.map(k=>{
    return `<tr><td>${escapeHtml(k)}</td><td class="mono">${round2(map[k])}</td></tr>`;
  }).join("");

  wrap.innerHTML = `
    <div class="row">
      <div class="left"><div class="num">ğŸ“Œ</div>
        <div>
          <div class="name">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)</div>
          <div class="mini">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span class="mono">${gt.total}</span> â€¢ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: <span class="mono">${gt.paid}</span> â€¢ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span class="mono">${gt.remaining}</span></div>
        </div>
      </div>
    </div>
    <div class="hr"></div>
    <table>
      <thead><tr><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ø¯Ø®Ù„</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}


/* ---------- Dashboard ---------- */
document.getElementById("btnDashPrint").onclick=()=>window.print();

function renderDashboard(){
  renderTopBar();
  const g=curGroup();
  const c=g?curCycle(g):null;

  const cards=document.getElementById("dashCards");
  const monthWrap=document.getElementById("dashMonthWrap");
  const alerts=document.getElementById("dashAlerts");
  if(!cards || !monthWrap || !alerts) return;

  cards.innerHTML=""; monthWrap.innerHTML=""; alerts.innerHTML="";

  if(!g || !c){
    cards.innerHTML = `<div class="hint">â€”</div>`;
    return;
  }

  const students = g.students.length;
  const sessions = sessionsCount(c);
  const len = cycleLen(g);

  // money only for admin
  const gt = groupTotals(g,c);

  const items = [
    { ico:"ğŸ‘¥", title:"Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨", val: String(students) },
    { ico:"ğŸ—“", title:"Ø­ØµØµ Ø§Ù„Ø¯ÙˆØ±Ø©", val: `${sessions} / ${len}` },
    { ico:"âœ…", title:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¶ÙˆØ± (Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©)", val: String(g.students.reduce((a,s)=>a+attendanceCountForStudent(c,s.id),0)) }
  ];

  if(currentRole===ROLE.ADMIN){
    items.push({ ico:"ğŸ’°", title:"Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)", val: String(gt.paid) });
    items.push({ ico:"ğŸ“Œ", title:"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)", val: String(gt.remaining) });
  }else{
    items.push({ ico:"ğŸ”’", title:"Ø§Ù„ØªØ­ØµÙŠÙ„", val: "Ù…Ø®ÙÙŠ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹" });
  }

  items.forEach(x=>{
    const el=document.createElement("div");
    el.className="row";
    el.style.flex="1";
    el.innerHTML = `
      <div class="left"><div class="num">${x.ico}</div>
        <div><div class="name">${escapeHtml(x.title)}</div>
        <div class="mini mono">${escapeHtml(String(x.val))}</div></div>
      </div>
    `;
    cards.appendChild(el);
  });

  // monthly income (admin only shows amounts)
  const map = {};
  g.cycles.forEach(cc=>{
    (cc.txs||[]).forEach(t=>{
      const k=monthKey(t.tsISO);
      map[k]=(map[k]||0)+Number(t.amount||0);
    });
  });
  const months = Object.keys(map).sort().reverse();

  if(!months.length){
    monthWrap.innerHTML = `<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¯ÙØ¹ Ø¨Ø¹Ø¯.</div>`;
  }else if(currentRole!==ROLE.ADMIN){
    monthWrap.innerHTML = `<div class="hint">Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù…Ø®ÙÙŠ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹.</div>`;
  }else{
    const rows = months.map(k=>`<tr><td>${escapeHtml(k)}</td><td class="mono">${round2(map[k])}</td></tr>`).join("");
    monthWrap.innerHTML = `
      <table>
        <thead><tr><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ø¯Ø®Ù„</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }

  // alerts: top remaining students (admin only shows amounts; others show names only)
  const list=[...g.students].map(s=>({s, t: totals(g,c,s)})).sort((a,b)=>b.t.remaining-a.t.remaining);
  const top=list.filter(x=>x.t.remaining>0.0001).slice(0,8);

  if(!top.length){
    alerts.innerHTML = `<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØªØ£Ø®Ø±Ø§Øª ÙˆØ§Ø¶Ø­Ø©.</div>`;
    return;
  }
  top.forEach((x,i)=>{
    const it=document.createElement("div");
    it.className="row";
    it.innerHTML = `
      <div class="left" style="min-width:0">
        <div class="num">${i+1}</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(x.s.name)}</div>
          <div class="mini">${currentRole===ROLE.ADMIN ? `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span class="mono">${x.t.remaining}</span>` : "Ù…ØªØ£Ø®Ø± (Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ø®ÙÙŠØ©)"}</div>
        </div>
      </div>
      <button class="moreBtn noPrint">Ø¹Ø±Ø¶</button>
    `;
    it.querySelector("button").onclick=()=>{
      if(!isUnlocked()){ openLockScreen("Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ"); return; }
      openPayModal(g,c,x.s);
    };
    alerts.appendChild(it);
  });
}


/* ---------- Render All ---------- */
function renderAll(){
  ensureDefaults();
  refreshGroupSelects();
  loadSettingsUI();
  renderStudentsSettings();
  renderRun();
  renderManage();
  renderDashboard();
}

/* ---------- Init ---------- */
(function init(){
  buildPinPad();
  // role handlers
  document.getElementById("btnLockRoleAdmin").onclick=()=>setRole(ROLE.ADMIN);
  document.getElementById("btnLockRoleAssistant").onclick=()=>setRole(ROLE.ASSISTANT);
  document.getElementById("btnLockRoleView").onclick=()=>setRole(ROLE.VIEW);
  document.getElementById("btnUnlock").onclick=()=>tryUnlock();
  document.getElementById("btnLockClear").onclick=()=>{ pinBuf=""; renderPinDots(); };
  setRole(ROLE.ADMIN);
  renderPinDots();
  // if already unlocked in this session, hide lock
  if(isUnlocked()) closeLockScreen();
  loadDB();
  ensureDefaults();
  renderAll();
  // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø¬Ù„Ø³Ø© Ù…ÙØªÙˆØ­Ø©: Ù†Ø¸Ù‡Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„
  if(!isUnlocked()) openLockScreen("Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ");
})();

/* ---------- PWA Install ---------- */
let deferredPrompt=null;
window.addEventListener("beforeinstallprompt",(e)=>{
  e.preventDefault();
  deferredPrompt=e;
  document.getElementById("btnInstall").style.display="inline-flex";
});
document.getElementById("btnInstall").onclick=async ()=>{
  if(!deferredPrompt){
    alert("Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­: Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â‹® Ø«Ù… (Install) Ø£Ùˆ (Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)");
    return;
  }
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt=null;
  document.getElementById("btnInstall").style.display="none";
};

/* ---------- Service Worker ---------- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
  </script>
</body>
</html>
