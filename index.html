<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hedra V6 â€“ Teacher Edition</title>
  <meta name="theme-color" content="#0A2A66">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon.png">
  <style>
    :root{--bg:#07152D;--bg2:#050E1F;--ink:#071223;--muted:#334155;--line:rgba(2,6,23,.14);--r:22px;--shadow:0 20px 50px rgba(2,6,23,.25);--shadow2:0 12px 28px rgba(2,6,23,.16)}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial}
    html,body{height:100%}
    body{margin:0;color:#F5F8FF;background:radial-gradient(1000px 620px at 85% -10%, rgba(10,42,102,.42), transparent 65%),radial-gradient(1000px 620px at -10% 10%, rgba(10,42,102,.26), transparent 65%),linear-gradient(180deg,var(--bg),var(--bg2));min-height:100vh}
    .top{position:sticky;top:0;z-index:50;background:rgba(7,21,45,.88);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,.16);padding:14px}
    .top .wrap{max-width:1060px;margin:0 auto;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:50px;height:50px;border-radius:18px;background:linear-gradient(135deg, rgba(255,255,255,.22), rgba(255,255,255,.08));border:1px solid rgba(255,255,255,.28);display:grid;place-items:center;font-weight:1000}
    .badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.09);font-weight:1000;font-size:12px;white-space:nowrap}
    .page{max-width:1060px;margin:0 auto;padding:14px 14px 112px}
    .card{background:rgba(255,255,255,.97);color:var(--ink);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    .hr{height:1px;background:rgba(2,6,23,.10);margin:12px 0}
    .hint{color:var(--muted);font-size:12px;line-height:1.8}
    .btn{border:1px solid rgba(255,255,255,.22);background:linear-gradient(180deg, rgba(255,255,255,.20), rgba(255,255,255,.07));color:#fff;border-radius:18px;padding:12px 14px;min-height:46px;font-weight:1000;cursor:pointer;display:inline-flex;gap:10px;align-items:center;justify-content:center;box-shadow:0 10px 0 rgba(0,0,0,.18)}
    .btn.small{min-height:42px;border-radius:16px;font-size:13px;padding:10px 12px}
    .btn.royal{background:linear-gradient(180deg, rgba(10,42,102,.76), rgba(10,42,102,.34));border-color:rgba(255,255,255,.30)}
    .btn.ghost{background:transparent;box-shadow:none}
    .btn.danger{background:linear-gradient(180deg, rgba(215,38,56,.70), rgba(215,38,56,.30))}
    input,select{width:100%;min-height:48px;padding:10px 12px;border-radius:16px;border:1px solid rgba(2,6,23,.14);outline:none;font-size:15px;background:#fff;color:var(--ink);box-shadow:var(--shadow2)}
    label{display:block;font-weight:1000;font-size:13px;margin:10px 0 6px}
    .rowWrap{display:flex;gap:10px;flex-wrap:wrap}
    .rowWrap>*{flex:1;min-width:220px}
    .list{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px;border-radius:20px;border:1px solid rgba(2,6,23,.12);background:#fff;box-shadow:var(--shadow2)}
    .left{display:flex;align-items:center;gap:12px;min-width:0}
    .num{width:40px;height:40px;border-radius:16px;background:rgba(10,42,102,.10);border:1px solid rgba(10,42,102,.24);display:grid;place-items:center;font-weight:1000;color:#0A2A66;flex:0 0 auto}
    .name{font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mini{font-size:12px;color:var(--muted);margin-top:4px}
    .moreBtn{width:52px;min-height:48px;border-radius:18px;border:1px solid rgba(2,6,23,.12);background:#fff;color:var(--ink);font-weight:1100;cursor:pointer;box-shadow:0 10px 0 rgba(0,0,0,.12)}
    .bottom{position:fixed;left:0;right:0;bottom:0;z-index:60;background:rgba(7,21,45,.88);backdrop-filter:blur(12px);border-top:1px solid rgba(255,255,255,.16);padding:10px 12px}
    .bottom .wrap{max-width:1060px;margin:0 auto;display:flex;gap:10px}
    .tab{flex:1;min-height:56px;border-radius:18px;border:1px solid rgba(255,255,255,.22);background:linear-gradient(180deg, rgba(255,255,255,.20), rgba(255,255,255,.07));color:#fff;font-weight:1000;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;box-shadow:0 10px 0 rgba(0,0,0,.18)}
    .tab.active{background:linear-gradient(180deg, rgba(10,42,102,.76), rgba(10,42,102,.32));border-color:rgba(255,255,255,.34)}
    .overlay{position:fixed;inset:0;z-index:90;background:rgba(2,6,23,.62);display:none;padding:14px}
    .modal{max-width:760px;margin:5vh auto;background:#fff;color:var(--ink);border:1px solid rgba(2,6,23,.12);border-radius:24px;box-shadow:var(--shadow);padding:14px}
    .toast{position:fixed;left:12px;bottom:88px;z-index:110;background:rgba(255,255,255,.96);color:var(--ink);border:1px solid rgba(2,6,23,.12);box-shadow:var(--shadow);padding:10px 12px;border-radius:16px;font-weight:1000;display:none;max-width:92vw}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid rgba(2,6,23,.10);padding:8px;text-align:right}
    .mono{font-variant-numeric:tabular-nums}
    @media print{.top,.bottom,.noPrint{display:none!important} body{background:#fff;color:#000} .page{padding:0} .card{box-shadow:none;border:1px solid #ddd}}
  </style>
</head>
<body>
<header class="top">
  <div class="wrap">
    <div class="brand">
      <div class="logo">TE</div>
      <div>
        <div style="font-weight:1000;font-size:18px">Hedra â€“ Teacher Edition</div>
        <div class="hint" id="topDate">â€”</div>
        <div class="rowWrap" style="gap:8px">
          <span class="badge" id="topSession">Ø§Ù„Ø­ØµØ©: â€”</span>
          <span class="badge" id="topCycle">Ø§Ù„Ø¯ÙˆØ±Ø©: â€”</span>
          <span class="badge" id="topRole">Ø§Ù„Ø¯ÙˆØ±: Ù…Ø¯ÙŠØ±</span>
          <span class="badge">v6.0.0-teacher</span>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
      <button class="btn small noPrint" id="btnInstall" style="display:none">â¬‡ ØªØ«Ø¨ÙŠØª</button>
      <button class="btn small ghost noPrint" id="btnExport">â¬† ØªØµØ¯ÙŠØ± Ù…Ø´ÙÙ‘Ø±</button>
      <button class="btn small ghost noPrint" id="btnImport">â¬‡ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
    </div>
  </div>
</header>

<main class="page">
  <section id="pageRun">
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start">
        <div>
          <div style="font-weight:1000;font-size:16px">Ø§Ù„Ø­ØµØ©</div>
          <div class="hint">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ + Ø§Ù„Ø¯ÙØ¹ + Ø§Ù„Ø­Ø¶ÙˆØ±.</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn small royal noPrint" id="btnAddSession">ï¼‹ Ø¥Ø¶Ø§ÙØ© Ø­ØµØ©</button>
          <button class="btn small danger noPrint" id="btnRemoveSession">âˆ’ Ø­Ø°Ù Ø¢Ø®Ø± Ø­ØµØ©</button>
        </div>
      </div>
      <div class="hr"></div>
      <label for="selGroupRun">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
      <select id="selGroupRun"></select>
      <div class="hr"></div>
      <div class="list" id="runList"></div>
    </div>
  </section>

  <section id="pageManage" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start">
        <div>
          <div style="font-weight:1000;font-size:16px">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
          <div class="hint">Ø¨Ø­Ø« + Ù…Ù„Ø®Øµ + ØªØ¯Ù‚ÙŠÙ‚ + Ø¥ÙŠØµØ§Ù„Ø§Øª.</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn small ghost noPrint" id="btnBulk">ğŸ“¥ Ø¥Ù†Ø´Ø§Ø¡ Ø­ØµØµ Ù‚Ø¯ÙŠÙ…Ø©</button>
          <button class="btn small ghost noPrint" id="btnAudit">ğŸ§¾ ØªØ¯Ù‚ÙŠÙ‚</button>
          <button class="btn small ghost noPrint" id="btnReceipts">ğŸ§¾ Ø¥ÙŠØµØ§Ù„Ø§Øª</button>
        </div>
      </div>

      <div class="hr"></div>
      <label for="qManage">Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… (ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª)</label>
      <input id="qManage" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." />
      <div class="hr"></div>
      <label for="selGroupManage">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
      <select id="selGroupManage"></select>
      <div class="hr"></div>
      <div class="list" id="manageList"></div>
    </div>
  </section>

  <section id="pageDashboard" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start">
        <div>
          <div style="font-weight:1000;font-size:16px">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
          <div class="hint">Ù…Ù„Ø®Øµ + Ø¯Ø®Ù„ Ø´Ù‡Ø±ÙŠ + Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†.</div>
        </div>
        <button class="btn small ghost noPrint" id="btnDashPrint">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
      <div class="hr"></div>
      <div class="rowWrap" id="dashCards"></div>
      <div class="hr"></div>
      <div id="dashMonth"></div>
      <div class="hr"></div>
      <div class="list" id="dashLate"></div>
    </div>
  </section>

  <section id="pageSettings" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start">
        <div>
          <div style="font-weight:1000;font-size:16px">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
          <div class="hint">Ù…Ø¬Ù…ÙˆØ¹Ø§Øª + Ø·Ù„Ø§Ø¨ + Ø£Ø³Ø¹Ø§Ø± + Ø®ØµÙˆÙ…Ø§Øª + Ø£Ù…Ø§Ù†.</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn small royal noPrint" id="btnAddGroup">ï¼‹ Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
          <button class="btn small ghost noPrint" id="btnNewCycle">ğŸ” Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
          <button class="btn small ghost noPrint" id="btnChangePIN">ğŸ”’ ØªØºÙŠÙŠØ± PIN</button>
        </div>
      </div>

      <div class="hr"></div>
      <label for="selGroupSettings">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
      <select id="selGroupSettings"></select>

      <div class="rowWrap">
        <div>
          <label for="cycleLen">Ù…Ø¯Ø© Ø§Ù„Ø¯ÙˆØ±Ø© (Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ)</label>
          <select id="cycleLen">
            <option value="4">4</option><option value="8" selected>8</option><option value="12">12</option>
          </select>
        </div>
        <div>
          <label for="chargeMode">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label>
          <select id="chargeMode">
            <option value="perSessions" selected>Ø­Ø³Ø¨ Ø§Ù„Ø­ØµØµ</option>
            <option value="byAttendance">Ø­Ø³Ø¨ Ø§Ù„Ø­Ø¶ÙˆØ±</option>
          </select>
        </div>
      </div>

      <div class="rowWrap">
        <div>
          <label for="brandName">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ø§Ù„Ù…Ø±ÙƒØ² ÙÙŠ Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</label>
          <input id="brandName" placeholder="Ù…Ø«Ø§Ù„: Ø£/ Ø£Ø­Ù…Ø¯" />
        </div>
        <div>
          <label for="brandPhone">Ù‡Ø§ØªÙ/ÙˆØ§ØªØ³Ø§Ø¨</label>
          <input id="brandPhone" placeholder="01xxxxxxxxx" />
        </div>
      </div>

      <div class="hr"></div>
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-end">
        <div>
          <div style="font-weight:1000">Ø§Ù„Ø·Ù„Ø§Ø¨</div>
          <div class="hint">Ø§Ù„Ø­Ø°Ù = Ø£Ø±Ø´ÙØ© (Ù„Ø§ Ø¶ÙŠØ§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª).</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <input id="newStudentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." style="min-width:220px"/>
          <button class="btn small royal noPrint" id="btnAddStudent">ï¼‹ Ø¥Ø¶Ø§ÙØ©</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="list" id="studentsList"></div>
    </div>
  </section>
</main>

<nav class="bottom noPrint">
  <div class="wrap">
    <button class="tab active" data-tab="run">ğŸ </button>
    <button class="tab" data-tab="manage">ğŸ§¾</button>
    <button class="tab" data-tab="dashboard">ğŸ“Š</button>
    <button class="tab" data-tab="settings">âš™ï¸</button>
  </div>
</nav>

<div class="overlay" id="lockOverlay" style="display:block">
  <div class="modal" style="max-width:520px">
    <div style="text-align:center">
      <img src="icon.png" alt="" style="width:92px;height:92px;border-radius:28px;box-shadow:var(--shadow2)"/>
      <div style="font-weight:1000;font-size:20px;margin-top:10px">Hedra Teacher Edition</div>
      <div class="hint" id="lockHint">Ø£Ø¯Ø®Ù„ PIN (4 Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ Ø£ÙƒØ«Ø±)</div>
    </div>
    <div class="hr"></div>
    <label for="pinInput">PIN</label>
    <input id="pinInput" inputmode="numeric" autocomplete="off" placeholder="â€¢â€¢â€¢â€¢" />
    <div class="rowWrap noPrint" style="margin-top:10px">
      <button class="btn small ghost" id="roleAdmin">Ù…Ø¯ÙŠØ±</button>
      <button class="btn small ghost" id="roleAssistant">Ù…Ø³Ø§Ø¹Ø¯</button>
      <button class="btn small ghost" id="roleView">Ø¹Ø±Ø¶ ÙÙ‚Ø·</button>
    </div>
    <div class="rowWrap noPrint" style="margin-top:10px">
      <button class="btn small royal" id="btnUnlock">ÙØªØ­</button>
      <button class="btn small ghost" id="btnLockClear">Ù…Ø³Ø­</button>
    </div>
    <div class="hr"></div>
    <div class="hint">Ù†Ø³Ø®Ø© ØªØ¬Ø§Ø±ÙŠØ©: Ø¥ÙŠØµØ§Ù„Ø§Øª + ØªØ¯Ù‚ÙŠÙ‚ + Ø£Ø±Ø´ÙØ© + ØªØµØ¯ÙŠØ± Ù…Ø´ÙÙ‘Ø± + Ù…Ù†Ø¹ Ø§Ù„Ø®ØµÙ… Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹.</div>
  </div>
</div>

<div class="overlay" id="payOverlay">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div>
        <div style="font-weight:1000" id="payTitle">â€”</div>
        <div class="hint" id="paySub">â€”</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap" class="noPrint">
        <button class="btn small ghost" id="btnPayReceipt">ğŸ§¾ Ø¥ÙŠØµØ§Ù„</button>
        <button class="btn small ghost" id="btnPayPrint">ğŸ–¨</button>
        <button class="btn small ghost" id="btnPayClose">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
    <div class="hr"></div>
    <div id="payBody"></div>
    <div class="hr"></div>
    <div class="rowWrap noPrint" id="payBtns">
      <button class="btn small royal" id="btnPaySet">âœ ØªØ¹Ø¯ÙŠÙ„</button>
      <button class="btn small ghost" id="btnPayAdd">ï¼‹ Ø¥Ø¶Ø§ÙØ©</button>
      <button class="btn small ghost" id="btnPayMinus">âˆ’ Ø®ØµÙ…</button>
    </div>
    <div class="rowWrap noPrint" id="payAmountWrap" style="display:none;margin-top:10px">
      <div style="flex:2;min-width:220px">
        <label id="payAmountLabel">Ø§Ù„Ù…Ø¨Ù„Øº</label>
        <input id="payAmount" type="number" step="1" />
      </div>
      <div style="flex:1;min-width:160px;align-self:flex-end">
        <button class="btn small royal" id="btnPayApply">âœ… ØªØ·Ø¨ÙŠÙ‚</button>
      </div>
    </div>
    <div class="hr"></div>
    <label for="payNote">Ù…Ù„Ø§Ø­Ø¸Ø©</label>
    <input id="payNote" />
    <div class="rowWrap noPrint" style="margin-top:10px">
      <button class="btn small royal" id="btnPaySaveNote">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
    <div class="hr"></div>
    <div class="hint">Ø§Ù„Ø­Ø¶ÙˆØ±/Ø§Ù„ØºÙŠØ§Ø¨:</div>
    <div class="list" id="attList"></div>
  </div>
</div>

<div class="overlay" id="bulkOverlay"><div class="modal">
  <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
    <div><div style="font-weight:1000">ğŸ“¥ Ø¥Ù†Ø´Ø§Ø¡ Ø­ØµØµ Ù‚Ø¯ÙŠÙ…Ø©</div><div class="hint">Ø§Ø®ØªÙŠØ§Ø± Ù†Ø·Ø§Ù‚ + Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (0=Ø§Ù„Ø£Ø­Ø¯ â€¦ 6=Ø§Ù„Ø³Ø¨Øª).</div></div>
    <button class="btn small ghost noPrint" id="btnBulkClose">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
  <div class="hr"></div>
  <div class="rowWrap">
    <div><label>Ù…Ù†</label><input id="bulkFrom" type="date"></div>
    <div><label>Ø¥Ù„Ù‰</label><input id="bulkTo" type="date"></div>
  </div>
  <div class="hr"></div>
  <div class="rowWrap" style="gap:8px">
    <label style="display:flex;gap:8px;align-items:center"><input class="dow" type="checkbox" value="0">Ø§Ù„Ø£Ø­Ø¯</label>
    <label style="display:flex;gap:8px;align-items:center"><input class="dow" type="checkbox" value="1">Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</label>
    <label style="display:flex;gap:8px;align-items:center"><input class="dow" type="checkbox" value="2">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</label>
    <label style="display:flex;gap:8px;align-items:center"><input class="dow" type="checkbox" value="3">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</label>
    <label style="display:flex;gap:8px;align-items:center"><input class="dow" type="checkbox" value="4">Ø§Ù„Ø®Ù…ÙŠØ³</label>
    <label style="display:flex;gap:8px;align-items:center"><input class="dow" type="checkbox" value="5">Ø§Ù„Ø¬Ù…Ø¹Ø©</label>
    <label style="display:flex;gap:8px;align-items:center"><input class="dow" type="checkbox" value="6">Ø§Ù„Ø³Ø¨Øª</label>
  </div>
  <div class="hr"></div>
  <button class="btn small royal noPrint" id="btnBulkApply">âœ… Ø¥Ù†Ø´Ø§Ø¡</button>
</div></div>

<div class="overlay" id="auditOverlay"><div class="modal">
  <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
    <div><div style="font-weight:1000">ğŸ§¾ Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</div><div class="hint">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø© (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·).</div></div>
    <div class="noPrint" style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn small ghost" id="btnAuditCSV">â¬† CSV</button>
      <button class="btn small ghost" id="btnAuditClose">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
  <div class="hr"></div>
  <pre id="auditText" class="hint" style="white-space:pre-wrap;margin:0">â€”</pre>
</div></div>

<div class="overlay" id="rcOverlay"><div class="modal">
  <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
    <div><div style="font-weight:1000">ğŸ§¾ Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</div><div class="hint">Ø·Ø¨Ø§Ø¹Ø© + CSV.</div></div>
    <div class="noPrint" style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn small ghost" id="btnRcCSV">â¬† CSV</button>
      <button class="btn small ghost" id="btnRcClose">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
  <div class="hr"></div>
  <div id="rcList"></div>
</div></div>

<div class="toast" id="toast"></div>

<script>
(() => {
  const BUILD="20260214015150";
  const ROLE={ADMIN:"admin",ASSISTANT:"assistant",VIEW:"view"};

  // utils
  const $=(id)=>document.getElementById(id);
  const round2=(n)=>Math.round((Number(n||0))*100)/100;
  const isoYMD=(d=new Date())=>{ const x=new Date(d); x.setHours(0,0,0,0); return x.toISOString().slice(0,10); };
  const ymdFromTs=(ts)=>{ const d=new Date(ts); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); };
  const fmtDMY=(ymd)=>{ const d=new Date(ymd+"T12:00:00"); return String(d.getDate()).padStart(2,"0")+"/"+String(d.getMonth()+1).padStart(2,"0")+"/"+d.getFullYear(); };
  const todayText=()=>new Date().toLocaleDateString("ar-EG",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
  const escapeHtml=(s)=>String(s??"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
  const uid=(p="id")=>`${p}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`;
  const downloadText=(name,text,mime="text/plain;charset=utf-8")=>{ const b=new Blob([text],{type:mime}); const a=document.createElement("a"); a.href=URL.createObjectURL(b); a.download=name; a.click(); URL.revokeObjectURL(a.href); };
  const toast=(msg)=>{ const t=$("toast"); t.textContent=msg; t.style.display="block"; clearTimeout(toast._t); toast._t=setTimeout(()=>t.style.display="none",2200); };

  // crypto (WebCrypto) for vault + export
  const KDF_ITERS=200000;
  const bufToB64=(buf)=>{ const b=new Uint8Array(buf); let bin=""; for(let i=0;i<b.length;i++) bin+=String.fromCharCode(b[i]); return btoa(bin); };
  const b64ToBuf=(b64)=>{ const bin=atob(b64); const b=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) b[i]=bin.charCodeAt(i); return b.buffer; };
  async function deriveKeyFromPIN(pin,saltBuf){
    const enc=new TextEncoder().encode(String(pin||""));
    const base=await crypto.subtle.importKey("raw", enc, {name:"PBKDF2"}, false, ["deriveKey"]);
    return crypto.subtle.deriveKey({name:"PBKDF2", salt:saltBuf, iterations:KDF_ITERS, hash:"SHA-256"}, base, {name:"AES-GCM", length:256}, false, ["encrypt","decrypt"]);
  }
  async function encryptJSON(key,obj){
    const iv=crypto.getRandomValues(new Uint8Array(12));
    const plain=new TextEncoder().encode(JSON.stringify(obj));
    const ct=await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, plain);
    return {ivB64:bufToB64(iv.buffer), ctB64:bufToB64(ct)};
  }
  async function decryptJSON(key,ivB64,ctB64){
    const iv=new Uint8Array(b64ToBuf(ivB64));
    const ct=b64ToBuf(ctB64);
    const plainBuf=await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, ct);
    return JSON.parse(new TextDecoder().decode(plainBuf));
  }

  // schema
  const newCycle=()=>({id:uid("c"), createdAtISO:new Date().toISOString(), sessions:[], attendance:{}, txs:[], notes:{}, carry:{}, receipts:[], closed:false});
  const makeEmptyDB=()=>{
    const g={id:uid("g"), name:"Ù…Ø¬Ù…ÙˆØ¹Ø© 1", cycleLen:8, students:[], cycles:[newCycle()], audit:[]};
    return {settings:{currentGroupId:g.id, chargeMode:"perSessions", brandName:"", brandPhone:"", receiptSeq:1, pinFailCount:0, pinLockUntil:0, saltB64:""}, groups:[g]};
  };
  function ensureDefaults(db){
    if(!db||typeof db!=="object") db=makeEmptyDB();
    db.settings=db.settings||{};
    db.groups=Array.isArray(db.groups)?db.groups:[];
    db.settings.chargeMode = (db.settings.chargeMode==="byAttendance") ? "byAttendance" : "perSessions";
    db.settings.brandName = String(db.settings.brandName||"");
    db.settings.brandPhone = String(db.settings.brandPhone||"");
    db.settings.receiptSeq = Number(db.settings.receiptSeq||1);
    db.settings.pinFailCount = Number(db.settings.pinFailCount||0);
    db.settings.pinLockUntil = Number(db.settings.pinLockUntil||0);
    if(db.groups.length===0){ const f=makeEmptyDB(); db.groups=f.groups; db.settings.currentGroupId=f.settings.currentGroupId; }
    db.groups.forEach(g=>{
      g.id=g.id||uid("g");
      g.name=String(g.name||"Ù…Ø¬Ù…ÙˆØ¹Ø©");
      g.cycleLen=Math.max(1,Number(g.cycleLen||8));
      g.students=Array.isArray(g.students)?g.students:[];
      g.cycles=Array.isArray(g.cycles)&&g.cycles.length?g.cycles:[newCycle()];
      g.audit=Array.isArray(g.audit)?g.audit:[];
      g.students.forEach(s=>{
        s.id=s.id||uid("s");
        s.name=String(s.name||"Ø·Ø§Ù„Ø¨");
        s.price=Number(s.price||0);
        s.paused=!!s.paused;
        s.archived=!!s.archived;
        s.discountType=["none","fixed","percent","exempt"].includes(s.discountType)?s.discountType:"none";
        s.discountValue=Number(s.discountValue||0);
      });
      g.cycles.forEach(c=>{
        c.id=c.id||uid("c");
        c.sessions=Array.isArray(c.sessions)?c.sessions:[];
        c.attendance=(c.attendance&&typeof c.attendance==="object")?c.attendance:{};
        c.txs=Array.isArray(c.txs)?c.txs:[];
        c.notes=(c.notes&&typeof c.notes==="object")?c.notes:{};
        c.carry=(c.carry&&typeof c.carry==="object")?c.carry:{};
        c.receipts=Array.isArray(c.receipts)?c.receipts:[];
        c.closed=!!c.closed;
      });
    });
    if(!db.groups.some(g=>g.id===db.settings.currentGroupId)) db.settings.currentGroupId=db.groups[0].id;
    return db;
  }

  // calc
  const curGroup=()=>db.groups.find(g=>g.id===db.settings.currentGroupId)||db.groups[0];
  const curCycle=(g)=>g.cycles[g.cycles.length-1];
  const sessionsCount=(c)=>(c.sessions||[]).length;
  const cycleLen=(g)=>Math.max(1,Number(g.cycleLen||8));
  function effectivePrice(s){
    if(s.paused||s.archived) return 0;
    const base=Math.max(0,Number(s.price||0));
    const t=s.discountType||"none";
    const v=Math.max(0,Number(s.discountValue||0));
    if(t==="exempt") return 0;
    if(t==="fixed") return Math.max(0, base-v);
    if(t==="percent"){ const p=Math.max(0,Math.min(100,v)); return Math.max(0, base*(1-p/100)); }
    return base;
  }
  const perSession=(g,s)=>round2(effectivePrice(s)/cycleLen(g));
  function attendanceCount(c,sid){
    let n=0;
    for(const ss of c.sessions||[]){ const map=c.attendance?.[ss.id]||{}; if(map[sid]==="P") n++; }
    return n;
  }
  function dueSoFar(g,c,s){
    const mode=db.settings.chargeMode||"perSessions";
    if(mode==="byAttendance") return round2(attendanceCount(c,s.id)*perSession(g,s));
    return round2(sessionsCount(c)*perSession(g,s));
  }
  const carry=(c,sid)=>round2(Number(c.carry?.[sid]||0));
  const paid=(c,sid)=>Math.max(0, round2((c.txs||[]).filter(t=>t.sid===sid).reduce((a,t)=>a+Number(t.amount||0),0)));
  function totals(g,c,s){
    const sub=dueSoFar(g,c,s);
    const prev=carry(c,s.id);
    const total=round2(sub+prev);
    const p=paid(c,s.id);
    return {sub,prev,total,paid:p,remaining:round2(total-p)};
  }
  function groupTotals(g,c){
    let total=0, paidSum=0, rem=0;
    g.students.filter(s=>!s.archived).forEach(s=>{ const t=totals(g,c,s); total+=t.total; paidSum+=t.paid; rem+=t.remaining; });
    return {total:round2(total), paid:round2(paidSum), remaining:round2(rem)};
  }

  // audit + receipts
  const auditAdd=(action,meta={})=>{ const g=curGroup(); g.audit.push({id:uid("aud"), tsISO:new Date().toISOString(), role, action, meta}); if(g.audit.length>2000) g.audit.splice(0,g.audit.length-2000); };
  const auditCSV=()=>{
    const rows=[["tsISO","role","action","meta"]];
    db.groups.forEach(g=>(g.audit||[]).forEach(a=>rows.push([a.tsISO,a.role,a.action,JSON.stringify(a.meta||{})])));
    return rows.map(r=>r.map(x=>`"${String(x??"").replaceAll('"','""')}"`).join(",")).join("\n");
  };
  function makeReceipt(g,c,s,amount,note){
    const seq=Number(db.settings.receiptSeq||1);
    db.settings.receiptSeq=seq+1;
    const rid=`R-${String(seq).padStart(6,"0")}`;
    const t=totals(g,c,s);
    const rc={id:uid("rc"), rid, tsISO:new Date().toISOString(), groupId:g.id, cycleId:c.id, studentId:s.id, studentName:s.name, amount:Number(amount||0), note:String(note||"").trim(), snapshot:{total:t.total, paid:t.paid, remaining:t.remaining}};
    c.receipts=c.receipts||[]; c.receipts.push(rc);
    auditAdd("receipt.created",{rid,studentId:s.id,amount:rc.amount});
    return rc;
  }
  const allReceipts=()=>{
    const out=[];
    db.groups.forEach(g=>g.cycles.forEach(c=>(c.receipts||[]).forEach(r=>out.push({g,c,r}))));
    out.sort((a,b)=>new Date(b.r.tsISO)-new Date(a.r.tsISO));
    return out;
  };
  const receiptsCSV=()=>{
    const rows=[["rid","tsISO","group","student","amount","note","total","paid","remaining"]];
    allReceipts().forEach(x=>rows.push([x.r.rid,x.r.tsISO,x.g.name,x.r.studentName,x.r.amount,x.r.note,x.r.snapshot.total,x.r.snapshot.paid,x.r.snapshot.remaining]));
    return rows.map(r=>r.map(x=>`"${String(x??"").replaceAll('"','""')}"`).join(",")).join("\n");
  };
  const receiptPrintHTML=(rc,groupName)=>{
    const brand=escapeHtml(db.settings.brandName||"");
    const phone=escapeHtml(db.settings.brandPhone||"");
    return `
    <div style="font-family:Tahoma,Arial;direction:rtl">
      <h2 style="margin:0">${brand||"â€”"}</h2>
      <div style="opacity:.7">${phone||"â€”"}</div>
      <hr/>
      <div><b>Ø¥ÙŠØµØ§Ù„:</b> ${escapeHtml(rc.rid)}</div>
      <div><b>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</b> ${escapeHtml(groupName)}</div>
      <div><b>Ø§Ù„Ø·Ø§Ù„Ø¨:</b> ${escapeHtml(rc.studentName)}</div>
      <div><b>Ø§Ù„Ù…Ø¨Ù„Øº:</b> ${escapeHtml(String(rc.amount))}</div>
      <div><b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> ${escapeHtml(rc.note||"â€”")}</div>
      <hr/>
      <div><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</b> ${escapeHtml(String(rc.snapshot.total))}</div>
      <div><b>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</b> ${escapeHtml(String(rc.snapshot.paid))}</div>
      <div><b>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</b> ${escapeHtml(String(rc.snapshot.remaining))}</div>
      <hr/>
      <small>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§ (Offline).</small>
    </div>`;
  };

  // vault (encrypted at rest)
  const DB_KEY="hedra_v6_teacher_vault";
  let role=ROLE.ADMIN;
  let db=ensureDefaults(makeEmptyDB());
  let sessionKey=null, saltB64=null;

  const hasVault=()=>!!localStorage.getItem(DB_KEY);
  const isUnlocked=()=>sessionStorage.getItem("hedra_unlocked")==="1";
  const setUnlocked=(on)=>{ sessionStorage.setItem("hedra_unlocked", on?"1":"0"); touch(); };
  const touch=()=>sessionStorage.setItem("hedra_last_active", String(Date.now()));
  async function save(){
    if(!sessionKey) return;
    const packed=await encryptJSON(sessionKey, db);
    localStorage.setItem(DB_KEY, JSON.stringify({v:2,kdf:{name:"PBKDF2",hash:"SHA-256",iters:KDF_ITERS}, saltB64, ...packed}));
  }
  async function setupNew(pin){
    const p=String(pin||"").trim(); if(p.length<4) throw new Error("PIN_SHORT");
    const salt=crypto.getRandomValues(new Uint8Array(16));
    saltB64=bufToB64(salt.buffer);
    sessionKey=await deriveKeyFromPIN(p, salt.buffer);
    db=ensureDefaults(makeEmptyDB());
    await save();
  }
  async function load(pin){
    const raw=localStorage.getItem(DB_KEY); if(!raw) return null;
    const v=JSON.parse(raw);
    const key=await deriveKeyFromPIN(String(pin||"").trim(), b64ToBuf(v.saltB64));
    const loaded=ensureDefaults(await decryptJSON(key, v.ivB64, v.ctB64));
    sessionKey=key; saltB64=v.saltB64;
    db=loaded;
    return db;
  }

  // UI nav
  const pages={run:$("pageRun"),manage:$("pageManage"),dashboard:$("pageDashboard"),settings:$("pageSettings")};
  function showTab(key){
    Object.entries(pages).forEach(([k,el])=>el.style.display=(k===key)?"":"none");
    document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===key));
    render();
  }
  document.querySelectorAll(".tab").forEach(t=>t.addEventListener("click",()=>showTab(t.dataset.tab)));

  function refreshGroupSelects(){
    ["selGroupRun","selGroupManage","selGroupSettings"].forEach(id=>{
      const sel=$(id); sel.innerHTML="";
      db.groups.forEach(g=>{ const o=document.createElement("option"); o.value=g.id; o.textContent=g.name; sel.appendChild(o); });
      sel.value=db.settings.currentGroupId;
      sel.onchange=async (e)=>{ db.settings.currentGroupId=e.target.value; await save(); render(); };
    });
  }
  function renderTop(){
    $("topDate").textContent=todayText();
    $("topRole").textContent = role===ROLE.ADMIN ? "Ø§Ù„Ø¯ÙˆØ±: Ù…Ø¯ÙŠØ±" : role===ROLE.ASSISTANT ? "Ø§Ù„Ø¯ÙˆØ±: Ù…Ø³Ø§Ø¹Ø¯" : "Ø§Ù„Ø¯ÙˆØ±: Ø¹Ø±Ø¶ ÙÙ‚Ø·";
    const g=curGroup(); const c=curCycle(g);
    $("topSession").textContent=`Ø§Ù„Ø­ØµØ©: ${Math.min(sessionsCount(c)+1,cycleLen(g))} / ${cycleLen(g)}`;
    $("topCycle").textContent=`Ø§Ù„Ø¯ÙˆØ±Ø©: ${fmtDMY(isoYMD(new Date(c.createdAtISO||Date.now())))} â†’ â€”`;
    $("btnExport").style.display = role===ROLE.ADMIN ? "inline-flex":"none";
    $("btnImport").style.display = role===ROLE.ADMIN ? "inline-flex":"none";
  }

  function renderRun(){
    const g=curGroup(); const c=curCycle(g);
    const wrap=$("runList"); wrap.innerHTML="";
    const list=g.students.filter(s=>!s.archived).sort((a,b)=>a.name.localeCompare(b.name,"ar"));
    if(!list.length){ wrap.innerHTML='<div class="hint">Ø£Ø¶Ù Ø·Ù„Ø§Ø¨ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.</div>'; return; }
    list.forEach((s,i)=>{
      const row=document.createElement("div"); row.className="row";
      row.innerHTML=`<div class="left"><div class="num">${i+1}</div><div><div class="name">${escapeHtml(s.name)}</div><div class="mini">Ø§Ø¶ØºØ· Ù„Ù„Ø¯ÙØ¹/Ø§Ù„Ø­Ø¶ÙˆØ±</div></div></div>
        <div style="display:flex;gap:8px"><button class="btn small royal noPrint">ğŸ’³</button><button class="moreBtn noPrint">â‹¯</button></div>`;
      row.querySelector(".btn").onclick=()=>openPay(g,c,s);
      row.querySelector(".moreBtn").onclick=()=>openPay(g,c,s);
      wrap.appendChild(row);
    });
  }

  $("qManage").addEventListener("input",()=>renderManage());
  function renderManage(){
    const q=String($("qManage").value||"").trim().toLowerCase();
    const wrap=$("manageList"); wrap.innerHTML="";
    if(q){
      const hits=[];
      db.groups.forEach(gr=>{
        const cy=curCycle(gr);
        gr.students.filter(s=>!s.archived).forEach(s=>{ if(s.name.toLowerCase().includes(q)) hits.push({gr,cy,s,t:totals(gr,cy,s)}); });
      });
      if(!hits.length){ wrap.innerHTML='<div class="hint">Ù„Ø§ Ù†ØªØ§Ø¦Ø¬.</div>'; return; }
      hits.sort((a,b)=>b.t.remaining-a.t.remaining);
      hits.slice(0,80).forEach(h=>{
        const row=document.createElement("div"); row.className="row";
        row.innerHTML=`<div class="left"><div class="num">ğŸ”</div><div><div class="name">${escapeHtml(h.s.name)}</div>
          <div class="mini">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: <b>${escapeHtml(h.gr.name)}</b> â€¢ ${role===ROLE.ADMIN?('Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span class="mono">'+h.t.remaining+'</span>'):'Ù…ØªØ£Ø®Ø±'}</div></div></div>
          <button class="moreBtn noPrint">Ø¹Ø±Ø¶</button>`;
        row.querySelector("button").onclick=()=>{ db.settings.currentGroupId=h.gr.id; save().then(()=>{render(); openPay(h.gr,h.cy,h.s);}); };
        wrap.appendChild(row);
      });
      return;
    }
    const g=curGroup(); const c=curCycle(g);
    const gt=groupTotals(g,c);
    wrap.innerHTML += `<div class="row"><div class="left"><div class="num">ğŸ“Œ</div><div><div class="name">Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</div>
      <div class="mini">${role===ROLE.ADMIN?('Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span class="mono">'+gt.total+'</span> â€¢ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: <span class="mono">'+gt.paid+'</span> â€¢ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span class="mono">'+gt.remaining+'</span>'):'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ù…Ø®ÙÙŠØ©'}</div></div></div>
      <button class="moreBtn noPrint" onclick="window.print()">ğŸ–¨</button></div>`;
    g.students.filter(s=>!s.archived).sort((a,b)=>a.name.localeCompare(b.name,"ar")).forEach(s=>{
      const t=totals(g,c,s);
      const row=document.createElement("div"); row.className="row";
      row.innerHTML=`<div class="left"><div class="num">ğŸ§¾</div><div><div class="name">${escapeHtml(s.name)}</div>
        <div class="mini">${role===ROLE.ADMIN?('Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span class="mono">'+t.remaining+'</span>'):'â€”'}</div></div></div>
        <button class="moreBtn noPrint">Ø¹Ø±Ø¶</button>`;
      row.querySelector("button").onclick=()=>openPay(g,c,s);
      wrap.appendChild(row);
    });
  }

  function renderDashboard(){
    const g=curGroup(); const c=curCycle(g);
    const cards=$("dashCards"), month=$("dashMonth"), late=$("dashLate");
    cards.innerHTML=""; month.innerHTML=""; late.innerHTML="";
    const gt=groupTotals(g,c);
    const items=[
      ["ğŸ‘¥","Ø§Ù„Ø·Ù„Ø§Ø¨", g.students.filter(s=>!s.archived).length],
      ["ğŸ—“","Ø§Ù„Ø­ØµØµ", `${sessionsCount(c)}/${cycleLen(g)}`],
      ["âœ…","Ø§Ù„Ø­Ø¶ÙˆØ±", g.students.filter(s=>!s.archived).reduce((a,s)=>a+attendanceCount(c,s.id),0)]
    ];
    if(role===ROLE.ADMIN) items.push(["ğŸ’°","Ø§Ù„Ù…Ø¯ÙÙˆØ¹", gt.paid],["ğŸ“Œ","Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ", gt.remaining]);
    items.forEach(x=>{
      const el=document.createElement("div"); el.className="row"; el.style.flex="1";
      el.innerHTML=`<div class="left"><div class="num">${x[0]}</div><div><div class="name">${x[1]}</div><div class="mini mono">${x[2]}</div></div></div>`;
      cards.appendChild(el);
    });
    const m={};
    g.cycles.forEach(cc=>(cc.txs||[]).forEach(t=>{ const d=new Date(t.tsISO); const k=d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0"); m[k]=(m[k]||0)+Number(t.amount||0); }));
    const ks=Object.keys(m).sort().reverse();
    if(role!==ROLE.ADMIN) month.innerHTML='<div class="hint">Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù…Ø®ÙÙŠ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹.</div>';
    else if(!ks.length) month.innerHTML='<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¯ÙØ¹ Ø¨Ø¹Ø¯.</div>';
    else month.innerHTML='<table><thead><tr><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ø¯Ø®Ù„</th></tr></thead><tbody>'+ks.map(k=>`<tr><td>${k}</td><td class="mono">${m[k].toFixed(2).replace(".00","")}</td></tr>`).join("")+'</tbody></table>';

    const list=g.students.filter(s=>!s.archived).map(s=>({s,t:totals(g,c,s)})).filter(x=>x.t.remaining>0).sort((a,b)=>b.t.remaining-a.t.remaining).slice(0,10);
    if(!list.length) late.innerHTML='<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØªØ£Ø®Ø±Ø§Øª ÙˆØ§Ø¶Ø­Ø©.</div>';
    else list.forEach((x,i)=>{
      const r=document.createElement("div"); r.className="row";
      r.innerHTML=`<div class="left"><div class="num">${i+1}</div><div><div class="name">${escapeHtml(x.s.name)}</div><div class="mini">${role===ROLE.ADMIN?('Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span class="mono">'+x.t.remaining+'</span>'):'Ù…ØªØ£Ø®Ø±'}</div></div></div>
      <button class="moreBtn noPrint">Ø¹Ø±Ø¶</button>`;
      r.querySelector("button").onclick=()=>openPay(g,c,x.s);
      late.appendChild(r);
    });
  }

  function renderSettings(){
    const g=curGroup();
    $("cycleLen").value=String(g.cycleLen||8);
    $("chargeMode").value=db.settings.chargeMode||"perSessions";
    $("brandName").value=db.settings.brandName||"";
    $("brandPhone").value=db.settings.brandPhone||"";
    const wrap=$("studentsList"); wrap.innerHTML="";
    g.students.filter(s=>!s.archived).sort((a,b)=>a.name.localeCompare(b.name,"ar")).forEach(s=>{
      const row=document.createElement("div"); row.className="row";
      row.innerHTML=`<div class="left"><div class="num">ğŸ‘¤</div><div><div class="name">${escapeHtml(s.name)}</div>
        <div class="mini">Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆØ±Ø©: <span class="mono">${Number(s.price||0)}</span> â€¢ Ø®ØµÙ…: <span class="mono">${escapeHtml(s.discountType||"none")}</span></div></div></div>
        <button class="moreBtn noPrint">â‹¯</button>`;
      row.querySelector("button").onclick=()=>editStudent(g,s);
      wrap.appendChild(row);
    });
  }

  async function render(){
    renderTop();
    refreshGroupSelects();
    if(pages.run.style.display!=="none") renderRun();
    if(pages.manage.style.display!=="none") renderManage();
    if(pages.dashboard.style.display!=="none") renderDashboard();
    if(pages.settings.style.display!=="none") renderSettings();
  }

  $("btnDashPrint").onclick=()=>window.print();

  // sessions
  function addSessionWithDate(g,c,ymd){
    if(sessionsCount(c)>=cycleLen(g)){ toast("Ø§ÙƒØªÙ…Ù„Øª Ø­ØµØµ Ø§Ù„Ø¯ÙˆØ±Ø©"); return false; }
    if(c.sessions.some(s=>ymdFromTs(s.tsISO)===ymd)){ toast("ØªØ§Ø±ÙŠØ® Ù…ÙƒØ±Ø±"); return false; }
    c.sessions.push({id:uid("ss"), tsISO:new Date(ymd+"T12:00:00").toISOString()});
    c.sessions.sort((a,b)=>new Date(a.tsISO)-new Date(b.tsISO));
    auditAdd("session.add",{groupId:g.id, ymd});
    return true;
  }
  $("btnAddSession").onclick=async ()=>{
    if(role!==ROLE.ADMIN) return toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
    const g=curGroup(); const c=curCycle(g);
    const y=prompt("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­ØµØ© (YYYY-MM-DD)", isoYMD(new Date())); if(!y) return;
    if(!/^\d{4}-\d{2}-\d{2}$/.test(y)) return alert("ØµÙŠØºØ© Ø®Ø·Ø£");
    if(addSessionWithDate(g,c,y)){ await save(); toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©"); render(); }
  };
  $("btnRemoveSession").onclick=async ()=>{
    if(role!==ROLE.ADMIN) return toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
    const g=curGroup(); const c=curCycle(g);
    if(!c.sessions.length) return toast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ");
    const last=c.sessions[c.sessions.length-1];
    if(!confirm("Ø­Ø°Ù Ø¢Ø®Ø± Ø­ØµØ©ØŸ "+fmtDMY(ymdFromTs(last.tsISO)))) return;
    c.sessions.pop();
    auditAdd("session.remove",{groupId:g.id, ymd:ymdFromTs(last.tsISO)});
    await save(); toast("ØªÙ… Ø§Ù„Ø­Ø°Ù"); render();
  };

  // bulk sessions (getDay: 0 Sunday .. 6 Saturday âœ…)
  $("btnBulk").onclick=()=>{ if(role!==ROLE.ADMIN) return toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­"); $("bulkFrom").value=isoYMD(new Date(Date.now()-30*86400000)); $("bulkTo").value=isoYMD(new Date()); document.querySelectorAll(".dow").forEach(x=>x.checked=false); $("bulkOverlay").style.display="block"; };
  $("btnBulkClose").onclick=()=>$("bulkOverlay").style.display="none";
  $("btnBulkApply").onclick=async ()=>{
    const g=curGroup(); const c=curCycle(g);
    const from=$("bulkFrom").value, to=$("bulkTo").value;
    const dows=[...document.querySelectorAll(".dow")].filter(x=>x.checked).map(x=>Number(x.value));
    if(!from||!to) return alert("Ø§Ø®ØªØ± Ù…Ù†/Ø¥Ù„Ù‰");
    if(new Date(from)>new Date(to)) return alert("Ù…Ù† Ø£ÙƒØ¨Ø± Ù…Ù† Ø¥Ù„Ù‰");
    if(!dows.length) return alert("Ø§Ø®ØªØ± ÙŠÙˆÙ…");
    let d=new Date(from+"T12:00:00"), end=new Date(to+"T12:00:00"), added=0;
    while(d<=end){
      if(dows.includes(d.getDay())){
        const y=d.toISOString().slice(0,10);
        if(addSessionWithDate(g,c,y)) added++;
        if(sessionsCount(c)>=cycleLen(g)) break;
      }
      d.setDate(d.getDate()+1);
    }
    await save();
    $("bulkOverlay").style.display="none";
    toast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ "+added+" Ø­ØµØµ");
    render();
  };

  // groups / students
  $("btnAddGroup").onclick=async ()=>{
    if(role!==ROLE.ADMIN) return toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
    const name=(prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©")||"").trim(); if(!name) return;
    if(db.groups.some(g=>g.name.trim().toLowerCase()===name.toLowerCase())) return alert("Ù…ÙˆØ¬ÙˆØ¯Ø©");
    db.groups.push({id:uid("g"), name, cycleLen:8, students:[], cycles:[newCycle()], audit:[]});
    db.settings.currentGroupId=db.groups[db.groups.length-1].id;
    auditAdd("group.add",{name});
    await save(); toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©"); render();
  };
  $("btnAddStudent").onclick=async ()=>{
    if(role!==ROLE.ADMIN) return toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
    const g=curGroup();
    const name=String($("newStudentName").value||"").trim(); if(!name) return;
    if(g.students.some(s=>!s.archived && s.name.trim().toLowerCase()===name.toLowerCase())) return alert("Ù…ÙˆØ¬ÙˆØ¯");
    g.students.push({id:uid("s"), name, price:0, paused:false, archived:false, discountType:"none", discountValue:0});
    $("newStudentName").value="";
    auditAdd("student.add",{groupId:g.id,name});
    await save(); toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨"); render();
  };
  $("cycleLen").onchange=async (e)=>{ if(role!==ROLE.ADMIN) return; const g=curGroup(); g.cycleLen=Number(e.target.value||8); auditAdd("settings.cycleLen",{value:g.cycleLen}); await save(); render(); };
  $("chargeMode").onchange=async (e)=>{ if(role!==ROLE.ADMIN) return; db.settings.chargeMode=e.target.value||"perSessions"; auditAdd("settings.chargeMode",{value:db.settings.chargeMode}); await save(); toast("ØªÙ… Ø§Ù„Ø­ÙØ¸"); render(); };
  $("brandName").onchange=async (e)=>{ db.settings.brandName=String(e.target.value||""); await save(); };
  $("brandPhone").onchange=async (e)=>{ db.settings.brandPhone=String(e.target.value||""); await save(); };

  $("btnNewCycle").onclick=async ()=>{
    if(role!==ROLE.ADMIN) return toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
    const g=curGroup(); const c=curCycle(g);
    if(!confirm("ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØŸ")) return;
    const carryMap={};
    g.students.filter(s=>!s.archived).forEach(s=>{ const t=totals(g,c,s); if(Math.abs(t.remaining)>0.0001) carryMap[s.id]=t.remaining; });
    c.closed=true;
    const nc=newCycle(); nc.carry=carryMap;
    g.cycles.push(nc);
    auditAdd("cycle.new",{groupId:g.id});
    await save(); toast("ØªÙ… ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©"); render();
  };

  function editStudent(g,s){
    if(role!==ROLE.ADMIN) return toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
    const name=(prompt("Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨", s.name)||"").trim(); if(!name) return;
    const price=Number(prompt("Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆØ±Ø©", String(s.price||0))||"0");
    const discType=(prompt("Ù†ÙˆØ¹ Ø§Ù„Ø®ØµÙ…: none / fixed / percent / exempt", s.discountType||"none")||"none").trim();
    const discVal=Number(prompt("Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ… (0 Ù„Ùˆ none/exempt)", String(s.discountValue||0))||"0");
    const paused=confirm("Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ (Ù…ÙˆØ§ÙÙ‚=Ù†Ø¹Ù…)");
    const archive=confirm("Ø£Ø±Ø´ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ (Ù…ÙˆØ§ÙÙ‚=Ù†Ø¹Ù…)");
    s.name=name; s.price=price; s.discountType=discType; s.discountValue=discVal; s.paused=paused; if(archive) s.archived=true;
    auditAdd(archive?"student.archive":"student.update",{studentId:s.id});
    save().then(()=>{ toast("ØªÙ… Ø§Ù„Ø­ÙØ¸"); render(); });
  }

  // pay modal
  let payCtx=null, payMode=null;
  function openPay(g,c,s){
    $("payTitle").textContent=s.name;
    $("paySub").textContent=`${g.name} â€¢ Ø­ØµØµ ${sessionsCount(c)}/${cycleLen(g)}`;
    $("payNote").value=String(c.notes?.[s.id]||"");
    const t=totals(g,c,s);
    $("payBody").innerHTML = (role===ROLE.ADMIN)
      ? `<table><thead><tr><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th></tr></thead><tbody>
          <tr><td>Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td><td class="mono">${t.sub}</td></tr>
          <tr><td>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø±Ø­Ù‘Ù„</td><td class="mono">${t.prev}</td></tr>
          <tr><td><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</b></td><td class="mono"><b>${t.total}</b></td></tr>
          <tr><td>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</td><td class="mono">${t.paid}</td></tr>
          <tr><td><b>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</b></td><td class="mono"><b>${t.remaining}</b></td></tr>
        </tbody></table>`
      : `<div class="hint">Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ù…Ø®ÙÙŠØ© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±/ØºÙŠØ§Ø¨ ÙˆÙ…Ù„Ø§Ø­Ø¸Ø©.</div>`;
    renderAttendance(g,c,s);
    $("payBtns").style.display = (role===ROLE.ADMIN) ? "flex":"none";
    $("btnPayReceipt").style.display = (role===ROLE.ADMIN) ? "inline-flex":"none";
    $("payOverlay").style.display="block";
    payCtx={g,c,s};
  }
  function closePay(){ $("payOverlay").style.display="none"; $("payAmountWrap").style.display="none"; payMode=null; payCtx=null; }
  $("btnPayClose").onclick=closePay;
  $("btnPayPrint").onclick=()=>window.print();
  $("payOverlay").addEventListener("click",(e)=>{ if(e.target===$("payOverlay")) closePay(); });

  $("btnPaySet").onclick=()=>{ payMode="set"; $("payAmountLabel").textContent="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹"; $("payAmount").value=String(paid(payCtx.c,payCtx.s.id)); $("payAmountWrap").style.display="flex"; };
  $("btnPayAdd").onclick=()=>{ payMode="add"; $("payAmountLabel").textContent="Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº"; $("payAmount").value=""; $("payAmountWrap").style.display="flex"; };
  $("btnPayMinus").onclick=()=>{ payMode="minus"; $("payAmountLabel").textContent="Ø®ØµÙ… (ØªØµØ­ÙŠØ­)"; $("payAmount").value=""; $("payAmountWrap").style.display="flex"; };

  $("btnPayApply").onclick=async ()=>{
    if(!payCtx||!payMode) return;
    if(role!==ROLE.ADMIN) return toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
    const v=Number($("payAmount").value||0);
    const {g,c,s}=payCtx;
    if(payMode==="set") {
      c.txs=(c.txs||[]).filter(t=>t.sid!==s.id);
      if(v>0) c.txs.push({id:uid("tx"), sid:s.id, amount:v, tsISO:new Date().toISOString(), note:"(ØªØ¹Ø¯ÙŠÙ„)"});
      auditAdd("payment.set",{studentId:s.id,value:v});
    } else if(payMode==="add") {
      if(!(v>0)) return alert("Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±");
      c.txs.push({id:uid("tx"), sid:s.id, amount:v, tsISO:new Date().toISOString(), note:"(Ø¥Ø¶Ø§ÙØ©)"});
      auditAdd("payment.add",{studentId:s.id,value:v});
    } else {
      if(!(v>0)) return alert("Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±");
      const curPaid=paid(c,s.id);
      if(v>curPaid) return alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø®ØµÙ… Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ ("+curPaid+")");
      c.txs.push({id:uid("tx"), sid:s.id, amount:-v, tsISO:new Date().toISOString(), note:"(Ø®ØµÙ…)"});
      auditAdd("payment.minus",{studentId:s.id,value:v});
    }
    await save();
    $("payAmountWrap").style.display="none"; payMode=null;
    toast("ØªÙ… Ø§Ù„Ø­ÙØ¸");
    openPay(g,c,s);
    render();
  };

  $("btnPaySaveNote").onclick=async ()=>{
    if(!payCtx) return;
    if(role===ROLE.VIEW) return toast("Ø¹Ø±Ø¶ ÙÙ‚Ø·");
    const {c,s}=payCtx;
    c.notes=c.notes||{};
    c.notes[s.id]=String($("payNote").value||"").trim();
    auditAdd("note.save",{studentId:s.id});
    await save(); toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©");
  };

  $("btnPayReceipt").onclick=async ()=>{
    if(!payCtx) return;
    if(role!==ROLE.ADMIN) return toast("Ù„Ù„Ù€ Ù…Ø¯ÙŠØ± ÙÙ‚Ø·");
    const amt=Number(prompt("Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„", "0")||"0"); if(!(amt>0)) return;
    const note=prompt("Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)")||"";
    const {g,c,s}=payCtx;
    const rc=makeReceipt(g,c,s,amt,note);
    await save(); toast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ "+rc.rid);
    const w=window.open("","_blank");
    w.document.write("<meta charset='utf-8'><title>"+rc.rid+"</title>"+receiptPrintHTML(rc,g.name)+"<script>window.onload=()=>window.print();</script>");
    w.document.close();
  };

  function renderAttendance(g,c,s){
    const wrap=$("attList"); wrap.innerHTML="";
    if(!c.sessions.length){ wrap.innerHTML='<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ø¨Ø¹Ø¯.</div>'; return; }
    c.sessions.forEach(ss=>{
      const y=ymdFromTs(ss.tsISO);
      const val=c.attendance?.[ss.id]?.[s.id]||"";
      const label= val==="P" ? "Ø­Ø¶ÙˆØ± âœ…" : val==="A" ? "ØºÙŠØ§Ø¨ âŒ" : "â€”";
      const row=document.createElement("div"); row.className="row";
      row.innerHTML=`<div class="left"><div class="num">ğŸ—“</div><div><div class="name">${fmtDMY(y)}</div><div class="mini">${y}</div></div></div>
        <button class="btn small ghost noPrint">${label}</button>`;
      row.querySelector("button").onclick=async ()=>{
        if(role===ROLE.VIEW) return toast("Ø¹Ø±Ø¶ ÙÙ‚Ø·");
        c.attendance=c.attendance||{}; c.attendance[ss.id]=c.attendance[ss.id]||{};
        const cur=c.attendance[ss.id][s.id]||"";
        const next = cur==="P" ? "A" : cur==="A" ? "" : "P";
        if(!next) delete c.attendance[ss.id][s.id]; else c.attendance[ss.id][s.id]=next;
        auditAdd("attendance.toggle",{studentId:s.id, ymd:y, val:next||"â€”"});
        await save();
        openPay(g,c,s);
        render();
      };
      wrap.appendChild(row);
    });
  }

  // audit / receipts overlays
  const closeOverlay=(id)=>$(id).style.display="none";
  const openOverlay=(id)=>$(id).style.display="block";

  $("btnAudit").onclick=()=>{
    if(role!==ROLE.ADMIN) return toast("Ù„Ù„Ù€ Ù…Ø¯ÙŠØ± ÙÙ‚Ø·");
    const g=curGroup();
    $("auditText").textContent=(g.audit||[]).slice(-500).reverse().map(a=>a.tsISO+" | "+a.role+" | "+a.action+" | "+JSON.stringify(a.meta||{})).join("\n")||"â€”";
    openOverlay("auditOverlay");
  };
  $("btnAuditClose").onclick=()=>closeOverlay("auditOverlay");
  $("auditOverlay").addEventListener("click",(e)=>{ if(e.target===$("auditOverlay")) closeOverlay("auditOverlay"); });
  $("btnAuditCSV").onclick=()=>{ downloadText("Hedra_Audit_"+isoYMD(new Date())+".csv", auditCSV(), "text/csv;charset=utf-8"); toast("ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±"); };

  $("btnReceipts").onclick=()=>{
    if(role!==ROLE.ADMIN) return toast("Ù„Ù„Ù€ Ù…Ø¯ÙŠØ± ÙÙ‚Ø·");
    const list=allReceipts().slice(0,250);
    const wrap=$("rcList");
    if(!list.length) wrap.innerHTML='<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØµØ§Ù„Ø§Øª.</div>';
    else wrap.innerHTML=list.map(x=>`<div class="row"><div class="left"><div class="num">ğŸ§¾</div><div><div class="name">${escapeHtml(x.r.rid)} â€¢ ${escapeHtml(x.r.studentName)}</div><div class="mini">${escapeHtml(x.g.name)} â€¢ ${x.r.amount}</div></div></div><button class="moreBtn noPrint" data-rid="${escapeHtml(x.r.rid)}">Ø·Ø¨Ø§Ø¹Ø©</button></div>`).join("");
    wrap.querySelectorAll("button[data-rid]").forEach(b=>b.onclick=()=>{
      const rid=b.getAttribute("data-rid");
      const f=allReceipts().find(x=>x.r.rid===rid); if(!f) return;
      const w=window.open("","_blank");
      w.document.write("<meta charset='utf-8'><title>"+rid+"</title>"+receiptPrintHTML(f.r,f.g.name)+"<script>window.onload=()=>window.print();</script>");
      w.document.close();
    });
    openOverlay("rcOverlay");
  };
  $("btnRcClose").onclick=()=>closeOverlay("rcOverlay");
  $("rcOverlay").addEventListener("click",(e)=>{ if(e.target===$("rcOverlay")) closeOverlay("rcOverlay"); });
  $("btnRcCSV").onclick=()=>{ downloadText("Hedra_Receipts_"+isoYMD(new Date())+".csv", receiptsCSV(), "text/csv;charset=utf-8"); toast("ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±"); };

  // Export / Import (encrypted backup)
  $("btnExport").onclick=async ()=>{
    if(role!==ROLE.ADMIN) return toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
    const pass=prompt("ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ØªØµØ¯ÙŠØ± (4+ Ø£Ø­Ø±Ù/Ø£Ø±Ù‚Ø§Ù…)"); if(!pass||String(pass).trim().length<4) return;
    const salt=crypto.getRandomValues(new Uint8Array(16));
    const key=await deriveKeyFromPIN(String(pass).trim(), salt.buffer);
    const packed=await encryptJSON(key, {type:"hedra_export", ver:"6.0-teacher", exportedAt:new Date().toISOString(), db});
    const out={type:"hedra_export", v:2, saltB64:bufToB64(salt.buffer), ...packed};
    downloadText("Hedra_V6_Teacher_Encrypted_Backup_"+isoYMD(new Date())+".json", JSON.stringify(out,null,2), "application/json;charset=utf-8");
    toast("ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±");
  };
  $("btnImport").onclick=()=>{
    if(role!==ROLE.ADMIN) return toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
    const inp=document.createElement("input"); inp.type="file"; inp.accept="application/json";
    inp.onchange=()=>{
      const f=inp.files?.[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>{ (async ()=>{
        try{
          const parsed=JSON.parse(String(r.result||""));
          let next=null;
          if(parsed?.type==="hedra_export" && parsed?.v===2){
            const pass=prompt("ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©"); if(!pass) return;
            const key=await deriveKeyFromPIN(String(pass).trim(), b64ToBuf(parsed.saltB64));
            next=await decryptJSON(key, parsed.ivB64, parsed.ctB64);
            next=next?.db ?? next;
          } else {
            next=parsed;
          }
          db=ensureDefaults(next);
          await save(); toast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯"); render();
        }catch(e){ alert("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯"); }
      })(); };
      r.readAsText(f);
    };
    inp.click();
  };

  // Change PIN (admin only)
  $("btnChangePIN").onclick=async ()=>{
    if(role!==ROLE.ADMIN) return toast("Ù„Ù„Ù€ Ù…Ø¯ÙŠØ± ÙÙ‚Ø·");
    if(!sessionKey) return toast("Ø§ÙØªØ­ Ø£ÙˆÙ„Ø§Ù‹");
    const old=prompt("PIN Ø§Ù„Ø­Ø§Ù„ÙŠ"); if(!old) return;
    try{
      // verify old by trying to decrypt vault
      const raw=localStorage.getItem(DB_KEY); if(!raw) return toast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø²Ù†Ø©");
      const v=JSON.parse(raw);
      const key=await deriveKeyFromPIN(String(old).trim(), b64ToBuf(v.saltB64));
      await decryptJSON(key, v.ivB64, v.ctB64); // verify
      const np=prompt("PIN Ø¬Ø¯ÙŠØ¯ (4+ Ø£Ø±Ù‚Ø§Ù…)"); if(!np||String(np).trim().length<4) return;
      // re-encrypt with new salt
      const salt=crypto.getRandomValues(new Uint8Array(16));
      saltB64=bufToB64(salt.buffer);
      sessionKey=await deriveKeyFromPIN(String(np).trim(), salt.buffer);
      await save();
      toast("ØªÙ… ØªØºÙŠÙŠØ± PIN");
      auditAdd("security.pin.change",{});
      await save();
    }catch(e){ toast("PIN Ø§Ù„Ø­Ø§Ù„ÙŠ Ø®Ø·Ø£"); }
  };

  // Lock / Unlock
  const openLock=(msg)=>{ $("lockHint").textContent=msg; $("lockOverlay").style.display="block"; };
  const closeLock=()=>{ $("lockOverlay").style.display="none"; $("pinInput").value=""; };
  $("btnLockClear").onclick=()=>$("pinInput").value="";
  $("roleAdmin").onclick=()=>{ role=ROLE.ADMIN; toast("Ù…Ø¯ÙŠØ±"); renderTop(); };
  $("roleAssistant").onclick=()=>{ role=ROLE.ASSISTANT; toast("Ù…Ø³Ø§Ø¹Ø¯"); renderTop(); };
  $("roleView").onclick=()=>{ role=ROLE.VIEW; toast("Ø¹Ø±Ø¶ ÙÙ‚Ø·"); renderTop(); };

  $("btnUnlock").onclick=async ()=>{
    const pin=String($("pinInput").value||"").trim();
    if(pin.length<4) return toast("PIN Ù‚ØµÙŠØ±");
    const now=Date.now();
    const lockUntil=Number(db.settings.pinLockUntil||0);
    if(lockUntil && now<lockUntil) return toast("Ù…Ù‚ÙÙˆÙ„ Ù…Ø¤Ù‚ØªÙ‹Ø§");
    try{
      if(!hasVault()) {
        await setupNew(pin);
      } else {
        const loaded=await load(pin);
        if(!loaded) throw new Error("bad");
        db.settings.pinFailCount=0; db.settings.pinLockUntil=0;
        await save();
      }
      setUnlocked(true);
      closeLock();
      toast("ØªÙ… Ø§Ù„ÙØªØ­");
      render();
    }catch(e){
      db.settings.pinFailCount = Number(db.settings.pinFailCount||0)+1;
      if(db.settings.pinFailCount>=5) {
        db.settings.pinLockUntil = Date.now()+30000;
        db.settings.pinFailCount=0;
        toast("Ù‚ÙÙ„ 30 Ø«Ø§Ù†ÙŠØ©");
      } else toast("PIN Ø®Ø·Ø£");
      $("pinInput").value="";
    }
  };

  // auto-lock (10 min) + wipe memory
  setInterval(()=>{
    if(!isUnlocked()) return;
    const last=Number(sessionStorage.getItem("hedra_last_active")||0);
    if(last && Date.now()-last>10*60*1000){
      setUnlocked(false);
      db=ensureDefaults(makeEmptyDB());
      sessionKey=null; saltB64=null;
      openLock("ØªÙ… Ø§Ù„Ù‚ÙÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§");
    }
  }, 4000);
  ["click","keydown","touchstart","mousemove"].forEach(ev=>window.addEventListener(ev,()=>touch(),{passive:true}));

  // PWA install
  let deferred=null;
  window.addEventListener("beforeinstallprompt",(e)=>{ e.preventDefault(); deferred=e; $("btnInstall").style.display="inline-flex"; });
  $("btnInstall").onclick=async ()=>{ if(!deferred) return alert("Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â‹® Ø«Ù… Install"); deferred.prompt(); await deferred.userChoice; deferred=null; $("btnInstall").style.display="none"; };

  // SW
  if("serviceWorker" in navigator) navigator.serviceWorker.register("sw.js?v="+BUILD);

  // First screen
  openLock(hasVault() ? "Ø£Ø¯Ø®Ù„ PIN" : "PIN Ø¬Ø¯ÙŠØ¯ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø²Ù†Ø©");
  showTab("run");
})();
</script>
</body>
</html>
