<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hedra</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0A2A66">
  <link rel="icon" href="icon.png">

  <style>
    :root{
      --bg:#071427;
      --bg2:#0A2A66;         /* Ø£Ø²Ø±Ù‚ Ù…Ù„ÙƒÙŠ */
      --paper:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:rgba(2,6,23,.10);
      --shadow: 0 18px 42px rgba(2,6,23,.18);
      --r:22px;

      --blue:#0A2A66;        /* Ù…Ø¯ÙÙˆØ¹ ÙƒØ§Ù…Ù„ */
      --blueSoft:#EAF2FF;    /* Ø¯ÙØ¹ Ø¬Ø²Ø¦ÙŠ */
      --red:#D72638;         /* Ø²Ø± Ø¨Ø±ÙˆØ§Ø² Ù„Ù„ØºÙŠØ± Ø¯Ø§ÙØ¹ */
    }

    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial}
    body{
      margin:0;
      background:
        radial-gradient(900px 520px at 80% -10%, rgba(10,42,102,.35), transparent 60%),
        radial-gradient(900px 520px at -10% 10%, rgba(10,42,102,.18), transparent 60%),
        linear-gradient(180deg, #071427, #071427);
      color:#fff;
    }

    .top{
      position:sticky; top:0; z-index:10;
      padding:14px 14px 12px;
      background: rgba(7,20,39,.72);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .top .wrap{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:44px;height:44px;border-radius:16px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      display:grid;place-items:center;
      font-weight:1000; letter-spacing:.5px;
    }
    .ttl{font-weight:1000;font-size:15px}
    .sub{opacity:.80;font-size:12px;margin-top:2px}

    .btn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:#fff;
      border-radius:18px;
      padding:10px 12px;
      min-height:44px;
      font-weight:950;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      transition:transform .08s ease, filter .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.06); border-color:rgba(255,255,255,.26)}
    .btn.small{min-height:40px;border-radius:16px;font-size:13px;padding:9px 10px}

    .page{max-width:980px;margin:0 auto;padding:14px 14px 96px}
    .card{
      background: rgba(255,255,255,.96);
      color:var(--ink);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
    }

    .bottom{
      position:fixed;left:0;right:0;bottom:0;z-index:20;
      padding:10px 12px;
      background: rgba(7,20,39,.72);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(255,255,255,.10);
    }
    .bottom .wrap{max-width:980px;margin:0 auto;display:flex;gap:10px;justify-content:space-between;align-items:center}
    .tab{
      flex:1; min-height:54px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:#fff; font-weight:1000;
      display:flex;align-items:center;justify-content:center;gap:10px;
      cursor:pointer;
    }
    .tab.active{background: rgba(10,42,102,.32); border-color: rgba(255,255,255,.28)}

    /* RUN list */
    .runHeader{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .runTitle{font-weight:1000;font-size:14px}
    .runGroup{opacity:.88;font-size:12px;margin-top:4px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      font-weight:1000;
      font-size:13px;
    }

    .list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .row{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px;
      border-radius:20px;
      border:1px solid rgba(2,6,23,.10);
      background:#fff;
    }
    .left{display:flex;align-items:center;gap:12px;min-width:0}
    .num{
      width:36px;height:36px;border-radius:14px;
      background: rgba(10,42,102,.08);
      border:1px solid rgba(10,42,102,.20);
      display:grid;place-items:center;
      font-weight:1000;color:var(--blue);
      flex:0 0 auto;
    }
    .name{font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    /* Pay button styles (NO numbers shown) */
    .payBtn{
      min-width:140px;
      min-height:46px;
      border-radius:18px;
      font-weight:1000;
      cursor:pointer;
      transition:transform .08s ease, filter .12s ease;
    }
    .payBtn:hover{transform:translateY(-1px); filter:brightness(1.02)}
    .pay-unpaid{
      background:#fff;
      color:var(--red);
      border:2px solid var(--red);
    }
    .pay-partial{
      background: var(--blueSoft);
      color: var(--blue);
      border:1px solid rgba(10,42,102,.22);
    }
    .pay-paid{
      background: var(--blue);
      color:#fff;
      border:1px solid rgba(10,42,102,.35);
    }
    .moreBtn{
      width:46px;min-height:46px;
      border-radius:18px;
      border:1px solid rgba(2,6,23,.12);
      background:#fff;
      color:var(--ink);
      font-weight:1100;
      cursor:pointer;
    }

    /* Inputs */
    label{display:block;font-weight:1000;font-size:13px;margin:10px 0 6px}
    input,select{
      width:100%;
      min-height:48px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(2,6,23,.12);
      outline:none;
      font-size:15px;
      background:#fff;
      color:var(--ink);
    }
    input:focus,select:focus{border-color: rgba(10,42,102,.55)}

    .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.grid2{grid-template-columns:1.2fr .8fr}}

    .hr{height:1px;background:rgba(2,6,23,.08);margin:12px 0}

    /* Table */
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th{font-size:12px;color:var(--muted);text-align:right;padding:0 8px}
    td{background:#fff;border:1px solid rgba(2,6,23,.10);padding:10px 10px;border-radius:14px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}

    /* Modals */
    .overlay{
      position:fixed;inset:0;z-index:80;
      background: rgba(2,6,23,.55);
      display:none;
      padding:14px;
    }
    .modal{
      max-width:560px;margin:8vh auto;
      background:#fff;color:var(--ink);
      border:1px solid rgba(2,6,23,.12);
      border-radius:24px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modal h3{margin:0 0 6px;font-size:16px}
    .hint{color:var(--muted);font-size:12px;line-height:1.7}

    .toast{
      position:fixed;left:12px;bottom:86px;z-index:90;
      background: rgba(255,255,255,.96);
      color:var(--ink);
      border:1px solid rgba(2,6,23,.12);
      box-shadow: var(--shadow);
      padding:10px 12px;
      border-radius:16px;
      font-weight:1000;
      display:none;
      max-width:92vw;
    }
  </style>
</head>

<body>

  <div class="top">
    <div class="wrap">
      <div class="brand">
        <div class="logo">H</div>
        <div>
          <div class="ttl">Hedra</div>
          <div class="sub mono" id="topDate">â€”</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
        <button class="btn small" id="btnInstall" style="display:none">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</button>
        <button class="btn small" id="btnReset">Ø¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯</button>
      </div>
    </div>
  </div>

  <div class="page">
    <!-- RUN -->
    <section id="pageRun" class="grid2">
      <div class="card">
        <div class="runHeader">
          <div>
            <div class="runTitle">Ø§Ù„ØªØ´ØºÙŠÙ„</div>
            <div class="runGroup" id="runGroupName">â€”</div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn small" id="btnAddSession">+ Ø­ØµØ©</button>
            <button class="btn small" id="btnRemoveSession">âˆ’ Ø­ØµØ©</button>
          </div>
        </div>

        <div class="hr"></div>

        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <input id="qRun" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." />
        </div>

        <div class="list" id="runList"></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap">
          <div style="font-weight:1000">Ù…Ø¹Ù„ÙˆÙ…Ø©</div>
          <div class="pill mono" id="todayOnly">â€”</div>
        </div>
        <div class="hr"></div>
        <div class="hint">
          - Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„Ø§ ÙŠØ¹Ø±Ø¶ Ø£Ø±Ù‚Ø§Ù… ÙˆÙ„Ø§ ØªÙØ§ØµÙŠÙ„ Ù…Ø§Ù„ÙŠØ©.<br>
          - Ù„Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙˆØ±Ø©/Ø§Ù„Ø¨Ù†ÙˆØ¯/Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª: Ø§ÙØªØ­ÙŠ "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª" Ùˆ "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©".
        </div>
      </div>
    </section>

    <!-- MANAGE -->
    <section id="pageManage" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap">
          <div>
            <div style="font-weight:1000">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
            <div class="hint">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª â€¢ Ø§Ù„Ø¨Ù†ÙˆØ¯ â€¢ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­ØµØµ â€¢ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div>
          </div>
        </div>

        <div class="hr"></div>

        <input id="qManage" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." />
        <div class="hr"></div>

        <div class="list" id="manageList"></div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="pageSettings" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap">
          <div>
            <div style="font-weight:1000">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
            <div class="hint">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© â€¢ Ø§Ù„Ø¯ÙˆØ±Ø© â€¢ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© â€¢ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn small" id="btnAddGroup">+ Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
          </div>
        </div>

        <div class="hr"></div>

        <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
        <select id="selGroup"></select>

        <div class="hr"></div>

        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ´ØºÙŠÙ„)</label>
        <input id="groupDisplayName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø­Ø¯ ÙˆØ§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡" />

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <div style="flex:1;min-width:240px">
            <label>Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆØ±Ø©)</label>
            <input id="priceCycle" type="number" min="0" step="1" placeholder="Ù…Ø«Ø§Ù„: 200"/>
          </div>
          <div style="flex:1;min-width:240px">
            <label>Ø·ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ±Ø©</label>
            <select id="cycleLen">
              <option value="4">4 Ø­ØµØµ</option>
              <option value="8">8 Ø­ØµØµ</option>
              <option value="12">12 Ø­ØµØ©</option>
            </select>
          </div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <button class="btn small" id="btnSaveSettings">Ø­ÙØ¸</button>
          <button class="btn small" id="btnNewBlock">ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>

        <div class="hr"></div>

        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-end;flex-wrap:wrap">
          <div>
            <div style="font-weight:1000">Ø¨Ù†ÙˆØ¯ Ø¥Ø¶Ø§ÙÙŠØ© (Ù„Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·)</div>
            <div class="hint">Ù…Ø°ÙƒØ±Ø© / Ø§Ø®ØªØ¨Ø§Ø± / ...</div>
          </div>
          <button class="btn small" id="btnAddExtra">+ Ø¨Ù†Ø¯</button>
        </div>

        <div class="hr"></div>
        <div id="extraItemsWrap"></div>

        <div class="hr"></div>

        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-end;flex-wrap:wrap">
          <div>
            <div style="font-weight:1000">Ø§Ù„Ø·Ù„Ø§Ø¨</div>
            <div class="hint">Ø®ØµÙ…/Ø¥Ø¹ÙØ§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€” Ù„Ø§ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„</div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <input id="newStudentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." style="min-width:220px"/>
            <button class="btn small" id="btnAddStudent">Ø¥Ø¶Ø§ÙØ©</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="list" id="studentsList"></div>
      </div>
    </section>

  </div>

  <div class="bottom">
    <div class="wrap">
      <button class="tab active" data-tab="run">ğŸ‘¥ ØªØ´ØºÙŠÙ„</button>
      <button class="tab" data-tab="manage">ğŸ§¾ Ø¥Ø¯Ø§Ø±Ø©</button>
      <button class="tab" data-tab="settings">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Pay/Detail Modal (admin) -->
  <div class="overlay" id="payOverlay">
    <div class="modal">
      <h3 id="payTitle">â€”</h3>
      <div class="hint" id="payInfo">â€”</div>
      <div class="hr"></div>

      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn small" id="btnPayFull">ØªÙ… Ø§Ù„Ø¯ÙØ¹ (ØªÙƒÙ…Ù„Ø©)</button>
        <button class="btn small" id="btnPayAdd">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº</button>
        <button class="btn small" id="btnPayMinus">âˆ’ Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹</button>
      </div>

      <div id="payAmountWrap" style="display:none;margin-top:10px">
        <label id="payAmountLabel">Ø§Ù„Ù…Ø¨Ù„Øº</label>
        <input id="payAmount" type="number" step="1" placeholder="Ù…Ø«Ø§Ù„: 50"/>
        <button class="btn small" id="btnPayApply" style="margin-top:10px">ØªØ·Ø¨ÙŠÙ‚</button>
      </div>

      <div class="hr"></div>

      <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input id="payNote" placeholder="Ù…Ø«Ø§Ù„: Ø«Ù…Ù† Ù…Ø°ÙƒØ±Ø© / Ø³Ø¯Ø§Ø¯ Ù…ØªØ£Ø®Ø± / ..." />

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
        <button class="btn small" id="btnPaySaveNote">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
        <button class="btn small" id="btnPayClose">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- New Block Modal -->
  <div class="overlay" id="blkOverlay">
    <div class="modal">
      <h3>ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
      <div class="hint">Ø§Ø®ØªØ§Ø±ÙŠ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©. Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø³ØªØ¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.</div>
      <div class="hr"></div>

      <label>Ù…Ù†</label>
      <input id="blkFrom" type="date"/>

      <label>Ø¥Ù„Ù‰</label>
      <input id="blkTo" type="date"/>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
        <button class="btn small" id="btnBlkCreate">Ø¥Ù†Ø´Ø§Ø¡</button>
        <button class="btn small" id="btnBlkClose">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Extra Item Modal -->
  <div class="overlay" id="exOverlay">
    <div class="modal">
      <h3>Ø¨Ù†Ø¯ Ø¥Ø¶Ø§ÙÙŠ</h3>
      <div class="hint">Ù„Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·</div>
      <div class="hr"></div>

      <label>Ø§Ù„Ø§Ø³Ù…</label>
      <input id="exName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø°ÙƒØ±Ø© Ø´Ù‡Ø± 10"/>

      <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
      <input id="exAmount" type="number" step="1" placeholder="Ù…Ø«Ø§Ù„: 50"/>

      <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
      <input id="exDate" type="date"/>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
        <button class="btn small" id="btnExSave">Ø­ÙØ¸</button>
        <button class="btn small" id="btnExClose">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   Hedra (Clean Fresh)
   - Run: no numbers, just status button (red outline -> blue filled)
   - Sessions stored with dates; show dates in Manage only
   - Discounts distribute from FIRST session
   - Extra items for current block only
   - Overpay -> credit carried to next block
   - No DELETE confirmations for payments; use -Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹
========================================================= */

const DB_KEY = "hedra_clean_fresh_v1";

let db = { groups: [], settings: { currentGroupId:"" } };

/* ---------- helpers ---------- */
function uid(p="id"){ return p+"_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16); }
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg; t.style.display="block";
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.style.display="none",2200);
}
function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function loadDB(){
  const raw=localStorage.getItem(DB_KEY);
  if(!raw) return;
  try{ const p=JSON.parse(raw); if(p&&typeof p==="object") db=p; }catch{}
}
function todayStr(){
  const d=new Date();
  const locale="ar-EG";
  return d.toLocaleDateString(locale,{weekday:"long",year:"numeric",month:"long",day:"numeric"});
}
function isoDateYMD(d=new Date()){
  const x=new Date(d); x.setHours(0,0,0,0);
  return x.toISOString().slice(0,10);
}
function fmtDMY(iso){
  const d=new Date(iso);
  const dd=String(d.getDate()).padStart(2,"0");
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const yy=d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}

/* ---------- data model ---------- */
/*
group = {
  id, name, displayName,
  price, cycleLen,
  students: [{id,name, paused, discountType, discountValue}],
  blocks: [ block ]
}
block = {
  id, from, to, label,
  sessions: [{id, tsISO}],
  extraItems: [{id,name,amount,dateYMD}],
  payments: { studentId: number },     // total paid
  notes:    { studentId: string },     // admin note
  carry:    { studentId: number },     // signed balance from previous block (+due / -credit)
  closed: boolean
}
*/
function newBlock(fromISO,toISO){
  return {
    id:uid("b"),
    from:fromISO, to:toISO,
    label:"",
    sessions:[],
    extraItems:[],
    payments:{},
    notes:{},
    carry:{},
    closed:false
  };
}
function ensureDefaults(){
  if(!db.settings) db.settings={currentGroupId:""};
  if(!Array.isArray(db.groups)) db.groups=[];

  db.groups.forEach(g=>{
    if(!g.id) g.id=uid("g");
    if(typeof g.name!=="string") g.name="Ù…Ø¬Ù…ÙˆØ¹Ø©";
    if(typeof g.displayName!=="string") g.displayName="";
    if(typeof g.price!=="number") g.price=Number(g.price||0);
    if(!g.cycleLen) g.cycleLen=8;
    if(!Array.isArray(g.students)) g.students=[];
    if(!Array.isArray(g.blocks)) g.blocks=[];

    g.students.forEach(s=>{
      if(!s.id) s.id=uid("s");
      if(typeof s.name!=="string") s.name="Ø·Ø§Ù„Ø¨";
      if(typeof s.paused!=="boolean") s.paused=false;
      if(!s.discountType) s.discountType="none"; // none/fixed/percent/exempt
      if(typeof s.discountValue!=="number") s.discountValue=Number(s.discountValue||0);
    });

    if(g.blocks.length===0){
      const from=new Date(); from.setHours(0,0,0,0);
      const to=new Date(); to.setHours(0,0,0,0);
      const b=newBlock(from.toISOString(), to.toISOString());
      b.label = `${fmtDMY(b.from)} â†’ ${fmtDMY(b.to)}`;
      g.blocks.push(b);
    }

    g.blocks.forEach(b=>{
      if(!b.id) b.id=uid("b");
      if(!b.from) b.from=new Date().toISOString();
      if(!b.to) b.to=new Date().toISOString();
      if(!Array.isArray(b.sessions)) b.sessions=[];
      if(!Array.isArray(b.extraItems)) b.extraItems=[];
      if(!b.payments||typeof b.payments!=="object") b.payments={};
      if(!b.notes||typeof b.notes!=="object") b.notes={};
      if(!b.carry||typeof b.carry!=="object") b.carry={};
      if(typeof b.closed!=="boolean") b.closed=false;
      b.label = `${fmtDMY(b.from)} â†’ ${fmtDMY(b.to)}`;
    });
  });

  if(!db.settings.currentGroupId && db.groups[0]) db.settings.currentGroupId=db.groups[0].id;
  saveDB();
}
function curGroup(){ return db.groups.find(g=>g.id===db.settings.currentGroupId) || db.groups[0] || null; }
function curBlock(g){ return g?.blocks?.[g.blocks.length-1] || null; }

/* ---------- pricing logic ---------- */
function cycleLen(g){ return Math.max(1, Number(g.cycleLen||8)); }
function baseCyclePrice(g){ return Math.max(0, Number(g.price||0)); }

function studentEffectiveCyclePrice(g,s){
  const price = baseCyclePrice(g);
  if(s.paused) return 0;
  const t=s.discountType||"none";
  const v=Number(s.discountValue||0);

  if(t==="exempt") return 0;
  if(t==="fixed") return Math.max(0, price - Math.max(0,v));
  if(t==="percent"){
    const p=Math.max(0, Math.min(100, v));
    return Math.max(0, price * (1 - p/100));
  }
  return price;
}

function perSessionForStudent(g,s){
  return studentEffectiveCyclePrice(g,s) / cycleLen(g);
}

function extraItemsTotal(block){
  return (block.extraItems||[]).reduce((a,x)=>a+Math.max(0,Number(x.amount||0)),0);
}

function sessionsCount(block){
  return (block.sessions||[]).length;
}

function carryBalance(block, sid){
  return Number((block.carry && block.carry[sid]) || 0); // signed
}

function paidTotal(block, sid){
  return Number((block.payments && block.payments[sid]) || 0); // can exceed
}

function subscriptionDueSoFar(g, block, s){
  // âœ… Ù…Ù‡Ù…: Ø§Ù„Ø®ØµÙ… ÙŠØªÙˆØ²Ø¹ Ù…Ù† Ø£ÙˆÙ„ Ø­ØµØ©
  const due = sessionsCount(block) * perSessionForStudent(g,s);
  return Math.max(0, Math.round(due*100)/100);
}

function totalsForStudent(g, block, s){
  const sub = subscriptionDueSoFar(g,block,s);
  const items = extraItemsTotal(block);
  const carry = carryBalance(block, s.id);
  const total = Math.round((sub + items + carry)*100)/100;     // signed possible
  const paid = Math.round(paidTotal(block,s.id)*100)/100;
  const remaining = Math.round((total - paid)*100)/100;        // signed: +due / -credit
  return { sub, items, carry, total, paid, remaining };
}

function statusForRun(g, block, s){
  const t=totalsForStudent(g,block,s);
  if(t.paid>0 && t.remaining>0.0001) return "partial";
  if(t.remaining<=0.0001) return "paid";
  return "unpaid";
}

/* ---------- UI tabs ---------- */
const pages={
  run: document.getElementById("pageRun"),
  manage: document.getElementById("pageManage"),
  settings: document.getElementById("pageSettings")
};
function showTab(k){
  if(k === "manage" || k === "settings"){
    if(!requirePIN()) return;
  }

  Object.keys(pages).forEach(x=>pages[x].style.display=(x===k)?"":"none");
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===k));
  renderAll();
}

document.querySelectorAll(".tab").forEach(t=>t.onclick=()=>showTab(t.dataset.tab));

/* ---------- reset (fresh) ---------- */
document.getElementById("btnReset").onclick=()=>{
  const ok = confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯. Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ");
  if(!ok) return;
  localStorage.removeItem(DB_KEY);
  db = { groups: [], settings: { currentGroupId:"" } };
  // Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
  const g = {
    id:uid("g"),
    name:"Ù…Ø¬Ù…ÙˆØ¹Ø© 1",
    displayName:"",
    price:200,
    cycleLen:8,
    students:[],
    blocks:[]
  };
  const from=new Date(); from.setHours(0,0,0,0);
  const to=new Date(); to.setHours(0,0,0,0);
  g.blocks=[ newBlock(from.toISOString(), to.toISOString()) ];
  db.groups=[g];
  db.settings.currentGroupId=g.id;
  saveDB();
  ensureDefaults();
  toast("ØªÙ… Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯");
  renderAll();
};

/* ---------- settings ---------- */
function refreshGroupSelect(){
  const sel=document.getElementById("selGroup");
  sel.innerHTML="";
  if(!db.groups.length){
    const o=document.createElement("option");
    o.value=""; o.textContent="Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª";
    sel.appendChild(o);
    return;
  }
  db.groups.forEach(g=>{
    const o=document.createElement("option");
    o.value=g.id; o.textContent=g.name;
    sel.appendChild(o);
  });
  const cg=curGroup();
  db.settings.currentGroupId=cg?.id || "";
  sel.value=db.settings.currentGroupId;
}
document.getElementById("selGroup").onchange=(e)=>{
  db.settings.currentGroupId=e.target.value;
  saveDB();
  renderAll();
};

document.getElementById("btnAddGroup").onclick=()=>{
  const name=(prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©")||"").trim();
  if(!name) return;
  if(db.groups.some(x=>x.name.trim().toLowerCase()===name.toLowerCase())) return alert("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©");
  const g={
    id:uid("g"),
    name,
    displayName:"",
    price:200,
    cycleLen:8,
    students:[],
    blocks:[]
  };
  const from=new Date(); from.setHours(0,0,0,0);
  const to=new Date(); to.setHours(0,0,0,0);
  g.blocks=[ newBlock(from.toISOString(), to.toISOString()) ];
  db.groups.push(g);
  db.settings.currentGroupId=g.id;
  saveDB();
  toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©");
  renderAll();
};

function loadSettingsUI(){
  const g=curGroup();
  if(!g) return;
  document.getElementById("groupDisplayName").value = g.displayName || "";
  document.getElementById("priceCycle").value = g.price || 0;
  document.getElementById("cycleLen").value = String(g.cycleLen||8);
}

document.getElementById("btnSaveSettings").onclick=()=>{
  const g=curGroup(); if(!g) return;
  g.displayName = String(document.getElementById("groupDisplayName").value||"").trim();
  g.price = Number(document.getElementById("priceCycle").value||0);
  g.cycleLen = Number(document.getElementById("cycleLen").value||8);
  saveDB();
  toast("ØªÙ… Ø§Ù„Ø­ÙØ¸");
  renderAll();
};

/* ---------- blocks (settings) ---------- */
const blkOverlay=document.getElementById("blkOverlay");
document.getElementById("btnNewBlock").onclick=()=>{
  document.getElementById("blkFrom").value = isoDateYMD(new Date());
  document.getElementById("blkTo").value = isoDateYMD(new Date());
  blkOverlay.style.display="block";
};
document.getElementById("btnBlkClose").onclick=()=>blkOverlay.style.display="none";
blkOverlay.onclick=(e)=>{ if(e.target===blkOverlay) blkOverlay.style.display="none"; };

document.getElementById("btnBlkCreate").onclick=()=>{
  const g=curGroup(); if(!g) return;
  const current=curBlock(g); if(!current) return;

  const fromV=document.getElementById("blkFrom").value;
  const toV=document.getElementById("blkTo").value;
  if(!fromV || !toV) return alert("Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®");

  // carry signed remaining (due or credit)
  const carryMap={};
  g.students.forEach(s=>{
    const t=totalsForStudent(g,current,s);
    if(Math.abs(t.remaining) > 0.0001) carryMap[s.id]=t.remaining;
  });
  current.closed=true;

  const fromISO=new Date(fromV+"T00:00:00").toISOString();
  const toISO=new Date(toV+"T00:00:00").toISOString();
  const nb=newBlock(fromISO,toISO);
  nb.carry=carryMap;         // âœ… ÙŠÙ†Ù‚Ù„ Ø§Ù„Ø±ØµÙŠØ¯/Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª
  nb.extraItems=[];          // âœ… Ø§Ù„Ø¨Ù†ÙˆØ¯ ØªØ¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯
  nb.sessions=[];            // âœ… Ø¬Ù„Ø³Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©

  g.blocks.push(nb);
  saveDB();
  blkOverlay.style.display="none";
  toast("ØªÙ… ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©");
  renderAll();
};

/* ---------- extra items (settings) ---------- */
const exOverlay=document.getElementById("exOverlay");
document.getElementById("btnAddExtra").onclick=()=>{
  document.getElementById("exName").value="";
  document.getElementById("exAmount").value="";
  document.getElementById("exDate").value=isoDateYMD(new Date());
  exOverlay.style.display="block";
};
document.getElementById("btnExClose").onclick=()=>exOverlay.style.display="none";
exOverlay.onclick=(e)=>{ if(e.target===exOverlay) exOverlay.style.display="none"; };

document.getElementById("btnExSave").onclick=()=>{
  const g=curGroup(); if(!g) return;
  const b=curBlock(g); if(!b) return;

  const name=(document.getElementById("exName").value||"").trim();
  const amt=Number(document.getElementById("exAmount").value||0);
  const date=document.getElementById("exDate").value || isoDateYMD(new Date());

  if(!name) return alert("Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯");
  if(!(amt>0)) return alert("Ø§ÙƒØªØ¨ÙŠ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");

  b.extraItems.push({ id:uid("x"), name, amount:amt, dateYMD:date });
  saveDB();
  exOverlay.style.display="none";
  toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†Ø¯");
  renderAll();
};

function renderExtraItems(){
  const g=curGroup();
  const wrap=document.getElementById("extraItemsWrap");
  wrap.innerHTML="";
  if(!g) return;
  const b=curBlock(g);
  if(!b) return;

  if(!b.extraItems.length){
    wrap.innerHTML = `<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ø¥Ø¶Ø§ÙÙŠØ© ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</div>`;
    return;
  }

  const box=document.createElement("div");
  box.className="list";
  b.extraItems.forEach(it=>{
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML = `
      <div class="left" style="min-width:0">
        <div class="num">ï¼‹</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(it.name)}</div>
          <div class="hint mono">${escapeHtml(it.dateYMD)} â€¢ ${escapeHtml(String(it.amount))}</div>
        </div>
      </div>
      <div class="actions">
        <button class="moreBtn" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
      </div>
    `;
    row.querySelector("button").onclick=()=>{
      const ok=confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ØŸ");
      if(!ok) return;
      b.extraItems=b.extraItems.filter(x=>x.id!==it.id);
      saveDB();
      toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯");
      renderAll();
    };
    box.appendChild(row);
  });
  wrap.appendChild(box);
}

/* ---------- students (settings) ---------- */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

document.getElementById("btnAddStudent").onclick=()=>{
  const g=curGroup(); if(!g) return;
  const name=(document.getElementById("newStudentName").value||"").trim();
  if(!name) return;
  if(g.students.some(s=>s.name.trim().toLowerCase()===name.toLowerCase())) return alert("Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯");
  g.students.push({ id:uid("s"), name, paused:false, discountType:"none", discountValue:0 });
  document.getElementById("newStudentName").value="";
  saveDB();
  toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨");
  renderAll();
};

function renderStudentsSettings(){
  const g=curGroup();
  const wrap=document.getElementById("studentsList");
  wrap.innerHTML="";
  if(!g){ wrap.innerHTML=`<div class="hint">Ø£Ø¶ÙŠÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£ÙˆÙ„Ø§Ù‹.</div>`; return; }
  if(!g.students.length){ wrap.innerHTML=`<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨.</div>`; return; }

  const list=[...g.students].sort((a,b)=>a.name.localeCompare(b.name,"ar"));
  list.forEach(s=>{
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <div class="left" style="min-width:0">
        <div class="num">ğŸ‘¤</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(s.name)} ${s.paused?`<span class="mono" style="color:#b91c1c">[Ù…ÙˆÙ‚ÙˆÙ]</span>`:""}</div>
          <div class="hint">
            ${s.discountType==="none"?"Ø¨Ø¯ÙˆÙ† Ø®ØµÙ…":
              s.discountType==="fixed"?`Ø®ØµÙ… Ø«Ø§Ø¨Øª: ${s.discountValue}`:
              s.discountType==="percent"?`Ø®ØµÙ… Ù†Ø³Ø¨Ø©: ${s.discountValue}%`:
              `Ø¥Ø¹ÙØ§Ø¡ ÙƒØ§Ù…Ù„`
            }
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="moreBtn" title="ØªØ¹Ø¯ÙŠÙ„">â‹¯</button>
      </div>
    `;
    row.querySelector("button").onclick=()=>openStudentEdit(s);
    wrap.appendChild(row);
  });
}

/* Student edit via prompt (Ø®ÙÙŠÙØ©) */
function openStudentEdit(s){
  const t = prompt("Ù†ÙˆØ¹ Ø§Ù„Ø®ØµÙ…: none / fixed / percent / exempt", s.discountType||"none");
  if(t===null) return;
  const type=t.trim().toLowerCase();
  if(!["none","fixed","percent","exempt"].includes(type)) return alert("Ù†ÙˆØ¹ ØºÙŠØ± ØµØ­ÙŠØ­");
  let val=0;
  if(type==="fixed") val = Number(prompt("Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø«Ø§Ø¨Øª", String(s.discountValue||0))||0);
  if(type==="percent") val = Number(prompt("Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… %", String(s.discountValue||0))||0);
  const paused = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ (OK=Ù…ÙˆÙ‚ÙˆÙ / Cancel=Ù†Ø´Ø·)");
  s.discountType=type;
  s.discountValue=Number.isFinite(val)?val:0;
  s.paused=paused;
  saveDB();
  toast("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«");
  renderAll();
}

/* ---------- sessions (run) ---------- */
document.getElementById("btnAddSession").onclick=()=>{
  const g=curGroup(); if(!g) return;
  const b=curBlock(g); if(!b) return;
  const len=cycleLen(g);
  if(b.sessions.length>=len){
    toast("Ø§ÙƒØªÙ…Ù„Øª Ø­ØµØµ Ø§Ù„Ø¯ÙˆØ±Ø©");
    return;
  }
  b.sessions.push({ id:uid("ss"), tsISO: new Date().toISOString() });
  saveDB();
  toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­ØµØ©");
  renderAll();
};

document.getElementById("btnRemoveSession").onclick=()=>{
  const g=curGroup(); if(!g) return;
  const b=curBlock(g); if(!b) return;
  if(!b.sessions.length){
    toast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ù„Ù„Ø­Ø°Ù");
    return;
  }
  const ok=confirm("Ø­Ø°Ù Ø¢Ø®Ø± Ø­ØµØ©ØŸ");
  if(!ok) return;
  b.sessions.pop();
  saveDB();
  toast("ØªÙ… Ø­Ø°Ù Ø¢Ø®Ø± Ø­ØµØ©");
  renderAll();
};

/* ---------- RUN list ---------- */
document.getElementById("qRun").oninput=()=>renderRun();

function renderRun(){
  const g=curGroup();
  const b=g?curBlock(g):null;
  const wrap=document.getElementById("runList");
  wrap.innerHTML="";

  document.getElementById("todayOnly").textContent = todayStr();
  document.getElementById("runGroupName").textContent = g ? (g.displayName||g.name||"") : "â€”";

  if(!g){
    wrap.innerHTML=`<div class="hint">Ø§Ø°Ù‡Ø¨ÙŠ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ£Ø¶ÙŠÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø©.</div>`;
    return;
  }
  if(!g.students.length){
    wrap.innerHTML=`<div class="hint">Ø£Ø¶ÙŠÙÙŠ Ø·Ù„Ø§Ø¨ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.</div>`;
    return;
  }

  const q=(document.getElementById("qRun").value||"").trim().toLowerCase();
  const list=[...g.students]
    .filter(s=>s.name.toLowerCase().includes(q))
    .sort((a,b)=>a.name.localeCompare(b.name,"ar"));

  list.forEach((s,idx)=>{
    const st = statusForRun(g,b,s);
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <div class="left">
        <div class="num">${idx+1}</div>
        <div class="name">${escapeHtml(s.name)}</div>
      </div>
      <div class="actions">
        <button class="payBtn ${st==="paid"?"pay-paid":st==="partial"?"pay-partial":"pay-unpaid"}">ØªÙ… Ø§Ù„Ø¯ÙØ¹</button>
        <button class="moreBtn" title="ØªÙØ§ØµÙŠÙ„">â‹¯</button>
      </div>
    `;

    // Fast pay: set paid to total (subscription so far + items + carry)
    row.querySelector(".payBtn").onclick=()=>{
      if(s.paused){ toast("Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆÙ‚ÙˆÙ"); return; }
      const t=totalsForStudent(g,b,s);
      // Ù„Ùˆ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ <= Ø§Ù„Ù…Ø¯ÙÙˆØ¹: Ø®Ù„Ø§Øµ
      if(t.remaining<=0.0001){ toast("ØªÙ…"); renderAll(); return; }
      b.payments[s.id] = Math.round((t.total)*100)/100; // pay to exactly total
      saveDB();
      toast("ØªÙ… Ø§Ù„Ø¯ÙØ¹");
      renderAll();
    };

    // Admin details
    row.querySelector(".moreBtn").onclick=()=>openPayModal(g,b,s);
    wrap.appendChild(row);
  });
}

/* ---------- MANAGE ---------- */
document.getElementById("qManage").oninput=()=>renderManage();

function renderManage(){
  const g=curGroup();
  const b=g?curBlock(g):null;
  const wrap=document.getElementById("manageList");
  wrap.innerHTML="";
  if(!g || !b){ wrap.innerHTML=`<div class="hint">â€”</div>`; return; }
  if(!g.students.length){ wrap.innerHTML=`<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨.</div>`; return; }

  const q=(document.getElementById("qManage").value||"").trim().toLowerCase();
  const list=[...g.students]
    .filter(s=>s.name.toLowerCase().includes(q))
    .sort((a,b)=>a.name.localeCompare(b.name,"ar"));

  list.forEach(s=>{
    const t=totalsForStudent(g,b,s);
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <div class="left" style="min-width:0">
        <div class="num">ğŸ§¾</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(s.name)}</div>
          <div class="hint">Ø§Ø¶ØºØ·ÙŠ Ù„Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ + ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­ØµØµ</div>
        </div>
      </div>
      <div class="actions">
        <button class="moreBtn">Ø¹Ø±Ø¶</button>
      </div>
    `;
    row.querySelector("button").onclick=()=>openPayModal(g,b,s,true);
    wrap.appendChild(row);
  });
}

/* ---------- Pay modal (admin) ---------- */
let payCtx=null;
let payMode=null; // "add" | "minus"
const payOverlay=document.getElementById("payOverlay");
const payAmountWrap=document.getElementById("payAmountWrap");
const payAmount=document.getElementById("payAmount");
const payAmountLabel=document.getElementById("payAmountLabel");

document.getElementById("btnPayClose").onclick=()=>{ payOverlay.style.display="none"; payCtx=null; payMode=null; payAmountWrap.style.display="none"; };
payOverlay.onclick=(e)=>{ if(e.target===payOverlay){ payOverlay.style.display="none"; payCtx=null; payMode=null; payAmountWrap.style.display="none"; } };

function openPayModal(g,b,s,fromManage=false){
  payCtx={g,b,s};
  payMode=null;
  payAmountWrap.style.display="none";
  payAmount.value="";

  const t=totalsForStudent(g,b,s);

  const sessions = b.sessions.map(x=>fmtDMY(x.tsISO)).join(" â€¢ ");
  const items = (b.extraItems||[]).map(x=>`${x.name} (${x.amount})`).join(" â€¢ ");

  // âœ… Ø¬Ø¯ÙˆÙ„ Ø­Ø³Ø§Ø¨ ÙˆØ§Ø¶Ø­
  const htmlTable = `
    <table>
      <thead>
        <tr><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr>
      </thead>
      <tbody>
        <tr><td>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</td><td class="mono">${t.sub}</td></tr>
        <tr><td>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¨Ù†ÙˆØ¯</td><td class="mono">${t.items}</td></tr>
        <tr><td>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚</td><td class="mono">${t.carry}</td></tr>
        <tr><td><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</b></td><td class="mono"><b>${t.total}</b></td></tr>
        <tr><td>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</td><td class="mono">${t.paid}</td></tr>
        <tr><td><b>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</b></td><td class="mono"><b>${t.remaining}</b></td></tr>
      </tbody>
    </table>
  `;

  document.getElementById("payTitle").textContent = s.name;
  document.getElementById("payInfo").innerHTML =
    `<div class="mono">Ø§Ù„Ø¯ÙˆØ±Ø©: ${b.label}</div>`+
    `<div class="hint">ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­ØµØµ: ${sessions||"â€”"}</div>`+
    `<div class="hint">Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©: ${items||"â€”"}</div>`+
    `<div class="hr"></div>`+
    htmlTable;

  document.getElementById("payNote").value = String(b.notes?.[s.id]||"");

  payOverlay.style.display="block";
}

/* quick full pay (admin) */
document.getElementById("btnPayFull").onclick=()=>{
  if(!payCtx) return;
  const {g,b,s}=payCtx;
  const t=totalsForStudent(g,b,s);
  if(t.remaining<=0.0001){ toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¨Ù‚ÙŠ"); return; }
  b.payments[s.id] = Math.round((t.total)*100)/100;
  saveDB();
  toast("ØªÙ…");
  renderAll();
  openPayModal(g,b,s,true);
};

/* add/minus */
document.getElementById("btnPayAdd").onclick=()=>{
  payMode="add";
  payAmountWrap.style.display="";
  payAmountLabel.textContent="Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº Ù„Ù„Ù…Ø¯ÙÙˆØ¹";
  payAmount.value="";
  payAmount.focus();
};
document.getElementById("btnPayMinus").onclick=()=>{
  payMode="minus";
  payAmountWrap.style.display="";
  payAmountLabel.textContent="Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (ØªØµØ­ÙŠØ­)";
  payAmount.value="";
  payAmount.focus();
};
document.getElementById("btnPayApply").onclick=()=>{
  if(!payCtx || !payMode) return;
  const {b,s}=payCtx;
  const v = Number(payAmount.value||0);
  if(!(v>0)) return alert("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
  const cur = paidTotal(b,s.id);

  if(payMode==="add"){
    b.payments[s.id] = Math.round((cur + v)*100)/100;
    saveDB(); toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
  }else if(payMode==="minus"){
    b.payments[s.id] = Math.round((Math.max(0, cur - v))*100)/100;
    saveDB(); toast("ØªÙ… Ø§Ù„Ø®ØµÙ…");
  }
  payAmountWrap.style.display="none";
  payMode=null;
  payAmount.value="";
  renderAll();
  openPayModal(payCtx.g,payCtx.b,payCtx.s,true);
};

document.getElementById("btnPaySaveNote").onclick=()=>{
  if(!payCtx) return;
  const {b,s}=payCtx;
  b.notes[s.id] = String(document.getElementById("payNote").value||"").trim();
  saveDB();
  toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©");
};

/* ---------- top date ---------- */
function renderTop(){
  document.getElementById("topDate").textContent = todayStr();
}

/* ---------- render all ---------- */
function renderAll(){
  ensureDefaults();
  renderTop();
  refreshGroupSelect();
  loadSettingsUI();
  renderExtraItems();
  renderStudentsSettings();
  renderRun();
  renderManage();
}

/* ---------- init ---------- */
(function init(){
  loadDB();
  if(db.groups.length===0){
    // Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù†Ø¸ÙŠÙØ©
    const g={
      id:uid("g"),
      name:"Ù…Ø¬Ù…ÙˆØ¹Ø© 1",
      displayName:"",
      price:200,
      cycleLen:8,
      students:[],
      blocks:[]
    };
    const from=new Date(); from.setHours(0,0,0,0);
    const to=new Date(); to.setHours(0,0,0,0);
    g.blocks=[ newBlock(from.toISOString(), to.toISOString()) ];
    db.groups=[g];
    db.settings.currentGroupId=g.id;
    saveDB();
  }
  ensureDefaults();
  renderAll();
  showTab("run");
})();

/* ---------- PWA install button ---------- */
let deferredPrompt=null;
window.addEventListener("beforeinstallprompt",(e)=>{
  e.preventDefault();
  deferredPrompt=e;
  document.getElementById("btnInstall").style.display="inline-flex";
});
document.getElementById("btnInstall").onclick=async ()=>{
  if(!deferredPrompt){
    alert("Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­: Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â‹® Ø«Ù… (Install) Ø£Ùˆ (Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)");
    return;
  }
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt=null;
  document.getElementById("btnInstall").style.display="none";
};

/* ---------- Service Worker ---------- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>


