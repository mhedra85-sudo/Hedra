<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hedra</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0A2A66">
  <link rel="icon" href="icon.png">

  <style>
    :root{
      --royal:#0A2A66;
      --royal2:#091F4A;
      --bg:#061226;
      --paper:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --soft:#EAF2FF;
      --line:rgba(2,6,23,.10);
      --shadow:0 18px 42px rgba(2,6,23,.22);

      --r:22px;
      --btnR:18px;
    }

    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial}
    body{
      margin:0; color:#fff;
      background:
        radial-gradient(900px 520px at 80% -10%, rgba(10,42,102,.38), transparent 60%),
        radial-gradient(900px 520px at -10% 10%, rgba(10,42,102,.22), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg));
    }

    /* Stronger Buttons (Ø·Ù„Ø¨Ùƒ: Ø£Ù‚ÙˆÙ‰ ÙˆØ£ÙˆØ¶Ø­) */
    .btn{
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.08);
      color:#fff;
      border-radius: var(--btnR);
      padding:11px 14px;
      min-height:48px;
      font-weight:1000;
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      transition: transform .08s ease, filter .12s ease, border-color .12s ease, box-shadow .12s ease;
      user-select:none;
      box-shadow: 0 10px 18px rgba(0,0,0,.14);
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.07); border-color:rgba(255,255,255,.32)}
    .btn:active{transform:translateY(0px) scale(.99); filter:brightness(1.02)}
    .btn.small{min-height:44px; border-radius:16px; font-size:13px; padding:10px 12px}
    .btn.royal{
      background: linear-gradient(180deg, rgba(10,42,102,.75), rgba(10,42,102,.45));
      border-color: rgba(255,255,255,.28);
      box-shadow: 0 12px 22px rgba(10,42,102,.22);
    }
    .btn.ghost{
      background: transparent;
      border-color: rgba(255,255,255,.20);
      box-shadow:none;
    }
    .btn.light{
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.24);
    }
    .btn.danger{
      background: rgba(215,38,56,.18);
      border-color: rgba(215,38,56,.55);
      box-shadow: 0 12px 22px rgba(215,38,56,.14);
    }

    .page{max-width:1060px; margin:0 auto; padding:14px 14px 104px}

    .card{
      background: rgba(255,255,255,.96);
      color:var(--ink);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
    }

    .hr{height:1px; background:rgba(2,6,23,.08); margin:12px 0}
    .hint{color:var(--muted); font-size:12px; line-height:1.75}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}

    /* Top sticky header area in Home (Ø·Ù„Ø¨Ùƒ: Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø«Ø§Ø¨Øª) */
    .homeHeader{
      position:sticky; top:0; z-index:25;
      background: rgba(6,18,38,.82);
      backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      padding:14px;
      box-shadow: 0 18px 42px rgba(0,0,0,.22);
    }
    .titleBig{font-weight:1100; font-size:20px; letter-spacing:.4px}
    .dateBig{margin-top:6px; font-size:16px; font-weight:1000; opacity:.95}
    .groupNameBig{font-weight:1100; font-size:16px}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(2,6,23,.10);
      background:rgba(10,42,102,.08);
      color:var(--royal);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }
    .badge.red{
      background: rgba(215,38,56,.10);
      border-color: rgba(215,38,56,.22);
      color:#b91c1c;
    }

    /* Tabs bottom */
    .bottom{
      position:fixed; left:0; right:0; bottom:0; z-index:30;
      background: rgba(6,18,38,.80);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(255,255,255,.10);
      padding:10px 12px;
    }
    .bottom .wrap{
      max-width:1060px; margin:0 auto;
      display:flex; gap:10px;
    }
    .tab{
      flex:1;
      min-height:56px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:#fff;
      font-weight:1100;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:10px;
      user-select:none;
      transition: transform .08s ease, filter .12s ease, border-color .12s ease;
    }
    .tab:hover{transform:translateY(-1px); filter:brightness(1.06); border-color:rgba(255,255,255,.26)}
    .tab.active{
      background: rgba(10,42,102,.36);
      border-color: rgba(255,255,255,.30);
    }

    /* List */
    .list{display:flex; flex-direction:column; gap:10px}
    .row{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:12px;
      border-radius:20px;
      border:1px solid rgba(2,6,23,.10);
      background:#fff;
    }
    .left{display:flex; align-items:center; gap:12px; min-width:0}
    .num{
      width:38px; height:38px; border-radius:14px;
      background: rgba(10,42,102,.08);
      border:1px solid rgba(10,42,102,.20);
      display:grid; place-items:center;
      font-weight:1100; color:var(--royal);
      flex:0 0 auto;
    }
    .name{font-weight:1100; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    /* Pay button (home) */
    .payBtn{
      min-width:120px;
      min-height:48px;
      border-radius:18px;
      font-weight:1100;
      cursor:pointer;
      transition: transform .08s ease, filter .12s ease, background .18s ease, color .18s ease, border-color .18s ease;
      user-select:none;
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
    }
    .payBtn:hover{transform:translateY(-1px); filter:brightness(1.02)}
    .pay-unpaid{ background:#fff; color:#b91c1c; border:2px solid #ef4444; }
    .pay-partial{ background: var(--soft); color: var(--royal); border:1px solid rgba(10,42,102,.26); }
    .pay-paid{ background: var(--royal); color:#fff; border:1px solid rgba(10,42,102,.35); }

    .moreBtn{
      width:52px; min-height:48px;
      border-radius:18px;
      border:1px solid rgba(2,6,23,.12);
      background:#fff;
      color:var(--ink);
      font-weight:1100;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
    }

    /* Inputs */
    label{display:block; font-weight:1100; font-size:13px; margin:10px 0 6px}
    input,select,textarea{
      width:100%;
      min-height:48px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(2,6,23,.12);
      outline:none;
      font-size:15px;
      background:#fff;
      color:var(--ink);
    }
    textarea{min-height:88px; resize:vertical}
    input:focus,select:focus,textarea:focus{border-color: rgba(10,42,102,.55)}
    .rowWrap{display:flex; gap:10px; flex-wrap:wrap}
    .rowWrap > *{flex:1; min-width:220px}

    /* Table */
    table{width:100%; border-collapse:separate; border-spacing:0 10px}
    th{font-size:12px; color:var(--muted); text-align:right; padding:0 8px}
    td{
      background:#fff;
      border:1px solid rgba(2,6,23,.10);
      padding:10px 10px;
      border-radius:14px;
    }

    /* Modal */
    .overlay{
      position:fixed; inset:0; z-index:90;
      background: rgba(2,6,23,.55);
      display:none;
      padding:14px;
    }
    .modal{
      max-width:720px;
      margin:6vh auto;
      background:#fff;
      color:var(--ink);
      border:1px solid rgba(2,6,23,.12);
      border-radius:24px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modal h3{margin:0 0 6px; font-size:16px}
    .modal .topline{display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap}
    .modal .actions{display:flex; gap:10px; flex-wrap:wrap}

    .toast{
      position:fixed; left:12px; bottom:88px; z-index:100;
      background: rgba(255,255,255,.96);
      color:var(--ink);
      border:1px solid rgba(2,6,23,.12);
      box-shadow: var(--shadow);
      padding:10px 12px;
      border-radius:16px;
      font-weight:1100;
      display:none;
      max-width:92vw;
    }

    /* Simple splash (Ø·Ù„Ø¨Ùƒ: ÙˆØ§Ø¬Ù‡Ø© Ø¬Ù…ÙŠÙ„Ø© ÙˆØ¹Ø¯Ù… ÙØªØ­ Ø¢Ø®Ø± Ù…Ø¬Ù…ÙˆØ¹Ø©) */
    .splash{
      min-height: calc(100vh - 98px);
      display:grid;
      place-items:center;
      padding:18px;
    }
    .splashCard{
      max-width:560px; width:100%;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      border-radius: 26px;
      padding:18px;
      box-shadow: 0 18px 42px rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
    }
    .splashLogo{
      width:56px; height:56px; border-radius:18px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.20);
      font-weight:1200;
      font-size:22px;
      margin-bottom:10px;
    }
  </style>
</head>

<body>

  <div class="page">

    <!-- SPLASH / UNLOCK -->
    <section id="pageSplash" class="splash">
      <div class="splashCard">
        <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap">
          <div style="display:flex; gap:12px; align-items:center">
            <div class="splashLogo">H</div>
            <div>
              <div class="titleBig">Hedra</div>
              <div class="hint" style="color:rgba(255,255,255,.78)">Ù†Ø³Ø®Ø© v4 Pro â€¢ ØªØ´ØºÙŠÙ„ + Ø¥Ø¯Ø§Ø±Ø©</div>
            </div>
          </div>
          <button class="btn light small" id="btnInstall" style="display:none">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</button>
        </div>

        <div class="hr" style="background:rgba(255,255,255,.16)"></div>

        <div class="hint" style="color:rgba(255,255,255,.82)">
          Ø³ÙŠØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬.  
          Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù† ÙŠØªÙ… Ø·Ù„Ø¨Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ (Ø¥Ù„Ø§ Ø¹Ù†Ø¯ Ø­Ø°Ù Ø­ØµØ© Ù„Ù„ØªØ£ÙƒÙŠØ¯).
        </div>

        <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn royal" id="btnUnlock">ğŸ”“ Ø¯Ø®ÙˆÙ„</button>
          <button class="btn ghost" id="btnExport">ØªØµØ¯ÙŠØ±</button>
          <button class="btn ghost" id="btnImport">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
        </div>
      </div>
    </section>

    <!-- HOME -->
    <section id="pageHome" style="display:none">
      <div class="homeHeader">
        <div class="titleBig">Hedra</div>
        <div class="dateBig mono" id="bigDate">â€”</div>

        <div class="hr" style="background:rgba(255,255,255,.14)"></div>

        <div class="rowWrap">
          <div>
            <label style="color:#fff; opacity:.92; margin-top:0">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
            <select id="homeGroupSelect"></select>
          </div>
          <div>
            <label style="color:#fff; opacity:.92; margin-top:0">Ø§Ù„Ø­ØµØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
              <div class="badge" id="homeSessionBadge">â€”</div>
              <div class="badge" id="homeCycleBadge">â€”</div>
            </div>
          </div>
        </div>

        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px">
          <div class="groupNameBig" id="homeGroupName" style="color:#fff">â€”</div>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn small royal" id="btnAddSession">+ Ø¥Ø¶Ø§ÙØ© Ø­ØµØ©</button>
            <button class="btn small danger" id="btnRemoveSession">âˆ’ Ø­Ø°Ù Ø­ØµØ©</button>
          </div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap">
          <div style="font-weight:1100">Ø§Ù„Ø·Ù„Ø§Ø¨</div>
          <div class="hint">Ø§Ø¶ØºØ· â€œØ¯ÙØ¹â€ Ù„Ø¥Ø¶Ø§ÙØ©/Ø®ØµÙ… Ù…Ø¨Ù„Øº Ø£Ùˆ Ø¯ÙØ¹ ÙƒØ§Ù…Ù„/Ù…Ù‚Ø¯Ù…</div>
        </div>
        <div class="hr"></div>
        <div class="list" id="homeStudentsList"></div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="pageAdmin" style="display:none">
      <div class="card">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap">
          <div>
            <div style="font-weight:1100">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
            <div class="hint" id="adminSub">â€”</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
            <button class="btn small ghost" id="btnChangePin">ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ</button>
            <button class="btn small ghost" id="btnSessionsLog">Ø³Ø¬Ù„ Ø§Ù„Ø­ØµØµ</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="rowWrap">
          <div>
            <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
            <select id="adminGroupSelect"></select>
          </div>
          <div>
            <label>Ø¨Ø­Ø« (ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª)</label>
            <input id="adminSearchAll" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." />
            <div class="hint">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« ØªØ¸Ù‡Ø± Ø£Ø³ÙÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©</div>
          </div>
        </div>

        <div class="hr"></div>

        <div id="adminTotals" class="rowWrap"></div>

        <div class="hr"></div>

        <div class="list" id="adminStudentsList"></div>

        <div class="hr"></div>
        <div id="adminSearchResultsWrap" style="display:none">
          <div style="font-weight:1100">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</div>
          <div class="hint">Ù…Ù† Ø£ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø©</div>
          <div class="hr"></div>
          <div class="list" id="adminSearchResults"></div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="pageSettings" style="display:none">
      <div class="card">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap">
          <div>
            <div style="font-weight:1100">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
            <div class="hint">Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù…ÙˆØ¹Ø© â€¢ Ø·Ù„Ø§Ø¨ â€¢ Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆØ±Ø© â€¢ Ø·ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ±Ø©</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
            <button class="btn small royal" id="btnAddGroup">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
            <button class="btn small ghost" id="btnReset">Ø¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯</button>
          </div>
        </div>

        <div class="hr"></div>

        <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</label>
        <div class="list" id="groupsList"></div>

        <div class="hr"></div>

        <div id="settingsGroupEditor" style="display:none">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap">
            <div style="font-weight:1100" id="editGroupTitle">â€”</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn small ghost" id="btnCloseGroupEditor">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="rowWrap">
            <div>
              <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
              <input id="editGroupName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø­Ø¯ ÙˆØ§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡"/>
            </div>
            <div>
              <label>Ø§Ø³Ù… Ø¹Ø±Ø¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="editGroupDisplayName" placeholder="ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"/>
            </div>
          </div>

          <div class="rowWrap">
            <div>
              <label>Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆØ±Ø©</label>
              <input id="editPriceCycle" type="number" min="0" step="1" placeholder="Ù…Ø«Ø§Ù„: 200"/>
            </div>
            <div>
              <label>Ø·ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ±Ø©</label>
              <select id="editCycleLen">
                <option value="4">4 Ø­ØµØµ</option>
                <option value="8" selected>8 Ø­ØµØµ</option>
                <option value="12">12 Ø­ØµØ©</option>
              </select>
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
            <button class="btn small royal" id="btnSaveGroup">Ø­ÙØ¸</button>
            <button class="btn small ghost" id="btnNewCycle">ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            <button class="btn small danger" id="btnDeleteGroup">Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
          </div>

          <div class="hr"></div>

          <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-end; flex-wrap:wrap">
            <div>
              <div style="font-weight:1100">Ø§Ù„Ø·Ù„Ø§Ø¨</div>
              <div class="hint">Ø®ØµÙ…/Ø¥Ø¹ÙØ§Ø¡ Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” Ø§Ù„Ø­Ø§Ù„Ø© ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <input id="newStudentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." style="min-width:220px"/>
              <button class="btn small royal" id="btnAddStudent">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
          </div>

          <div class="hr"></div>
          <div class="list" id="studentsList"></div>
        </div>
      </div>
    </section>

  </div>

  <!-- Tabs -->
  <div class="bottom">
    <div class="wrap">
      <button class="tab active" data-tab="home">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="tab" data-tab="admin">ğŸ§¾ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
      <button class="tab" data-tab="settings">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- MODALS -->

  <!-- Quick Pay Modal (Home) -->
  <div class="overlay" id="qpOverlay">
    <div class="modal">
      <div class="topline">
        <div>
          <h3 id="qpTitle">â€”</h3>
          <div class="hint mono" id="qpSub">â€”</div>
          <div id="qpStateBadges" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap"></div>
        </div>
        <div class="actions">
          <button class="btn small ghost" id="btnQpClose">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="rowWrap">
        <div>
          <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
          <input id="qpAmount" type="number" step="1" placeholder="Ù…Ø«Ø§Ù„: 50"/>
          <div class="hint">ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¯ÙØ¹ Ø£Ù‚Ù„/Ø£ÙƒØ«Ø± (Ù…Ù‚Ø¯Ù…). Ø§Ù„Ø®ØµÙ… ÙŠØ³ØªØ®Ø¯Ù… Ù„Ù„ØªØµØ­ÙŠØ­.</div>
        </div>
        <div>
          <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="qpNote" placeholder="Ù…Ø«Ø§Ù„: Ø¯ÙØ¹ Ø¬Ø²Ø¡ / Ù…Ù‚Ø¯Ù… / ØªØµØ­ÙŠØ­"/>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
        <button class="btn small royal" id="btnQpPayPart">Ø¯ÙØ¹ Ø¨Ø§Ù„Ù…Ø¨Ù„Øº</button>
        <button class="btn small ghost" id="btnQpMinus">Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹</button>
        <button class="btn small light" id="btnQpPayFull">Ø¯ÙØ¹ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</button>
      </div>

      <div class="hr"></div>

      <div id="qpMiniSummary" class="hint mono">â€”</div>

      <div class="hr"></div>

      <div class="hint">
        <b>Ù…Ø¹Ù„ÙˆÙ…Ø©:</b> Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø²Ø§Ø¦Ø¯ ÙŠØªØ­ÙˆÙ„ Ù„Ø±ØµÙŠØ¯ (Credit) ÙŠÙØ±Ø­Ù„ Ù„Ù„Ø¯ÙˆØ±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
      </div>
    </div>
  </div>

  <!-- Details/Pay Modal (Admin full) -->
  <div class="overlay" id="payOverlay">
    <div class="modal">
      <div class="topline">
        <div>
          <h3 id="payTitle">â€”</h3>
          <div class="hint mono" id="paySub">â€”</div>
          <div id="payStateBadges" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap"></div>
        </div>
        <div class="actions">
          <button class="btn small ghost" id="btnPayClose">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

      <div class="hr"></div>
      <div id="payTableWrap"></div>

      <div class="hr"></div>
      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn small royal" id="btnPayFull">Ø¯ÙØ¹ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</button>
        <button class="btn small ghost" id="btnPayAdd">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº</button>
        <button class="btn small ghost" id="btnPayMinus">âˆ’ Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹</button>
      </div>

      <div id="payAmountWrap" style="display:none; margin-top:10px">
        <label id="payAmountLabel">Ø§Ù„Ù…Ø¨Ù„Øº</label>
        <input id="payAmount" type="number" step="1" placeholder="Ù…Ø«Ø§Ù„: 50"/>
        <button class="btn small royal" id="btnPayApply" style="margin-top:10px">ØªØ·Ø¨ÙŠÙ‚</button>
      </div>

      <div class="hr"></div>

      <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input id="payNote" placeholder="Ù…Ø«Ø§Ù„: Ø¯ÙØ¹ Ø¬Ø²Ø¡ / Ù…Ù‚Ø¯Ù… / ØªØµØ­ÙŠØ­" />

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
        <button class="btn small royal" id="btnPaySaveNote">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
      </div>
    </div>
  </div>

  <!-- Student Modal (Settings) -->
  <div class="overlay" id="stOverlay">
    <div class="modal">
      <div class="topline">
        <div>
          <h3 id="stTitle">Ø·Ø§Ù„Ø¨</h3>
          <div class="hint">Ø§Ù„Ø­Ø§Ù„Ø© ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø£Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</div>
        </div>
        <div class="actions">
          <button class="btn small ghost" id="btnStClose">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

      <div class="hr"></div>

      <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
      <input id="stName" />

      <div class="rowWrap">
        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø®ØµÙ…</label>
          <select id="stDiscType">
            <option value="none">Ø¨Ø¯ÙˆÙ†</option>
            <option value="fixed">Ø®ØµÙ… Ù…Ø¨Ù„Øº</option>
            <option value="percent">Ø®ØµÙ… Ù†Ø³Ø¨Ø©</option>
            <option value="exempt">Ø¥Ø¹ÙØ§Ø¡</option>
          </select>
        </div>
        <div>
          <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…</label>
          <input id="stDiscVal" type="number" step="1" placeholder="Ù…Ø«Ø§Ù„: 50 Ø£Ùˆ 10%"/>
        </div>
      </div>

      <label style="display:flex; align-items:center; gap:10px; margin-top:10px">
        <input id="stPaused" type="checkbox" style="width:auto; min-height:auto"/>
        Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø·Ø§Ù„Ø¨ (Ù„Ø§ ÙŠØªØ­Ø§Ø³Ø¨ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù)
      </label>

      <div class="hr"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn small royal" id="btnStSave">Ø­ÙØ¸</button>
        <button class="btn small danger" id="btnStDelete">Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨</button>
      </div>
    </div>
  </div>

  <!-- Sessions Log Modal -->
  <div class="overlay" id="ssOverlay">
    <div class="modal">
      <div class="topline">
        <div>
          <h3>Ø³Ø¬Ù„ Ø§Ù„Ø­ØµØµ</h3>
          <div class="hint">ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­ØµØµ Ù„Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
        </div>
        <div class="actions">
          <button class="btn small ghost" id="btnSsClose">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
      <div class="hr"></div>
      <div id="ssList" class="hint mono">â€”</div>
    </div>
  </div>

<script>
/* =========================================================
   Hedra v4 Pro (Rebuild)
   - PIN asked once per session (on unlock)
   - Delete session requires PIN confirm (always)
   - Home: single section (title + big date + group selector + session number + add/remove + students)
   - Search: Admin only, across ALL groups
   - Payments: quick pay (amount add), minus correction, pay full remaining, can overpay (credit)
   - No "remember last group": home group selection not persisted
========================================================= */

const DB_KEY = "hedra_v4_pro_singlefile";
const SESSION_UNLOCK_KEY = "hedra_v4_unlocked";
const SESSION_GROUP_KEY  = "hedra_v4_selected_group"; // session only; we will clear at init to avoid remembering

let db = { groups: [] };

/* ---------- Utils ---------- */
function uid(p="id"){ return p+"_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16); }
function round2(n){ return Math.round((Number(n||0))*100)/100; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.style.display="none",2200);
}
function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function loadDB(){
  const raw = localStorage.getItem(DB_KEY);
  if(!raw) return;
  try{
    const p=JSON.parse(raw);
    if(p && typeof p==="object") db=p;
  }catch{}
}
function todayText(){
  return new Date().toLocaleDateString("ar-EG",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
}
function isoYMD(d=new Date()){
  const x=new Date(d); x.setHours(0,0,0,0);
  return x.toISOString().slice(0,10);
}
function fmtDMY(iso){
  const d=new Date(iso);
  const dd=String(d.getDate()).padStart(2,"0");
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const yy=d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}

/* ---------- PIN / Session Unlock ---------- */
function getPIN(){ return localStorage.getItem("hedra_pin") || ""; }
function setPIN(pin){ localStorage.setItem("hedra_pin", pin); }

function requirePINSetupOrCheck(){
  const existing = getPIN();
  if(!existing){
    const set = prompt("Ø¹ÙŠÙ‘Ù†ÙŠ Ø±Ù‚Ù… Ø³Ø±ÙŠ (4 Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ Ø£ÙƒØ«Ø±)");
    if(!set || set.trim().length < 4) return false;
    setPIN(set.trim());
    return true;
  }
  const entered = prompt("Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ");
  if(entered === existing) return true;
  alert("Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­");
  return false;
}

function isUnlocked(){
  return sessionStorage.getItem(SESSION_UNLOCK_KEY) === "1";
}
function setUnlocked(v){
  sessionStorage.setItem(SESSION_UNLOCK_KEY, v ? "1" : "0");
}

/* ---------- Data Model ---------- */
/*
group = { id, name, displayName, price, cycleLen, students:[...], blocks:[...] }
student = { id, name, paused, discountType, discountValue }
block = {
  id, createdAtISO,
  sessions:[{id,tsISO}],
  payments:{ [sid]: number }, notes:{ [sid]: string },
  carry:{ [sid]: number }, // signed (+due / -credit)
  closed:boolean
}
*/

function newBlock(){
  return {
    id: uid("b"),
    createdAtISO: new Date().toISOString(),
    sessions: [],
    payments: {},
    notes: {},
    carry: {},
    closed: false
  };
}

function ensureDefaults(){
  if(!Array.isArray(db.groups)) db.groups=[];

  // create initial data if empty
  if(db.groups.length===0){
    db.groups.push({
      id: uid("g"),
      name: "Ù…Ø¬Ù…ÙˆØ¹Ø© 1",
      displayName: "",
      price: 200,
      cycleLen: 8,
      students: [],
      blocks: [ newBlock() ]
    });
  }

  db.groups.forEach(g=>{
    if(!g.id) g.id=uid("g");
    if(typeof g.name!=="string") g.name="Ù…Ø¬Ù…ÙˆØ¹Ø©";
    if(typeof g.displayName!=="string") g.displayName="";
    if(typeof g.price!=="number") g.price=Number(g.price||0);
    if(!g.cycleLen) g.cycleLen=8;
    if(!Array.isArray(g.students)) g.students=[];
    if(!Array.isArray(g.blocks)) g.blocks=[ newBlock() ];

    g.students.forEach(s=>{
      if(!s.id) s.id=uid("s");
      if(typeof s.name!=="string") s.name="Ø·Ø§Ù„Ø¨";
      if(typeof s.paused!=="boolean") s.paused=false;
      if(!s.discountType) s.discountType="none";
      if(typeof s.discountValue!=="number") s.discountValue=Number(s.discountValue||0);
    });

    g.blocks.forEach(b=>{
      if(!b.id) b.id=uid("b");
      if(!b.createdAtISO) b.createdAtISO=new Date().toISOString();
      if(!Array.isArray(b.sessions)) b.sessions=[];
      if(!b.payments || typeof b.payments!=="object") b.payments={};
      if(!b.notes || typeof b.notes!=="object") b.notes={};
      if(!b.carry || typeof b.carry!=="object") b.carry={};
      if(typeof b.closed!=="boolean") b.closed=false;
    });

    if(g.blocks.length===0) g.blocks=[ newBlock() ];
  });

  saveDB();
}

function getGroupById(id){
  return db.groups.find(g=>g.id===id) || null;
}
function curBlock(g){
  return g?.blocks?.[g.blocks.length-1] || null;
}

/* ---------- Pricing / Totals ---------- */
function cycleLen(g){ return Math.max(1, Number(g.cycleLen||8)); }
function cyclePrice(g){ return Math.max(0, Number(g.price||0)); }

function effectiveCyclePrice(g,s){
  if(s.paused) return 0;
  const base = cyclePrice(g);
  const t=(s.discountType||"none");
  const v=Number(s.discountValue||0);

  if(t==="exempt") return 0;
  if(t==="fixed") return Math.max(0, base - Math.max(0,v));
  if(t==="percent"){
    const p=Math.max(0, Math.min(100, v));
    return Math.max(0, base*(1-p/100));
  }
  return base;
}
function perSessionForStudent(g,s){
  return round2(effectiveCyclePrice(g,s) / cycleLen(g));
}
function sessionsCount(b){ return (b.sessions||[]).length; }
function carry(b,sid){ return round2(Number(b.carry?.[sid] || 0)); }   // signed
function paid(b,sid){ return round2(Number(b.payments?.[sid] || 0)); } // can exceed

function subscriptionDueSoFar(g,b,s){
  return round2(sessionsCount(b) * perSessionForStudent(g,s));
}

function totals(g,b,s){
  const sub = subscriptionDueSoFar(g,b,s);
  const prev = carry(b, s.id);
  const total = round2(sub + prev);
  const p = paid(b, s.id);
  const remaining = round2(total - p); // +due / -credit
  return { sub, prev, total, paid:p, remaining };
}

function status(g,b,s){
  const t=totals(g,b,s);
  if(t.remaining <= 0) return "paid";
  if(t.paid > 0) return "partial";
  return "unpaid";
}

/* ---------- Cycle Date Auto (Ø·Ù„Ø¨Ùƒ: Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ±Ø© = Ø£ÙˆÙ„ Ø­ØµØ©) ---------- */
function cycleStartLabel(b){
  if(!b || !b.sessions?.length) return "â€”";
  // start = first session timestamp
  return fmtDMY(b.sessions[0].tsISO);
}
function cycleEndLabel(g,b){
  if(!b || sessionsCount(b) < cycleLen(g)) return "â€”";
  // end = last session date once completed
  return fmtDMY(b.sessions[b.sessions.length-1].tsISO);
}

/* ---------- Session Group selection: do not remember last group (Ø·Ù„Ø¨Ùƒ) ---------- */
function getSessionGroup(){
  return sessionStorage.getItem(SESSION_GROUP_KEY) || "";
}
function setSessionGroup(id){
  sessionStorage.setItem(SESSION_GROUP_KEY, id || "");
}

/* ---------- Export / Import ---------- */
document.getElementById("btnExport").onclick=()=>{
  const data = JSON.stringify(db, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "Hedra_Backup_v4.json";
  a.click();
  URL.revokeObjectURL(a.href);
  toast("ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±");
};
document.getElementById("btnImport").onclick=()=>{
  const inp=document.createElement("input");
  inp.type="file"; inp.accept="application/json";
  inp.onchange=()=>{
    const f=inp.files?.[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const parsed=JSON.parse(r.result);
        if(!parsed || typeof parsed!=="object") throw new Error();
        db=parsed;
        ensureDefaults();
        toast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯");
        renderAll();
      }catch{
        alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
      }
    };
    r.readAsText(f);
  };
  inp.click();
};

/* ---------- Tabs ---------- */
const pages = {
  splash: document.getElementById("pageSplash"),
  home: document.getElementById("pageHome"),
  admin: document.getElementById("pageAdmin"),
  settings: document.getElementById("pageSettings")
};

function showTab(k){
  // enforce unlock for any app page
  if(k !== "splash" && !isUnlocked()){
    pages.splash.style.display="";
    pages.home.style.display="none";
    pages.admin.style.display="none";
    pages.settings.style.display="none";
    document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab==="home"));
    return;
  }

  pages.splash.style.display = (k==="splash") ? "" : "none";
  pages.home.style.display   = (k==="home")   ? "" : "none";
  pages.admin.style.display  = (k==="admin")  ? "" : "none";
  pages.settings.style.display=(k==="settings")? "" : "none";

  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===k));
  renderAll();
}
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>showTab(t.dataset.tab));
});

/* ---------- Unlock Button ---------- */
document.getElementById("btnUnlock").onclick=()=>{
  if(requirePINSetupOrCheck()){
    setUnlocked(true);

    // IMPORTANT: do not remember last group => clear session selected group on each new unlock
    setSessionGroup("");

    toast("ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„");
    showTab("home");
  }
};

/* ---------- HOME ---------- */
const homeGroupSelect = document.getElementById("homeGroupSelect");

function refreshHomeGroupSelect(){
  homeGroupSelect.innerHTML="";
  const o0=document.createElement("option");
  o0.value=""; o0.textContent="â€” Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø© â€”";
  homeGroupSelect.appendChild(o0);

  db.groups.forEach(g=>{
    const o=document.createElement("option");
    o.value=g.id;
    o.textContent=g.name;
    homeGroupSelect.appendChild(o);
  });

  homeGroupSelect.value = getSessionGroup();
}

homeGroupSelect.addEventListener("change",(e)=>{
  setSessionGroup(e.target.value || "");
  renderAll();
});

document.getElementById("btnAddSession").onclick=()=>{
  const gid=getSessionGroup();
  const g=getGroupById(gid);
  if(!g){ toast("Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£ÙˆÙ„Ø§Ù‹"); return; }
  const b=curBlock(g); if(!b) return;

  if(sessionsCount(b) >= cycleLen(g)){
    toast("Ø§ÙƒØªÙ…Ù„Øª Ø­ØµØµ Ø§Ù„Ø¯ÙˆØ±Ø©. Ø§ÙØªØ­ÙŠ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.");
    return;
  }

  b.sessions.push({ id:uid("ss"), tsISO:new Date().toISOString() });
  saveDB();
  toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­ØµØ©");
  renderAll();
};

document.getElementById("btnRemoveSession").onclick=()=>{
  const gid=getSessionGroup();
  const g=getGroupById(gid);
  if(!g){ toast("Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£ÙˆÙ„Ø§Ù‹"); return; }
  const b=curBlock(g); if(!b) return;

  if(!b.sessions.length){
    toast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ù„Ù„Ø­Ø°Ù");
    return;
  }

  // Ø·Ù„Ø¨Ùƒ: Ø­Ø°Ù Ø§Ù„Ø­ØµØ© ÙŠØ­ØªØ§Ø¬ Ø¨Ø§Ø³ÙˆØ±Ø¯ (Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…ÙØªÙˆØ­)
  const okPin = requirePINSetupOrCheck();
  if(!okPin) return;

  const ok=confirm("Ø­Ø°Ù Ø¢Ø®Ø± Ø­ØµØ©ØŸ");
  if(!ok) return;

  b.sessions.pop();
  saveDB();
  toast("ØªÙ… Ø­Ø°Ù Ø¢Ø®Ø± Ø­ØµØ©");
  renderAll();
};

function renderHomeHeader(){
  document.getElementById("bigDate").textContent = todayText();

  const gid=getSessionGroup();
  const g=getGroupById(gid);
  const b=g?curBlock(g):null;

  document.getElementById("homeGroupName").textContent = g ? (g.displayName || g.name) : "â€”";

  if(!g || !b){
    document.getElementById("homeSessionBadge").textContent = "Ø§Ù„Ø­ØµØ©: â€”";
    document.getElementById("homeCycleBadge").textContent = "Ø§Ù„Ø¯ÙˆØ±Ø©: â€”";
    return;
  }

  const sc = sessionsCount(b);
  const next = Math.min(sc+1, cycleLen(g));
  document.getElementById("homeSessionBadge").textContent = `Ø§Ù„Ø­ØµØ©: ${next} / ${cycleLen(g)}`;
  const from = cycleStartLabel(b);
  const to = cycleEndLabel(g,b);
  document.getElementById("homeCycleBadge").textContent = `Ø§Ù„Ø¯ÙˆØ±Ø©: ${from} â†’ ${to}`;
}

function renderHomeStudents(){
  const wrap=document.getElementById("homeStudentsList");
  wrap.innerHTML="";

  const gid=getSessionGroup();
  const g=getGroupById(gid);
  const b=g?curBlock(g):null;

  if(!g){
    wrap.innerHTML = `<div class="hint">Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨.</div>`;
    return;
  }
  if(!g.students.length){
    wrap.innerHTML = `<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©. Ø£Ø¶ÙŠÙÙŠÙ‡Ù… Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.</div>`;
    return;
  }

  const list=[...g.students].sort((a,b)=>a.name.localeCompare(b.name,"ar"));
  list.forEach((s,idx)=>{
    const st=status(g,b,s);

    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <div class="left">
        <div class="num">${idx+1}</div>
        <div class="name">${escapeHtml(s.name)} ${s.paused?` <span class="badge red">Ù…ÙˆÙ‚ÙˆÙ</span>`:""}</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="payBtn ${st==="paid"?"pay-paid":st==="partial"?"pay-partial":"pay-unpaid"}">${st==="paid"?"ØªÙ…/Ø±ØµÙŠØ¯":"Ø¯ÙØ¹"}</button>
        <button class="moreBtn" title="ØªÙØ§ØµÙŠÙ„ (Ø¥Ø¯Ø§Ø±Ø©)">â‹¯</button>
      </div>
    `;

    row.querySelector(".payBtn").onclick=()=>{
      if(s.paused){ toast("Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆÙ‚ÙˆÙ"); return; }
      openQuickPay(g,b,s);
    };

    row.querySelector(".moreBtn").onclick=()=>{
      // Admin details allowed because already unlocked
      openPayModal(g,b,s);
    };

    wrap.appendChild(row);
  });
}

/* ---------- QUICK PAY (Home) ---------- */
const qpOverlay = document.getElementById("qpOverlay");
const qpAmount  = document.getElementById("qpAmount");
let qpCtx=null;

document.getElementById("btnQpClose").onclick=()=>{ qpOverlay.style.display="none"; qpCtx=null; };
qpOverlay.addEventListener("click",(e)=>{ if(e.target===qpOverlay){ qpOverlay.style.display="none"; qpCtx=null; } });

function studentStateBadges(s){
  const arr=[];
  if(s.paused) arr.push(`<span class="badge red">Ù…ÙˆÙ‚ÙˆÙ</span>`);
  if(s.discountType==="exempt") arr.push(`<span class="badge">Ù…Ø¹ÙÙ‰</span>`);
  if(s.discountType==="fixed") arr.push(`<span class="badge">Ø®ØµÙ… Ù…Ø¨Ù„Øº: ${escapeHtml(String(s.discountValue||0))}</span>`);
  if(s.discountType==="percent") arr.push(`<span class="badge">Ø®ØµÙ… Ù†Ø³Ø¨Ø©: ${escapeHtml(String(s.discountValue||0))}%</span>`);
  return arr.join("");
}

function openQuickPay(g,b,s){
  qpCtx={g,b,s};
  qpAmount.value="";
  document.getElementById("qpNote").value = String(b.notes?.[s.id] || "");

  const sc = sessionsCount(b);
  const cycleInfo = `Ø­ØµØµ: ${sc}/${cycleLen(g)} â€¢ Ø§Ù„Ø¯ÙˆØ±Ø©: ${cycleStartLabel(b)} â†’ ${cycleEndLabel(g,b)}`;
  document.getElementById("qpTitle").textContent = s.name;
  document.getElementById("qpSub").textContent = cycleInfo;
  document.getElementById("qpStateBadges").innerHTML = studentStateBadges(s) || `<span class="badge">â€”</span>`;

  updateQuickPaySummary(g,b,s);

  qpOverlay.style.display="block";
  setTimeout(()=>qpAmount.focus(), 40);
}

function updateQuickPaySummary(g,b,s){
  const t=totals(g,b,s);
  const msg = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†: ${t.total} â€¢ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${t.paid} â€¢ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${t.remaining}`;
  document.getElementById("qpMiniSummary").textContent = msg;
}

function saveNoteForStudent(b,sid, note){
  b.notes[sid] = String(note||"").trim();
}

document.getElementById("btnQpPayPart").onclick=()=>{
  if(!qpCtx) return;
  const {g,b,s}=qpCtx;
  const v=Number(qpAmount.value||0);
  if(!(v>0)) return alert("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");

  const cur = paid(b,s.id);
  b.payments[s.id] = round2(cur + v);

  saveNoteForStudent(b, s.id, document.getElementById("qpNote").value);
  saveDB();
  toast("ØªÙ… Ø§Ù„Ø¯ÙØ¹");
  updateQuickPaySummary(g,b,s);
  renderAll();
};

document.getElementById("btnQpMinus").onclick=()=>{
  if(!qpCtx) return;
  const {g,b,s}=qpCtx;
  const v=Number(qpAmount.value||0);
  if(!(v>0)) return alert("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");

  const cur = paid(b,s.id);
  b.payments[s.id] = round2(Math.max(0, cur - v));

  saveNoteForStudent(b, s.id, document.getElementById("qpNote").value);
  saveDB();
  toast("ØªÙ… Ø§Ù„Ø®ØµÙ…");
  updateQuickPaySummary(g,b,s);
  renderAll();
};

document.getElementById("btnQpPayFull").onclick=()=>{
  if(!qpCtx) return;
  const {g,b,s}=qpCtx;
  const t=totals(g,b,s);
  if(t.remaining <= 0){ toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¨Ù‚ÙŠ"); return; }

  b.payments[s.id] = round2(t.total);

  saveNoteForStudent(b, s.id, document.getElementById("qpNote").value);
  saveDB();
  toast("ØªÙ… Ø¯ÙØ¹ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ");
  updateQuickPaySummary(g,b,s);
  renderAll();
};

/* ---------- ADMIN: sessions log / change pin ---------- */
document.getElementById("btnSessionsLog").onclick=()=>{
  const gid = document.getElementById("adminGroupSelect").value || "";
  const g = getGroupById(gid);
  const b = g ? curBlock(g) : null;
  if(!g || !b){ toast("Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø©"); return; }

  const ss = b.sessions.map((x,i)=>`${i+1}) ${fmtDMY(x.tsISO)}`).join("\n");
  document.getElementById("ssList").textContent = ss || "â€”";
  document.getElementById("ssOverlay").style.display="block";
};
document.getElementById("btnSsClose").onclick=()=>document.getElementById("ssOverlay").style.display="none";
document.getElementById("ssOverlay").addEventListener("click",(e)=>{ if(e.target.id==="ssOverlay") document.getElementById("ssOverlay").style.display="none"; });

document.getElementById("btnChangePin").onclick=()=>{
  const existing=getPIN();
  if(existing){
    const entered = prompt("Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ");
    if(entered !== existing){ alert("ØºÙŠØ± ØµØ­ÙŠØ­"); return; }
  }
  const n = prompt("Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (4 Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ Ø£ÙƒØ«Ø±)");
  if(!n || n.trim().length < 4) return alert("Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­");
  setPIN(n.trim());
  toast("ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ");
};

const adminGroupSelect = document.getElementById("adminGroupSelect");
const adminSearchAll   = document.getElementById("adminSearchAll");

function refreshAdminGroupSelect(){
  adminGroupSelect.innerHTML="";
  db.groups.forEach(g=>{
    const o=document.createElement("option");
    o.value=g.id; o.textContent=g.name;
    adminGroupSelect.appendChild(o);
  });
  // default to first group if exists
  if(db.groups[0]) adminGroupSelect.value = db.groups[0].id;
}

adminGroupSelect.addEventListener("change", ()=>renderAdmin());
adminSearchAll.addEventListener("input", ()=>renderAdminSearchAll());

function adminGroupTotals(g,b){
  let total=0, paidSum=0, remainingSum=0;

  g.students.forEach(s=>{
    const t=totals(g,b,s);
    total += t.total;
    paidSum += t.paid;
    remainingSum += t.remaining;
  });

  total=round2(total); paidSum=round2(paidSum); remainingSum=round2(remainingSum);

  const wrap=document.getElementById("adminTotals");
  wrap.innerHTML=`
    <div class="row" style="flex:1; min-width:240px">
      <div class="left"><div class="num">âˆ‘</div><div><div class="name">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</div><div class="hint mono">${total}</div></div></div>
    </div>
    <div class="row" style="flex:1; min-width:240px">
      <div class="left"><div class="num">ğŸ’°</div><div><div class="name">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div><div class="hint mono">${paidSum}</div></div></div>
    </div>
    <div class="row" style="flex:1; min-width:240px">
      <div class="left"><div class="num">ğŸ§¾</div><div><div class="name">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div><div class="hint mono">${remainingSum}</div></div></div>
    </div>
  `;
}

function renderAdmin(){
  const gid = adminGroupSelect.value || "";
  const g = getGroupById(gid);
  const b = g ? curBlock(g) : null;

  document.getElementById("adminSub").textContent = (g && b)
    ? `${g.displayName || g.name} â€¢ Ø­ØµØµ: ${sessionsCount(b)}/${cycleLen(g)} â€¢ Ø§Ù„Ø¯ÙˆØ±Ø©: ${cycleStartLabel(b)} â†’ ${cycleEndLabel(g,b)}`
    : "â€”";

  const listWrap=document.getElementById("adminStudentsList");
  listWrap.innerHTML="";

  if(!g || !b){
    listWrap.innerHTML=`<div class="hint">â€”</div>`;
    return;
  }

  adminGroupTotals(g,b);

  if(!g.students.length){
    listWrap.innerHTML=`<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨.</div>`;
    return;
  }

  const list=[...g.students].sort((a,b)=>a.name.localeCompare(b.name,"ar"));
  list.forEach(s=>{
    const t=totals(g,b,s);
    const st=status(g,b,s);

    const it=document.createElement("div");
    it.className="row";
    it.innerHTML=`
      <div class="left" style="min-width:0">
        <div class="num">ğŸ‘¤</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(s.name)} ${s.paused?` <span class="badge red">Ù…ÙˆÙ‚ÙˆÙ</span>`:""}</div>
          <div class="hint mono">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${t.total} â€¢ Ù…Ø¯ÙÙˆØ¹: ${t.paid} â€¢ Ù…ØªØ¨Ù‚ÙŠ: ${t.remaining}</div>
        </div>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <div class="badge">${st==="paid"?"Ù…ÙƒØªÙ…Ù„/Ø±ØµÙŠØ¯":st==="partial"?"Ø¬Ø²Ø¦ÙŠ":"ØºÙŠØ± Ù…ÙƒØªÙ…Ù„"}</div>
        <button class="moreBtn">Ø¹Ø±Ø¶</button>
      </div>
    `;
    it.querySelector("button").onclick=()=>openPayModal(g,b,s);
    listWrap.appendChild(it);
  });

  renderAdminSearchAll();
}

function renderAdminSearchAll(){
  const q=(adminSearchAll.value||"").trim().toLowerCase();
  const wrap=document.getElementById("adminSearchResultsWrap");
  const out=document.getElementById("adminSearchResults");
  out.innerHTML="";

  if(!q){
    wrap.style.display="none";
    return;
  }

  const hits=[];
  db.groups.forEach(g=>{
    const b=curBlock(g);
    g.students.forEach(s=>{
      if(s.name.toLowerCase().includes(q)){
        hits.push({g,b,s});
      }
    });
  });

  wrap.style.display="";
  if(!hits.length){
    out.innerHTML=`<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</div>`;
    return;
  }

  hits
    .sort((a,b)=>a.s.name.localeCompare(b.s.name,"ar"))
    .forEach(({g,b,s})=>{
      const t=totals(g,b,s);
      const it=document.createElement("div");
      it.className="row";
      it.innerHTML=`
        <div class="left" style="min-width:0">
          <div class="num">ğŸ”</div>
          <div style="min-width:0">
            <div class="name">${escapeHtml(s.name)}</div>
            <div class="hint">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: <b>${escapeHtml(g.name)}</b></div>
            <div class="hint mono">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${t.total} â€¢ Ù…Ø¯ÙÙˆØ¹: ${t.paid} â€¢ Ù…ØªØ¨Ù‚ÙŠ: ${t.remaining}</div>
          </div>
        </div>
        <div><button class="moreBtn">Ø¹Ø±Ø¶</button></div>
      `;
      it.querySelector("button").onclick=()=>openPayModal(g,b,s);
      out.appendChild(it);
    });
}

/* ---------- ADMIN Pay/Details Modal ---------- */
const payOverlay=document.getElementById("payOverlay");
const payAmountWrap=document.getElementById("payAmountWrap");
const payAmount=document.getElementById("payAmount");
const payAmountLabel=document.getElementById("payAmountLabel");
let payCtx=null;
let payMode=null; // add | minus

document.getElementById("btnPayClose").onclick=()=>{ payOverlay.style.display="none"; payCtx=null; payMode=null; payAmountWrap.style.display="none"; };
payOverlay.addEventListener("click",(e)=>{ if(e.target===payOverlay){ payOverlay.style.display="none"; payCtx=null; payMode=null; payAmountWrap.style.display="none"; } });

document.getElementById("btnPayFull").onclick=()=>{
  if(!payCtx) return;
  const {g,b,s}=payCtx;
  const t=totals(g,b,s);
  if(t.remaining <= 0){ toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¨Ù‚ÙŠ"); return; }
  b.payments[s.id] = round2(t.total);
  saveDB();
  toast("ØªÙ…");
  renderAll();
  openPayModal(g,b,s);
};

document.getElementById("btnPayAdd").onclick=()=>{
  payMode="add";
  payAmountWrap.style.display="";
  payAmountLabel.textContent="Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº Ù„Ù„Ù…Ø¯ÙÙˆØ¹";
  payAmount.value="";
  payAmount.focus();
};

document.getElementById("btnPayMinus").onclick=()=>{
  payMode="minus";
  payAmountWrap.style.display="";
  payAmountLabel.textContent="Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (ØªØµØ­ÙŠØ­)";
  payAmount.value="";
  payAmount.focus();
};

document.getElementById("btnPayApply").onclick=()=>{
  if(!payCtx || !payMode) return;
  const {b,s}=payCtx;
  const v=Number(payAmount.value||0);
  if(!(v>0)) return alert("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");

  const cur = paid(b,s.id);

  if(payMode==="add"){
    b.payments[s.id] = round2(cur + v);
    toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
  }else{
    b.payments[s.id] = round2(Math.max(0, cur - v));
    toast("ØªÙ… Ø§Ù„Ø®ØµÙ…");
  }

  saveDB();
  payMode=null;
  payAmountWrap.style.display="none";
  payAmount.value="";
  renderAll();
  openPayModal(payCtx.g, payCtx.b, payCtx.s);
};

document.getElementById("btnPaySaveNote").onclick=()=>{
  if(!payCtx) return;
  const {b,s}=payCtx;
  b.notes[s.id] = String(document.getElementById("payNote").value||"").trim();
  saveDB();
  toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©");
};

function openPayModal(g,b,s){
  payCtx={g,b,s};
  payMode=null;
  payAmountWrap.style.display="none";
  payAmount.value="";

  const t=totals(g,b,s);

  const cycleLabel = `Ø­ØµØµ: ${sessionsCount(b)}/${cycleLen(g)} â€¢ Ø§Ù„Ø¯ÙˆØ±Ø©: ${cycleStartLabel(b)} â†’ ${cycleEndLabel(g,b)}`;
  document.getElementById("payTitle").textContent = s.name;
  document.getElementById("paySub").textContent = cycleLabel;

  document.getElementById("payNote").value = String(b.notes?.[s.id] || "");

  // state badges (Ø·Ù„Ø¨Ùƒ: ÙŠØ¸Ù‡Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¹ÙÙ‰/Ø®ØµÙ…/Ù…ÙˆÙ‚ÙˆÙ)
  document.getElementById("payStateBadges").innerHTML = studentStateBadges(s) || `<span class="badge">â€”</span>`;

  const ss = b.sessions.map(x=>fmtDMY(x.tsISO)).join(" â€¢ ");

  const table = `
    <table>
      <thead>
        <tr><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr>
      </thead>
      <tbody>
        <tr><td>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td><td class="mono">${t.sub}</td></tr>
        <tr><td>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚</td><td class="mono">${t.prev}</td></tr>
        <tr><td><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</b></td><td class="mono"><b>${t.total}</b></td></tr>
        <tr><td>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</td><td class="mono">${t.paid}</td></tr>
        <tr><td><b>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</b></td><td class="mono"><b>${t.remaining}</b></td></tr>
      </tbody>
    </table>
  `;

  document.getElementById("payTableWrap").innerHTML = `
    <div class="hint">ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­ØµØµ: <span class="mono">${escapeHtml(ss||"â€”")}</span></div>
    <div class="hr"></div>
    ${table}
  `;

  payOverlay.style.display="block";
}

/* ---------- SETTINGS: Groups & Students ---------- */
const groupsList = document.getElementById("groupsList");
const editor = document.getElementById("settingsGroupEditor");
let editGroupId = null;

document.getElementById("btnAddGroup").onclick=()=>{
  const name=(prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©")||"").trim();
  if(!name) return;
  if(db.groups.some(x=>x.name.trim().toLowerCase()===name.toLowerCase())) return alert("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©");

  db.groups.push({
    id: uid("g"),
    name,
    displayName:"",
    price: 200,
    cycleLen: 8,
    students: [],
    blocks: [ newBlock() ]
  });
  saveDB();
  toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©");
  renderAll();
};

document.getElementById("btnReset").onclick=()=>{
  const ok=confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯. Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ");
  if(!ok) return;
  localStorage.removeItem(DB_KEY);
  location.reload();
};

document.getElementById("btnCloseGroupEditor").onclick=()=>{
  editor.style.display="none";
  editGroupId=null;
};

document.getElementById("btnSaveGroup").onclick=()=>{
  const g=getGroupById(editGroupId);
  if(!g) return;

  const n=(document.getElementById("editGroupName").value||"").trim();
  if(!n) return alert("Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©");

  // prevent duplicate names
  if(db.groups.some(x=>x.id!==g.id && x.name.trim().toLowerCase()===n.toLowerCase())) return alert("Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙˆØ¬ÙˆØ¯");

  g.name=n;
  g.displayName=(document.getElementById("editGroupDisplayName").value||"").trim();
  g.price=Number(document.getElementById("editPriceCycle").value||0);
  g.cycleLen=Number(document.getElementById("editCycleLen").value||8);

  saveDB();
  toast("ØªÙ… Ø§Ù„Ø­ÙØ¸");
  renderAll();
};

document.getElementById("btnNewCycle").onclick=()=>{
  const g=getGroupById(editGroupId);
  if(!g) return;
  const b=curBlock(g);
  if(!b) return;

  const ok = confirm("ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ Ø³ÙŠØªÙ… ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ/Ø§Ù„Ø±ØµÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.");
  if(!ok) return;

  // carry remaining (signed)
  const carryMap = {};
  g.students.forEach(s=>{
    const t = totals(g,b,s);
    if(Math.abs(t.remaining) > 0.0001) carryMap[s.id]=t.remaining;
  });

  b.closed=true;

  const nb = newBlock();
  nb.carry = carryMap;
  g.blocks.push(nb);

  saveDB();
  toast("ØªÙ… ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©");
  renderAll();
};

document.getElementById("btnDeleteGroup").onclick=()=>{
  const g=getGroupById(editGroupId);
  if(!g) return;

  const ok=confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§ØŸ");
  if(!ok) return;

  db.groups = db.groups.filter(x=>x.id!==g.id);
  saveDB();
  toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©");
  editor.style.display="none";
  editGroupId=null;
  renderAll();
};

document.getElementById("btnAddStudent").onclick=()=>{
  const g=getGroupById(editGroupId);
  if(!g) return;

  const name=(document.getElementById("newStudentName").value||"").trim();
  if(!name) return;
  if(g.students.some(s=>s.name.trim().toLowerCase()===name.toLowerCase())) return alert("Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯");

  g.students.push({ id:uid("s"), name, paused:false, discountType:"none", discountValue:0 });
  document.getElementById("newStudentName").value="";
  saveDB();
  toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨");
  renderAll();
};

/* Student editor modal */
const stOverlay=document.getElementById("stOverlay");
let stCtx=null;

document.getElementById("btnStClose").onclick=()=>{ stOverlay.style.display="none"; stCtx=null; };
stOverlay.addEventListener("click",(e)=>{ if(e.target===stOverlay){ stOverlay.style.display="none"; stCtx=null; } });

document.getElementById("btnStSave").onclick=()=>{
  if(!stCtx) return;
  const { g, s } = stCtx;

  const newName=(document.getElementById("stName").value||"").trim();
  if(!newName) return alert("Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… ØµØ­ÙŠØ­");

  if(g.students.some(x=>x.id!==s.id && x.name.trim().toLowerCase()===newName.toLowerCase())) return alert("Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„");

  s.name=newName;
  s.discountType=document.getElementById("stDiscType").value || "none";
  s.discountValue=Number(document.getElementById("stDiscVal").value||0);
  s.paused=!!document.getElementById("stPaused").checked;

  saveDB();
  toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨");
  renderAll();
  stOverlay.style.display="none";
  stCtx=null;
};

document.getElementById("btnStDelete").onclick=()=>{
  if(!stCtx) return;
  const { g, s } = stCtx;

  const ok=confirm("Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ù…Ø¯ÙÙˆØ¹Ø§ØªÙ‡ ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§ØªÙ‡ Ù…Ù† ÙƒÙ„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª.");
  if(!ok) return;

  g.blocks.forEach(b=>{
    delete b.payments?.[s.id];
    delete b.notes?.[s.id];
    delete b.carry?.[s.id];
  });

  g.students = g.students.filter(x=>x.id!==s.id);

  saveDB();
  toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨");
  renderAll();
  stOverlay.style.display="none";
  stCtx=null;
};

function openStudentModal(g,s){
  stCtx={g,s};
  document.getElementById("stTitle").textContent = s.name;
  document.getElementById("stName").value = s.name || "";
  document.getElementById("stDiscType").value = s.discountType || "none";
  document.getElementById("stDiscVal").value = (s.discountType==="fixed"||s.discountType==="percent") ? String(s.discountValue||0) : "";
  document.getElementById("stPaused").checked = !!s.paused;
  stOverlay.style.display="block";
}

function openGroupEditor(gid){
  const g=getGroupById(gid);
  if(!g) return;
  editGroupId=gid;

  document.getElementById("editGroupTitle").textContent = `ØªØ¹Ø¯ÙŠÙ„: ${g.name}`;
  document.getElementById("editGroupName").value = g.name || "";
  document.getElementById("editGroupDisplayName").value = g.displayName || "";
  document.getElementById("editPriceCycle").value = g.price || 0;
  document.getElementById("editCycleLen").value = String(g.cycleLen||8);

  editor.style.display="";
  renderStudentsSettings();
}

function renderGroupsList(){
  groupsList.innerHTML="";
  if(!db.groups.length){
    groupsList.innerHTML = `<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª.</div>`;
    return;
  }

  db.groups.forEach(g=>{
    const b=curBlock(g);
    const sc = b ? sessionsCount(b) : 0;
    const it=document.createElement("div");
    it.className="row";
    it.innerHTML=`
      <div class="left" style="min-width:0">
        <div class="num">ğŸ‘¥</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(g.name)}</div>
          <div class="hint mono">Ø·Ù„Ø§Ø¨: ${g.students.length} â€¢ Ø­ØµØµ: ${sc}/${cycleLen(g)} â€¢ Ø³Ø¹Ø±: ${g.price||0}</div>
        </div>
      </div>
      <div style="display:flex; gap:8px">
        <button class="moreBtn">ØªØ¹Ø¯ÙŠÙ„</button>
      </div>
    `;
    it.querySelector("button").onclick=()=>openGroupEditor(g.id);
    groupsList.appendChild(it);
  });
}

function renderStudentsSettings(){
  const wrap=document.getElementById("studentsList");
  wrap.innerHTML="";

  const g=getGroupById(editGroupId);
  if(!g){ wrap.innerHTML=`<div class="hint">â€”</div>`; return; }
  if(!g.students.length){ wrap.innerHTML=`<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨.</div>`; return; }

  const list=[...g.students].sort((a,b)=>a.name.localeCompare(b.name,"ar"));
  list.forEach(s=>{
    const discLabel =
      s.discountType==="none" ? "Ø¨Ø¯ÙˆÙ† Ø®ØµÙ…" :
      s.discountType==="fixed" ? `Ø®ØµÙ… Ù…Ø¨Ù„Øº: ${s.discountValue||0}` :
      s.discountType==="percent" ? `Ø®ØµÙ… Ù†Ø³Ø¨Ø©: ${s.discountValue||0}%` :
      "Ø¥Ø¹ÙØ§Ø¡";

    const it=document.createElement("div");
    it.className="row";
    it.innerHTML=`
      <div class="left" style="min-width:0">
        <div class="num">ğŸ‘¤</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(s.name)} ${s.paused?` <span class="badge red">Ù…ÙˆÙ‚ÙˆÙ</span>`:""}</div>
          <div class="hint">${escapeHtml(discLabel)}</div>
        </div>
      </div>
      <div>
        <button class="moreBtn">â‹¯</button>
      </div>
    `;
    it.querySelector("button").onclick=()=>openStudentModal(g,s);
    wrap.appendChild(it);
  });
}

/* ---------- Render All ---------- */
function renderAll(){
  ensureDefaults();

  // show correct page (splash if not unlocked)
  if(!isUnlocked()){
    pages.splash.style.display="";
    pages.home.style.display="none";
    pages.admin.style.display="none";
    pages.settings.style.display="none";
    return;
  }

  // refresh home header & lists
  refreshHomeGroupSelect();
  renderHomeHeader();
  renderHomeStudents();

  // admin
  refreshAdminGroupSelect();
  renderAdmin();

  // settings
  renderGroupsList();

  // if group editor open, keep it updated
  if(editor.style.display !== "none"){
    renderStudentsSettings();
  }
}

/* ---------- Init ---------- */
(function init(){
  loadDB();
  ensureDefaults();

  // do not remember last group even Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø©
  // (Ù‡ÙŠØªØ­Ø¯Ø¯ Ø¨Ø¹Ø¯ unlock ÙÙ‚Ø·)
  if(!isUnlocked()){
    setSessionGroup("");
  }

  // initial date
  document.getElementById("bigDate").textContent = todayText();

  // show splash by default
  showTab(isUnlocked() ? "home" : "splash");

  renderAll();
})();

/* ---------- PWA Install Button ---------- */
let deferredPrompt=null;
window.addEventListener("beforeinstallprompt",(e)=>{
  e.preventDefault();
  deferredPrompt=e;
  document.getElementById("btnInstall").style.display="inline-flex";
});
document.getElementById("btnInstall").onclick=async ()=>{
  if(!deferredPrompt){
    alert("Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­: Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â‹® Ø«Ù… (Install) Ø£Ùˆ (Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)");
    return;
  }
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt=null;
  document.getElementById("btnInstall").style.display="none";
};

/* ---------- Service Worker ---------- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
