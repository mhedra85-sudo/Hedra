<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hedra</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0A2A66">
  <link rel="icon" href="icon.png">

  <style>
    :root{
      --royal:#0A2A66;
      --royal2:#091F4A;
      --soft:#EAF2FF;
      --red:#D72638;
      --bg:#061226;
      --paper:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:rgba(2,6,23,.10);
      --shadow:0 18px 42px rgba(2,6,23,.22);
      --r:22px;
    }

    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial}
    body{
      margin:0; color:#fff;
      background:
        radial-gradient(900px 520px at 80% -10%, rgba(10,42,102,.38), transparent 60%),
        radial-gradient(900px 520px at -10% 10%, rgba(10,42,102,.22), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg));
    }

    .top{
      position:sticky; top:0; z-index:20;
      background: rgba(6,18,38,.76);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:14px 14px 12px;
    }
    .top .wrap{
      max-width:1060px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:46px; height:46px; border-radius:16px;
      background: linear-gradient(135deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      display:grid; place-items:center;
      font-weight:1000; letter-spacing:.8px;
    }
    .ttl{font-weight:1000; font-size:15px}
    .sub{opacity:.82; font-size:12px; margin-top:2px}

    .btn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:#fff;
      border-radius:18px;
      padding:10px 12px;
      min-height:44px;
      font-weight:950;
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      transition: transform .08s ease, filter .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.06); border-color:rgba(255,255,255,.26)}
    .btn.small{min-height:40px; border-radius:16px; font-size:13px; padding:9px 10px}
    .btn.royal{background: rgba(10,42,102,.34); border-color: rgba(255,255,255,.24)}
    .btn.ghost{background: transparent}
    .btn.light{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.22);
    }

    .page{max-width:1060px; margin:0 auto; padding:14px 14px 104px}
    .grid2{display:grid; gap:14px; grid-template-columns:1fr}
    @media(min-width:980px){ .grid2{grid-template-columns: 1.1fr .9fr;} }

    .card{
      background: rgba(255,255,255,.96);
      color:var(--ink);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
    }

    .hr{height:1px; background:rgba(2,6,23,.08); margin:12px 0}
    .hint{color:var(--muted); font-size:12px; line-height:1.75}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      font-weight:1000;
      font-size:13px;
      color:#fff;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}

    /* Tabs */
    .bottom{
      position:fixed; left:0; right:0; bottom:0; z-index:30;
      background: rgba(6,18,38,.76);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(255,255,255,.10);
      padding:10px 12px;
    }
    .bottom .wrap{
      max-width:1060px; margin:0 auto;
      display:flex; gap:10px;
    }
    .tab{
      flex:1;
      min-height:54px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:10px;
      user-select:none;
    }
    .tab.active{
      background: rgba(10,42,102,.34);
      border-color: rgba(255,255,255,.28);
    }

    /* List */
    .list{display:flex; flex-direction:column; gap:10px}
    .row{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:12px;
      border-radius:20px;
      border:1px solid rgba(2,6,23,.10);
      background:#fff;
    }
    .left{display:flex; align-items:center; gap:12px; min-width:0}
    .num{
      width:38px; height:38px; border-radius:14px;
      background: rgba(10,42,102,.08);
      border:1px solid rgba(10,42,102,.20);
      display:grid; place-items:center;
      font-weight:1000; color:var(--royal);
      flex:0 0 auto;
    }
    .name{font-weight:1000; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    /* RUN pay button states */
    .payBtn{
      min-width:150px;
      min-height:48px;
      border-radius:18px;
      font-weight:1000;
      cursor:pointer;
      transition: transform .08s ease, filter .12s ease, background .18s ease, color .18s ease, border-color .18s ease;
      user-select:none;
    }
    .payBtn:hover{transform:translateY(-1px); filter:brightness(1.02)}
    .pay-unpaid{
      background:#fff;
      color:var(--red);
      border:2px solid var(--red);
    }
    .pay-partial{
      background: var(--soft);
      color: var(--royal);
      border:1px solid rgba(10,42,102,.22);
    }
    .pay-paid{
      background: var(--royal);
      color:#fff;
      border:1px solid rgba(10,42,102,.35);
      animation: paidPulse .38s ease;
    }
    @keyframes paidPulse{
      0%{transform:scale(1)}
      50%{transform:scale(1.05)}
      100%{transform:scale(1)}
    }

    /* Small action button */
    .moreBtn{
      width:48px; min-height:48px;
      border-radius:18px;
      border:1px solid rgba(2,6,23,.12);
      background:#fff;
      color:var(--ink);
      font-weight:1100;
      cursor:pointer;
    }

    /* Inputs */
    label{display:block; font-weight:1000; font-size:13px; margin:10px 0 6px}
    input,select,textarea{
      width:100%;
      min-height:48px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(2,6,23,.12);
      outline:none;
      font-size:15px;
      background:#fff;
      color:var(--ink);
    }
    textarea{min-height:88px; resize:vertical}
    input:focus,select:focus,textarea:focus{border-color: rgba(10,42,102,.55)}
    .rowWrap{display:flex; gap:10px; flex-wrap:wrap}
    .rowWrap > *{flex:1; min-width:220px}

    /* Table */
    table{width:100%; border-collapse:separate; border-spacing:0 10px}
    th{font-size:12px; color:var(--muted); text-align:right; padding:0 8px}
    td{
      background:#fff;
      border:1px solid rgba(2,6,23,.10);
      padding:10px 10px;
      border-radius:14px;
    }

    /* Modal */
    .overlay{
      position:fixed; inset:0; z-index:90;
      background: rgba(2,6,23,.55);
      display:none;
      padding:14px;
    }
    .modal{
      max-width:640px;
      margin:6vh auto;
      background:#fff;
      color:var(--ink);
      border:1px solid rgba(2,6,23,.12);
      border-radius:24px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modal h3{margin:0 0 6px; font-size:16px}
    .modal .topline{display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap}
    .modal .actions{display:flex; gap:10px; flex-wrap:wrap}

    .toast{
      position:fixed; left:12px; bottom:88px; z-index:100;
      background: rgba(255,255,255,.96);
      color:var(--ink);
      border:1px solid rgba(2,6,23,.12);
      box-shadow: var(--shadow);
      padding:10px 12px;
      border-radius:16px;
      font-weight:1000;
      display:none;
      max-width:92vw;
    }

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(2,6,23,.10);
      background:rgba(10,42,102,.06);
      color:var(--royal);
      font-weight:1000;
      font-size:12px;
    }
  </style>
</head>

<body>
  <div class="top">
    <div class="wrap">
      <div class="brand">
        <div class="logo">H</div>
        <div>
          <div class="ttl">Hedra</div>
          <div class="sub mono" id="topDate">â€”</div>
        </div>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end">
        <button class="btn small light" id="btnInstall" style="display:none">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</button>
        <button class="btn small ghost" id="btnExport">ØªØµØ¯ÙŠØ±</button>
        <button class="btn small ghost" id="btnImport">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
      </div>
    </div>
  </div>

  <div class="page">
    <!-- RUN -->
    <section id="pageRun" class="grid2">
      <div class="card">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap">
          <div>
            <div style="font-weight:1000">Ø§Ù„ØªØ´ØºÙŠÙ„</div>
            <div class="hint" id="runGroupName">â€”</div>
          </div>

          <div class="rowWrap" style="justify-content:flex-end">
            <button class="btn small royal" id="btnAddSession">+ Ø­ØµØ©</button>
            <button class="btn small ghost" id="btnRemoveSession">âˆ’ Ø­ØµØ©</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="rowWrap">
          <input id="qRun" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." />
        </div>

        <div class="hr"></div>
        <div class="list" id="runList"></div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap">
          <div style="font-weight:1000">Ø§Ù„ÙŠÙˆÙ…</div>
          <div class="pill mono" id="todayOnly">â€”</div>
        </div>
        <div class="hr"></div>
        <div class="hint">
          Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„Ø§ ÙŠØ¹Ø±Ø¶ Ø£ÙŠ Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ ØªÙØ§ØµÙŠÙ„ Ù…Ø§Ù„ÙŠØ© Ø£Ù…Ø§Ù… Ø§Ù„Ù†Ø§Ø³.<br>
          Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙƒØ§Ù…Ù„Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ù…Ø­Ù…ÙŠØ© Ø¨Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ).
        </div>
      </div>
    </section>

    <!-- MANAGE -->
    <section id="pageManage" style="display:none">
      <div class="card">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap">
          <div>
            <div style="font-weight:1000">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
            <div class="hint" id="manageSub">â€”</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
            <button class="btn small ghost" id="btnSessionsLog">Ø³Ø¬Ù„ Ø§Ù„Ø­ØµØµ</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="rowWrap">
          <input id="qManage" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." />
        </div>

        <div class="hr"></div>
        <div class="list" id="manageList"></div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="pageSettings" style="display:none">
      <div class="card">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap">
          <div>
            <div style="font-weight:1000">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
            <div class="hint">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© â€¢ Ø§Ù„Ø¯ÙˆØ±Ø© â€¢ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© â€¢ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
            <button class="btn small royal" id="btnAddGroup">+ Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
            <button class="btn small ghost" id="btnReset">Ø¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯</button>
          </div>
        </div>

        <div class="hr"></div>

        <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
        <select id="selGroup"></select>

        <div class="hr"></div>

        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ´ØºÙŠÙ„)</label>
        <input id="groupDisplayName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø­Ø¯ ÙˆØ§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡" />

        <div class="rowWrap">
          <div>
            <label>Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆØ±Ø©)</label>
            <input id="priceCycle" type="number" min="0" step="1" placeholder="Ù…Ø«Ø§Ù„: 200"/>
          </div>
          <div>
            <label>Ø·ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ±Ø©</label>
            <select id="cycleLen">
              <option value="4">4 Ø­ØµØµ</option>
              <option value="8" selected>8 Ø­ØµØµ</option>
              <option value="12">12 Ø­ØµØ©</option>
            </select>
          </div>
        </div>

        <div class="rowWrap">
          <div>
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙˆØ±Ø© (Ù…Ù†)</label>
            <input id="blkFrom" type="date"/>
          </div>
          <div>
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙˆØ±Ø© (Ø¥Ù„Ù‰)</label>
            <input id="blkTo" type="date"/>
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
          <button class="btn small royal" id="btnSaveSettings">Ø­ÙØ¸</button>
          <button class="btn small ghost" id="btnNewBlock">ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>

        <div class="hr"></div>

        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-end; flex-wrap:wrap">
          <div>
            <div style="font-weight:1000">Ø¨Ù†ÙˆØ¯ Ø¥Ø¶Ø§ÙÙŠØ© (Ù„Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·)</div>
            <div class="hint">Ù…Ø°ÙƒØ±Ø© / Ø§Ø®ØªØ¨Ø§Ø± / ... (Ù…Ø±Ø© Ø£Ùˆ Ø£ÙƒØ«Ø± Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©)</div>
          </div>
          <button class="btn small royal" id="btnAddExtra">+ Ø¨Ù†Ø¯</button>
        </div>

        <div class="hr"></div>
        <div id="extraItemsWrap"></div>

        <div class="hr"></div>

        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-end; flex-wrap:wrap">
          <div>
            <div style="font-weight:1000">Ø§Ù„Ø·Ù„Ø§Ø¨</div>
            <div class="hint">Ø®ØµÙ…/Ø¥Ø¹ÙØ§Ø¡ Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” Ù„Ø§ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <input id="newStudentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." style="min-width:220px"/>
            <button class="btn small royal" id="btnAddStudent">Ø¥Ø¶Ø§ÙØ©</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="list" id="studentsList"></div>
      </div>
    </section>
  </div>

  <!-- Tabs -->
  <div class="bottom">
    <div class="wrap">
      <button class="tab active" data-tab="run">ğŸ‘¥ ØªØ´ØºÙŠÙ„</button>
      <button class="tab" data-tab="manage">ğŸ§¾ Ø¥Ø¯Ø§Ø±Ø©</button>
      <button class="tab" data-tab="settings">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- MODALS -->

  <!-- Pay/Details Modal (Admin) -->
  <div class="overlay" id="payOverlay">
    <div class="modal">
      <div class="topline">
        <div>
          <h3 id="payTitle">â€”</h3>
          <div class="hint mono" id="paySub">â€”</div>
        </div>
        <div class="actions">
          <button class="btn small ghost" id="btnPayClose">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

      <div class="hr"></div>

      <div id="payTableWrap"></div>

      <div class="hr"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn small royal" id="btnPayFull">ØªÙ… Ø§Ù„Ø¯ÙØ¹ (ØªÙƒÙ…Ù„Ø©)</button>
        <button class="btn small ghost" id="btnPayAdd">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº</button>
        <button class="btn small ghost" id="btnPayMinus">âˆ’ Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹</button>
      </div>

      <div id="payAmountWrap" style="display:none; margin-top:10px">
        <label id="payAmountLabel">Ø§Ù„Ù…Ø¨Ù„Øº</label>
        <input id="payAmount" type="number" step="1" placeholder="Ù…Ø«Ø§Ù„: 50"/>
        <button class="btn small royal" id="btnPayApply" style="margin-top:10px">ØªØ·Ø¨ÙŠÙ‚</button>
      </div>

      <div class="hr"></div>

      <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input id="payNote" placeholder="Ù…Ø«Ø§Ù„: Ø«Ù…Ù† Ù…Ø°ÙƒØ±Ø© / Ø³Ø¯Ø§Ø¯ Ù…ØªØ£Ø®Ø± / ..." />

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
        <button class="btn small royal" id="btnPaySaveNote">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
      </div>
    </div>
  </div>

  <!-- Extra Item Modal -->
  <div class="overlay" id="exOverlay">
    <div class="modal">
      <div class="topline">
        <div>
          <h3>Ø¨Ù†Ø¯ Ø¥Ø¶Ø§ÙÙŠ</h3>
          <div class="hint">Ù„Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·</div>
        </div>
        <div class="actions">
          <button class="btn small ghost" id="btnExClose">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

      <div class="hr"></div>

      <label>Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯</label>
      <input id="exName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø°ÙƒØ±Ø© Ø´Ù‡Ø± 10"/>

      <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
      <input id="exAmount" type="number" step="1" placeholder="Ù…Ø«Ø§Ù„: 50"/>

      <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
      <input id="exDate" type="date"/>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
        <button class="btn small royal" id="btnExSave">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <!-- Student Modal -->
  <div class="overlay" id="stOverlay">
    <div class="modal">
      <div class="topline">
        <div>
          <h3 id="stTitle">Ø·Ø§Ù„Ø¨</h3>
          <div class="hint">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø§ ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„</div>
        </div>
        <div class="actions">
          <button class="btn small ghost" id="btnStClose">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

      <div class="hr"></div>

      <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
      <input id="stName" />

      <div class="rowWrap">
        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø®ØµÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <select id="stDiscType">
            <option value="none">Ø¨Ø¯ÙˆÙ†</option>
            <option value="fixed">Ø®ØµÙ… Ù…Ø¨Ù„Øº</option>
            <option value="percent">Ø®ØµÙ… Ù†Ø³Ø¨Ø©</option>
            <option value="exempt">Ø¥Ø¹ÙØ§Ø¡</option>
          </select>
        </div>
        <div>
          <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="stDiscVal" type="number" step="1" placeholder="Ù…Ø«Ø§Ù„: 50 Ø£Ùˆ 10%"/>
        </div>
      </div>

      <label style="display:flex; align-items:center; gap:10px; margin-top:10px">
        <input id="stPaused" type="checkbox" style="width:auto; min-height:auto"/>
        Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø·Ø§Ù„Ø¨ (Ù„Ø§ ÙŠØªØ­Ø§Ø³Ø¨ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù)
      </label>

      <div class="hr"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn small royal" id="btnStSave">Ø­ÙØ¸</button>
        <button class="btn small ghost" id="btnStDelete">Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨</button>
      </div>
    </div>
  </div>

  <!-- Sessions Log Modal -->
  <div class="overlay" id="ssOverlay">
    <div class="modal">
      <div class="topline">
        <div>
          <h3>Ø³Ø¬Ù„ Ø§Ù„Ø­ØµØµ</h3>
          <div class="hint">ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­ØµØµ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù„Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
        </div>
        <div class="actions">
          <button class="btn small ghost" id="btnSsClose">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
      <div class="hr"></div>
      <div id="ssList" class="hint mono">â€”</div>
    </div>
  </div>

<script>
/* =========================================================
   Hedra v3 (Clean, Single File)
   - Run: no numbers, just status button
   - Unpaid: red outline, Paid: royal blue, Partial: soft blue
   - Cycle length: 4/8/12
   - Cycle dates: From/To
   - Everyone charged per session count (no attendance per student)
   - Discounts: distributed from FIRST session
   - Extra Items: current cycle only
   - Overpay/underpay carried to next cycle as signed balance
   - Admin & Settings protected by PIN
   - No DELETE confirmations for payments: use minus correction
========================================================= */

const DB_KEY = "hedra_v3_clean_singlefile";
let db = { groups: [], settings: { currentGroupId: "" } };

/* ---------- Utilities ---------- */
function uid(p="id"){ return p+"_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16); }
function round2(n){ return Math.round((Number(n||0))*100)/100; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.style.display="none",2200);
}

function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function loadDB(){
  const raw = localStorage.getItem(DB_KEY);
  if(!raw) return;
  try{
    const p=JSON.parse(raw);
    if(p && typeof p==="object") db=p;
  }catch{}
}

function todayText(){
  return new Date().toLocaleDateString("ar-EG",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
}
function isoYMD(d=new Date()){
  const x=new Date(d); x.setHours(0,0,0,0);
  return x.toISOString().slice(0,10);
}
function fmtDMY(iso){
  const d=new Date(iso);
  const dd=String(d.getDate()).padStart(2,"0");
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const yy=d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}

/* ---------- PIN Protection (Admin) ---------- */
function getPIN(){ return localStorage.getItem("hedra_pin") || ""; }
function requirePIN(){
  const existing = getPIN();
  if(!existing){
    const set = prompt("Ø¹ÙŠÙ‘Ù†ÙŠ Ø±Ù‚Ù… Ø³Ø±ÙŠ (4 Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ Ø£ÙƒØ«Ø±)");
    if(!set || set.trim().length < 4) return false;
    localStorage.setItem("hedra_pin", set.trim());
    return true;
  }
  const entered = prompt("Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ");
  if(entered === existing) return true;
  alert("Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­");
  return false;
}

/* ---------- Data Model ---------- */
/*
group = { id, name, displayName, price, cycleLen, students:[...], blocks:[...] }
student = { id, name, paused, discountType, discountValue }
block = {
  id, fromYMD, toYMD, createdAtISO,
  sessions:[{id,tsISO}],
  extraItems:[{id,name,amount,dateYMD}],
  payments:{ [sid]: number }, notes:{ [sid]: string },
  carry:{ [sid]: number }, // signed (+due / -credit)
  closed:boolean
}
*/

function newBlock(fromYMD, toYMD){
  const nowISO = new Date().toISOString();
  return {
    id: uid("b"),
    fromYMD, toYMD,
    createdAtISO: nowISO,
    sessions: [],
    extraItems: [],
    payments: {},
    notes: {},
    carry: {},
    closed: false
  };
}

function ensureDefaults(){
  if(!db.settings) db.settings={ currentGroupId:"" };
  if(!Array.isArray(db.groups)) db.groups=[];

  db.groups.forEach(g=>{
    if(!g.id) g.id=uid("g");
    if(typeof g.name!=="string") g.name="Ù…Ø¬Ù…ÙˆØ¹Ø©";
    if(typeof g.displayName!=="string") g.displayName="";
    if(typeof g.price!=="number") g.price=Number(g.price||0);
    if(!g.cycleLen) g.cycleLen=8;
    if(!Array.isArray(g.students)) g.students=[];
    if(!Array.isArray(g.blocks)) g.blocks=[];

    g.students.forEach(s=>{
      if(!s.id) s.id=uid("s");
      if(typeof s.name!=="string") s.name="Ø·Ø§Ù„Ø¨";
      if(typeof s.paused!=="boolean") s.paused=false;
      if(!s.discountType) s.discountType="none"; // none/fixed/percent/exempt
      if(typeof s.discountValue!=="number") s.discountValue=Number(s.discountValue||0);
    });

    if(g.blocks.length===0){
      const from=isoYMD(new Date());
      const to=isoYMD(new Date());
      g.blocks.push(newBlock(from,to));
    }

    g.blocks.forEach(b=>{
      if(!b.id) b.id=uid("b");
      if(!b.fromYMD) b.fromYMD=isoYMD(new Date());
      if(!b.toYMD) b.toYMD=isoYMD(new Date());
      if(!b.createdAtISO) b.createdAtISO=new Date().toISOString();
      if(!Array.isArray(b.sessions)) b.sessions=[];
      if(!Array.isArray(b.extraItems)) b.extraItems=[];
      if(!b.payments || typeof b.payments!=="object") b.payments={};
      if(!b.notes || typeof b.notes!=="object") b.notes={};
      if(!b.carry || typeof b.carry!=="object") b.carry={};
      if(typeof b.closed!=="boolean") b.closed=false;
    });
  });

  if(!db.settings.currentGroupId && db.groups[0]) db.settings.currentGroupId=db.groups[0].id;

  // Create initial group if none
  if(db.groups.length===0){
    const g = {
      id: uid("g"),
      name: "Ù…Ø¬Ù…ÙˆØ¹Ø© 1",
      displayName: "",
      price: 200,
      cycleLen: 8,
      students: [],
      blocks: [ newBlock(isoYMD(new Date()), isoYMD(new Date())) ]
    };
    db.groups=[g];
    db.settings.currentGroupId=g.id;
  }

  saveDB();
}

function curGroup(){
  return db.groups.find(g=>g.id===db.settings.currentGroupId) || db.groups[0] || null;
}
function curBlock(g){
  return g?.blocks?.[g.blocks.length-1] || null;
}

/* ---------- Pricing Logic ---------- */
function cycleLen(g){ return Math.max(1, Number(g.cycleLen||8)); }
function cyclePrice(g){ return Math.max(0, Number(g.price||0)); }

function effectiveCyclePrice(g,s){
  if(s.paused) return 0;
  const base = cyclePrice(g);
  const t=(s.discountType||"none");
  const v=Number(s.discountValue||0);

  if(t==="exempt") return 0;
  if(t==="fixed") return Math.max(0, base - Math.max(0,v));
  if(t==="percent"){
    const p=Math.max(0, Math.min(100, v));
    return Math.max(0, base*(1-p/100));
  }
  return base;
}

function perSessionForStudent(g,s){
  return round2(effectiveCyclePrice(g,s) / cycleLen(g));
}

function sessionsCount(b){ return (b.sessions||[]).length; }
function extraTotal(b){
  return round2((b.extraItems||[]).reduce((a,x)=>a + Math.max(0,Number(x.amount||0)), 0));
}
function carry(b,sid){ return round2(Number(b.carry?.[sid] || 0)); }   // signed
function paid(b,sid){ return round2(Number(b.payments?.[sid] || 0)); } // can exceed

// âœ… IMPORTANT: everyone charged by session count (no attendance), and discount distributed from first session.
function subscriptionDueSoFar(g,b,s){
  return round2(sessionsCount(b) * perSessionForStudent(g,s));
}

function totals(g,b,s){
  const sub = subscriptionDueSoFar(g,b,s);
  const items = extraTotal(b);
  const prev = carry(b, s.id);
  const total = round2(sub + items + prev);      // signed allowed
  const p = paid(b, s.id);
  const remaining = round2(total - p);           // +due / -credit
  return { sub, items, prev, total, paid:p, remaining };
}

function status(g,b,s){
  const t=totals(g,b,s);
  if(t.remaining <= 0) return "paid";         // fully paid or credit
  if(t.paid > 0) return "partial";
  return "unpaid";
}

/* ---------- Export / Import ---------- */
document.getElementById("btnExport").onclick=()=>{
  const data = JSON.stringify(db, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "Hedra_Backup.json";
  a.click();
  URL.revokeObjectURL(a.href);
  toast("ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±");
};

document.getElementById("btnImport").onclick=()=>{
  const inp=document.createElement("input");
  inp.type="file"; inp.accept="application/json";
  inp.onchange=()=>{
    const f=inp.files?.[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const parsed=JSON.parse(r.result);
        if(!parsed || typeof parsed!=="object") throw new Error();
        db=parsed;
        ensureDefaults();
        toast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯");
        renderAll();
      }catch{
        alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
      }
    };
    r.readAsText(f);
  };
  inp.click();
};

/* ---------- Tabs ---------- */
const pages = {
  run: document.getElementById("pageRun"),
  manage: document.getElementById("pageManage"),
  settings: document.getElementById("pageSettings")
};

function showTab(k){
  // PIN protect manage/settings
  if(k==="manage" || k==="settings"){
    if(!requirePIN()) return;
  }

  Object.keys(pages).forEach(x=>pages[x].style.display=(x===k)?"":"none");
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===k));
  renderAll();
}

document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>showTab(t.dataset.tab));
});

/* ---------- RUN: Sessions + Quick Pay ---------- */
document.getElementById("qRun").addEventListener("input", ()=>renderRun());

document.getElementById("btnAddSession").onclick=()=>{
  const g=curGroup(); if(!g) return;
  const b=curBlock(g); if(!b) return;

  if(sessionsCount(b) >= cycleLen(g)){
    toast("Ø§ÙƒØªÙ…Ù„Øª Ø­ØµØµ Ø§Ù„Ø¯ÙˆØ±Ø©");
    return;
  }

  b.sessions.push({ id:uid("ss"), tsISO:new Date().toISOString() });
  saveDB();
  toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­ØµØ©");
  renderAll();
};

document.getElementById("btnRemoveSession").onclick=()=>{
  const g=curGroup(); if(!g) return;
  const b=curBlock(g); if(!b) return;
  if(!b.sessions.length){
    toast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ù„Ù„Ø­Ø°Ù");
    return;
  }
  const ok=confirm("Ø­Ø°Ù Ø¢Ø®Ø± Ø­ØµØ©ØŸ");
  if(!ok) return;
  b.sessions.pop();
  saveDB();
  toast("ØªÙ… Ø­Ø°Ù Ø¢Ø®Ø± Ø­ØµØ©");
  renderAll();
};

/* ---------- SETTINGS: Groups ---------- */
const selGroup=document.getElementById("selGroup");

function refreshGroupSelect(){
  selGroup.innerHTML="";
  if(!db.groups.length){
    const o=document.createElement("option");
    o.value=""; o.textContent="Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª";
    selGroup.appendChild(o);
    return;
  }
  db.groups.forEach(g=>{
    const o=document.createElement("option");
    o.value=g.id; o.textContent=g.name;
    selGroup.appendChild(o);
  });
  const g=curGroup();
  db.settings.currentGroupId=g?.id || "";
  selGroup.value=db.settings.currentGroupId;
}

selGroup.addEventListener("change",(e)=>{
  db.settings.currentGroupId=e.target.value;
  saveDB();
  renderAll();
});

document.getElementById("btnAddGroup").onclick=()=>{
  const name=(prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©")||"").trim();
  if(!name) return;
  if(db.groups.some(x=>x.name.trim().toLowerCase()===name.toLowerCase())) return alert("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©");
  const g = {
    id: uid("g"),
    name,
    displayName:"",
    price: 200,
    cycleLen: 8,
    students: [],
    blocks: [ newBlock(isoYMD(new Date()), isoYMD(new Date())) ]
  };
  db.groups.push(g);
  db.settings.currentGroupId=g.id;
  saveDB();
  toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©");
  renderAll();
};

function loadSettingsUI(){
  const g=curGroup(); if(!g) return;
  const b=curBlock(g);
  document.getElementById("groupDisplayName").value = g.displayName || "";
  document.getElementById("priceCycle").value = g.price || 0;
  document.getElementById("cycleLen").value = String(g.cycleLen||8);

  // show current cycle dates in settings inputs
  const from = b?.fromYMD || isoYMD(new Date());
  const to = b?.toYMD || isoYMD(new Date());
  document.getElementById("blkFrom").value = from;
  document.getElementById("blkTo").value = to;
}

document.getElementById("btnSaveSettings").onclick=()=>{
  const g=curGroup(); if(!g) return;
  const b=curBlock(g); if(!b) return;

  g.displayName = String(document.getElementById("groupDisplayName").value||"").trim();
  g.price = Number(document.getElementById("priceCycle").value||0);
  g.cycleLen = Number(document.getElementById("cycleLen").value||8);

  // update current cycle date range (for label only)
  b.fromYMD = document.getElementById("blkFrom").value || b.fromYMD;
  b.toYMD = document.getElementById("blkTo").value || b.toYMD;

  saveDB();
  toast("ØªÙ… Ø§Ù„Ø­ÙØ¸");
  renderAll();
};

document.getElementById("btnNewBlock").onclick=()=>{
  const g=curGroup(); if(!g) return;
  const b=curBlock(g); if(!b) return;

  const fromV = document.getElementById("blkFrom").value || isoYMD(new Date());
  const toV = document.getElementById("blkTo").value || isoYMD(new Date());

  const ok = confirm("ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ Ø³ÙŠØªÙ… ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯/Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ØŒ ÙˆØ§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø³ØªØ¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯.");
  if(!ok) return;

  // carry signed remaining
  const carryMap = {};
  g.students.forEach(s=>{
    const t = totals(g,b,s);
    if(Math.abs(t.remaining) > 0.0001) carryMap[s.id]=t.remaining;
  });

  b.closed=true;

  const nb = newBlock(fromV, toV);
  nb.carry = carryMap; // âœ… carry to next cycle
  nb.extraItems = [];  // âœ… extra items only current cycle
  nb.sessions = [];
  nb.payments = {};
  nb.notes = {};

  g.blocks.push(nb);
  saveDB();
  toast("ØªÙ… ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©");
  renderAll();
};

document.getElementById("btnReset").onclick=()=>{
  const ok=confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯. Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ");
  if(!ok) return;
  localStorage.removeItem(DB_KEY);
  location.reload();
};

/* ---------- SETTINGS: Extra Items ---------- */
const exOverlay=document.getElementById("exOverlay");
document.getElementById("btnAddExtra").onclick=()=>{
  document.getElementById("exName").value="";
  document.getElementById("exAmount").value="";
  document.getElementById("exDate").value=isoYMD(new Date());
  exOverlay.style.display="block";
};
document.getElementById("btnExClose").onclick=()=>exOverlay.style.display="none";
exOverlay.addEventListener("click",(e)=>{ if(e.target===exOverlay) exOverlay.style.display="none"; });

document.getElementById("btnExSave").onclick=()=>{
  const g=curGroup(); if(!g) return;
  const b=curBlock(g); if(!b) return;

  const name=(document.getElementById("exName").value||"").trim();
  const amt=Number(document.getElementById("exAmount").value||0);
  const date=document.getElementById("exDate").value || isoYMD(new Date());

  if(!name) return alert("Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯");
  if(!(amt>0)) return alert("Ø§ÙƒØªØ¨ÙŠ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");

  b.extraItems.push({ id:uid("x"), name, amount:round2(amt), dateYMD:date });
  saveDB();
  exOverlay.style.display="none";
  toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†Ø¯");
  renderAll();
};

function renderExtraItems(){
  const g=curGroup();
  const wrap=document.getElementById("extraItemsWrap");
  wrap.innerHTML="";
  if(!g) return;
  const b=curBlock(g);
  if(!b) return;

  if(!b.extraItems.length){
    wrap.innerHTML = `<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ø¥Ø¶Ø§ÙÙŠØ© ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</div>`;
    return;
  }

  const box=document.createElement("div");
  box.className="list";
  b.extraItems.forEach(it=>{
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <div class="left" style="min-width:0">
        <div class="num">ï¼‹</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(it.name)}</div>
          <div class="hint mono">${escapeHtml(it.dateYMD)} â€¢ ${escapeHtml(String(it.amount))}</div>
        </div>
      </div>
      <div style="display:flex; gap:8px">
        <button class="moreBtn" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
      </div>
    `;
    row.querySelector("button").onclick=()=>{
      const ok=confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ØŸ");
      if(!ok) return;
      b.extraItems=b.extraItems.filter(x=>x.id!==it.id);
      saveDB();
      toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯");
      renderAll();
    };
    box.appendChild(row);
  });
  wrap.appendChild(box);
}

/* ---------- SETTINGS: Students ---------- */
document.getElementById("btnAddStudent").onclick=()=>{
  const g=curGroup(); if(!g) return;
  const name=(document.getElementById("newStudentName").value||"").trim();
  if(!name) return;
  if(g.students.some(s=>s.name.trim().toLowerCase()===name.toLowerCase())) return alert("Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯");
  g.students.push({ id:uid("s"), name, paused:false, discountType:"none", discountValue:0 });
  document.getElementById("newStudentName").value="";
  saveDB();
  toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨");
  renderAll();
};

const stOverlay=document.getElementById("stOverlay");
let stCtx=null;

document.getElementById("btnStClose").onclick=()=>{ stOverlay.style.display="none"; stCtx=null; };
stOverlay.addEventListener("click",(e)=>{ if(e.target===stOverlay){ stOverlay.style.display="none"; stCtx=null; } });

document.getElementById("btnStSave").onclick=()=>{
  if(!stCtx) return;
  const { g, s } = stCtx;

  const newName = (document.getElementById("stName").value||"").trim();
  if(!newName) return alert("Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… ØµØ­ÙŠØ­");
  // prevent duplicates (other than self)
  if(g.students.some(x=>x.id!==s.id && x.name.trim().toLowerCase()===newName.toLowerCase())) return alert("Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„");

  s.name = newName;
  s.discountType = document.getElementById("stDiscType").value || "none";
  s.discountValue = Number(document.getElementById("stDiscVal").value||0);
  s.paused = !!document.getElementById("stPaused").checked;

  saveDB();
  toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨");
  renderAll();
  stOverlay.style.display="none";
  stCtx=null;
};

document.getElementById("btnStDelete").onclick=()=>{
  if(!stCtx) return;
  const { g, s } = stCtx;

  const ok = confirm("Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ù…Ø¯ÙÙˆØ¹Ø§ØªÙ‡ ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§ØªÙ‡ Ù…Ù† ÙƒÙ„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª.");
  if(!ok) return;

  // remove student data from all blocks
  g.blocks.forEach(b=>{
    delete b.payments?.[s.id];
    delete b.notes?.[s.id];
    delete b.carry?.[s.id];
  });

  g.students = g.students.filter(x=>x.id!==s.id);

  saveDB();
  toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨");
  renderAll();
  stOverlay.style.display="none";
  stCtx=null;
};

function openStudentModal(g, s){
  stCtx={g,s};
  document.getElementById("stTitle").textContent = s.name;
  document.getElementById("stName").value = s.name || "";
  document.getElementById("stDiscType").value = s.discountType || "none";
  document.getElementById("stDiscVal").value = (s.discountType==="fixed"||s.discountType==="percent") ? String(s.discountValue||0) : "";
  document.getElementById("stPaused").checked = !!s.paused;
  stOverlay.style.display="block";
}

function renderStudentsSettings(){
  const g=curGroup();
  const wrap=document.getElementById("studentsList");
  wrap.innerHTML="";
  if(!g){ wrap.innerHTML=`<div class="hint">Ø£Ø¶ÙŠÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£ÙˆÙ„Ø§Ù‹.</div>`; return; }
  if(!g.students.length){ wrap.innerHTML=`<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨.</div>`; return; }

  const list=[...g.students].sort((a,b)=>a.name.localeCompare(b.name,"ar"));
  list.forEach(s=>{
    const discLabel =
      s.discountType==="none" ? "Ø¨Ø¯ÙˆÙ† Ø®ØµÙ…" :
      s.discountType==="fixed" ? `Ø®ØµÙ… Ù…Ø¨Ù„Øº: ${s.discountValue||0}` :
      s.discountType==="percent" ? `Ø®ØµÙ… Ù†Ø³Ø¨Ø©: ${s.discountValue||0}%` :
      "Ø¥Ø¹ÙØ§Ø¡";

    const it=document.createElement("div");
    it.className="row";
    it.innerHTML=`
      <div class="left" style="min-width:0">
        <div class="num">ğŸ‘¤</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(s.name)} ${s.paused?` <span class="badge">Ù…ÙˆÙ‚ÙˆÙ</span>`:""}</div>
          <div class="hint">${escapeHtml(discLabel)}</div>
        </div>
      </div>
      <div>
        <button class="moreBtn" title="ØªØ¹Ø¯ÙŠÙ„">â‹¯</button>
      </div>
    `;
    it.querySelector("button").onclick=()=>openStudentModal(g,s);
    wrap.appendChild(it);
  });
}

/* ---------- PAY / DETAILS (Admin) ---------- */
const payOverlay=document.getElementById("payOverlay");
const payAmountWrap=document.getElementById("payAmountWrap");
const payAmount=document.getElementById("payAmount");
const payAmountLabel=document.getElementById("payAmountLabel");
let payCtx=null;
let payMode=null; // add | minus

document.getElementById("btnPayClose").onclick=()=>{ payOverlay.style.display="none"; payCtx=null; payMode=null; payAmountWrap.style.display="none"; };
payOverlay.addEventListener("click",(e)=>{ if(e.target===payOverlay){ payOverlay.style.display="none"; payCtx=null; payMode=null; payAmountWrap.style.display="none"; } });

document.getElementById("btnPayFull").onclick=()=>{
  if(!payCtx) return;
  const {g,b,s}=payCtx;
  const t=totals(g,b,s);
  if(t.remaining <= 0){ toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¨Ù‚ÙŠ"); return; }
  b.payments[s.id] = round2(t.total);
  saveDB();
  toast("ØªÙ…");
  renderAll();
  openPayModal(g,b,s);
};

document.getElementById("btnPayAdd").onclick=()=>{
  payMode="add";
  payAmountWrap.style.display="";
  payAmountLabel.textContent="Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº Ù„Ù„Ù…Ø¯ÙÙˆØ¹";
  payAmount.value="";
  payAmount.focus();
};

document.getElementById("btnPayMinus").onclick=()=>{
  payMode="minus";
  payAmountWrap.style.display="";
  payAmountLabel.textContent="Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (ØªØµØ­ÙŠØ­)";
  payAmount.value="";
  payAmount.focus();
};

document.getElementById("btnPayApply").onclick=()=>{
  if(!payCtx || !payMode) return;
  const {b,s}=payCtx;
  const v=Number(payAmount.value||0);
  if(!(v>0)) return alert("Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");

  const cur = paid(b,s.id);

  if(payMode==="add"){
    b.payments[s.id] = round2(cur + v);
    toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
  }else{
    b.payments[s.id] = round2(Math.max(0, cur - v));
    toast("ØªÙ… Ø§Ù„Ø®ØµÙ…");
  }

  saveDB();
  payMode=null;
  payAmountWrap.style.display="none";
  payAmount.value="";
  renderAll();
  openPayModal(payCtx.g, payCtx.b, payCtx.s);
};

document.getElementById("btnPaySaveNote").onclick=()=>{
  if(!payCtx) return;
  const {b,s}=payCtx;
  b.notes[s.id] = String(document.getElementById("payNote").value||"").trim();
  saveDB();
  toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©");
};

function openPayModal(g,b,s){
  payCtx={g,b,s};
  payMode=null;
  payAmountWrap.style.display="none";
  payAmount.value="";

  const t=totals(g,b,s);

  const cycleLabel = `${b.fromYMD} â†’ ${b.toYMD} â€¢ Ø­ØµØµ: ${sessionsCount(b)}/${cycleLen(g)}`;
  document.getElementById("payTitle").textContent = s.name;
  document.getElementById("paySub").textContent = cycleLabel;

  document.getElementById("payNote").value = String(b.notes?.[s.id] || "");

  // table (as requested)
  const table = `
    <table>
      <thead>
        <tr><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr>
      </thead>
      <tbody>
        <tr><td>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</td><td class="mono">${t.sub}</td></tr>
        <tr><td>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¨Ù†ÙˆØ¯</td><td class="mono">${t.items}</td></tr>
        <tr><td>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚</td><td class="mono">${t.prev}</td></tr>
        <tr><td><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</b></td><td class="mono"><b>${t.total}</b></td></tr>
        <tr><td>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</td><td class="mono">${t.paid}</td></tr>
        <tr><td><b>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</b></td><td class="mono"><b>${t.remaining}</b></td></tr>
      </tbody>
    </table>
  `;

  // details lines (sessions + extras) inside admin only
  const ss = b.sessions.map(x=>fmtDMY(x.tsISO)).join(" â€¢ ");
  const ex = (b.extraItems||[]).map(x=>`${x.name} (${x.amount})`).join(" â€¢ ");

  document.getElementById("payTableWrap").innerHTML = `
    <div class="hint">ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­ØµØµ: <span class="mono">${escapeHtml(ss||"â€”")}</span></div>
    <div class="hint">Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©: <span class="mono">${escapeHtml(ex||"â€”")}</span></div>
    <div class="hr"></div>
    ${table}
  `;

  payOverlay.style.display="block";
}

/* ---------- RUN render ---------- */
function renderRun(){
  const g=curGroup();
  const b=g?curBlock(g):null;

  document.getElementById("topDate").textContent = todayText();
  document.getElementById("todayOnly").textContent = todayText();

  document.getElementById("runGroupName").textContent = g ? (g.displayName || g.name || "â€”") : "â€”";

  const wrap=document.getElementById("runList");
  wrap.innerHTML="";

  if(!g){
    wrap.innerHTML=`<div class="hint">Ø§Ø°Ù‡Ø¨ÙŠ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ£Ø¶ÙŠÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø©.</div>`;
    return;
  }
  if(!g.students.length){
    wrap.innerHTML=`<div class="hint">Ø£Ø¶ÙŠÙÙŠ Ø·Ù„Ø§Ø¨ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.</div>`;
    return;
  }

  const q=(document.getElementById("qRun").value||"").trim().toLowerCase();
  const list=[...g.students]
    .filter(s=>s.name.toLowerCase().includes(q))
    .sort((a,b)=>a.name.localeCompare(b.name,"ar"));

  list.forEach((s,idx)=>{
    const st=status(g,b,s);

    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <div class="left">
        <div class="num">${idx+1}</div>
        <div class="name">${escapeHtml(s.name)}</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="payBtn ${st==="paid"?"pay-paid":st==="partial"?"pay-partial":"pay-unpaid"}">ØªÙ… Ø§Ù„Ø¯ÙØ¹</button>
        <button class="moreBtn" title="ØªÙØ§ØµÙŠÙ„ (Ø¥Ø¯Ø§Ø±Ø©)">â‹¯</button>
      </div>
    `;

    // Quick pay: pay to total due (admin-friendly), but NO numbers shown.
    row.querySelector(".payBtn").onclick=()=>{
      if(s.paused){ toast("Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆÙ‚ÙˆÙ"); return; }
      const t=totals(g,b,s);
      if(t.remaining <= 0){ toast("ØªÙ…"); renderAll(); return; }
      b.payments[s.id] = round2(t.total);
      saveDB();
      toast("ØªÙ… Ø§Ù„Ø¯ÙØ¹");
      renderAll();
    };

    // Details button: require PIN (so even in run itâ€™s protected)
    row.querySelector(".moreBtn").onclick=()=>{
      if(!requirePIN()) return;
      openPayModal(g,b,s);
    };

    wrap.appendChild(row);
  });
}

/* ---------- MANAGE render ---------- */
document.getElementById("qManage").addEventListener("input", ()=>renderManage());
document.getElementById("btnSessionsLog").onclick=()=>{
  const g=curGroup(); if(!g) return;
  const b=curBlock(g); if(!b) return;

  const ss = b.sessions.map((x,i)=>`${i+1}) ${fmtDMY(x.tsISO)}`).join("\n");
  document.getElementById("ssList").textContent = ss || "â€”";
  document.getElementById("ssOverlay").style.display="block";
};
document.getElementById("btnSsClose").onclick=()=>document.getElementById("ssOverlay").style.display="none";
document.getElementById("ssOverlay").addEventListener("click",(e)=>{ if(e.target.id==="ssOverlay") document.getElementById("ssOverlay").style.display="none"; });

function renderManage(){
  const g=curGroup();
  const b=g?curBlock(g):null;

  document.getElementById("manageSub").textContent = g && b
    ? `${g.displayName || g.name} â€¢ ${b.fromYMD} â†’ ${b.toYMD}`
    : "â€”";

  const wrap=document.getElementById("manageList");
  wrap.innerHTML="";

  if(!g || !b){
    wrap.innerHTML=`<div class="hint">â€”</div>`;
    return;
  }
  if(!g.students.length){
    wrap.innerHTML=`<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨.</div>`;
    return;
  }

  const q=(document.getElementById("qManage").value||"").trim().toLowerCase();
  const list=[...g.students]
    .filter(s=>s.name.toLowerCase().includes(q))
    .sort((a,b)=>a.name.localeCompare(b.name,"ar"));

  list.forEach(s=>{
    const t=totals(g,b,s);
    const st=status(g,b,s);

    const it=document.createElement("div");
    it.className="row";
    it.innerHTML=`
      <div class="left" style="min-width:0">
        <div class="num">ğŸ§¾</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(s.name)} ${s.paused?` <span class="badge">Ù…ÙˆÙ‚ÙˆÙ</span>`:""}</div>
          <div class="hint">Ø§Ø¶ØºØ·ÙŠ Ù„Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„</div>
        </div>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <div class="badge">${st==="paid"?"Ù…ÙƒØªÙ…Ù„":st==="partial"?"Ø¬Ø²Ø¦ÙŠ":"ØºÙŠØ± Ù…ÙƒØªÙ…Ù„"}</div>
        <button class="moreBtn">Ø¹Ø±Ø¶</button>
      </div>
    `;
    it.querySelector("button").onclick=()=>openPayModal(g,b,s);
    wrap.appendChild(it);
  });
}

/* ---------- Render All ---------- */
function renderAll(){
  ensureDefaults();
  refreshGroupSelect();
  loadSettingsUI();
  renderExtraItems();
  renderStudentsSettings();
  renderRun();
  renderManage();
}

/* ---------- Init ---------- */
(function init(){
  loadDB();
  ensureDefaults();
  renderAll();
})();

/* ---------- PWA Install Button ---------- */
let deferredPrompt=null;
window.addEventListener("beforeinstallprompt",(e)=>{
  e.preventDefault();
  deferredPrompt=e;
  document.getElementById("btnInstall").style.display="inline-flex";
});
document.getElementById("btnInstall").onclick=async ()=>{
  if(!deferredPrompt){
    alert("Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­: Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â‹® Ø«Ù… (Install) Ø£Ùˆ (Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)");
    return;
  }
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt=null;
  document.getElementById("btnInstall").style.display="none";
};

/* ---------- Service Worker ---------- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
