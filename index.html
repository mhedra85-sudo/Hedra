<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hedra</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1220">
  <link rel="icon" href="icon.png">

  <style>
    :root{
      --bg:#0b1220;
      --paper:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --brand:#0ea5e9; /* Ù„ÙˆÙ† ÙˆØ§Ø­Ø¯ Ù„Ù„Ù‡ÙˆÙŠØ© */
      --ok:#16a34a;
      --bad:#dc2626;
      --shadow: 0 18px 40px rgba(2,6,23,.14);
      --r:22px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial}
    body{
      margin:0;
      background: radial-gradient(900px 520px at 80% -10%, rgba(14,165,233,.20), transparent 60%),
                  radial-gradient(900px 520px at -10% 10%, rgba(14,165,233,.10), transparent 60%),
                  linear-gradient(180deg, #0b1220, #0b1220);
      color:var(--paper);
    }
    a{color:inherit}

    /* Shell */
    .shell{min-height:100dvh; display:flex; flex-direction:column}
    .top{
      position:sticky; top:0; z-index:20;
      padding:14px 14px 10px;
      background: rgba(11,18,32,.70);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .top .row{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brand{
      display:flex;align-items:center;gap:10px
    }
    .logo{
      width:42px;height:42px;border-radius:16px;
      background: rgba(14,165,233,.18);
      border:1px solid rgba(14,165,233,.35);
      display:grid;place-items:center;
      font-weight:1000; letter-spacing:.5px;
    }
    .title{font-weight:900;font-size:15px}
    .sub{color:rgba(255,255,255,.70);font-size:12px;margin-top:2px}

    /* Page */
    .page{
      width:100%;
      max-width:980px;
      margin:0 auto;
      padding:14px 14px 96px;
      flex:1;
    }

    /* Card */
    .card{
      background: rgba(255,255,255,.96);
      color:var(--ink);
      border:1px solid rgba(2,6,23,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
    }

    /* Buttons */
    .btn{
      border:1px solid rgba(2,6,23,.12);
      background:#fff;
      color:var(--ink);
      border-radius:18px;
      padding:12px 14px;
      min-height:48px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      transition:transform .08s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .btn:hover{transform:translateY(-1px); border-color:rgba(2,6,23,.18); box-shadow:0 14px 24px rgba(2,6,23,.10)}
    .btn.primary{
      background: rgba(14,165,233,.12);
      border-color: rgba(14,165,233,.32);
      color:#075985;
    }
    .btn.dark{
      background: var(--bg);
      color:#fff;
      border-color: rgba(255,255,255,.14);
    }
    .btn.ok{background: rgba(22,163,74,.10); border-color: rgba(22,163,74,.30); color:#14532d}
    .btn.bad{background: rgba(220,38,38,.10); border-color: rgba(220,38,38,.30); color:#7f1d1d}
    .btn.ghost{
      background: transparent;
      color:#fff;
      border-color: rgba(255,255,255,.16);
    }
    .btn.small{min-height:42px;padding:10px 12px;border-radius:16px;font-size:13px}

    /* Bottom nav */
    .bottom{
      position:fixed;left:0;right:0;bottom:0;z-index:30;
      padding:10px 12px;
      background: rgba(11,18,32,.72);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(255,255,255,.08);
    }
    .bottom .wrap{
      max-width:980px;margin:0 auto;
      display:flex;gap:10px;justify-content:space-between;align-items:center;
    }
    .tab{
      flex:1;
      min-height:54px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#fff;
      font-weight:900;
      display:flex;align-items:center;justify-content:center;gap:10px;
      cursor:pointer;
    }
    .tab.active{background: rgba(14,165,233,.20); border-color: rgba(14,165,233,.40)}
    .tab span{opacity:.95}

    /* Lists */
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(2,6,23,.10);
      background:#fff;
    }
    .name{font-weight:950}
    .meta{font-size:12px;color:var(--muted);margin-top:4px}
    .money{font-weight:1000}
    .money.bad{color:var(--bad)}
    .money.ok{color:var(--ok)}
    .money.neutral{color:var(--ink)}
    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}

    /* Inputs */
    label{display:block;font-weight:950;font-size:13px;margin:10px 0 6px}
    input,select{
      width:100%;
      min-height:48px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(2,6,23,.12);
      outline:none;
      font-size:15px;
      background:#fff;
      color:var(--ink);
    }
    input:focus,select:focus{border-color: rgba(14,165,233,.55)}
    .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:860px){.grid2{grid-template-columns:1.2fr .8fr}}

    .hr{height:1px;background:rgba(2,6,23,.08);margin:12px 0}

    /* Modals */
    .overlay{
      position:fixed;inset:0;z-index:80;
      background: rgba(2,6,23,.55);
      display:none;
      padding:14px;
    }
    .modal{
      max-width:520px;margin:8vh auto;
      background:#fff;color:var(--ink);
      border:1px solid rgba(2,6,23,.12);
      border-radius:24px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modal h3{margin:0 0 6px;font-size:16px}
    .hint{color:var(--muted);font-size:12px;line-height:1.7}

    /* Start screen */
    .start{
      min-height: calc(100dvh - 72px);
      display:grid;place-items:center;
      padding:22px 14px 110px;
    }
    .startCard{
      width:min(520px, 100%);
      background: rgba(255,255,255,.96);
      color:var(--ink);
      border:1px solid rgba(2,6,23,.12);
      border-radius:28px;
      box-shadow: var(--shadow);
      padding:22px;
      text-align:center;
    }
    .bigLogo{
      width:84px;height:84px;border-radius:28px;
      margin:0 auto 12px;
      background: rgba(14,165,233,.14);
      border:1px solid rgba(14,165,233,.30);
      display:grid;place-items:center;
      font-weight:1100;font-size:34px;letter-spacing:1px;
    }
    .startTitle{font-weight:1100;font-size:20px;margin:6px 0 4px}
    .startSub{color:var(--muted);font-size:13px;margin:0 0 14px}
    .startBtns{display:grid;gap:10px;margin-top:12px}

    /* Toast */
    .toast{
      position:fixed;left:12px;bottom:86px;z-index:90;
      background: rgba(255,255,255,.96);
      color:var(--ink);
      border:1px solid rgba(2,6,23,.12);
      box-shadow: var(--shadow);
      padding:10px 12px;
      border-radius:16px;
      font-weight:1000;
      display:none;
      max-width:92vw;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
  </style>
</head>

<body>
<div class="shell">

  <div class="top">
    <div class="row">
      <div class="brand">
        <div class="logo">H</div>
        <div>
          <div class="title">Hedra</div>
          <div class="sub mono" id="topLine">â€”</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
        <button class="btn ghost small" id="btnInstall" style="display:none">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</button>
        <button class="btn ghost small" id="btnExport">ØªØµØ¯ÙŠØ±</button>
        <button class="btn ghost small" id="btnImport">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
      </div>
    </div>
  </div>

  <!-- Start -->
  <div class="start" id="startScreen">
    <div class="startCard">
      <div class="bigLogo">H</div>
      <div class="startTitle">Hedra</div>
      <p class="startSub">â€”</p>

      <div class="startBtns">
        <button class="btn dark" id="btnStart">â–¶ï¸ Ø§Ø¨Ø¯Ø£</button>
        <button class="btn primary" id="btnQuickSetup">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø³Ø±ÙŠØ¹</button>
      </div>
    </div>
  </div>

  <div class="page" id="app" style="display:none">
    <!-- RUN (Main) -->
    <section id="pageRun">
      <div class="grid2">
        <div class="card">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div>
              <div class="mono" style="font-weight:1000" id="runHeader">â€”</div>
              <div class="hint" id="runSub">â€”</div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
              <button class="btn primary small" id="btnAddSession">+ Ø­ØµØ©</button>
              <button class="btn primary small" id="btnNewBlock">+ Ø¯ÙˆØ±Ø©</button>
            </div>
          </div>

          <div class="hr"></div>

          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <div style="flex:1;min-width:220px">
              <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
              <select id="selGroup"></select>
            </div>
            <div style="flex:1;min-width:220px">
              <label>Ø§Ù„Ø¯ÙˆØ±Ø©</label>
              <select id="selBlock"></select>
            </div>
          </div>

          <div class="hr"></div>

          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <input id="qStudent" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." />
            <select id="filter">
              <option value="all">Ø§Ù„ÙƒÙ„</option>
              <option value="due">Ø¹Ù„ÙŠÙ‡ Ø¨Ø§Ù‚ÙŠ</option>
              <option value="credit">Ù„Ù‡ Ø±ØµÙŠØ¯</option>
              <option value="zero">ØµÙØ±</option>
            </select>
          </div>

          <div class="hr"></div>
          <div class="list" id="runList"></div>
        </div>

        <!-- Small side card (quiet) -->
        <div class="card">
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
            <div style="font-weight:1000">Ù…Ù„Ø®Øµ</div>
            <div class="mono" style="color:var(--muted)" id="todayLine">â€”</div>
          </div>
          <div class="hr"></div>
          <div class="hint" id="summaryText">â€”</div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="pageSettings" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start">
          <div>
            <div style="font-weight:1000">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
            <div class="hint">Ù…Ø¬Ù…ÙˆØ¹Ø§Øª â€¢ Ø·Ù„Ø§Ø¨ â€¢ Ø¯ÙˆØ±Ø©</div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn primary small" id="btnAddGroup">+ Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
          </div>
        </div>

        <div class="hr"></div>

        <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
        <select id="setGroup"></select>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <div style="flex:1;min-width:240px">
            <label>Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆØ±Ø©)</label>
            <input id="priceCycle" type="number" min="0" step="1" placeholder="Ù…Ø«Ø§Ù„: 400"/>
          </div>
          <div style="flex:1;min-width:240px">
            <label>Ø·ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ±Ø©</label>
            <select id="cycleLen">
              <option value="4">4 Ø­ØµØµ</option>
              <option value="8">8 Ø­ØµØµ</option>
              <option value="12">12 Ø­ØµØ©</option>
            </select>
          </div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <button class="btn ok" id="btnSaveSettings">Ø­ÙØ¸</button>
          <button class="btn bad" id="btnDeleteGroup">Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
        </div>

        <div class="hr"></div>

        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-end;flex-wrap:wrap">
          <div>
            <div style="font-weight:1000">Ø§Ù„Ø·Ù„Ø§Ø¨</div>
            <div class="hint">Ø®ØµÙ…/Ø¥Ø¹ÙØ§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€¢ Ø¥ÙŠÙ‚Ø§Ù Ø·Ø§Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <input id="newStudentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." style="min-width:220px"/>
            <button class="btn primary" id="btnAddStudent">Ø¥Ø¶Ø§ÙØ©</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="list" id="studentsList"></div>
      </div>
    </section>

    <!-- MANAGE -->
    <section id="pageManage" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap">
          <div>
            <div style="font-weight:1000">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
            <div class="hint">ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ù„Ù„Ø¯ÙØ¹ â€¢ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
          </div>
        </div>

        <div class="hr"></div>

        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div style="flex:1;min-width:220px">
            <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
            <select id="mgGroup"></select>
          </div>
          <div style="flex:1;min-width:220px">
            <label>Ø§Ù„Ø¯ÙˆØ±Ø©</label>
            <select id="mgBlock"></select>
          </div>
        </div>

        <div class="hr"></div>

        <input id="mgQ" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." />
        <div class="hr"></div>
        <div class="list" id="mgList"></div>
      </div>
    </section>

  </div>

  <!-- Bottom Tabs -->
  <div class="bottom" id="bottomNav" style="display:none">
    <div class="wrap">
      <button class="tab active" data-tab="run"><span>ğŸ‘¥</span> ØªØ´ØºÙŠÙ„</button>
      <button class="tab" data-tab="manage"><span>ğŸ§¾</span> Ø¥Ø¯Ø§Ø±Ø©</button>
      <button class="tab" data-tab="settings"><span>âš™ï¸</span> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>
  </div>

</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Pay Modal -->
<div class="overlay" id="payOverlay">
  <div class="modal">
    <h3 id="payTitle">â€”</h3>
    <div class="hint" id="payInfo">â€”</div>
    <div class="hr"></div>

    <label>Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹</label>
    <input id="payAmount" type="number" step="1" placeholder="Ù…Ø«Ø§Ù„: 200"/>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
      <button class="btn ok" id="btnPaySave">Ø­ÙØ¸</button>
      <button class="btn" id="btnPayClose">Ø¥ØºÙ„Ø§Ù‚</button>
      <button class="btn bad" id="btnPayClear">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¯ÙØ¹</button>
    </div>
  </div>
</div>

<!-- Student Modal (discount/exempt) -->
<div class="overlay" id="stOverlay">
  <div class="modal">
    <h3 id="stTitle">â€”</h3>
    <div class="hint" id="stHint">â€”</div>
    <div class="hr"></div>

    <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</label>
    <select id="stPaused">
      <option value="0">Ù†Ø´Ø·</option>
      <option value="1">Ù…ÙˆÙ‚ÙˆÙ</option>
    </select>

    <div class="hr"></div>

    <label>Ø®ØµÙ… / Ø¥Ø¹ÙØ§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <select id="discType">
      <option value="none">Ø¨Ø¯ÙˆÙ†</option>
      <option value="fixed">Ø®ØµÙ… Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª</option>
      <option value="percent">Ø®ØµÙ… Ù†Ø³Ø¨Ø© %</option>
      <option value="exempt">Ø¥Ø¹ÙØ§Ø¡ ÙƒØ§Ù…Ù„</option>
    </select>

    <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <input id="discVal" type="number" step="1" placeholder="Ù…Ø«Ø§Ù„: 50"/>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
      <button class="btn ok" id="btnStSave">Ø­ÙØ¸</button>
      <button class="btn" id="btnStClose">Ø¥ØºÙ„Ø§Ù‚</button>
      <button class="btn bad" id="btnStDelete">Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨</button>
    </div>
  </div>
</div>

<!-- New Block Modal -->
<div class="overlay" id="blkOverlay">
  <div class="modal">
    <h3>Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
    <div class="hint">Ø§Ø®ØªØ§Ø±ÙŠ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©. Ø§Ù„Ø§Ø³Ù… Ù‡ÙŠØªÙˆÙ„Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
    <div class="hr"></div>

    <label>Ù…Ù†</label>
    <input id="blkFrom" type="date"/>

    <label>Ø¥Ù„Ù‰</label>
    <input id="blkTo" type="date"/>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
      <button class="btn ok" id="btnBlkCreate">Ø¥Ù†Ø´Ø§Ø¡</button>
      <button class="btn" id="btnBlkClose">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<script>
/* =========================================================
   Hedra v3 â€” Clean + Quiet
   Rules:
   - Each session charges ALL students in the group (no per-student attendance)
   - Cycle length = 4/8/12 (default 8)
   - Block label uses dates "DD/MM â†’ DD/MM"
   - Payments can exceed due => credit (negative remaining)
========================================================= */

const DB_KEY = "hedra_v3_clean";
let db = { groups: [], settings: { currentGroupId:"" } };

/* ---------- Utils ---------- */
function uid(p="id"){ return p+"_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16); }
function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return d.toISOString(); }
function fmtDate(d){
  const x = new Date(d);
  const dd=String(x.getDate()).padStart(2,"0");
  const mm=String(x.getMonth()+1).padStart(2,"0");
  const yy=x.getFullYear();
  return `${dd}/${mm}/${yy}`;
}
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.style.display="none",2200);
}
function safeDelete(msg){
  const v = prompt(msg + "\nØ§ÙƒØªØ¨ DELETE Ù„Ù„ØªØ£ÙƒÙŠØ¯");
  return v==="DELETE";
}
function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function loadDB(){
  const raw=localStorage.getItem(DB_KEY);
  if(!raw) return;
  try{
    const p=JSON.parse(raw);
    if(p && typeof p==="object"){ db=p; }
  }catch{}
}
function normalize(){
  if(!db.settings) db.settings={currentGroupId:""};
  if(!Array.isArray(db.groups)) db.groups=[];
  db.groups.forEach(g=>{
    if(!g.id) g.id=uid("g");
    if(typeof g.name!=="string") g.name="Ù…Ø¬Ù…ÙˆØ¹Ø©";
    if(typeof g.price!=="number") g.price=Number(g.price||0);
    if(!g.cycleLen) g.cycleLen=8;
    if(!Array.isArray(g.students)) g.students=[];
    if(!Array.isArray(g.blocks)) g.blocks=[];
    g.students.forEach(s=>{
      if(!s.id) s.id=uid("s");
      if(typeof s.name!=="string") s.name="Ø·Ø§Ù„Ø¨";
      if(typeof s.paused!=="boolean") s.paused=false;
      if(!s.discountType) s.discountType="none";
      if(typeof s.discountValue!=="number") s.discountValue=Number(s.discountValue||0);
    });
    if(g.blocks.length===0){
      const from=todayISO();
      const to=todayISO();
      g.blocks.push(newBlock(from,to));
    }
    g.blocks.forEach(b=>{
      if(!b.id) b.id=uid("b");
      if(!b.from) b.from=todayISO();
      if(!b.to) b.to=todayISO();
      if(typeof b.sessionsCount!=="number") b.sessionsCount=Number(b.sessionsCount||0);
      if(!b.payments || typeof b.payments!=="object") b.payments={};  // total paid number (can exceed)
      if(!b.carry || typeof b.carry!=="object") b.carry={};          // signed balance from previous blocks (+due / -credit)
      if(!b.notes || typeof b.notes!=="object") b.notes={};
      if(typeof b.closed!=="boolean") b.closed=false;
      b.label = blockLabel(b);
    });
  });
  if(!db.settings.currentGroupId && db.groups[0]) db.settings.currentGroupId=db.groups[0].id;
  saveDB();
}
function getGroup(id){ return db.groups.find(g=>g.id===id) || null; }
function curGroup(){ return getGroup(db.settings.currentGroupId) || db.groups[0] || null; }
function getBlock(g, id){ return g.blocks.find(b=>b.id===id) || null; }
function curBlockForRun(g){
  const id=document.getElementById("selBlock").value;
  return getBlock(g,id) || g.blocks[g.blocks.length-1] || null;
}
function curBlockForManage(g){
  const id=document.getElementById("mgBlock").value;
  return getBlock(g,id) || g.blocks[g.blocks.length-1] || null;
}
function blockLabel(b){
  return `${fmtDate(b.from)} â†’ ${fmtDate(b.to)}`;
}
function newBlock(fromISO, toISO){
  return { id:uid("b"), from:fromISO, to:toISO, label:"", sessionsCount:0, payments:{}, carry:{}, notes:{}, closed:false };
}

/* ---------- Pricing rules ---------- */
function perSession(g){
  const len=Number(g.cycleLen||8);
  const price=Number(g.price||0);
  return len>0 ? (price/len) : 0;
}
function applyDiscount(g, s, base){
  if(s.paused) return 0;
  const t=s.discountType||"none";
  const v=Number(s.discountValue||0);

  if(t==="exempt") return 0;
  if(t==="fixed") return Math.max(0, base - Math.max(0,v));
  if(t==="percent"){
    const p=Math.max(0, Math.min(100, v));
    return Math.max(0, base*(1-p/100));
  }
  return base;
}
function dueThisBlock(g,b,s){
  const base = b.sessionsCount * perSession(g);
  return applyDiscount(g,s, base);
}
function carryBalance(b, sid){
  return Number((b.carry && b.carry[sid]) || 0); // signed
}
function paidTotal(b, sid){
  return Number((b.payments && b.payments[sid]) || 0); // can exceed
}
function totalDue(g,b,s){
  return dueThisBlock(g,b,s) + carryBalance(b,s.id);
}
function remaining(g,b,s){
  // signed remaining: + = due, - = credit
  return totalDue(g,b,s) - paidTotal(b,s.id);
}
function moneyTxt(x){
  const n = Math.round(Number(x||0)*100)/100;
  if(Math.abs(n - Math.round(n))<1e-9) return String(Math.round(n));
  return String(n);
}

/* ---------- UI: Tabs ---------- */
const startScreen=document.getElementById("startScreen");
const app=document.getElementById("app");
const bottomNav=document.getElementById("bottomNav");
const pages={
  run:document.getElementById("pageRun"),
  manage:document.getElementById("pageManage"),
  settings:document.getElementById("pageSettings"),
};
function showTab(k){
  Object.keys(pages).forEach(x=>pages[x].style.display=(x===k)?"":"none");
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab===k);
  });
  renderAll();
}
document.querySelectorAll(".tab").forEach(t=>t.onclick=()=>showTab(t.dataset.tab));

/* ---------- Start ---------- */
document.getElementById("btnStart").onclick=()=>{
  startScreen.style.display="none";
  app.style.display="";
  bottomNav.style.display="";
  showTab("run");
};
document.getElementById("btnQuickSetup").onclick=()=>{
  startScreen.style.display="none";
  app.style.display="";
  bottomNav.style.display="";
  showTab("settings");
};

/* ---------- Export/Import ---------- */
document.getElementById("btnExport").onclick=()=>{
  const data=JSON.stringify(db,null,2);
  const blob=new Blob([data],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="Hedra_v3_Backup.json";
  a.click();
  URL.revokeObjectURL(a.href);
  toast("ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±");
};
document.getElementById("btnImport").onclick=()=>{
  const inp=document.createElement("input");
  inp.type="file"; inp.accept="application/json";
  inp.onchange=()=>{
    const f=inp.files?.[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const parsed=JSON.parse(r.result);
        if(!parsed || typeof parsed!=="object") throw new Error();
        db=parsed;
        normalize();
        toast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯");
        renderAll();
      }catch{ alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­"); }
    };
    r.readAsText(f);
  };
  inp.click();
};

/* ---------- Selects ---------- */
function refreshSelects(){
  const selG=document.getElementById("selGroup");
  const setG=document.getElementById("setGroup");
  const mgG=document.getElementById("mgGroup");
  selG.innerHTML=""; setG.innerHTML=""; mgG.innerHTML="";
  if(!db.groups.length){
    const o=document.createElement("option");
    o.value=""; o.textContent="Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª";
    selG.appendChild(o);
    setG.appendChild(o.cloneNode(true));
    mgG.appendChild(o.cloneNode(true));
    return;
  }
  db.groups.forEach(g=>{
    const o1=document.createElement("option"); o1.value=g.id; o1.textContent=g.name; selG.appendChild(o1);
    const o2=document.createElement("option"); o2.value=g.id; o2.textContent=g.name; setG.appendChild(o2);
    const o3=document.createElement("option"); o3.value=g.id; o3.textContent=g.name; mgG.appendChild(o3);
  });
  const cg=curGroup();
  db.settings.currentGroupId=cg?.id || "";
  selG.value=db.settings.currentGroupId;
  setG.value=db.settings.currentGroupId;
  mgG.value=db.settings.currentGroupId;
}
function refreshBlocks(){
  const g=curGroup();
  const selB=document.getElementById("selBlock");
  const mgB=document.getElementById("mgBlock");
  selB.innerHTML=""; mgB.innerHTML="";
  if(!g) return;
  const prev=selB.value;
  const prev2=mgB.value;

  g.blocks.forEach((b,idx)=>{
    const o=document.createElement("option");
    o.value=b.id;
    const suffix = (idx===g.blocks.length-1) ? " (Ø§Ù„Ø­Ø§Ù„ÙŠ)" : "";
    o.textContent = blockLabel(b)+suffix;
    selB.appendChild(o);

    const o2=document.createElement("option");
    o2.value=b.id;
    o2.textContent=o.textContent;
    mgB.appendChild(o2);
  });

  const newest=g.blocks[g.blocks.length-1]?.id || "";
  selB.value = g.blocks.some(x=>x.id===prev) ? prev : newest;
  mgB.value  = g.blocks.some(x=>x.id===prev2) ? prev2 : newest;
}
document.getElementById("selGroup").onchange=(e)=>{ db.settings.currentGroupId=e.target.value; saveDB(); renderAll(); };
document.getElementById("setGroup").onchange=(e)=>{ db.settings.currentGroupId=e.target.value; saveDB(); renderAll(); };
document.getElementById("mgGroup").onchange=(e)=>{ db.settings.currentGroupId=e.target.value; saveDB(); renderAll(); };
document.getElementById("selBlock").onchange=()=>renderAll();
document.getElementById("mgBlock").onchange=()=>renderAll();

/* ---------- Settings actions ---------- */
document.getElementById("btnAddGroup").onclick=()=>{
  const name=(prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©")||"").trim();
  if(!name) return;
  if(db.groups.some(x=>x.name.trim().toLowerCase()===name.toLowerCase())) return alert("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©");
  const g={ id:uid("g"), name, price:0, cycleLen:8, students:[], blocks:[] };
  const from=todayISO();
  const to=todayISO();
  g.blocks=[ newBlock(from,to) ];
  db.groups.push(g);
  db.settings.currentGroupId=g.id;
  saveDB(); toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©");
  renderAll();
};

function loadSettingsUI(){
  const g=curGroup();
  document.getElementById("priceCycle").value = g ? (g.price||0) : 0;
  document.getElementById("cycleLen").value = g ? String(g.cycleLen||8) : "8";
}
document.getElementById("btnSaveSettings").onclick=()=>{
  const g=curGroup(); if(!g) return;
  g.price = Number(document.getElementById("priceCycle").value||0);
  g.cycleLen = Number(document.getElementById("cycleLen").value||8);
  saveDB(); toast("ØªÙ… Ø§Ù„Ø­ÙØ¸");
  renderAll();
};
document.getElementById("btnDeleteGroup").onclick=()=>{
  const g=curGroup(); if(!g) return;
  if(!safeDelete("Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ")) return;
  db.groups=db.groups.filter(x=>x.id!==g.id);
  db.settings.currentGroupId=db.groups[0]?.id || "";
  saveDB(); toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©");
  renderAll();
};

/* ---------- Students ---------- */
document.getElementById("btnAddStudent").onclick=()=>{
  const g=curGroup(); if(!g) return;
  const name=(document.getElementById("newStudentName").value||"").trim();
  if(!name) return;
  if(g.students.some(s=>s.name.trim().toLowerCase()===name.toLowerCase())) return alert("Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯");
  g.students.push({ id:uid("s"), name, paused:false, discountType:"none", discountValue:0 });
  document.getElementById("newStudentName").value="";
  saveDB(); toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨");
  renderAll();
};

let stCtx=null;
const stOverlay=document.getElementById("stOverlay");
document.getElementById("btnStClose").onclick=()=>{ stOverlay.style.display="none"; stCtx=null; };
stOverlay.onclick=(e)=>{ if(e.target===stOverlay){ stOverlay.style.display="none"; stCtx=null; } };
document.getElementById("btnStSave").onclick=()=>{
  if(!stCtx) return;
  const {g,s}=stCtx;
  s.paused = document.getElementById("stPaused").value==="1";
  s.discountType = document.getElementById("discType").value;
  s.discountValue = Number(document.getElementById("discVal").value||0);
  saveDB(); toast("ØªÙ… Ø§Ù„Ø­ÙØ¸");
  stOverlay.style.display="none"; stCtx=null;
  renderAll();
};
document.getElementById("btnStDelete").onclick=()=>{
  if(!stCtx) return;
  const {g,s}=stCtx;
  if(!safeDelete("Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ")) return;
  // remove from all blocks maps
  g.blocks.forEach(b=>{
    delete b.payments[s.id];
    delete b.carry[s.id];
    delete b.notes[s.id];
  });
  g.students=g.students.filter(x=>x.id!==s.id);
  saveDB(); toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨");
  stOverlay.style.display="none"; stCtx=null;
  renderAll();
};
function openStudentModal(g,s){
  stCtx={g,s};
  document.getElementById("stTitle").textContent = s.name;
  document.getElementById("stHint").textContent = "Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©";
  document.getElementById("stPaused").value = s.paused ? "1" : "0";
  document.getElementById("discType").value = s.discountType||"none";
  document.getElementById("discVal").value = Number(s.discountValue||0);
  stOverlay.style.display="block";
}
function renderStudentsList(){
  const g=curGroup();
  const wrap=document.getElementById("studentsList");
  wrap.innerHTML="";
  if(!g){ wrap.innerHTML=`<div class="hint">Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø©</div>`; return; }
  if(!g.students.length){ wrap.innerHTML=`<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</div>`; return; }

  g.students.slice().sort((a,b)=>a.name.localeCompare(b.name,"ar")).forEach(s=>{
    const it=document.createElement("div");
    it.className="item";
    it.innerHTML=`
      <div>
        <div class="name">${s.name} ${s.paused?`<span class="mono" style="color:var(--bad)">[Ù…ÙˆÙ‚ÙˆÙ]</span>`:""}</div>
        <div class="meta">
          ${s.discountType==="none"?"Ø¨Ø¯ÙˆÙ† Ø®ØµÙ…":
            s.discountType==="fixed" ? `Ø®ØµÙ… Ø«Ø§Ø¨Øª: ${moneyTxt(s.discountValue)}` :
            s.discountType==="percent" ? `Ø®ØµÙ… Ù†Ø³Ø¨Ø©: ${moneyTxt(s.discountValue)}%` :
            `Ø¥Ø¹ÙØ§Ø¡ ÙƒØ§Ù…Ù„`
          }
        </div>
      </div>
      <div class="right">
        <button class="btn primary small">ØªØ¹Ø¯ÙŠÙ„</button>
      </div>
    `;
    it.querySelector("button").onclick=()=>openStudentModal(g,s);
    wrap.appendChild(it);
  });
}

/* ---------- Sessions & Blocks ---------- */
document.getElementById("btnAddSession").onclick=()=>{
  const g=curGroup(); if(!g) return;
  const b=curBlockForRun(g); if(!b) return;
  if(b.sessionsCount >= Number(g.cycleLen||8)){
    toast("Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ø¯ÙˆØ±Ø©. Ø§ÙØªØ­ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©");
    return;
  }
  b.sessionsCount += 1;
  saveDB();
  toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­ØµØ©");
  renderAll();
};

const blkOverlay=document.getElementById("blkOverlay");
document.getElementById("btnBlkClose").onclick=()=>blkOverlay.style.display="none";
blkOverlay.onclick=(e)=>{ if(e.target===blkOverlay) blkOverlay.style.display="none"; };

document.getElementById("btnNewBlock").onclick=()=>{
  const d=new Date();
  const iso = d.toISOString().slice(0,10);
  document.getElementById("blkFrom").value = iso;
  document.getElementById("blkTo").value = iso;
  blkOverlay.style.display="block";
};

document.getElementById("btnBlkCreate").onclick=()=>{
  const g=curGroup(); if(!g) return;
  const cur=g.blocks[g.blocks.length-1];
  // close current & carry signed balance (due or credit)
  const carryMap={};
  g.students.forEach(s=>{
    const bal = remaining(g,cur,s); // signed
    if(Math.abs(bal) > 1e-9) carryMap[s.id]=Math.round(bal*100)/100;
  });
  cur.closed=true;

  const fromV=document.getElementById("blkFrom").value;
  const toV=document.getElementById("blkTo").value;
  if(!fromV || !toV) return alert("Ø§Ø®ØªØ§Ø± Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®");
  const fromISO=new Date(fromV+"T00:00:00").toISOString();
  const toISO=new Date(toV+"T00:00:00").toISOString();
  const b=newBlock(fromISO,toISO);
  b.carry=carryMap;

  g.blocks.push(b);
  saveDB();
  blkOverlay.style.display="none";
  toast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©");
  renderAll();
};

/* ---------- Pay Modal ---------- */
let payCtx=null;
const payOverlay=document.getElementById("payOverlay");
document.getElementById("btnPayClose").onclick=()=>{ payOverlay.style.display="none"; payCtx=null; };
payOverlay.onclick=(e)=>{ if(e.target===payOverlay){ payOverlay.style.display="none"; payCtx=null; } };

document.getElementById("btnPaySave").onclick=()=>{
  if(!payCtx) return;
  const {g,b,s}=payCtx;
  const v = Number(document.getElementById("payAmount").value||0);
  // ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ù…Ù‚Ø¯Ù… / Ø§Ù„Ø²ÙŠØ§Ø¯Ø©
  b.payments[s.id] = Math.round((paidTotal(b,s.id) + v)*100)/100;
  saveDB();
  toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹");
  payOverlay.style.display="none"; payCtx=null;
  renderAll();
};
document.getElementById("btnPayClear").onclick=()=>{
  if(!payCtx) return;
  const {b,s}=payCtx;
  if(!safeDelete("Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¯ÙØ¹ØŸ")) return;
  delete b.payments[s.id];
  saveDB();
  toast("ØªÙ… Ø§Ù„Ù…Ø³Ø­");
  payOverlay.style.display="none"; payCtx=null;
  renderAll();
};

function openPay(g,b,s){
  payCtx={g,b,s};
  const due = totalDue(g,b,s);
  const paid = paidTotal(b,s.id);
  const rem = remaining(g,b,s);

  document.getElementById("payTitle").textContent = s.name;
  document.getElementById("payInfo").innerHTML =
    `Ø§Ù„Ø¯ÙˆØ±Ø©: <span class="mono">${blockLabel(b)}</span><br>`+
    `Ø­ØµØµ: <b>${b.sessionsCount}</b> / <b>${g.cycleLen}</b><br>`+
    `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b>${moneyTxt(due)}</b> â€¢ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: <b>${moneyTxt(paid)}</b> â€¢ `+
    `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <b style="color:${rem>0?'var(--bad)':rem<0?'var(--ok)':'var(--ink)'}">${moneyTxt(rem)}</b>`;

  document.getElementById("payAmount").value = "";
  payOverlay.style.display="block";
}

/* ---------- Run List ---------- */
document.getElementById("qStudent").oninput=()=>renderRunList();
document.getElementById("filter").onchange=()=>renderRunList();

function renderRunHeader(){
  const g=curGroup();
  if(!g){ document.getElementById("runHeader").textContent="â€”"; return; }
  const b=curBlockForRun(g);
  document.getElementById("runHeader").textContent = `${g.name} â€¢ ${b?blockLabel(b):"â€”"}`;
  document.getElementById("runSub").textContent = `Ø·ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ±Ø©: ${g.cycleLen} â€¢ Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆØ±Ø©: ${moneyTxt(g.price)} â€¢ Ø³Ø¹Ø± Ø§Ù„Ø­ØµØ©: ${moneyTxt(perSession(g))}`;
}
function renderRunList(){
  const g=curGroup();
  const wrap=document.getElementById("runList");
  wrap.innerHTML="";
  if(!g){ wrap.innerHTML=`<div class="hint">Ø£Ø¶Ù Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£ÙˆÙ„Ø§Ù‹</div>`; return; }
  const b=curBlockForRun(g);
  if(!b){ wrap.innerHTML=`<div class="hint">â€”</div>`; return; }

  const q=(document.getElementById("qStudent").value||"").trim().toLowerCase();
  const f=document.getElementById("filter").value;

  const list=g.students
    .filter(s=>s.name.toLowerCase().includes(q))
    .sort((a,b)=>a.name.localeCompare(b.name,"ar"))
    .filter(s=>{
      const rem=remaining(g,b,s);
      if(f==="due") return rem>0.000001;
      if(f==="credit") return rem<-0.000001;
      if(f==="zero") return Math.abs(rem) <= 0.000001;
      return true;
    });

  if(!list.length){ wrap.innerHTML=`<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>`; return; }

  list.forEach(s=>{
    const rem=remaining(g,b,s);
    let cls="neutral";
    if(rem>0.000001) cls="bad";
    else if(rem<-0.000001) cls="ok";

    const it=document.createElement("div");
    it.className="item";
    it.innerHTML=`
      <div>
        <div class="name">${s.name} ${s.paused?`<span class="mono" style="color:var(--bad)">[Ù…ÙˆÙ‚ÙˆÙ]</span>`:""}</div>
        <div class="meta">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span class="money ${cls}">${moneyTxt(rem)}</span></div>
      </div>
      <div class="right">
        <button class="btn ${rem>0?'bad':rem<0?'ok':'primary'} small">${rem>0?'Ø¯ÙØ¹':rem<0?'Ø±ØµÙŠØ¯':'ØªÙØ§ØµÙŠÙ„'}</button>
      </div>
    `;
    it.querySelector("button").onclick=()=>openPay(g,b,s);
    wrap.appendChild(it);
  });
}

/* ---------- Manage ---------- */
document.getElementById("mgQ").oninput=()=>renderManage();
function renderManage(){
  const g=curGroup();
  const wrap=document.getElementById("mgList");
  wrap.innerHTML="";
  if(!g){ wrap.innerHTML=`<div class="hint">â€”</div>`; return; }
  const b=curBlockForManage(g);
  if(!b){ wrap.innerHTML=`<div class="hint">â€”</div>`; return; }
  const q=(document.getElementById("mgQ").value||"").trim().toLowerCase();
  const list=g.students
    .filter(s=>s.name.toLowerCase().includes(q))
    .sort((a,b)=>a.name.localeCompare(b.name,"ar"));

  if(!list.length){ wrap.innerHTML=`<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>`; return; }

  list.forEach(s=>{
    const due=totalDue(g,b,s);
    const paid=paidTotal(b,s.id);
    const rem=remaining(g,b,s);

    const it=document.createElement("div");
    it.className="item";
    it.innerHTML=`
      <div>
        <div class="name">${s.name}</div>
        <div class="meta mono">
          Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${moneyTxt(due)} â€¢ Ù…Ø¯ÙÙˆØ¹: ${moneyTxt(paid)} â€¢ Ù…ØªØ¨Ù‚ÙŠ: ${moneyTxt(rem)}<br>
          Ù…Ù„Ø§Ø­Ø¸Ø©: ${String(b.notes?.[s.id]||"")}
        </div>
      </div>
      <div class="right">
        <button class="btn primary small" data-a="pay">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹</button>
        <button class="btn primary small" data-a="note">Ù…Ù„Ø§Ø­Ø¸Ø©</button>
        <button class="btn bad small" data-a="clear">Ù…Ø³Ø­ Ø§Ù„Ø¯ÙØ¹</button>
      </div>
    `;
    it.querySelector('[data-a="pay"]').onclick=()=>{
      const v=prompt("Ø§ÙƒØªØ¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©", String(paidTotal(b,s.id)));
      if(v===null) return;
      b.payments[s.id]=Number(v||0);
      saveDB(); toast("ØªÙ… Ø§Ù„Ø­ÙØ¸"); renderAll(); showTab("manage");
    };
    it.querySelector('[data-a="note"]').onclick=()=>{
      const cur=String(b.notes?.[s.id]||"");
      const v=prompt("Ù…Ù„Ø§Ø­Ø¸Ø©", cur);
      if(v===null) return;
      b.notes[s.id]=String(v);
      saveDB(); toast("ØªÙ… Ø§Ù„Ø­ÙØ¸"); renderAll(); showTab("manage");
    };
    it.querySelector('[data-a="clear"]').onclick=()=>{
      if(!safeDelete("Ù…Ø³Ø­ Ø§Ù„Ø¯ÙØ¹ØŸ")) return;
      delete b.payments[s.id];
      saveDB(); toast("ØªÙ… Ø§Ù„Ù…Ø³Ø­"); renderAll(); showTab("manage");
    };
    wrap.appendChild(it);
  });
}

/* ---------- Summary / Top line ---------- */
function renderTop(){
  const g=curGroup();
  const d=new Date();
  const dd=String(d.getDate()).padStart(2,"0");
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const yy=d.getFullYear();
  document.getElementById("todayLine").textContent = `${dd}/${mm}/${yy}`;
  document.getElementById("topLine").textContent = g ? g.name : "â€”";
}
function renderSummary(){
  const g=curGroup();
  const el=document.getElementById("summaryText");
  if(!g){ el.textContent="Ø£Ø¶Ù Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„Ù„Ø¨Ø¯Ø¡."; return; }
  const b=curBlockForRun(g);
  const cnt=b?b.sessionsCount:0;
  const len=Number(g.cycleLen||8);
  el.innerHTML =
    `Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span class="mono">${b?blockLabel(b):"â€”"}</span><br>`+
    `Ø­ØµØµ: <b>${cnt}</b> / <b>${len}</b><br>`+
    `Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ø¯ÙØ¹ Ø£Ùˆ Ø§Ù„ØªÙØ§ØµÙŠÙ„.`;
}

/* ---------- Render all ---------- */
function renderAll(){
  normalize();
  refreshSelects();
  refreshBlocks();
  loadSettingsUI();
  renderTop();
  renderRunHeader();
  renderRunList();
  renderStudentsList();
  renderManage();
  renderSummary();
}

/* ---------- Install button (PWA) ---------- */
let deferredPrompt=null;
window.addEventListener("beforeinstallprompt",(e)=>{
  e.preventDefault();
  deferredPrompt=e;
  document.getElementById("btnInstall").style.display="inline-flex";
});
document.getElementById("btnInstall").onclick=async ()=>{
  if(!deferredPrompt){
    alert("Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­: Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â‹® Ø«Ù… (Install) Ø£Ùˆ (Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)");
    return;
  }
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt=null;
  document.getElementById("btnInstall").style.display="none";
};

/* ---------- Init ---------- */
(function init(){
  loadDB();
  normalize();
  renderAll();
  // Ù„Ùˆ ÙÙŠÙ‡ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¨Ø§Ù„ÙØ¹Ù„ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¨Ø§Ø´Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
})();

/* ---------- Service Worker ---------- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
